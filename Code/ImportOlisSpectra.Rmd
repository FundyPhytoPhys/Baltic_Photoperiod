---
title: "Import OLIS spectral data data"
author: "Douglas A. Campbell, Sylwia Sliwinska-Wilczewska, Sarah Gore, Adrian Kryk"
date: "`r format(Sys.Date())`"
output:
  html_document:
    df_print: paged
---

# Import spectral files generated by OLIS spectrophotometer

```{r setup, include = FALSE}
# knitr::opts_chunk$set(echo = TRUE, message = FALSE)
# knitr::opts_chunk$set(fig.path='Figs/')
```


Whole-cell spectra

For WWPhotoperiodSingle - I added 1 mL of culture and 7 mL of f/2 medium
For SySlCCASingle, SySlCCASingleChosen, SySlColorSingle - I added 4 mL of culture and 4 mL of f/2 medium

```{r set project variables}
Project <- "PicoBaltic"
DataOut <- file.path("..", "ImportedData", "OLIS")
# DataIn <- file.path("..", "OLISSpectraCorr", "SySlCCASingle", fsep = .Platform$file.sep)
# DataIn <- file.path("..", "OLISSpectraCorr", "SySlCCASingleChosen", fsep = .Platform$file.sep)
# DataIn <- file.path("..", "OLISSpectraCorr", "SySlColorSingle", fsep = .Platform$file.sep)
# DataIn <- file.path("..", "OLISSpectraCorr", "UnusedSingle", fsep = .Platform$file.sep)
# DataIn <- file.path("..", "OLISSpectraCorr", "WWPhotoperiodSingle", fsep = .Platform$file.sep)
DataIn <- file.path("..", "OLISSpectraCorr", "AllSingle", fsep = .Platform$file.sep)

FileID <- "Smooth"
FileEncode <- "UTF-8" 
Delimiter <- ""
HeaderRows <- 0
```


```{r load libraries} 
# libraries; Note check actual dependencies
library(tidyverse)
library(lubridate)
library(stringr)
library(broom)
library(knitr)
library(OneR)
library(zoo)
library(strucchange)

library(dplyr)
library(magrittr)
library(googledrive)
library(googlesheets4)
library(readxl)

library(ggspectra)
library(ggpubr)
library(caret)

library(photobiologyWavebands)
library(reshape2)
library(photobiology)

library(gcookbook)
library(RColorBrewer)
library(viridis)
library(scales)

library(reshape)
library(patchwork)
```

```{r set colours}
Wavelengths_nm = c(445, 470, 505, 535, 590)
Colours_nm = c("darkblue", "dodgerblue", "darkgreen", "yellowgreen",  "darkorange")

names(Colours_nm) <- Wavelengths_nm
Colours_nm

```


```{r list available OLIS Files}
OlisFiles <- list.files(path = DataIn, pattern = FileID, full.names = TRUE)
OlisFiles
unique(duplicated(OlisFiles))
```


# set up read_delim_plus
```{r}

read.delim_plus <- function(flnm, filencode, delimiter, headerrows){read.delim(flnm, fileEncoding = filencode, sep = delimiter,  skip = headerrows, header = TRUE, row.names = NULL) %>%
     mutate(Filename = flnm, Cdatetime = ymd_hms(file.info(flnm)$ctime))
}

#read.delim_long meant for map over a vector of filepaths to read, convert to long format and tidy the imported data
read.delim_long <- function(flnm, filencode, delimiter, headerrows){read.delim(flnm, fileEncoding = filencode, sep = delimiter,  skip = headerrows, header = TRUE, row.names = NULL) %>%
    mutate(Filename = flnm, Cdatetime = ymd_hms(file.info(flnm)$ctime)) %>%
 rename(nm = OLIS.3D.ASCII) %>%
  mutate(FirstLastSpec = str_extract(Filename, "_[A-Z][a-z][A-Z][a-z][:digit:][:digit:][:digit:][:digit:]_[A-Z][a-z][A-Z][a-z][:digit:][:digit:][:digit:][:digit:]_")) %>%
  mutate(SampleNumbers = str_extract_all(FirstLastSpec, "[:digit:][:digit:][:digit:][:digit:]")) %>%
  mutate(FirstSampleNumber = as.numeric(map(SampleNumbers, ~.[[1]]))) %>%
  mutate(LastSampleNumber = as.numeric(map(SampleNumbers, ~.[[2]]))) %>%
  mutate(OperatorID = str_extract(Filename,"[A-Z][a-z][A-Z][a-z]")) %>%
  pivot_longer(cols = starts_with("X"), names_to = "SpectraID", values_to = "Abs") %>%
  mutate(SampleCode = as.numeric(str_remove(SpectraID, "X"))) %>%
  mutate(SampleNumber = SampleCode - min(SampleCode, na.rm = TRUE) + FirstSampleNumber) %>%
  relocate(OperatorID, SampleNumber) %>%
  unite(col = SampleID, OperatorID:SampleNumber, sep = "", remove = FALSE) %>%
  arrange(SampleID, nm) %>%
  relocate(SampleID, nm, Abs) %>%
  mutate(SpectraDate = str_extract(Filename, "/[:digit:][:digit:][:digit:][:digit:][:digit:][:digit:][:digit:][:digit:]_"),
         SpectraDate = str_remove_all(SpectraDate, "_"),
         SpectraDate = str_remove_all(SpectraDate, "/"),
         SpectraDate = ymd(SpectraDate)
  )
}
```


# Import OLISSpectra corrected files
```{r import from specific OLIS corrected file containing multiple spectra}

TargetFile <-  OlisFiles
TargetSpectra <- TargetFile %>% map_df(~read.delim_plus(flnm = ., filencode = FileEncode, delimiter = Delimiter, headerrows = HeaderRows)) %>% 
  pivot_longer(., -c(`OLIS.3D.ASCII`, Filename, Cdatetime), values_to = "Absorbance", names_to = "SampleID") %>%
  filter(!is.na(Absorbance)) %>%
  mutate(nm = `OLIS.3D.ASCII`) %>% 
  select(-c(`OLIS.3D.ASCII`))   
  #separate(col = SampleID, into = c("SampleID", "Replicate"), sep = "_")
TargetSpectraLong <- TargetSpectra %>%
  # rename(nm = OLIS.3D.ASCII) %>%
  separate(col = Filename, into = c("fp1", "fp2", "fp3", "SpectraDate", "Project", "Source", "Range", "Type", "Correction", "Smooth"), sep = "([\\/\\_\\:])", remove = FALSE) 

TargetSpectraLong <- TargetSpectraLong %>%
  select(-c(fp1, fp2, fp3, Type, Correction, Smooth, SampleID)) %>% 
  mutate(CultureID = Source) %>% 
  select(-c(Source)) %>% 
  mutate(SpectraDate = ymd(`SpectraDate`)) 

#rm(TargetSpectraLong2)
```

Load Multiculti catalog
```{r load local multiculticatalog, message = FALSE, warning = FALSE, echo=FALSE}
gs4_deauth()

MetaData <- read_sheet("https://docs.google.com/spreadsheets/d/1ZXpwR7Gfto-uRzVdXzMpQF4frbrvMLH_IyLqonFZRSw/edit#gid=0") %>%
  drop_na(WL) %>%
  mutate(WL = unlist(WL))

as.data.frame(MetaData)
MetaData <- MetaData %>%
   mutate(ExpDate = ymd(ExpDate),
          ExpEndDate = ymd_hms(`ExpEndDate`))
```

Filter multiculti catalog for SySl WWPhotoperiod paper
```{r}

# MetaData <- MetaData %>%
# summarize(Run, ID, Strain, InnocDate, ExpDate, Par_ue, Photoperiod, Tube, O2, WL, LightShape) %>% 
#   filter(Strain == "BA127R" | Strain == "BA77G" | Strain == "BA48R" | Strain == "BA56G") %>%
#   filter(WL == "WW") %>%
#   filter(Par_ue != 600) %>% 
#   filter(Run == "39" | Run == "40" | Run == "43" | Run == "44" |Run == "45" | Run == "46" | Run == "60" | Run == "62" | Run == "65" | Run == "71" | Run == "74" | Run == "77") 
#   
#   MetaData1 <- MetaData %>%
#   filter(Photoperiod != "24") %>% 
#   mutate(PARPhotonDose =(Par_ue/2)*Photoperiod*3600)
#   
#   MetaData2 <- MetaData %>%
#   filter(Photoperiod == "24") %>% 
#   mutate(PARPhotonDose = Par_ue*Photoperiod*3600) 
#   
#   MetaData <-rbind(MetaData1, MetaData2)
#   rm(MetaData1,MetaData2)

```


# Merge OLISSpectra with MetaData
```{r OLISDateSpectra with MetaData}

OLISSpectraMeta <- MetaData %>%
  left_join(., TargetSpectraLong, by = c("ID" = "CultureID")) 

# OLISSpectraMeta <- OLISSpectraMeta %>%
#   rename("FilenameOlis" = "Filename") %>% 
#   select(-c(PrimaryOperator, doi, ProjectID, Inoc_mL, Media_mL, InnocDate, Tube, Plate, Well, Salinity,  N2, Ar, CO2, Media, MediaDate, SourceSalinity, OptodeCh, InocpH, FinalpH, Par_ueAdjusted, DateOfAdjustment, ElaspedHoursAtAdjustment, ...44, ...45, Description, Motivation, MC, EndDate,  ExpCul, ExpStartTime, Source, Optode, Range, Cdatetime, Project))
          
OLISSpectraMeta <- OLISSpectraMeta %>%
group_by(ID) %>%
  arrange(SpectraDate) %>%
  mutate(E_days = as.numeric((SpectraDate - ExpDate[1]))) %>%
  mutate(SumAb = sum(Absorbance)) %>% 
ungroup()

OLISSpectraMeta <- OLISSpectraMeta %>%
  filter(nm >= 400 & nm <= 700)

```

Normalization at 440 
```{r}

Absorbance440 <- OLISSpectraMeta %>% 
  filter(nm == 440) %>%
  mutate(Abs440 = Absorbance) %>%
  select(ID, Strain, Abs440, Par_ue, Photoperiod, E_days)
  
OLISSpectraMeta440 <- OLISSpectraMeta %>%
  left_join(., Absorbance440) %>%
  mutate(AbsNorm440 = Absorbance / Abs440) 
  
OLISSpectraMeta440 <- OLISSpectraMeta440 %>%
group_by(ID, E_days, Par_ue, Photoperiod) %>%
  mutate(SumAbNorm = sum(AbsNorm440)) %>% 
ungroup()

```
```{r}

OLISSpectraMeta440<-OLISSpectraMeta440 %>% 
  mutate(CultureID=ID) %>% 
  mutate(FilenameOlis=Filename) %>% 
  mutate(ObsDate=SpectraDate) %>% 
  select(-c(PrimaryOperator,Description, Motivation, doi, ProjectID, Inoc_mL, Media_mL, ExpCul, ExpStartTime, Temp_c, Plate, Well, EndDate, Salinity, N2, Ar, CO2, O2_Category, Media, MediaDate, Source, SourceSalinity, InocpH, FinalpH, Par_ueAdjusted, DateOfAdjustment, ElaspedHoursAtAdjustment, ...46, ...47, SampleID, OptodeMeasure, Project, Cdatetime, Range, ID, Filename, "Calculated_ÂµmolPhotons_m-2d-1", SpectraDate)) %>% 
  select(c(Run, CultureID, Strain, InnocDate, ExpDate, Par_ue, Photoperiod, MC, Tube, O2, WL, LightShape, Optode, OptodeCh, ExpEndDate, FilenameOlis, ObsDate, Absorbance, nm, E_days, SumAb, Abs440, AbsNorm440, SumAbNorm))


colnames(OLISSpectraMeta440)
```


```{r}
saveRDS(OLISSpectraMeta440, file.path(DataOut, paste(Project, "OLISSpectraAllSingle.Rds", sep = "_"), fsep = .Platform$file.sep))

```







Extracted pigment spectra
Chla and phycobilins - I added 1 mL of pigments extract and 7 mL of 90% acetone or solution for phyco
```{r set project variables}
Project <- "PicoBaltic"
DataOut <- file.path("..", "ImportedData", "OLIS")
DataIn <- file.path("..", "OLISSpectraCorr", "PigmentsCombinedData_375710Single", fsep = .Platform$file.sep)

FileID <- "Smooth"
FileEncode <- "UTF-8" 
Delimiter <- ""
HeaderRows <- 0
```


```{r list available OLIS Files}
OlisFiles <- list.files(path = DataIn, pattern = FileID, full.names = TRUE)
OlisFiles
unique(duplicated(OlisFiles))
```


# set up read_delim_plus
```{r}

read.delim_plus <- function(flnm, filencode, delimiter, headerrows){read.delim(flnm, fileEncoding = filencode, sep = delimiter,  skip = headerrows, header = TRUE, row.names = NULL) %>%
     mutate(Filename = flnm, Cdatetime = ymd_hms(file.info(flnm)$ctime))
}

#read.delim_long meant for map over a vector of filepaths to read, convert to long format and tidy the imported data
read.delim_long <- function(flnm, filencode, delimiter, headerrows){read.delim(flnm, fileEncoding = filencode, sep = delimiter,  skip = headerrows, header = TRUE, row.names = NULL) %>%
    mutate(Filename = flnm, Cdatetime = ymd_hms(file.info(flnm)$ctime)) %>%
 rename(nm = OLIS.3D.ASCII) %>%
  mutate(FirstLastSpec = str_extract(Filename, "_[A-Z][a-z][A-Z][a-z][:digit:][:digit:][:digit:][:digit:]_[A-Z][a-z][A-Z][a-z][:digit:][:digit:][:digit:][:digit:]_")) %>%
  mutate(SampleNumbers = str_extract_all(FirstLastSpec, "[:digit:][:digit:][:digit:][:digit:]")) %>%
  mutate(FirstSampleNumber = as.numeric(map(SampleNumbers, ~.[[1]]))) %>%
  mutate(LastSampleNumber = as.numeric(map(SampleNumbers, ~.[[2]]))) %>%
  mutate(OperatorID = str_extract(Filename,"[A-Z][a-z][A-Z][a-z]")) %>%
  pivot_longer(cols = starts_with("X"), names_to = "SpectraID", values_to = "Abs") %>%
  mutate(SampleCode = as.numeric(str_remove(SpectraID, "X"))) %>%
  mutate(SampleNumber = SampleCode - min(SampleCode, na.rm = TRUE) + FirstSampleNumber) %>%
  relocate(OperatorID, SampleNumber) %>%
  unite(col = SampleID, OperatorID:SampleNumber, sep = "", remove = FALSE) %>%
  arrange(SampleID, nm) %>%
  relocate(SampleID, nm, Abs) %>%
  mutate(SpectraDate = str_extract(Filename, "/[:digit:][:digit:][:digit:][:digit:][:digit:][:digit:][:digit:][:digit:]_"),
         SpectraDate = str_remove_all(SpectraDate, "_"),
         SpectraDate = str_remove_all(SpectraDate, "/"),
         SpectraDate = ymd(SpectraDate)
  )
}
```


# Import OLISSpectra corrected files
```{r import from specific OLIS corrected file containing multiple spectra}

TargetFile <-  OlisFiles
TargetSpectra <- TargetFile %>% map_df(~read.delim_plus(flnm = ., filencode = FileEncode, delimiter = Delimiter, headerrows = HeaderRows)) %>% 
  pivot_longer(., -c(`OLIS.3D.ASCII`, Filename, Cdatetime), values_to = "Absorbance", names_to = "SampleID") %>%
  filter(!is.na(Absorbance)) %>%
  mutate(nm = `OLIS.3D.ASCII`) %>% 
  select(-c(`OLIS.3D.ASCII`))   
  #separate(col = SampleID, into = c("SampleID", "Replicate"), sep = "_")
TargetSpectraLong <- TargetSpectra %>%
  # rename(nm = OLIS.3D.ASCII) %>%
  separate(col = Filename, into = c("fp1", "fp2", "fp3", "fp4", "SpectraDate", "Project", "Source", "Range", "Pigment", "Type", "Correction", "Smooth"), sep = "([\\/\\_\\:])", remove = FALSE) 

TargetSpectraLong <- TargetSpectraLong %>%
  select(-c(fp1, fp2, fp3, fp4, Type, Correction, Smooth, SampleID)) %>% 
  mutate(CultureID = Source) %>% 
  select(-c(Source)) %>% 
  mutate(SpectraDate = ymd(`SpectraDate`)) 

#rm(TargetSpectraLong2)
```



Filter multiculti catalog for SySl WWPhotoperiod paper
```{r}

# MetaData <- MetaData %>%
# summarize(Run, ID, Strain, InnocDate, ExpDate, Par_ue, Photoperiod, Tube, O2, WL, LightShape) %>% 
#   filter(Strain == "BA127R" | Strain == "BA77G" | Strain == "BA48R" | Strain == "BA56G") %>%
#   filter(WL == "WW") %>%
#   filter(Par_ue != 600) %>% 
#   filter(Run == "39" | Run == "40" | Run == "43" | Run == "44" |Run == "45" | Run == "46" | Run == "60" | Run == "62" | Run == "65" | Run == "71" | Run == "74" | Run == "77") 
#   
#   MetaData1 <- MetaData %>%
#   filter(Photoperiod != "24") %>% 
#   mutate(PARPhotonDose =(Par_ue/2)*Photoperiod*3600)
#   
#   MetaData2 <- MetaData %>%
#   filter(Photoperiod == "24") %>% 
#   mutate(PARPhotonDose = Par_ue*Photoperiod*3600) 
#   
#   MetaData <-rbind(MetaData1, MetaData2)
#   rm(MetaData1,MetaData2)

```


# Merge OLISSpectra with MetaData
```{r OLISDateSpectra with MetaData}

OLISSpectraMeta <- MetaData %>%
  left_join(., TargetSpectraLong, by = c("ID" = "CultureID")) 

# OLISSpectraMeta <- OLISSpectraMeta %>%
#   rename("FilenameOlis" = "Filename") %>% 
#   select(-c(PrimaryOperator, doi, ProjectID, Inoc_mL, Media_mL, InnocDate, Tube, Plate, Well, Salinity,  N2, Ar, CO2, Media, MediaDate, SourceSalinity, OptodeCh, InocpH, FinalpH, Par_ueAdjusted, DateOfAdjustment, ElaspedHoursAtAdjustment, ...44, ...45, Description, Motivation, MC, EndDate,  ExpCul, ExpStartTime, Source, Optode, Range, Cdatetime, Project))
          
OLISSpectraMeta <- OLISSpectraMeta %>%
group_by(ID) %>%
  arrange(SpectraDate) %>%
  mutate(E_days = as.numeric((SpectraDate - ExpDate[1]))) %>%
  # mutate(SumAb = sum(Absorbance)) %>% 
ungroup()

OLISSpectraMeta <- OLISSpectraMeta %>%
  filter(nm >= 400 & nm <= 700)

```

Normalization at 440 
```{r}

# Absorbance440 <- OLISSpectraMeta %>% 
#   filter(nm == 440) %>%
#   mutate(Abs440 = Absorbance) %>%
#   select(ID, Strain, Abs440, Par_ue, Photoperiod, E_days)
#   
# OLISSpectraMeta440 <- OLISSpectraMeta %>%
#   left_join(., Absorbance440) %>%
#   mutate(AbsNorm440 = Absorbance / Abs440) 
#   
# OLISSpectraMeta440 <- OLISSpectraMeta440 %>%
# group_by(ID, E_days, Par_ue, Photoperiod) %>%
#   mutate(SumAbNorm = sum(AbsNorm440)) %>% 
# ungroup()

```

```{r}

OLISSpectraMeta<-OLISSpectraMeta %>% 
  mutate(CultureID=ID) %>% 
  mutate(FilenameOlis=Filename) %>% 
  mutate(ObsDate=SpectraDate) %>% 
  select(-c(PrimaryOperator,Description, Motivation, doi, ProjectID, Inoc_mL, Media_mL, ExpCul, ExpStartTime, Temp_c, Plate, Well, EndDate, Salinity, N2, Ar, CO2, O2_Category, Media, MediaDate, Source, SourceSalinity, InocpH, FinalpH, Par_ueAdjusted, DateOfAdjustment, ElaspedHoursAtAdjustment, ...46, ...47, SampleID, OptodeMeasure, Project, Cdatetime, Range, ID, Filename, "Calculated_ÂµmolPhotons_m-2d-1", SpectraDate)) %>% 

  select(c(Run, CultureID, Strain, InnocDate, ExpDate, Par_ue, Photoperiod, MC, Tube, O2, WL, LightShape, Optode, OptodeCh, ExpEndDate, FilenameOlis, ObsDate, Pigment, Absorbance, nm, E_days))


colnames(OLISSpectraMeta)
```

```{r}
saveRDS(OLISSpectraMeta, file.path(DataOut, paste(Project, "OLISSpectraPigmentsExtract.Rds", sep = "_"), fsep = .Platform$file.sep))

```






Daily Exp - with different hour of measurements and replica
```{r set project variables}
Project <- "PicoBaltic"
DataOut <- file.path("..", "ImportedData", "OLIS")
DataIn <- file.path("..", "OLISSpectraCorr", "DailyPeakSingle", fsep = .Platform$file.sep)
FileID <- "JavCorr"
FileEncode <- "UTF-8" 
Delimiter <- ""
HeaderRows <- 0
```


```{r list available OLIS Files}
OlisFiles <- list.files(path = DataIn, pattern = FileID, full.names = TRUE)
OlisFiles
unique(duplicated(OlisFiles))
```


# set up read_delim_plus
```{r}

read.delim_plus <- function(flnm, filencode, delimiter, headerrows){read.delim(flnm, fileEncoding = filencode, sep = delimiter,  skip = headerrows, header = TRUE, row.names = NULL) %>%
     mutate(Filename = flnm, Cdatetime = ymd_hms(file.info(flnm)$ctime))
}

#read.delim_long meant for map over a vector of filepaths to read, convert to long format and tidy the imported data
read.delim_long <- function(flnm, filencode, delimiter, headerrows){read.delim(flnm, fileEncoding = filencode, sep = delimiter,  skip = headerrows, header = TRUE, row.names = NULL) %>%
    mutate(Filename = flnm, Cdatetime = ymd_hms(file.info(flnm)$ctime)) %>%
 rename(nm = OLIS.3D.ASCII) %>%
  mutate(FirstLastSpec = str_extract(Filename, "_[A-Z][a-z][A-Z][a-z][:digit:][:digit:][:digit:][:digit:]_[A-Z][a-z][A-Z][a-z][:digit:][:digit:][:digit:][:digit:]_")) %>%
  mutate(SampleNumbers = str_extract_all(FirstLastSpec, "[:digit:][:digit:][:digit:][:digit:]")) %>%
  mutate(FirstSampleNumber = as.numeric(map(SampleNumbers, ~.[[1]]))) %>%
  mutate(LastSampleNumber = as.numeric(map(SampleNumbers, ~.[[2]]))) %>%
  mutate(OperatorID = str_extract(Filename,"[A-Z][a-z][A-Z][a-z]")) %>%
  pivot_longer(cols = starts_with("X"), names_to = "SpectraID", values_to = "Abs") %>%
  mutate(SampleCode = as.numeric(str_remove(SpectraID, "X"))) %>%
  mutate(SampleNumber = SampleCode - min(SampleCode, na.rm = TRUE) + FirstSampleNumber) %>%
  relocate(OperatorID, SampleNumber) %>%
  unite(col = SampleID, OperatorID:SampleNumber, sep = "", remove = FALSE) %>%
  arrange(SampleID, nm) %>%
  relocate(SampleID, nm, Abs) %>%
  mutate(SpectraDate = str_extract(Filename, "/[:digit:][:digit:][:digit:][:digit:][:digit:][:digit:][:digit:][:digit:]_"),
         SpectraDate = str_remove_all(SpectraDate, "_"),
         SpectraDate = str_remove_all(SpectraDate, "/"),
         SpectraDate = ymd(SpectraDate)
  )
}
```


# Import OLISSpectra corrected files
```{r import from specific OLIS corrected file containing multiple spectra}

TargetFile <-  OlisFiles
TargetSpectra <- TargetFile %>% map_df(~read.delim_plus(flnm = ., filencode = FileEncode, delimiter = Delimiter, headerrows = HeaderRows)) %>% 
  pivot_longer(., -c(`OLIS.3D.ASCII`, Filename, Cdatetime), values_to = "Absorbance", names_to = "SampleID") %>%
  filter(!is.na(Absorbance)) %>%
  mutate(nm = `OLIS.3D.ASCII`) %>% 
  select(-c(`OLIS.3D.ASCII`))   
  #separate(col = SampleID, into = c("SampleID", "Replicate"), sep = "_")
TargetSpectraLong <- TargetSpectra %>%
  # rename(nm = OLIS.3D.ASCII) %>%
  separate(col = Filename, into = c("fp1", "fp2", "fp3", "SpectraDate", "Project", "Source", "SpectraHour", "Type", "Correction", "Replica"), sep = "([\\/\\_\\:])", remove = FALSE) 

TargetSpectraLong <- TargetSpectraLong %>%
  select(-c(fp1, fp2, fp3, Type, Correction, SampleID)) %>% 
  mutate(CultureID = Source) %>% 
  select(-c(Source)) %>% 
  mutate(Replica=case_when(Replica=="1.asc"~1,
         Replica=="2.asc"~2)) %>% 
  mutate(SpectraDate = ymd(`SpectraDate`)) 

#rm(TargetSpectraLong2)
```



Filter multiculti catalog for SySl Daily Peak paper
```{r}
# colnames(MetaData)
# MetaData <- MetaData %>%
# summarize(Run, ID, Strain, InnocDate, ExpDate, Par_ue, Photoperiod, Tube, O2, WL, LightShape) %>% 
#   filter(Strain == "BA127R" | Strain == "BA77G" | Strain == "BA48R" | Strain == "BA56G") %>%
#   filter(WL == "WW") %>%
#   filter(Par_ue != 600) %>% 
#   filter(Run == "39" | Run == "40" | Run == "43" | Run == "44" |Run == "45" | Run == "46" | Run == "60" | Run == "62" | Run == "65" | Run == "71" | Run == "74" | Run == "77" | Run == "117") 
#   
#   MetaData1 <- MetaData %>%
#   filter(Photoperiod != "24") %>% 
#   mutate(PARPhotonDose =(Par_ue/2)*Photoperiod*3600)
#   
#   MetaData2 <- MetaData %>%
#   filter(Photoperiod == "24") %>% 
#   mutate(PARPhotonDose = Par_ue*Photoperiod*3600) 
#   
#   MetaData <-rbind(MetaData1, MetaData2)
#   rm(MetaData1,MetaData2)

```


# Merge OLISSpectra with MetaData
```{r OLISDateSpectra with MetaData}

OLISSpectraMeta <- MetaData %>%
  left_join(., TargetSpectraLong, by = c("ID" = "CultureID")) 

# OLISSpectraMeta <- OLISSpectraMeta %>%
#   rename("FilenameOlis" = "Filename") %>% 
#   select(-c(PrimaryOperator, doi, ProjectID, Inoc_mL, Media_mL, InnocDate, Tube, Plate, Well, Salinity,  N2, Ar, CO2, Media, MediaDate, SourceSalinity, OptodeCh, InocpH, FinalpH, Par_ueAdjusted, DateOfAdjustment, ElaspedHoursAtAdjustment, ...44, ...45, Description, Motivation, MC, EndDate,  ExpCul, ExpStartTime, Source, Optode, Range, Cdatetime, Project))
          
OLISSpectraMeta <- OLISSpectraMeta %>%
group_by(ID) %>%
  arrange(SpectraDate) %>%
  mutate(E_days = as.numeric((SpectraDate - ExpDate[1]))) %>%
ungroup()

OLISSpectraMeta <- OLISSpectraMeta %>%
  filter(nm >= 400 & nm <= 700)

```

Normalization at 440 
```{r}

Absorbance440 <- OLISSpectraMeta %>% 
  filter(nm == 700) %>%
  mutate(Abs440 = Absorbance) %>%
  select(ID, Strain, Abs440, Par_ue, Photoperiod, E_days, SpectraHour, Replica)
  
OLISSpectraMeta440 <- OLISSpectraMeta %>%
  left_join(., Absorbance440) %>%
  mutate(AbsNorm440 = Absorbance / Abs440) %>% 
  
ungroup()

```


```{r}
saveRDS(OLISSpectraMeta440, file.path(DataOut, paste(Project, "OLISSpectraDailyPeak.Rds", sep = "_"), fsep = .Platform$file.sep))

```





Whole-cell spectra raw - without dillution
```{r set project variables}
Project <- "PicoBaltic"
DataOut <- file.path("..", "ImportedData", "OLIS")
DataIn <- file.path("..", "OLISSpectraCorr", "RawSpectraSingle", fsep = .Platform$file.sep)
FileID <- "JavCorr"
FileEncode <- "UTF-8" 
Delimiter <- ""
HeaderRows <- 0
```


```{r list available OLIS Files}
OlisFiles <- list.files(path = DataIn, pattern = FileID, full.names = TRUE)
OlisFiles
unique(duplicated(OlisFiles))
```


# set up read_delim_plus
```{r}

read.delim_plus <- function(flnm, filencode, delimiter, headerrows){read.delim(flnm, fileEncoding = filencode, sep = delimiter,  skip = headerrows, header = TRUE, row.names = NULL) %>%
     mutate(Filename = flnm, Cdatetime = ymd_hms(file.info(flnm)$ctime))
}

#read.delim_long meant for map over a vector of filepaths to read, convert to long format and tidy the imported data
read.delim_long <- function(flnm, filencode, delimiter, headerrows){read.delim(flnm, fileEncoding = filencode, sep = delimiter,  skip = headerrows, header = TRUE, row.names = NULL) %>%
    mutate(Filename = flnm, Cdatetime = ymd_hms(file.info(flnm)$ctime)) %>%
 rename(nm = OLIS.3D.ASCII) %>%
  mutate(FirstLastSpec = str_extract(Filename, "_[A-Z][a-z][A-Z][a-z][:digit:][:digit:][:digit:][:digit:]_[A-Z][a-z][A-Z][a-z][:digit:][:digit:][:digit:][:digit:]_")) %>%
  mutate(SampleNumbers = str_extract_all(FirstLastSpec, "[:digit:][:digit:][:digit:][:digit:]")) %>%
  mutate(FirstSampleNumber = as.numeric(map(SampleNumbers, ~.[[1]]))) %>%
  mutate(LastSampleNumber = as.numeric(map(SampleNumbers, ~.[[2]]))) %>%
  mutate(OperatorID = str_extract(Filename,"[A-Z][a-z][A-Z][a-z]")) %>%
  pivot_longer(cols = starts_with("X"), names_to = "SpectraID", values_to = "Abs") %>%
  mutate(SampleCode = as.numeric(str_remove(SpectraID, "X"))) %>%
  mutate(SampleNumber = SampleCode - min(SampleCode, na.rm = TRUE) + FirstSampleNumber) %>%
  relocate(OperatorID, SampleNumber) %>%
  unite(col = SampleID, OperatorID:SampleNumber, sep = "", remove = FALSE) %>%
  arrange(SampleID, nm) %>%
  relocate(SampleID, nm, Abs) %>%
  mutate(SpectraDate = str_extract(Filename, "/[:digit:][:digit:][:digit:][:digit:][:digit:][:digit:][:digit:][:digit:]_"),
         SpectraDate = str_remove_all(SpectraDate, "_"),
         SpectraDate = str_remove_all(SpectraDate, "/"),
         SpectraDate = ymd(SpectraDate)
  )
}
```


# Import OLISSpectra corrected files
```{r import from specific OLIS corrected file containing multiple spectra}

TargetFile <-  OlisFiles
TargetSpectra <- TargetFile %>% map_df(~read.delim_plus(flnm = ., filencode = FileEncode, delimiter = Delimiter, headerrows = HeaderRows)) %>% 
  pivot_longer(., -c(`OLIS.3D.ASCII`, Filename, Cdatetime), values_to = "Absorbance", names_to = "SampleID") %>%
  filter(!is.na(Absorbance)) %>%
  mutate(nm = `OLIS.3D.ASCII`) %>% 
  select(-c(`OLIS.3D.ASCII`))   
  #separate(col = SampleID, into = c("SampleID", "Replicate"), sep = "_")
TargetSpectraLong <- TargetSpectra %>%
  # rename(nm = OLIS.3D.ASCII) %>%
  separate(col = Filename, into = c("fp1", "fp2", "fp3", "SpectraDate", "Project", "Source", "Range", "Type", "Correction", "Replica"), sep = "([\\/\\_\\:])", remove = FALSE) 

TargetSpectraLong <- TargetSpectraLong %>%
  select(-c(fp1, fp2, fp3, Type, Correction, SampleID, Replica)) %>% 
  mutate(CultureID = Source) %>% 
  select(-c(Source)) %>% 
  mutate(SpectraDate = ymd(`SpectraDate`)) 

#rm(TargetSpectraLong2)
```



Filter multiculti catalog for SySl Daily Peak paper
```{r}
# colnames(MetaData)
# MetaData <- MetaData %>%
# summarize(Run, ID, Strain, InnocDate, ExpDate, Par_ue, Photoperiod, Tube, O2, WL, LightShape) %>% 
#   filter(Strain == "BA127R" | Strain == "BA77G" | Strain == "BA48R" | Strain == "BA56G") %>%
#   filter(WL == "WW") %>%
#   filter(Par_ue != 600) %>% 
#   filter(Run == "39" | Run == "40" | Run == "43" | Run == "44" |Run == "45" | Run == "46" | Run == "60" | Run == "62" | Run == "65" | Run == "71" | Run == "74" | Run == "77" | Run == "117") 
#   
#   MetaData1 <- MetaData %>%
#   filter(Photoperiod != "24") %>% 
#   mutate(PARPhotonDose =(Par_ue/2)*Photoperiod*3600)
#   
#   MetaData2 <- MetaData %>%
#   filter(Photoperiod == "24") %>% 
#   mutate(PARPhotonDose = Par_ue*Photoperiod*3600) 
#   
#   MetaData <-rbind(MetaData1, MetaData2)
#   rm(MetaData1,MetaData2)

```


# Merge OLISSpectra with MetaData
```{r OLISDateSpectra with MetaData}

OLISSpectraMeta <- MetaData %>%
  left_join(., TargetSpectraLong, by = c("ID" = "CultureID")) 

# OLISSpectraMeta <- OLISSpectraMeta %>%
#   rename("FilenameOlis" = "Filename") %>% 
#   select(-c(PrimaryOperator, doi, ProjectID, Inoc_mL, Media_mL, InnocDate, Tube, Plate, Well, Salinity,  N2, Ar, CO2, Media, MediaDate, SourceSalinity, OptodeCh, InocpH, FinalpH, Par_ueAdjusted, DateOfAdjustment, ElaspedHoursAtAdjustment, ...44, ...45, Description, Motivation, MC, EndDate,  ExpCul, ExpStartTime, Source, Optode, Range, Cdatetime, Project))
          
OLISSpectraMeta <- OLISSpectraMeta %>%
group_by(ID) %>%
  arrange(SpectraDate) %>%
  mutate(E_days = as.numeric((SpectraDate - ExpDate[1]))) %>%
ungroup()

OLISSpectraMeta <- OLISSpectraMeta %>%
  filter(nm >= 400 & nm <= 700)

```

Normalization at 440 
```{r}

Absorbance440 <- OLISSpectraMeta %>% 
  filter(nm == 700) %>%
  mutate(Abs440 = Absorbance) %>%
  select(ID, Strain, Abs440, Par_ue, Photoperiod, E_days)
  
OLISSpectraMeta440 <- OLISSpectraMeta %>%
  left_join(., Absorbance440) %>%
  mutate(AbsNorm440 = Absorbance / Abs440) %>% 
  
ungroup()

```


```{r}
saveRDS(OLISSpectraMeta440, file.path(DataOut, paste(Project, "OLISSpectraRaw.Rds", sep = "_"), fsep = .Platform$file.sep))

```




SySl FS experiment - in flask, stationary phase and recovery with new media and new conditions
```{r set project variables}
Project <- "PicoBaltic"
DataOut <- file.path("..", "ImportedData", "OLIS")
DataIn <- file.path("..", "OLISSpectraCorr", "FSSingle", fsep = .Platform$file.sep)
FileID <- "JavCorr"
FileEncode <- "UTF-8" 
Delimiter <- ""
HeaderRows <- 0
```


```{r list available OLIS Files}
OlisFiles <- list.files(path = DataIn, pattern = FileID, full.names = TRUE)
OlisFiles
unique(duplicated(OlisFiles))
```


# set up read_delim_plus
```{r}

read.delim_plus <- function(flnm, filencode, delimiter, headerrows){read.delim(flnm, fileEncoding = filencode, sep = delimiter,  skip = headerrows, header = TRUE, row.names = NULL) %>%
     mutate(Filename = flnm, Cdatetime = ymd_hms(file.info(flnm)$ctime))
}

#read.delim_long meant for map over a vector of filepaths to read, convert to long format and tidy the imported data
read.delim_long <- function(flnm, filencode, delimiter, headerrows){read.delim(flnm, fileEncoding = filencode, sep = delimiter,  skip = headerrows, header = TRUE, row.names = NULL) %>%
    mutate(Filename = flnm, Cdatetime = ymd_hms(file.info(flnm)$ctime)) %>%
 rename(nm = OLIS.3D.ASCII) %>%
  mutate(FirstLastSpec = str_extract(Filename, "_[A-Z][a-z][A-Z][a-z][:digit:][:digit:][:digit:][:digit:]_[A-Z][a-z][A-Z][a-z][:digit:][:digit:][:digit:][:digit:]_")) %>%
  mutate(SampleNumbers = str_extract_all(FirstLastSpec, "[:digit:][:digit:][:digit:][:digit:]")) %>%
  mutate(FirstSampleNumber = as.numeric(map(SampleNumbers, ~.[[1]]))) %>%
  mutate(LastSampleNumber = as.numeric(map(SampleNumbers, ~.[[2]]))) %>%
  mutate(OperatorID = str_extract(Filename,"[A-Z][a-z][A-Z][a-z]")) %>%
  pivot_longer(cols = starts_with("X"), names_to = "SpectraID", values_to = "Abs") %>%
  mutate(SampleCode = as.numeric(str_remove(SpectraID, "X"))) %>%
  mutate(SampleNumber = SampleCode - min(SampleCode, na.rm = TRUE) + FirstSampleNumber) %>%
  relocate(OperatorID, SampleNumber) %>%
  unite(col = SampleID, OperatorID:SampleNumber, sep = "", remove = FALSE) %>%
  arrange(SampleID, nm) %>%
  relocate(SampleID, nm, Abs) %>%
  mutate(SpectraDate = str_extract(Filename, "/[:digit:][:digit:][:digit:][:digit:][:digit:][:digit:][:digit:][:digit:]_"),
         SpectraDate = str_remove_all(SpectraDate, "_"),
         SpectraDate = str_remove_all(SpectraDate, "/"),
         SpectraDate = ymd(SpectraDate)
  )
}
```


# Import OLISSpectra corrected files
```{r import from specific OLIS corrected file containing multiple spectra}

TargetFile <-  OlisFiles
TargetSpectra <- TargetFile %>% map_df(~read.delim_plus(flnm = ., filencode = FileEncode, delimiter = Delimiter, headerrows = HeaderRows)) %>% 
  pivot_longer(., -c(`OLIS.3D.ASCII`, Filename, Cdatetime), values_to = "Absorbance", names_to = "SampleID") %>%
  filter(!is.na(Absorbance)) %>%
  mutate(nm = `OLIS.3D.ASCII`) %>% 
  select(-c(`OLIS.3D.ASCII`))   
  #separate(col = SampleID, into = c("SampleID", "Replicate"), sep = "_")
TargetSpectraLong <- TargetSpectra %>%
  # rename(nm = OLIS.3D.ASCII) %>%
  separate(col = Filename, into = c("fp1", "fp2", "fp3", "SpectraDate", "Project", "Source", "Range", "Type", "Correction", "Replica"), sep = "([\\/\\_\\:])", remove = FALSE) 

TargetSpectraLong <- TargetSpectraLong %>%
  select(-c(fp1, fp2, fp3, Type, Correction, SampleID, Replica)) %>% 
  mutate(CultureID = Source) %>% 
  select(-c(Source)) %>% 
  mutate(SpectraDate = ymd(`SpectraDate`)) 

#rm(TargetSpectraLong2)
```



Filter multiculti catalog for SySl Daily Peak paper
```{r}
# colnames(MetaData)
# MetaData <- MetaData %>%
# summarize(Run, ID, Strain, InnocDate, ExpDate, Par_ue, Photoperiod, Tube, O2, WL, LightShape) %>% 
#   filter(Strain == "BA127R" | Strain == "BA77G" | Strain == "BA48R" | Strain == "BA56G") %>%
#   filter(WL == "WW") %>%
#   filter(Par_ue != 600) %>% 
#   filter(Run == "39" | Run == "40" | Run == "43" | Run == "44" |Run == "45" | Run == "46" | Run == "60" | Run == "62" | Run == "65" | Run == "71" | Run == "74" | Run == "77" | Run == "117") 
#   
#   MetaData1 <- MetaData %>%
#   filter(Photoperiod != "24") %>% 
#   mutate(PARPhotonDose =(Par_ue/2)*Photoperiod*3600)
#   
#   MetaData2 <- MetaData %>%
#   filter(Photoperiod == "24") %>% 
#   mutate(PARPhotonDose = Par_ue*Photoperiod*3600) 
#   
#   MetaData <-rbind(MetaData1, MetaData2)
#   rm(MetaData1,MetaData2)

```


# Merge OLISSpectra with MetaData
```{r OLISDateSpectra with MetaData}

# OLISSpectraMeta <- MetaData %>%
#   left_join(., TargetSpectraLong, by = c("ID" = "CultureID")) 
# 
# OLISSpectraMeta <- OLISSpectraMeta %>%
# group_by(ID) %>%
#   arrange(SpectraDate) %>%
#   mutate(E_days = as.numeric((SpectraDate - ExpDate[1]))) %>%
# ungroup()
# 
OLISSpectraMeta <- TargetSpectraLong %>%
  filter(nm >= 400 & nm <= 700)

```

Normalization at 440 
```{r}

# Absorbance440 <- OLISSpectraMeta %>% 
#   filter(nm == 700) %>%
#   mutate(Abs440 = Absorbance) %>%
#   select(ID, Strain, Abs440, Par_ue, Photoperiod, E_days)
#   
# OLISSpectraMeta440 <- OLISSpectraMeta %>%
#   left_join(., Absorbance440) %>%
#   mutate(AbsNorm440 = Absorbance / Abs440) %>% 
#   
# ungroup()

```


```{r}
saveRDS(OLISSpectraMeta, file.path(DataOut, paste(Project, "OLISSpectraFS.Rds", sep = "_"), fsep = .Platform$file.sep))

```



