---
title: "Process_SolisensePigmentsData"
author:
- Sylwia Sliwinska-Wilczewska
- Douglas A. Campbell
date: "`r format(Sys.Date())`"
output:
bookdown::html_document2:
    code_folding: show
    keep_md: yes
    toc: TRUE
    toc_float: TRUE
    toc_depth: 6
    fig_caption: yes
bibliography: BalticPhotoperiod.bib
csl: plos-one.csl
editor_options: 
  markdown: 
    wrap: 72
---

# Set Chunk Options

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
knitr::opts_chunk$set(fig.path='Figs/')
```

# Introduction

This RMD process Solisense and pigments rds.

# Load Libraries and set Project Variables

```{r load libraries, warning = FALSE, echo=FALSE} 
library(tidyverse)
library(lubridate)
library(stringr)
library(broom)
library(knitr)
library(OneR)
library(zoo)
library(ggpubr)
library(caret)
library(reshape2)
library(gcookbook)
library(scales)
library(Cairo) #for greek symbols
library(googledrive)
library(googlesheets4)
library(readxl)
```

```{r set project variables}
Project <- "Baltic_Photoperiod"
DataOut <- file.path("..", "Data", "ProcessedData", "ProcessedSolisenseData")
DataIn <- file.path("..", "Data", "ImportedData", "ImportedSolisenseData", fsep = .Platform$file.sep)

PlotsPath <- file.path("..", "Output", "Plots")
RDSPlotPath <- file.path("..", "Output", "PlotsRDS")
```

# List and read Imported_Solisense RDS

```{r Exported Rmd}
list.files(path = DataIn, pattern = Project, full.names = TRUE)
```

# This RDS contained only data from corresponding growth light 
# Also, conteined mean sig - mean for replica measured on the same day

```{r read ProcessFile}
SolisenseFile <- "../Data/ImportedData/ImportedSolisenseData/Baltic_Photoperiod_Imported_SolisenseLight.Rds"  

SolisenseFileName <- str_split(string = SolisenseFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")

SolFits <- readRDS(SolisenseFile)  %>%
  ungroup()
```

# This RDS contained only sigma in 1s of dark after corresponding light (it caused problems when I tried to combain them with sig in the light)
# Also, conteined mean for sig1s - mean for replica measured on the same day

```{r read ProcessFile}
Solisense1sFile <- "../Data/ImportedData/ImportedSolisenseData/Baltic_Photoperiod_Imported_SolisenseDarkafterLight.Rds"

Solisense1sFileName <- str_split(string = Solisense1sFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")

SolFits1s <- readRDS(Solisense1sFile)  %>%
  ungroup()
```


```{r Preparing df for further analysis}
SolFits <-SolFits %>% 
  select(c(SampleID, Run, Strain, ExpDate, Par_ue, Photoperiod, MC, Tube, O2, WL, LightShape, ExpEndDate, PARPhotonDose_day, Filename, ObsDate, ObsTime, Ex_WL, ActPAR, LR_s, nm445, nm590, nm445Corr, nm590Corr, ActPARCorr, Sig, Sig_nm2psii, Sigdark, Sigdark_nm2psii, ActPARCorr_photonsm2s, FoOxbo, qpOxbo,  JVPSII_aLHIIOxbomax, JVPSII_ETRtauav_FoSig, JVPSII_ETRqpOxbo_FoSig, JVPSII_ETRtauav_aLHII_Sig, JVPSII_ETRqpOxbo_aLHII_Sig, E_days, Time_h)) %>% 
  filter(Strain=="BA127R"| Strain=="BA48R"| Strain=="BA56G"| Strain=="BA77G") %>% 
  filter(WL=="WW") %>% 
  filter(O2==21) %>% 
  mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077")) 
SolFits$facetsPhotonDose_day = factor(SolFits$WL, labels = c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"))
SolFits$facetsExcitation = factor(SolFits$WL, labels = c("Excitation~(nm)"))
SolFits$facetsStrain = factor(SolFits$WL, labels = c("Strain"))


SolFits1s <-SolFits1s %>% 
  select(c(SampleID, Run, Strain, ExpDate, Par_ue, Photoperiod, MC, Tube, O2, WL, LightShape, ExpEndDate, PARPhotonDose_day, Filename, ObsDate, ObsTime, Ex_WL, ActPAR, LR_s, nm445, nm590, nm445Corr, nm590Corr, ActPARCorr, Sig1s, Sig1s_nm2psii, ActPARCorr_photonsm2s, E_days, Time_h)) %>% 
  filter(Strain=="BA127R"| Strain=="BA48R"| Strain=="BA56G"| Strain=="BA77G") %>% 
  filter(WL=="WW") %>% 
  filter(O2==21) %>% 
  mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077")) 
SolFits1s$facetsPhotonDose_day = factor(SolFits1s$WL, labels = c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"))
SolFits1s$facetsExcitation = factor(SolFits1s$WL, labels = c("Excitation~(nm)"))
SolFits1s$facetsStrain = factor(SolFits1s$WL, labels = c("Strain"))
```

# Filter unrevelant data and outliers

```{r filter outliers}
# #Filter one unrevelant data point at 445nm, 16h, 900uE
SolFitsAll445<-SolFits %>%
  filter(Ex_WL == 445) %>%
  filter(Sig<250) 
SolFitsAll590<-SolFits %>%
  filter(Ex_WL == 590)
SolFits<-rbind(SolFitsAll445,SolFitsAll590)
  rm(SolFitsAll445,SolFitsAll590)
  
SolFitsAll4451s<-SolFits1s %>%
  filter(Ex_WL == 445) %>%
  filter(Sig1s<250) 
SolFitsAll5901s<-SolFits1s %>%
  filter(Ex_WL == 590)
SolFits1s<-rbind(SolFitsAll4451s,SolFitsAll5901s)
  rm(SolFitsAll4451s,SolFitsAll5901s)  
```

# Create preliminary plots 

```{r preliminary plot}
SolFits %>%
  ggplot() +
  geom_point(aes(x = Par_ue, y = Sig, colour = as.factor(Strain)), size = 3.5, show.legend = T) +
  facet_grid(rows = vars(Ex_WL), cols = vars(Photoperiod)) +
  theme_bw()
```

!!!!dodac, skad wzielam te wartosci!!! based on tmaxAG

# Choose only exp data for sigma and JVPSII in the corresponding light

```{r choose only exp data}
O1 <- SolFits %>%
  filter(Par_ue == 30 | Par_ue == 300 | Par_ue == 90 | Par_ue == 180 | Par_ue == 900) %>% 
  filter(Photoperiod == 24) %>% 
  filter(E_days <= 4)

O2 <- SolFits %>%
  filter(Par_ue == 90 | Par_ue == 180 | Par_ue == 300) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days < 9)

O3 <- SolFits %>%
  filter(Par_ue == 900) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days <= 4)

O4 <- SolFits %>%
  filter(Par_ue == 30) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days <= 14)

O5 <- SolFits %>%
  filter(Par_ue == 30) %>% 
  filter(Photoperiod == 8 | Photoperiod == 12) %>% 
  filter(E_days <=14)
  
O6 <- SolFits %>%
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 8) %>% 
  filter(E_days <=14)

O7 <- SolFits %>%
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 12) %>% 
  filter(E_days <=10)

O8 <- SolFits %>%
  filter(Par_ue == 180 | Par_ue == 300) %>% 
  filter(Photoperiod == 8 | Photoperiod == 12) %>% 
  filter(E_days <=10)

O9 <- SolFits %>%
  filter(Par_ue == 900) %>% 
  filter(Photoperiod == 8 | Photoperiod == 12) %>% 
  filter(E_days <=7)

SolFitsExp <-rbind(O1, O2, O3, O4, O5, O6, O7, O8, O9)

rm(O1, O2, O3, O4, O5, O6, O7, O8, O9)
```

# Choose only exp data for sigma at 1s after corresponding light

```{r choose only exp data for Sig 1s}
O1 <- SolFits1s %>%
  filter(Par_ue == 30 | Par_ue == 300 | Par_ue == 90 | Par_ue == 180 | Par_ue == 900) %>% 
  filter(Photoperiod == 24) %>% 
  filter(E_days <= 4)

O2 <- SolFits1s %>%
  filter(Par_ue == 90 | Par_ue == 180 | Par_ue == 300) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days < 9)

O3 <- SolFits1s %>%
  filter(Par_ue == 900) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days <= 4)

O4 <- SolFits1s %>%
  filter(Par_ue == 30) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days <= 14)

O5 <- SolFits1s %>%
  filter(Par_ue == 30) %>% 
  filter(Photoperiod == 8 | Photoperiod == 12) %>% 
  filter(E_days <=14)
  
O6 <- SolFits1s %>%
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 8) %>% 
  filter(E_days <=14)

O7 <- SolFits1s %>%
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 12) %>% 
  filter(E_days <=10)

O8 <- SolFits1s %>%
  filter(Par_ue == 180 | Par_ue == 300) %>% 
  filter(Photoperiod == 8 | Photoperiod == 12) %>% 
  filter(E_days <=10)

O9 <- SolFits1s %>%
  filter(Par_ue == 900) %>% 
  filter(Photoperiod == 8 | Photoperiod == 12) %>% 
  filter(E_days <=7)

SolFitsExp1s <-rbind(O1, O2, O3, O4, O5, O6, O7, O8, O9)

rm(O1, O2, O3, O4, O5, O6, O7, O8, O9)
```

# Create preliminary plot

```{r preliminary plot}
SolFits %>%
  ggplot() +
  geom_point(aes(x = Time_h, y = Sig, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
  # geom_vline(data = data_vline1, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  # geom_vline(data = data_vline2, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  # geom_vline(data = data_vline3, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  # geom_vline(data = data_vline4, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 

SolFitsExp %>%
  ggplot() +
  geom_point(aes(x = Time_h, y = Sig, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
  # geom_vline(data = data_vline1, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  # geom_vline(data = data_vline2, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  # geom_vline(data = data_vline3, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  # geom_vline(data = data_vline4, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 
```


# Calculate Sigma mean from 3 replica measured on the same day

```{r calculate Sigma mean from 3 replica measured on the same day}
SolFitsExpmeanDay <- SolFitsExp %>%
  group_by(SampleID, Ex_WL, ObsDate, Par_ue, Photoperiod, WL, O2) %>%
  
  summarize(SampleID, Ex_WL, Filename, Run, Strain, ExpDate, Par_ue, Photoperiod, O2, WL, PARPhotonDose_day, ObsDate, ObsTime, Sig, Sig_nm2psii, ActPARCorr_photonsm2s, Sigdark_nm2psii, FoOxbo, qpOxbo, JVPSII_aLHIIOxbomax, JVPSII_ETRtauav_FoSig, JVPSII_ETRqpOxbo_FoSig, JVPSII_ETRtauav_aLHII_Sig, JVPSII_ETRqpOxbo_aLHII_Sig, facetsPhotonDose_day, facetsExcitation, facetsStrain,
            meanSig_nm2psii = mean(Sig_nm2psii),
            sdSig_nm2psii = sd(Sig_nm2psii),
            meanSigdark_nm2psii = mean(Sigdark_nm2psii),
            sdSigdark_nm2psii = sd(Sigdark_nm2psii)) %>%
  ungroup()

SolFitsExpmeanDay<- SolFitsExpmeanDay %>%
group_by(SampleID) %>%
  arrange(ObsDate) %>%
  mutate(E_days = as.numeric((ObsDate - ExpDate[1]))) %>%
ungroup()

SolFitsExpmeanDay<- SolFitsExpmeanDay %>%
  mutate(Time_h = E_days*24)
```

# Calculate Sigma1s mean from 3 replica measured on the same day

```{r calculate Sigma1s mean from 3 replica measured on the same day}
SolFitsExpmeanDay1s <- SolFitsExp1s %>%
  group_by(SampleID, Ex_WL, ObsDate, Par_ue, Photoperiod, WL, O2) %>%
  
  summarize(SampleID, Ex_WL, Filename, Run, Strain, ExpDate, Par_ue, Photoperiod, O2, WL, PARPhotonDose_day, ObsDate, ObsTime, Sig1s, Sig1s_nm2psii, ActPARCorr_photonsm2s, facetsPhotonDose_day, facetsExcitation, facetsStrain,
            meanSig1s_nm2psii = mean(Sig1s_nm2psii),
            sdSig1s_nm2psii = sd(Sig1s_nm2psii)) %>%
  ungroup()

SolFitsExpmeanDay1s<- SolFitsExpmeanDay1s %>%
group_by(SampleID) %>%
  arrange(ObsDate) %>%
  mutate(E_days = as.numeric((ObsDate - ExpDate[1]))) %>%
ungroup()

SolFitsExpmeanDay1s<- SolFitsExpmeanDay1s %>%
  mutate(Time_h = E_days*24)
```

Make "one big" mean to combine all days (only from exp) and all replica when samples were measured 
(This give me only one value of JVPSII for further growth vs JVPSII plot and nice sig plot as well)

I select only data from exp phase here


# Calculate Sigma mean from all data measured on exp phase 

```{r calculate Sigma mean from exp phase}

SolFitsExpmeanAll<-SolFitsExpmeanDay %>% 
  group_by(Strain, Ex_WL, Par_ue, Photoperiod, WL, O2) %>%
  
  summarize(SampleID, Ex_WL, Filename, Run, Strain, ExpDate, Par_ue, Photoperiod, O2, WL, PARPhotonDose_day, ObsDate, ObsTime, Sig, Sig_nm2psii, meanSig_nm2psii, sdSig_nm2psii, ActPARCorr_photonsm2s, Sigdark_nm2psii, meanSigdark_nm2psii, sdSigdark_nm2psii, FoOxbo, qpOxbo, JVPSII_aLHIIOxbomax, JVPSII_ETRtauav_FoSig, JVPSII_ETRqpOxbo_FoSig, JVPSII_ETRtauav_aLHII_Sig, JVPSII_ETRqpOxbo_aLHII_Sig, facetsPhotonDose_day, facetsExcitation, facetsStrain,
              
            #  AllmeanJVPSII_aLHIIOxbomax= mean(JVPSII_aLHIIOxbomax),
            #  AllmeanJVPSII_ETRtauav_FoSig= mean(JVPSII_ETRtauav_FoSig),
            #  AllmeanJVPSII_ETRqpOxbo_FoSig= mean(JVPSII_ETRqpOxbo_FoSig),
            # AllmeanJVPSII_ETRtauav_aLHII_Sig = mean(JVPSII_ETRtauav_aLHII_Sig),
            #  AllmeanJVPSII_ETRqpOxbo_aLHII_Sig= mean(JVPSII_ETRqpOxbo_aLHII_Sig),
            AllmeanSig_nm2psii = mean(Sig_nm2psii),
            AllsdSig_nm2psii = sd(Sig_nm2psii),
            AllmeanSigdark_nm2psii = mean(Sigdark_nm2psii),
            AllsdSigdark_nm2psii = sd(Sigdark_nm2psii)) %>%
  ungroup()

SolFitsExpmeanAll<- SolFitsExpmeanAll %>%
group_by(SampleID) %>%
  arrange(ObsDate) %>%
  mutate(E_days = as.numeric((ObsDate - ExpDate[1]))) %>%
ungroup()

SolFitsExpmeanAll<- SolFitsExpmeanAll %>%
  mutate(Time_h = E_days*24)
```

# Removed unnessesary df from the environment

```{r}
rm(SolFits, SolFits1s, SolFitsExp, SolFitsExp1s, SolFitsExpmeanDay)
```

# Filter otliers to calculate exponential decay function

```{r filter outliers (4 data points)}
Sol1<-SolFitsExpmeanAll %>% 
  filter(Ex_WL==590) %>% 
  filter(Par_ue !=900) %>% 
  filter(Strain=="PE-rich_048") 
Sol2<-SolFitsExpmeanAll %>% 
  filter(Ex_WL==590) %>% 
  filter(Par_ue !=900) %>% 
  filter(Strain=="PC-rich_077") 
Sol3<-SolFitsExpmeanAll %>% 
  filter(Ex_WL==590) %>% 
  filter(Par_ue !=900) %>% 
  filter(Strain=="PC-rich_056") %>% 
  filter(Sig>200)
Sol4<-SolFitsExpmeanAll %>%
  filter(Ex_WL==590) %>%
  filter(Par_ue !=900) %>% 
  filter(Strain=="PE-rich_127") %>%
  filter(Sig>310) 
Sol5<-SolFitsExpmeanAll %>% 
  filter(Ex_WL==590) %>% 
  filter(Par_ue ==900) %>% 
  filter(Sig<600)
Sol6<-SolFitsExpmeanAll %>% 
  filter(Ex_WL==445) 

SolFitsExpFit590<-rbind(Sol1, Sol2, Sol3, Sol4, Sol5)
SolFitsExpFitAll<-rbind(Sol1, Sol2, Sol3, Sol4, Sol5, Sol6)

rm(Sol1, Sol2, Sol3, Sol4, Sol5, Sol6)
```

# Create plot to check data before and after filtering outliers

```{r checking data before and after filtering outliers}
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))

SolFitsExpmeanAll %>% 
  ggplot() +
  geom_point(aes(x = PARPhotonDose_day, y = meanSig_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  geom_errorbar(aes(x = PARPhotonDose_day, ymin = meanSig_nm2psii - sdSig_nm2psii, ymax = meanSig_nm2psii + sdSig_nm2psii, colour=as.factor(Par_ue))) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  # labs(y=expression(paste(sigma,""["PSII"]*"'(nm"^"2"*")")), x = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  ggh4x::facet_nested(cols = vars(facetsExcitation,Ex_WL), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  theme_bw() 


SolFitsExpFitAll %>% 
  ggplot() +
  geom_point(aes(x = PARPhotonDose_day, y = meanSig_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  geom_errorbar(aes(x = PARPhotonDose_day, ymin = meanSig_nm2psii - sdSig_nm2psii, ymax = meanSig_nm2psii + sdSig_nm2psii, colour=as.factor(Par_ue))) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  # labs(y=expression(paste(sigma,""["PSII"]*"'(nm"^"2"*")")), x = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  ggh4x::facet_nested(cols = vars(facetsExcitation,Ex_WL), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  theme_bw() 
```

# Fit the data to exponential decays

```{r fit the data to exponential decays, echo=FALSE, warning = FALSE}

SolFitsExpFit590Clean <-SolFitsExpFit590 %>% 
  drop_na(Sig_nm2psii) %>%
  select(c(Sig_nm2psii, PARPhotonDose_day, Strain)) 

# Fit the data
fitted <- SolFitsExpFit590Clean %>% 
  nest(-Strain) %>%
  mutate(
    fit = map(data, ~nls(Sig_nm2psii ~ SSasymp(PARPhotonDose_day, yf, y0, log_alpha), data = .)),
    tidied = map(fit, tidy),
    augmented = map(fit, augment),
  )  

# Produce a table of fit parameters: y0, yf, alpha
fitted_Param<-fitted %>% 
  unnest(tidied) %>% 
  select(Strain, term, estimate) %>% 
pivot_wider(., names_from = c(term), values_from = c(estimate)) %>% 
  mutate(alpha = exp(log_alpha))
```

```{r unnest, preparing df to preparing final plot, echo=FALSE, warning = FALSE}
augmented<-fitted  %>%
  unnest(augmented) %>%
  select(c(Strain, PARPhotonDose_day,Sig_nm2psii, .fitted)) 

SolFitsExpmeanAll590Plot <- SolFitsExpFit590 %>%
  left_join(., augmented, by = c("Strain"="Strain", "PARPhotonDose_day"="PARPhotonDose_day", "Sig_nm2psii"="Sig_nm2psii"))

SolFitsExpmeanAll445 <-SolFitsExpFitAll %>%
  filter(Ex_WL == 445) %>%
  mutate(.fitted=0)

SolFitsExpmeanAllPlot<-rbind(SolFitsExpmeanAll590Plot, SolFitsExpmeanAll445)
```

# Create Sigma plot

```{r create Sigma plot, fig.height = 8, fig.width = 8, warning = FALSE}

data_text_y0<- data.frame(WL = c("WW", "WW"), Ex_WL = c(590), O2=c(21, 21, 21, 21), Strain  = c("PC-rich_056", "PC-rich_077", "PE-rich_048", "PE-rich_127"),  label = c('y0 = 7.2', 'y0 = 5.8', 'y0 = 8.5', 'y0 = 7.9'))
data_text_y0<-data_text_y0 %>% 
  mutate(Ex_WL=as.factor(Ex_WL))

data_text_yf<- data.frame(WL = c("WW", "WW"), Ex_WL = c(590), O2=c(21, 21, 21, 21), Strain  = c("PC-rich_056", "PC-rich_077", "PE-rich_048", "PE-rich_127"),  label = c('yf = 3.2', 'yf = 1.5', 'yf = 3.8', 'yf = 4.1'))
data_text_yf<-data_text_yf %>% 
  mutate(Ex_WL=as.factor(Ex_WL))

data_text_alpha<- data.frame(WL = c("WW", "WW"), Ex_WL = c(590), O2=c(21, 21, 21, 21), Strain  = c("PC-rich_056", "PC-rich_077", "PE-rich_048", "PE-rich_127"),  label = c('\u03B1 = 2.8', '\u03B1 = 2.6', '\u03B1 = 1.9', '\u03B1 = 3.6'))
data_text_alpha<-data_text_alpha %>% 
  mutate(Ex_WL=as.factor(Ex_WL))

WL.labs <- c("Excitation (nm)")
names(WL.labs) <- c("WW")
O2.labs <- c("Strain")
names(O2.labs) <- c(21)

scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))

ggplot(SolFitsExpFitAll, aes(x = PARPhotonDose_day, y = Sig_nm2psii)) +
  geom_point(aes(x = PARPhotonDose_day, y = AllmeanSig_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  geom_errorbar(aes(x = PARPhotonDose_day, ymin = AllmeanSig_nm2psii - AllsdSig_nm2psii, ymax = AllmeanSig_nm2psii + AllsdSig_nm2psii, colour=as.factor(Par_ue)), width=0, size=0.3, show.legend = F) +
  geom_line(aes(PARPhotonDose_day, .fitted), show.legend = F, SolFitsExpmeanAllPlot) +
  
  geom_text(data=data_text_y0, aes(x=80000000, y=8, label=label), size=3.5) +
  geom_text(data=data_text_yf, aes(x=80000000, y=7.1, label=label), size=3.5) +
  geom_text(data=data_text_alpha, aes(x=80000000, y=6.2, label=label), size=3.5) +
  
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  labs(y=expression(paste(sigma,""["PSII"]*"' (nm"^"2"*" quanta"^"-1"*")")), x = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  scale_x_continuous(breaks=seq(0, 60000000, by = 30000000), label=scientific_10) +
  scale_y_continuous(breaks=seq(0, 8, by = 2)) +
  coord_cartesian(xlim = c(0, 90000000)) +
  ggh4x::facet_nested(rows = vars(O2,Strain), cols = vars(WL,Ex_WL), labeller = labeller(WL = WL.labs, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=11),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.075,0.9),
        legend.key.height= unit(0.003, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        legend.spacing.x = unit(-0.1, 'cm'),
        legend.title = element_blank(),
        legend.text = element_text(size=9))
```

# Save RDS that create plot

```{r}
saveRDS(SolFitsExpFitAll, file.path(RDSPlotPath, paste(Project, "Plot_Sigma_1.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)

saveRDS(SolFitsExpmeanAllPlot, file.path(RDSPlotPath, paste(Project, "Plot_Sigma_2.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)

saveRDS(fitted_Param, file.path(RDSPlotPath, paste(Project, "Plot_Sigma_3.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)
```

# Save plot 

```{r save plot}
ggsave(file = file.path(PlotsPath, paste("Sigma_SupPlot",".png",sep = "")), height=10, width= 8,  dpi = 300, limitsize = TRUE)
```

# Removed unneccessary df from the environment

```{r}
rm(SolFitsExpmeanAll590Plot, SolFitsExpmeanAll445, fitted, augmented, SolFitsExpFit590Clean, SolFitsExpFit590, SolFitsExpFitAll, SolFitsExpmeanAllPlot, fitted_Param, data_text_alpha, data_text_y0, data_text_yf)
```

# Sig per phyco/chla ratio

Issue - not always pigment based on Olis correspond to Solisense data-> I combine these two df with only selected exp data

Later - come back to OD680data from Multiculti and choose cell/ml (based on pamas corr) corresponding with the same day of sigma and JVPSII!!! Before calculations! Fix this Sylwia!!!!!

```{r set project variables}
Project <- "Baltic_Photoperiod"
DataIn <- file.path("..", "Data", "ProcessedData", "ProcessedPigmentsData", fsep = .Platform$file.sep)
```

```{r Exported Rmd}
list.files(path = DataIn, pattern = Project, full.names = TRUE)
```

```{r read pigments File}
#df ontained mean OD per day from Multiculti and Abs from Olis spectra for selected nm. Based on this I calculated pigments per mL and per cell (pg/cell)

MCPigmentExpFile <- "../Data/ProcessedData/ProcessedPigmentsData/Baltic_Photoperiod_Processed_PigmentsExp.Rds"
MCPigmentExpFileName <- str_split(string = MCPigmentExpFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")
MCPigmentExp <- readRDS(MCPigmentExpFile)  %>%
  ungroup()
```

```{r Joining Solisense and pig exp data}
SolFitsPigmentExp <- SolFitsExpmeanAll %>% 
  left_join(., MCPigmentExp, by = c("Strain"="Strain","Par_ue"="Par_ue","Photoperiod"="Photoperiod")) 

SolFitsPigmentExp1s <- SolFitsExpmeanDay1s %>% 
  left_join(., MCPigmentExp, by = c("Strain"="Strain","Par_ue"="Par_ue","Photoperiod"="Photoperiod")) 

rm(SolFitsExpmeanAll, SolFitsExpmeanDay1s, MCPigmentExp)
```

# Create preliminary plots

```{r preliminary plots}
scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))

SolFitsPigmentExp %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = AllmeanSig_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  geom_errorbar(aes(x = PhycoChlaRatioExp, ymin = AllmeanSig_nm2psii - AllsdSig_nm2psii, ymax = AllmeanSig_nm2psii + AllsdSig_nm2psii, colour=as.factor(Par_ue))) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  ggh4x::facet_nested(cols = vars(facetsExcitation, Ex_WL), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  theme_bw()


SolFitsPigmentExp %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = AllmeanSig_nm2psii, colour = as.factor(Strain)), size = 3.5, show.legend = T) +
  geom_errorbar(aes(x = PhycoChlaRatioExp, ymin = AllmeanSig_nm2psii - AllsdSig_nm2psii, ymax = AllmeanSig_nm2psii + AllsdSig_nm2psii, colour=as.factor(Strain))) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  ggh4x::facet_nested(cols = vars(facetsExcitation, Ex_WL), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 


SolFitsPigmentExp %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = AllmeanSigdark_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  geom_errorbar(aes(x = PhycoChlaRatioExp, ymin = AllmeanSigdark_nm2psii - AllsdSigdark_nm2psii, ymax = AllmeanSigdark_nm2psii + AllsdSigdark_nm2psii, colour=as.factor(Par_ue))) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  ggh4x::facet_nested(cols = vars(facetsExcitation, Ex_WL), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  theme_bw() 


SolFitsPigmentExp %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = AllmeanSigdark_nm2psii, colour = as.factor(Strain)), size = 3.5, show.legend = T) +
  geom_errorbar(aes(x = PhycoChlaRatioExp, ymin = AllmeanSigdark_nm2psii - AllsdSigdark_nm2psii, ymax = AllmeanSigdark_nm2psii + AllsdSigdark_nm2psii, colour=as.factor(Strain))) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  ggh4x::facet_nested(cols = vars(facetsExcitation, Ex_WL), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 


SolFitsPigmentExp1s %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = Sig1s_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  # geom_errorbar(aes(x = PhycoChlaRatioExp, ymin = meanSig1s_nm2psii - sdSig1s_nm2psii, ymax = meanSig1s_nm2psii + sdSig1s_nm2psii, colour=as.factor(Par_ue))) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Strain), labeller = label_parsed) +
  theme_bw() 


SolFitsPigmentExp1s %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = Sig1s_nm2psii, colour = as.factor(Strain)), size = 3.5, show.legend = T) +
    # geom_errorbar(aes(x = PhycoChlaRatioExp, ymin = meanSig1s_nm2psii - sdSig1s_nm2psii, ymax = meanSig1s_nm2psii + sdSig1s_nm2psii, colour=as.factor(Strain))) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw()
```

# Combine PC and PE-rich strains together

```{r combine PC and PE-rich strains}
SolFitsAllPigmentPC<-SolFitsPigmentExp %>% 
  filter(Strain == "PC-rich_056" | Strain == "PC-rich_077") 
SolFitsAllPigmentPC$StrainGroup = "PC-rich"
SolFitsAllPigmentPE<-SolFitsPigmentExp %>% 
  filter(Strain == "PE-rich_048" | Strain == "PE-rich_127")  
SolFitsAllPigmentPE$StrainGroup = "PE-rich"

SolFitsAllPigmentPCPE<-rbind(SolFitsAllPigmentPC, SolFitsAllPigmentPE)
rm(SolFitsAllPigmentPC, SolFitsAllPigmentPE)


SolFitsAllPigmentPC1s<-SolFitsPigmentExp1s %>% 
  filter(Strain == "PC-rich_056" | Strain == "PC-rich_077") 
SolFitsAllPigmentPC1s$StrainGroup = "PC-rich"
SolFitsAllPigmentPE1s<-SolFitsPigmentExp1s %>% 
  filter(Strain == "PE-rich_048" | Strain == "PE-rich_127")  
SolFitsAllPigmentPE1s$StrainGroup = "PE-rich"
  
SolFitsAllPigmentPCPE1s<-rbind(SolFitsAllPigmentPC1s, SolFitsAllPigmentPE1s)
rm(SolFitsAllPigmentPC1s, SolFitsAllPigmentPE1s, SolFitsPigmentExp1s)
```

# Filtering data measured from log and very early exponential phase of growth

```{r filtering data from log phase}
SolFitsAllPigmentPCPE<-SolFitsAllPigmentPCPE %>%
  filter(E_days!=2) %>%
  filter(E_days!=3)

SolFitsAllPigmentPCPE1s<-SolFitsAllPigmentPCPE1s %>%
  filter(E_days!=2) %>%
  filter(E_days!=3)
```

# Linear fit per Ex_WL

```{r linear fit}
SolFitsAllPigmentfitPhycoChlalinearExWL <- SolFitsAllPigmentPCPE %>%   
  select(c(Strain, Par_ue, Photoperiod, Ex_WL, meanSig_nm2psii, PhycoChlaRatioExp, O2, WL)) %>%  
  nest(data = -c("Ex_WL")) %>%  
  mutate(Linear_Model = map(data, ~lm(meanSig_nm2psii ~ PhycoChlaRatioExp, data = .x))) %>%     
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance)))


SolFitsAllPigmentfitPhycoChlalineardarkExWL <- SolFitsAllPigmentPCPE %>%   
  select(c(Strain, Par_ue, Photoperiod, Ex_WL, meanSigdark_nm2psii, PhycoChlaRatioExp, O2, WL)) %>% 
  nest(data = -c("Ex_WL")) %>% 
  mutate(Linear_Model = map(data, ~lm(meanSigdark_nm2psii ~ PhycoChlaRatioExp, data = .x))) %>%     
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance)))


SolFitsAllPigmentfitPhycoChlalinearExWL1s <- SolFitsAllPigmentPCPE1s %>%  
  select(c(Strain, Par_ue, Photoperiod, Ex_WL, meanSig1s_nm2psii, PhycoChlaRatioExp, O2, WL)) %>% 
  nest(data = -c("Ex_WL")) %>% 
  mutate(Linear_Model = map(data, ~lm(meanSig1s_nm2psii ~ PhycoChlaRatioExp, data = .x))) %>%    
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance)))
```

# Creat preliminary plot

```{r preliminary plot, warning = FALSE}
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))

SolFitsAllPigmentfitPhycoChlalinearExWL %>% 
  unnest(Linear_Model_Predict) %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = meanSig_nm2psii, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE) + 
  # geom_errorbar(aes(x = PhycoChlaRatioExp, ymin = AllmeanSigdark_nm2psii - AllsdSigdark_nm2psii, ymax = AllmeanSigdark_nm2psii + AllsdSigdark_nm2psii, colour=as.factor(Par_ue))) +
  geom_line(aes(x = PhycoChlaRatioExp, y = `.fitted`), show.legend = F) +   
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  ggh4x::facet_nested(cols = vars(Ex_WL), labeller = label_parsed) +
  theme_bw() 


SolFitsAllPigmentfitPhycoChlalineardarkExWL %>% 
  unnest(Linear_Model_Predict) %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = meanSigdark_nm2psii, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE) + 
  geom_line(aes(x = PhycoChlaRatioExp, y = `.fitted`), show.legend = F) +  
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  ggh4x::facet_nested(cols = vars(Ex_WL), labeller = label_parsed) +
  theme_bw() 


SolFitsAllPigmentfitPhycoChlalinearExWL1s %>% 
  unnest(Linear_Model_Predict) %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = meanSig1s_nm2psii, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE1s) + 
  geom_line(aes(x = PhycoChlaRatioExp, y = `.fitted`), show.legend = F) +   
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  ggh4x::facet_nested(cols = vars(Ex_WL), labeller = label_parsed) +
  theme_bw() 
```

# Linear fit per par_ue

```{r linear fit}

SolFitsAllPigmentfitPhycoChlalinear <- SolFitsAllPigmentPCPE %>%   
  select(c(Strain, Par_ue, Photoperiod, Ex_WL, meanSig_nm2psii, PhycoChlaRatioExp, O2, WL)) %>%  
  nest(data = -c("Par_ue", "Ex_WL")) %>%   
  mutate(Linear_Model = map(data, ~lm(meanSig_nm2psii ~ PhycoChlaRatioExp, data = .x))) %>%     
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance)))


SolFitsAllPigmentfitPhycoChlalineardark <- SolFitsAllPigmentPCPE %>%   
  select(c(Strain, Par_ue, Photoperiod, Ex_WL, meanSigdark_nm2psii, PhycoChlaRatioExp, O2, WL)) %>%  
  nest(data = -c("Par_ue", "Ex_WL")) %>%   
  mutate(Linear_Model = map(data, ~lm(meanSigdark_nm2psii ~ PhycoChlaRatioExp, data = .x))) %>%     
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance)))


SolFitsAllPigmentfitPhycoChlalinear1s <- SolFitsAllPigmentPCPE1s %>%   
  select(c(Strain, Par_ue, Photoperiod, Ex_WL, meanSig1s_nm2psii, PhycoChlaRatioExp, O2, WL)) %>% 
  nest(data = -c("Par_ue", "Ex_WL")) %>%   
  mutate(Linear_Model = map(data, ~lm(meanSig1s_nm2psii ~ PhycoChlaRatioExp, data = .x))) %>%     
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance)))


SolFitsAllPigmentfitPhycoChlalinearPCPE1s <- SolFitsAllPigmentPCPE1s %>%   
  select(c(StrainGroup, Par_ue, Photoperiod, Ex_WL, meanSig1s_nm2psii, PhycoChlaRatioExp, O2, WL)) %>%  
  nest(data = -c("Par_ue", "Ex_WL", "StrainGroup")) %>%  
  mutate(Linear_Model = map(data, ~lm(meanSig1s_nm2psii ~ PhycoChlaRatioExp, data = .x))) %>%    
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance)))
```

# Create preliminary plot

```{r preliminary plot}

lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))

SolFitsAllPigmentfitPhycoChlalinear %>% 
  unnest(Linear_Model_Predict) %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = meanSig_nm2psii, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE) + 
  geom_errorbar(aes(x = PhycoChlaRatioExp, ymin = meanSig_nm2psii - sdSig_nm2psii, ymax = meanSig_nm2psii + sdSig_nm2psii, colour=as.factor(Strain)), SolFitsAllPigmentPCPE) +
  geom_line(aes(x = PhycoChlaRatioExp, y = `.fitted`), show.legend = F) +   
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #labs(y=expression(paste(sigma,""["PSII"]*"'(nm"^"2"*")")), x = "Total phycobilins/Chl" ~italic(a)~ "ratio") +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 


SolFitsAllPigmentfitPhycoChlalineardark %>% 
  unnest(Linear_Model_Predict) %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = meanSigdark_nm2psii, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE) + 
  geom_errorbar(aes(x = PhycoChlaRatioExp, ymin = meanSigdark_nm2psii - sdSigdark_nm2psii, ymax = meanSigdark_nm2psii + sdSigdark_nm2psii, colour=as.factor(Strain)), SolFitsAllPigmentPCPE) +
  geom_line(aes(x = PhycoChlaRatioExp, y = `.fitted`), show.legend = F) + 
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 


SolFitsAllPigmentfitPhycoChlalinear1s %>% 
  unnest(Linear_Model_Predict) %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = meanSig1s_nm2psii, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE1s) + 
  geom_errorbar(aes(x = PhycoChlaRatioExp, ymin = meanSig1s_nm2psii - sdSig1s_nm2psii, ymax = meanSig1s_nm2psii + sdSig1s_nm2psii, colour=as.factor(Strain)), SolFitsAllPigmentPCPE1s) +
  geom_line(aes(x = PhycoChlaRatioExp, y = `.fitted`), show.legend = F) + 
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw()
```

# Linear fit per Strain

```{r linear fit}
SolFitsAllPigmentfitPhycoChlalinearStrain <- SolFitsAllPigmentPCPE %>%  
  select(c(Strain, Par_ue, Photoperiod, Ex_WL, meanSig_nm2psii, PhycoChlaRatioExp, O2, WL, facetsExcitation, facetsStrain)) %>%  
  nest(data = -c("Strain", "Ex_WL")) %>%  
  mutate(Linear_Model = map(data, ~lm(meanSig_nm2psii ~ PhycoChlaRatioExp, data = .x))) %>%    
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance)))


SolFitsAllPigmentfitPhycoChlalineardarkStrain <- SolFitsAllPigmentPCPE %>%   
  select(c(Strain, Par_ue, Photoperiod, Ex_WL, meanSigdark_nm2psii, PhycoChlaRatioExp, O2, WL)) %>%  
  nest(data = -c("Strain", "Ex_WL")) %>% 
  mutate(Linear_Model = map(data, ~lm(meanSigdark_nm2psii ~ PhycoChlaRatioExp, data = .x))) %>%     
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance)))


SolFitsAllPigmentfitPhycoChlalinearStrain1s <- SolFitsAllPigmentPCPE1s %>%  
  select(c(Strain, Par_ue, Photoperiod, Ex_WL, meanSig1s_nm2psii, PhycoChlaRatioExp, O2, WL)) %>%  
  nest(data = -c("Strain", "Ex_WL")) %>% 
  mutate(Linear_Model = map(data, ~lm(meanSig1s_nm2psii ~ PhycoChlaRatioExp, data = .x))) %>%    
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance)))

#xxxxxx

SolFitsAllPigmentfitPhycoChlalinearStrainGroup <- SolFitsAllPigmentPCPE %>%   
  select(c(StrainGroup, Par_ue, Photoperiod, Ex_WL, meanSig_nm2psii, PhycoChlaRatioExp, O2, WL)) %>%  
  nest(data = -c("StrainGroup", "Ex_WL")) %>% 
  mutate(Linear_Model = map(data, ~lm(meanSig_nm2psii ~ PhycoChlaRatioExp, data = .x))) %>%     
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance)))


SolFitsAllPigmentfitPhycoChlalineardarkStrainGroup <- SolFitsAllPigmentPCPE %>%   
  select(c(StrainGroup, Par_ue, Photoperiod, Ex_WL, meanSigdark_nm2psii, PhycoChlaRatioExp, O2, WL)) %>%  
  nest(data = -c("StrainGroup", "Ex_WL")) %>% 
  mutate(Linear_Model = map(data, ~lm(meanSigdark_nm2psii ~ PhycoChlaRatioExp, data = .x))) %>%     
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance)))


SolFitsAllPigmentfitPhycoChlalinearStrainGroup1s <- SolFitsAllPigmentPCPE1s %>%   
  select(c(StrainGroup, Par_ue, Photoperiod, Ex_WL, meanSig1s_nm2psii, PhycoChlaRatioExp, O2, WL)) %>%  
  nest(data = -c("StrainGroup", "Ex_WL")) %>%  
  mutate(Linear_Model = map(data, ~lm(meanSig1s_nm2psii ~ PhycoChlaRatioExp, data = .x))) %>%     
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance)))
```

# Creat preliminary plot

```{r preliminary plot}
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))


SolFitsAllPigmentfitPhycoChlalinearStrain %>% 
  unnest(Linear_Model_Predict) %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = meanSig_nm2psii, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE) + 
  geom_errorbar(aes(x = PhycoChlaRatioExp, ymin = meanSig_nm2psii - sdSig_nm2psii, ymax = meanSig_nm2psii + sdSig_nm2psii, colour=as.factor(Strain)), SolFitsAllPigmentPCPE) +
  geom_line(aes(x = PhycoChlaRatioExp, y = `.fitted`), show.legend = F) +   
  # scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  # scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Strain), labeller = label_parsed) +
  theme_bw() 


SolFitsAllPigmentfitPhycoChlalineardarkStrain %>% 
  unnest(Linear_Model_Predict) %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = meanSigdark_nm2psii, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE) + 
  geom_errorbar(aes(x = PhycoChlaRatioExp, ymin = meanSigdark_nm2psii - sdSigdark_nm2psii, ymax = meanSigdark_nm2psii + sdSigdark_nm2psii, colour=as.factor(Strain)), SolFitsAllPigmentPCPE) +
  geom_line(aes(x = PhycoChlaRatioExp, y = `.fitted`), show.legend = F) + 
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Strain),labeller = label_parsed) +
  theme_bw() 
  
  
SolFitsAllPigmentfitPhycoChlalinearStrain1s %>% 
  unnest(Linear_Model_Predict) %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = meanSig1s_nm2psii, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE1s) + 
  geom_errorbar(aes(x = PhycoChlaRatioExp, ymin = meanSig1s_nm2psii - sdSig1s_nm2psii, ymax = meanSig1s_nm2psii + sdSig1s_nm2psii, colour=as.factor(Strain)), SolFitsAllPigmentPCPE1s) +
  geom_line(aes(x = PhycoChlaRatioExp, y = `.fitted`), show.legend = F) +   
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Strain), labeller = label_parsed) +
  theme_bw() 
  
  #xxxxxxxx
  
SolFitsAllPigmentfitPhycoChlalineardarkStrainGroup %>% 
  unnest(Linear_Model_Predict) %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = meanSigdark_nm2psii, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE) + 
  geom_errorbar(aes(x = PhycoChlaRatioExp, ymin = meanSigdark_nm2psii - sdSigdark_nm2psii, ymax = meanSigdark_nm2psii + sdSigdark_nm2psii, colour=as.factor(Strain)), SolFitsAllPigmentPCPE) +
  geom_line(aes(x = PhycoChlaRatioExp, y = `.fitted`), show.legend = F) + 
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(StrainGroup),labeller = label_parsed) +
  theme_bw() 
```

# Creating Sigma vs pigments ratio plot

```{r fig.height = 8, fig.width = 8, warning = FALSE}
WL.labs <- c("Excitation (nm)")
names(WL.labs) <- c("WW")
O2.labs <- c("Strain")
names(O2.labs) <- c(21)

scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))

SolFitsAllPigmentfitPhycoChlalinearStrain %>% 
  unnest(Linear_Model_Predict, data) %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = AllmeanSig_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE) + 
  geom_errorbar(aes(x = PhycoChlaRatioExp, ymin = AllmeanSig_nm2psii - AllsdSig_nm2psii, ymax = AllmeanSig_nm2psii + AllsdSig_nm2psii, colour = as.factor(Par_ue)), show.legend = F, width=0, size=0.3, SolFitsAllPigmentPCPE) +
  geom_line(aes(x = PhycoChlaRatioExp, y = `.fitted`), show.legend = F) +   
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  scale_y_continuous(breaks=seq(0, 8, by = 2)) +
  coord_cartesian(ylim = c(0, 9)) +
  labs(y=expression(paste(sigma,""["PSII"]*"' (nm"^"2"*" quanta"^"-1"*")")), x = "Total phyco/Chl" ~italic(a)~ "ratio") +
  ggh4x::facet_nested(cols = vars(WL,Ex_WL), rows = vars(O2, Strain), labeller = labeller(WL = WL.labs, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="white"),
        legend.position = c(0.92,0.88),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        legend.title = element_blank(),
        legend.text = element_text(size=10))
```

# Save RDS that create plot

```{r}
saveRDS(SolFitsAllPigmentfitPhycoChlalinearStrain, file.path(RDSPlotPath, paste(Project, "Plot_SigmavsPigments_1.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)

saveRDS(SolFitsAllPigmentPCPE, file.path(RDSPlotPath, paste(Project, "Plot_SigmavsPigments_2.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)
```

# Save plot 

```{r save plot}
ggsave(file = file.path(PlotsPath, paste("SigmavsPigments_Plot",".png",sep = "")), height=10, width= 8,  dpi = 300, limitsize = TRUE)
```

# Clean the environment

```{r}
rm(SolFitsAllPigmentfitPhycoChlalineardarkStrain, SolFitsAllPigmentfitPhycoChlalineardarkStrainGroup, SolFitsAllPigmentfitPhycoChlalinearStrain, SolFitsAllPigmentfitPhycoChlalinearStrain1s, SolFitsAllPigmentfitPhycoChlalinearStrainGroup, SolFitsAllPigmentfitPhycoChlalinearStrainGroup1s)
```


# Load Turner catalog

```{r load turner catalog, message = FALSE, warning = FALSE, echo=FALSE}
gs4_deauth()
Turnercatalog<- read_sheet("https://docs.google.com/spreadsheets/d/13mQm0B3siS65UuGjNdzvpHFomfuwn6aAg7dBoq1IqrM/edit#gid=0")

as.data.frame(Turnercatalog)
ChlData <- Turnercatalog 

ChlData <- ChlData %>%  
  mutate(Chl_ugL = as.numeric(Reading_rfu) * as.numeric(Chl_slope) + as.numeric(Chl_intercept)) %>% 
  mutate(DATE = ymd(`DATE`)) %>% 
  rename(SampleID=CultureID) %>% 
  rename(ObsDate=DATE) %>% 
  select(c(SampleID, ObsDate, Chl_ugL)) %>% 
  filter(Chl_ugL<212354.754) #outliers
```

# Calculate Chl mean from 3 technical replica

```{r}
ChlData <- ChlData %>%
  group_by(SampleID, ObsDate) %>%
  summarize(SampleID, ObsDate, Chl_ugL,
            meanChl_ugL = mean(Chl_ugL),
            sdChl_ugL = sd(Chl_ugL)) %>%
  ungroup()
```
# Merge Sigma with chlorophyll Turner data

```{r}
SolFitsAllPigmentPCPETurner <- ChlData %>%
  left_join(., SolFitsPigmentExp, by = c("SampleID"="SampleID", "ObsDate"="ObsDate"))

SolFitsAllPigmentPCPETurner<-SolFitsAllPigmentPCPETurner %>% 
  filter(Strain=="PC-rich_056" | Strain == "PC-rich_077" | Strain == "PE-rich_048" | Strain == "PE-rich_127")
```

# Create preliminary JVPSII vs Chl Turner (ug/L) plot

```{r preliminary plots, warning = FALSE}
SolFitsAllPigmentPCPETurner %>% 
  ggplot() +
  geom_point(aes(x = Chl_ugL, y = JVPSII_ETRqpOxbo_aLHII_Sig, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Strain), labeller = label_parsed) +
  theme_bw()


SolFitsAllPigmentPCPETurner %>% 
  ggplot() +
  geom_point(aes(x = cellLExp, y = JVPSII_ETRqpOxbo_aLHII_Sig, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Strain), labeller = label_parsed) +
  theme_bw() 


SolFitsAllPigmentPCPETurner %>% 
  ggplot() +
  geom_point(aes(x = E_days, y = JVPSII_ETRqpOxbo_aLHII_Sig, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Strain), labeller = label_parsed) +
  theme_bw()
```

# Clean the environment

```{r}
rm(Turnercatalog, ChlData, SolFitsAllPigmentPCPE, SolFitsAllPigmentPCPE1s)
```

# Save rds for further analysis

```{r save rds}
saveRDS(SolFitsAllPigmentPCPETurner, file.path(DataOut, paste(Project, "Procesed_SolisensePigmentsExp.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)
```









Set up R codes for Greek letters

\u0391  Α   Greek Capital Letter Alpha
\u0392  Β   Greek Capital Letter Beta
\u0393  Γ   Greek Capital Letter Gamma
\u0394  Δ   Greek Capital Letter Delta
\u0395  Ε   Greek Capital Letter Epsilon
\u0396  Ζ   Greek Capital Letter Zeta
\u0397  Η   Greek Capital Letter Eta
\u0398  Θ   Greek Capital Letter Theta
\u0399  Ι   Greek Capital Letter Iota
\u039A  Κ   Greek Capital Letter Kappa
\u039B  Λ   Greek Capital Letter Lambda
\u039C  Μ   Greek Capital Letter Mu
\u039D  Ν   Greek Capital Letter Nu
\u039E  Ξ   Greek Capital Letter Xi
\u039F  Ο   Greek Capital Letter Omicron
\u03A0  Π   Greek Capital Letter Pi
\u03A1  Ρ   Greek Capital Letter Rho
\u03A3  Σ   Greek Capital Letter Sigma
\u03A4  Τ   Greek Capital Letter Tau
\u03A5  Υ   Greek Capital Letter Upsilon
\u03A6  Φ   Greek Capital Letter Phi
\u03A7  Χ   Greek Capital Letter Chi
\u03A8  Ψ   Greek Capital Letter Psi
\u03A9  Ω   Greek Capital Letter Omega
\u03B1  α   Greek Small Letter alpha
\u03B2  β   Greek Small Letter beta
\u03B3  γ   Greek Small Letter gamma
\u03B4  δ   Greek Small Letter delta
\u03B5  ε   Greek Small Letter epsilon
\u03B6  ζ   Greek Small Letter zeta
\u03B7  η   Greek Small Letter eta
\u03B8  θ   Greek Small Letter theta
\u03B9  ι   Greek Small Letter iota
\u03BA  κ   Greek Small Letter kappa
\u03BB  λ   Greek Small Letter lambda
\u03BC  μ   Greek Small Letter mu
\u03BD  ν   Greek Small Letter nu
\u03BE  ξ   Greek Small Letter xi
\u03BF  ο   Greek Small Letter omicron
\u03C0  π   Greek Small Letter pi
\u03C1  ρ   Greek Small Letter rho
\u03C2  ς   Greek Small Letter final sigma
\u03C3  σ   Greek Small Letter sigma
\u03C4  τ   Greek Small Letter tau
\u03C5  υ   Greek Small Letter upsilon
\u03C6  φ   Greek Small Letter phi
\u03C7  χ   Greek Small Letter chi
\u03C8  ψ   Greek Small Letter psi
\u03C9  ω   Greek Small Letter omega





