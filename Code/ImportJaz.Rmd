---
title: "Import Jaz emission data"
author: "Douglas A. Campbell, Sylwia Sliwinska-Wilczewska, Mireille Savoie"
date: "`r format(Sys.Date())`"
output:
  html_document:
    df_print: paged
---

```{r libraries}
library(tidyverse)
library(lubridate)
library(googledrive)
```

```{r set project variables, read zipped files, list available files, warning = FALSE, echo=FALSE}
Project <- "Baltic_Photoperiod"
DataOut <- file.path("..", "Data", "ImportedData")

# Set the path to the zip folder and the destination folder
zip_file <- "C:/Users/Lenovo/Documents/GitHub/Baltic_Photoperiod/Data/RawData/JazEm.zip"
#destination_folder <- "C:/Users/Lenovo/Documents/GitHub/Baltic_Photoperiod/Data/RawData"

#List files in the extracted folder with a ".txt" extension
Jazfile <- unzip(zip_file, list = TRUE)
Jazfile <- Jazfile[grepl(".txt$", Jazfile$Name), "Name"]
print(Jazfile)
```
```{r set up read_delim_plus, warning = FALSE, echo=FALSE}
SkipCS <- 14
FileEncodeCS <- "UTF-8"
DelimCS <- "\t"
RollWindow <- 10

# Define function to read and process each file
fread_plus <- function(Flnm, Skip, FileEncode, Delim) {
  con <- unz(zip_file, Flnm)  # Corrected the file path within the zip archive
  data <- read.table(con, skip = Skip, encoding = FileEncode, sep = Delim, header = FALSE)
  
# Use tryCatch to handle errors during the closing of the connection
  tryCatch(
    close(con),
    error = function(e) {
      warning("Error closing connection: ", e$message)
    })
  
  data <- data %>%
    mutate(Filename = Flnm, CDateTime = ymd_hms(file.info(zip_file)$ctime)) 
  return(data)
}

# Use map_df to read and process all files in Jazfile
JazSpec <- Jazfile %>%
  map_df(~fread_plus(Flnm = ., Skip = SkipCS, FileEncode = FileEncodeCS, Delim = DelimCS))

# Rename columns
colnames(JazSpec)[1] <- "Wavelength"
colnames(JazSpec)[2] <- "Counts"
```

```{r filename separation}
JazSpec <- JazSpec %>% 
  mutate(Filename = str_remove(Filename, pattern = " "))  %>% 
  separate(col = Filename, into = c("Instrument","ObsDate", "Strain", "Par_ue", "WL"), sep = "([\\/\\/\\_\\_\\_\\_\\_\\_\\.])", remove = FALSE) %>% 
  mutate(FilenameJaz=Filename) %>% 
  select(-c("Instrument", "Filename"))

JazSpec <- JazSpec %>% 
mutate(ObsDate = ymd(ObsDate),
       Par_ue = as.numeric(Par_ue),
       WL = as.factor(WL))
```

```{r remove the wl < 350 and > 750}
JazSpecTrim <- JazSpec %>% 
  subset(JazSpec$Wavelength >= 400 & JazSpec$Wavelength <= 701)
```

```{r Remove all NA columns & empty rows, fix column types}
not_all_na <- function(x) {!all(is.na(x))}

JazSpecTrim <- JazSpecTrim %>%
  select_if(not_all_na)
```

```{r, Find nm at max count and compare with rolling mean of counts}
JazSpecTrim <- JazSpecTrim %>% 
  group_by(WL, Strain) %>%
   mutate(rollmeanCounts = zoo::rollmean(Counts, k = RollWindow, align = "left", fill = NA),
          is_nm = round(Wavelength[which.max(Counts)]),
          is_nm_rollmean= round(Wavelength[which.max(rollmeanCounts)])) %>% 
  ungroup()
```

```{r cleaning JazSpecTrim for final rds}
JazSpecTrim<-JazSpecTrim %>% 
  select(-c(CDateTime))

colnames(JazSpecTrim)
```
```{r Removed unnecessary files from environment}
rm(JazSpec)
```

```{r}
 saveRDS(JazSpecTrim, file.path(DataOut, paste(Project, "Imported_JazEm.Rds", sep = "_"), fsep = .Platform$file.sep))
```


