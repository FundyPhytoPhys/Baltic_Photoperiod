---
title: "Import Growth symmetry data"
author: "Douglas A. Campbell, Sylwia Sliwinska-Wilczewska"
date: "`r format(Sys.Date())`"
output:
  html_document:
    df_print: paged
---

```{r setup, include = FALSE}
# knitr::opts_chunk$set(echo = TRUE, message = FALSE)
# knitr::opts_chunk$set(fig.path='Figs/')
```

```{r set project variables}
Project <- "Baltic_Photoperiod"
DataOut <- file.path("..", "Data", "ImportedData")

FileID <- "Smooth"
FileEncode <- "UTF-8" 
Delimiter <- ""
HeaderRows <- 0
```

```{r load libraries} 
library(tidyverse)
library(lubridate)
library(stringr)
library(broom)
library(knitr)
library(OneR)
library(zoo)
library(strucchange)
library(magrittr)
library(googledrive)
library(googlesheets4)
library(readxl)
```

```{r load local multiculticatalog, message = FALSE, warning = FALSE, echo=FALSE}
gs4_deauth()

MetaData <- read_sheet("https://docs.google.com/spreadsheets/d/1ZXpwR7Gfto-uRzVdXzMpQF4frbrvMLH_IyLqonFZRSw/edit#gid=0") %>%
  drop_na(WL) %>%
  mutate(WL = unlist(WL))

as.data.frame(MetaData)
MetaData <- MetaData %>%
   mutate(ExpDate = ymd(ExpDate),
          ExpEndDate = ymd_hms(`ExpEndDate`))
```

```{r cleanning MetaData}
MetaData<-MetaData %>% 
  select(-c(PrimaryOperator,Description, Motivation, doi, ProjectID, Inoc_mL, Media_mL, ExpCul, ExpStartTime, Temp_c, Plate, Well, EndDate, Salinity, N2, Ar, CO2, O2_Category, Media, MediaDate, Source, SourceSalinity, InocpH, FinalpH, Par_ueAdjusted, DateOfAdjustment, ElaspedHoursAtAdjustment, ...46, ...47, OptodeMeasure, SampleID, "Calculated_µmolPhotons_m-2d-1")) 
```

```{r Load local GS catalog, message = FALSE, warning = FALSE, echo=FALSE}
gs4_deauth()

GScatalog<- read_sheet("https://docs.google.com/spreadsheets/d/1JG_GvHuJBtGf4NfWBSrgm0GxM7EpFVLQG-BARl8Lw8A/edit#gid=0")

as.data.frame(GScatalog)
GScatalog <- GScatalog 
```
```{r Clean unnecessary data}
GScatalog <- GScatalog %>% 
  select(-c(Acceleration_len, Decceleration_len, Ratio))
```

```{r Prepare data - mutate as numeric, calculate AccLen, DecLen, GS (growth symmetry)}
GScatalog <- GScatalog %>% 
    mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077")) %>% 
  mutate(Acc_perc = as.numeric(Acc_perc)) %>% 
  mutate(Dec_perc = as.numeric(Dec_perc)) %>% 
  mutate(AccDecRatio_perc = Acc_perc/Dec_perc) %>% 
  mutate(Par_ue = as.numeric(Par_ue)) %>% 
  mutate(Photoperiod = as.numeric(Photoperiod)) %>%
  mutate(tMaxAG = as.numeric(tMaxAG)) %>%
  mutate(tMaxDG = as.numeric(tMaxDG)) %>%
  mutate(PhotoperiodTstart_h=as.numeric(PhotoperiodTstart_h)) %>% 
  mutate(PhotoperiodTend_h=as.numeric(PhotoperiodTend_h)) %>% 
  mutate(AccLen = tMaxDG-PhotoperiodTstart_h) %>% 
  mutate(DecLen = PhotoperiodTend_h-tMaxDG) %>% 
  mutate(GS = AccLen/DecLen) %>% 
  mutate(TDG = as.numeric(TDG)) 
```

```{r Calculate mean of GS from every day (every peak in exp and pre-stationary phase)}
GScatalog2<-GScatalog %>% 
  filter(AccDecRatio_perc<10) %>% #3 error points 
  group_by(Strain, Photoperiod, Par_ue, Phase) %>%
  summarize(PhotoperiodTstart_h, PhotoperiodTend_h,tMaxDG,tMaxAG, Phase, AchivePreStationary, MaxDG, MaxAG, Acc_perc, Dec_perc, Strain, Par_ue, Photoperiod, O2, WL, OD680start, OD680end, TDG, AccDecRatio_perc, AccLen, DecLen, GS, 
            meanAccLen = mean(AccLen), 
            sdAccLen = sd(AccLen),
            meanDecLen = mean(DecLen), 
            sdDecLen = sd(DecLen)) %>%  
  mutate(meanGS = meanAccLen/meanDecLen) %>% 
  ungroup() 
```

```{r Calculate Photon Dose}
  GScatalog21 <- GScatalog2 %>%
  filter(Photoperiod != "24") %>% 
  mutate(PARPhotonDose =(Par_ue/2)*Photoperiod*3600)
  
  GScatalog22 <- GScatalog2 %>%
  filter(Photoperiod == "24") %>% 
  mutate(PARPhotonDose = Par_ue*Photoperiod*3600) 
  
  GScatalogAll <-rbind(GScatalog21, GScatalog22)

  rm(GScatalog2, GScatalog21, GScatalog22)
```


vertical lines without 24 photoperiod
```{r}

data_vline9 <- data.frame(Par_ue= c(30, 90, 180, 300, 900,30, 90, 180, 300, 900,30, 90, 180, 300, 900),Photoperiod= c(8,8,8,8,8,12,12,12,12,12,16,16,16,16,16),facets= c("PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})"),facets2= c("Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)"), value = c(347,321.02,240.90,187.92,110,347,245.39,189.48,162.62,110,347,168.39,113.76,111.56,110))

data_vline10 <- data.frame(Par_ue= c(30, 90, 180, 300, 900,30, 90, 180, 300, 900,30, 90, 180, 300, 900),Photoperiod= c(8,8,8,8,8,12,12,12,12,12,16,16,16,16,16),facets= c("PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})"),facets2= c("Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)"), value = c(346,319.92,240.81,214.41,109.5,346,216.33,163.44,136.03,109.5,299.38,166.28,137.32,111.28,109.45))

data_vline11 <- data.frame(Par_ue= c(30, 90, 180, 300, 900,30, 90, 180, 300, 900,30, 90, 180, 300, 900),Photoperiod= c(8,8,8,8,8,12,12,12,12,12,16,16,16,16,16),facets= c("PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})"),facets2= c("Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)"), value = c(345,347,266.84,240.72,109,345,296.45,217.80,191.03,109,345,191.49,114.95,112.75,108))

data_vline12 <- data.frame(Par_ue= c(30, 90, 180, 300, 900,30, 90, 180, 300, 900,30, 90, 180, 300, 900),Photoperiod= c(8,8,8,8,8,12,12,12,12,12,16,16,16,16,16),facets= c("PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})"),facets2= c("Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)"), value = c(344, 345, 266.93, 215.42, 108.5,344, 244.38,190.39,163.62,108.5,299.57, 168.85, 137.50, 112.29, 107))

```

Create facets for nice plot
```{r}

GScatalogAll$facetsPar_ue = factor(GScatalogAll$O2, labels = c("PAR~(µmol~photons~m^{-2}~s^{-1})"))

GScatalogAll$facetsPhotoperiod = factor(GScatalogAll$WL, labels = c("Photoperiod~(h)"))

GScatalogAll$facetsStrain = factor(GScatalogAll$O2, labels = c("Strain"))

GScatalogAll$facetsPhase = factor(GScatalogAll$WL, labels = c("Phase~of~growth"))
```



TDG plot
```{r fig.height = 8, fig.width = 8, warning = FALSE}



# lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
# 
# Strain.labs <- c("PE-rich_127", "PE-rich_048", "PC-rich_056", "PC-rich_077")
# names(Strain.labs) <- c("BA127R", "BA48R", "BA56G", "BA77G")
# 
# Par_ue.labs <- c("30 µE", "90 µE", "180 µE", "300 µE", "900 µE")
# names(Par_ue.labs) <- c("30", "90", "180", "300", "900")
# WL.labs <- c("Strain")
# names(WL.labs) <- c("WW")
# O2.labs <- c("Light level")
# names(O2.labs) <- c(21)

#scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
Plot <- GScatalogAll %>%
  #filter(Photoperiod != 24) %>% 
  ggplot() +
  geom_point(aes(x = PhotoperiodTend_h, y = TDG, colour = as.factor(Strain)), size = 3.5, alpha = 0.8, show.legend = T) +
  geom_vline(data = data_vline9, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  geom_vline(data = data_vline10, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  geom_vline(data = data_vline11, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = data_vline12, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +
labs(y = "TDG ("~OD[680]~")", x = "Elapsed time (h)") +
  # scale_x_continuous(breaks=seq(0, 4000000, by = 1000000)) +
  # coord_cartesian(xlim = c(-100, 3300000)) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #   scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  theme_bw() 
Plot
```

Create df to show hline
```{r}
data_hlineGS8 <- data.frame(Photoperiod= c(8),facets2= c("Photoperiod~(h)"),value = c(4))
data_hlineGS12 <- data.frame(Photoperiod= c(12),facets2= c("Photoperiod~(h)"),value = c(6))
data_hlineGS16 <- data.frame(Photoperiod= c(16),facets2= c("Photoperiod~(h)"),value = c(8))
```


GS
```{r fig.height = 8, fig.width = 8, warning = FALSE}


scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))



Plot<-GScatalogAll %>%
  filter(Phase != "TP") %>% 
  #filter(meanGS<3) %>% 
  ggplot() +
  geom_point(aes(x = PARPhotonDose, y = meanGS, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.8, show.legend = T) +
  # geom_errorbar(aes(x = PARPhotonDose, ymin = meanGS_h - sdGS_h, ymax = meanGS_h + sdGS_h, colour = as.factor(Par_ue)), show.legend = F) +
  # geom_hline(data = data_hlineGS8, aes(yintercept = value), linetype="dotted") +
  # geom_hline(data = data_hlineGS12, aes(yintercept = value), linetype="dotdash") +
  # geom_hline(data = data_hlineGS16, aes(yintercept = value), linetype="dashed") +
  geom_hline(yintercept = 1, linetype="dashed") +
   labs(y = "Diel growth symmetry (AccLen/DecLen)", x = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
 #labs(y = "Diel growth symmetry", x = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  scale_shape_manual(values = c(15, 16, 17), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  # scale_y_continuous(breaks=seq(0, 2, by = 0.5)) +
  # coord_cartesian(ylim = c(0, 2)) +
  scale_x_continuous(label=scientific_10) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #geom_hline(aes(yintercept = 50), linetype="dotted") +
  ggh4x::facet_nested(cols = vars(facetsPhase, Phase), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="white"),
        legend.position = c(0.92,0.89),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        # legend.spacing.x = unit(0.01, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=10))
Plot



Plot<-GScatalogAll %>%
  #mutate(HalfPhotoperiod = Photoperiod/2) %>% 
  #filter(meanAccLen>=0) %>%
  filter(Phase != "TP") %>%
  #filter(sdGS_h<"4") %>% 
  ggplot() +
  geom_point(aes(x = Photoperiod, y = meanAccLen, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.8, show.legend = T) +
  # geom_errorbar(aes(x = PARPhotonDose, ymin = meanGS_h - sdGS_h, ymax = meanGS_h + sdGS_h, colour = as.factor(Par_ue)), show.legend = F) +
  # geom_hline(data = data_hlineGS8, aes(yintercept = value), linetype="dotted") +
  # geom_hline(data = data_hlineGS12, aes(yintercept = value), linetype="dotdash") +
  # geom_hline(data = data_hlineGS16, aes(yintercept = value), linetype="dashed") +
  #geom_hline(yintercept = 1, linetype="dashed") +
labs(y = "AccLen (h)", x = "Photoperiod (h)") +
  #scale_shape_manual(values = c(15, 16, 17), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  # scale_y_continuous(breaks=seq(0, 10, by = 2.5)) +
  # coord_cartesian(ylim = c(0, 10)) +
  # 
  # scale_x_continuous(breaks=seq(0, 10, by = 2.5)) +
  # coord_cartesian(xlim = c(0, 10)) +
  # geom_hline(yintercept = 0, linetype = "dashed") +
  # geom_vline(xintercept = 0, linetype = "dashed") +
  geom_abline(slope = 0.5, intercept = 0, linetype = "dashed") +
  #coord_fixed(ratio = 1, xlim = c (0, 16), ylim = c(0, 10) ) +
  #scale_x_continuous(label=scientific_10) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #geom_hline(aes(yintercept = 50), linetype="dotted") +
  ggh4x::facet_nested(cols = vars(facetsPhase, Phase), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        panel.spacing.x = unit(1,"lines"),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.88,0.89),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        # legend.spacing.x = unit(0.01, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=10))
Plot


```



AccLen vs PARphotondose Plot
```{r fig.height = 8, fig.width = 8, warning = FALSE}


scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))


Plot<-GScatalogAll %>%
  filter(Phase != "TP") %>% 
  filter(meanAccLen>0) %>% 
  ggplot() +
  geom_point(aes(x = PARPhotonDose, y = meanAccLen, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.8, show.legend = T) +
    geom_line(aes(x = PARPhotonDose, y = meanAccLen, colour = as.factor(Par_ue)), size = 0.7, show.legend = F) +
  # geom_errorbar(aes(x = PARPhotonDose, ymin = meanGS_h - sdGS_h, ymax = meanGS_h + sdGS_h, colour = as.factor(Par_ue)), show.legend = F) +
  
  # geom_hline(data = data_hlineGS8, aes(yintercept = value), linetype="dotted") +
  # geom_hline(data = data_hlineGS12, aes(yintercept = value), linetype="dotdash") +
  # geom_hline(data = data_hlineGS16, aes(yintercept = value), linetype="dashed") +
  #geom_hline(yintercept = 1, linetype="dashed") +
   labs(y = "AccLen (h)", x = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
 #labs(y = "Diel growth symmetry", x = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  scale_shape_manual(values = c(15, 16, 17), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  
  # scale_y_continuous(breaks=seq(0, 2, by = 0.5)) +
  # coord_cartesian(ylim = c(0, 2)) +
  
  scale_x_continuous(label=scientific_10) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #geom_hline(aes(yintercept = 50), linetype="dotted") +
  ggh4x::facet_nested(cols = vars(facetsPhase, Phase), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="white"),
        legend.position = c(0.92,0.89),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        # legend.spacing.x = unit(0.01, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=10))
Plot



```

Calculate real Par_ue and PARphotondoseSine based on AccLen (because of sine shape of light)

change as character to extract first digit without round - b/c this is hours
```{r}
GScatalogAllSine<-GScatalogAll %>% 
  mutate(meanAccLen = as.character(meanAccLen)) 

  library(stringi)
GScatalogAllSine$meanAccLenRound<- substr(GScatalogAllSine$meanAccLen, 1, 1)

GScatalogAllSine<-GScatalogAllSine %>% 
  mutate(meanAccLen = as.numeric(meanAccLen)) %>% 
  mutate(meanAccLenRound = as.numeric(meanAccLenRound)) 

```
df with calculated Par_ue sine per hour
```{r}
gs4_deauth()

ParSine<- read_sheet("https://docs.google.com/spreadsheets/d/1oZLemHtd6H3j2MgXbgNzqtZ2Gy3EKH6Vnn14PnEpPTw/edit#gid=0")

as.data.frame(ParSine)
ParSine <- ParSine

ParSine<-ParSine %>%
  mutate(PAR_Sine = as.numeric(PAR_Sine)) %>%
  mutate(Par_ue = as.numeric(Par_ue)) %>%
  mutate(Photoperiod = as.numeric(Photoperiod)) %>%
  mutate(RealTime = as.numeric(RealTime)) %>%
  mutate(Photoperiod_h_Sine = as.numeric(Photoperiod_h_Sine)) %>%
  mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077")) %>% 
  mutate(PARPhotonDoseSine = (PAR_Sine*Photoperiod/2)*3600)

```

Combine GScatalogAllSine with ParSine
```{r}
GScatalogAllSineok <- GScatalogAllSine %>%
  left_join(., ParSine, by = c("Strain" = "Strain", "Photoperiod" = "Photoperiod", "Par_ue" = "Par_ue", "meanAccLenRound" = "Photoperiod_h_Sine"))

```

AccLen vs PARphotondose Plot
```{r fig.height = 8, fig.width = 8, warning = FALSE}


scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))



Plot<-GScatalogAllSineok %>%
  filter(Phase != "TP") %>% 
  filter(meanAccLen>0) %>% 
  ggplot() +
  geom_point(aes(x = PARPhotonDoseSine, y = meanAccLen, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.8, show.legend = T) +
  geom_line(aes(x = PARPhotonDoseSine, y = meanAccLen, colour = as.factor(Par_ue)), size = 0.7, show.legend = F) +
  # geom_errorbar(aes(x = PARPhotonDose, ymin = meanGS_h - sdGS_h, ymax = meanGS_h + sdGS_h, colour = as.factor(Par_ue)), show.legend = F) +
  # geom_hline(data = data_hlineGS8, aes(yintercept = value), linetype="dotted") +
  # geom_hline(data = data_hlineGS12, aes(yintercept = value), linetype="dotdash") +
  # geom_hline(data = data_hlineGS16, aes(yintercept = value), linetype="dashed") +
  #geom_hline(yintercept = 1, linetype="dashed") +
   labs(y = "AccLen (h)", x = "Real PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
 #labs(y = "Diel growth symmetry", x = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  scale_shape_manual(values = c(15, 16, 17), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  # scale_y_continuous(breaks=seq(0, 2, by = 0.5)) +
  # coord_cartesian(ylim = c(0, 2)) +
  scale_x_continuous(label=scientific_10) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #geom_hline(aes(yintercept = 50), linetype="dotted") +
  ggh4x::facet_nested(cols = vars(facetsPhase, Phase), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  theme_bw()
Plot



Plot<-GScatalogAllSineok %>%
  #mutate(HalfPhotoperiod = Photoperiod/2) %>% 
  #filter(meanAccLen>=0) %>%
  filter(Phase != "TP") %>%
  #filter(sdGS_h<"4") %>% 
  ggplot() +
  geom_point(aes(x = PAR_Sine, y = meanAccLen, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.8, show.legend = T) +
  # geom_errorbar(aes(x = PARPhotonDose, ymin = meanGS_h - sdGS_h, ymax = meanGS_h + sdGS_h, colour = as.factor(Par_ue)), show.legend = F) +
#labs(y = "AccLen (h)", x = "Photoperiod (h)") +
  scale_shape_manual(values = c(15, 16, 17), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  # scale_y_continuous(breaks=seq(0, 10, by = 2.5)) +
  # coord_cartesian(ylim = c(0, 10)) +
  # 
  # scale_x_continuous(breaks=seq(0, 10, by = 2.5)) +
  # coord_cartesian(xlim = c(0, 10)) +
  #scale_x_continuous(label=scientific_10) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #geom_hline(aes(yintercept = 50), linetype="dotted") +
  ggh4x::facet_nested(cols = vars(facetsPhase, Phase), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  theme_bw() 
Plot




```






