---
title: "Process_GrowthRateData"
author:
- Sylwia Sliwinska-Wilczewska
- Douglas A. Campbell
date: "`r format(Sys.Date())`"
output:
bookdown::html_document2:
    code_folding: show
    keep_md: yes
    toc: TRUE
    toc_float: TRUE
    toc_depth: 6
    fig_caption: yes
bibliography: BalticPhotoperiod.bib
csl: plos-one.csl
editor_options: 
  markdown: 
    wrap: 72
---

# Set Chunk Options

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
knitr::opts_chunk$set(fig.path='Figs/')
```

# Introduction

Process_GrowthRateData.Rmd processes and combines PICO_NestedFitsData.Rds from Data/CleanData/CleanedMCData folder and Baltic_Photoperiod_Processed_OlisSpectraTidy.Rds from Data/ProcessedData/ProcessedOlisJazData. This .Rmd generates Baltic_Photoperiod_Processed_GrowthRate.Rds (stored in Data/ProcessedData/ProcessesGrowthRateData folder) and GrowthRate_Plot.png (stored in Output/Plots folder).

# Load Libraries and set Project Variables

```{r load libraries} 
library(tidyverse)
library(lubridate)
library(stringr)
library(broom)
library(knitr)
library(OneR)
library(zoo)
library(strucchange)
library(ggpubr)
library(caret)
library(reshape2)
library(gcookbook)
library(scales)
library(minpack.lm) #Standard 'nls' framework that uses 'nls.lm' for fitting
library(data.table)
library(googledrive)
library(googlesheets4)
```

```{r set project variables}
Project <- "Baltic_Photoperiod"
DataOut <- file.path("..", "Data", "ProcessedData", "ProcessesGrowthRateData")
DataIn <- file.path("..", "Data", "CleanData", "CleanedMCData", fsep = .Platform$file.sep)

PlotsPath <- file.path("..", "Output", "Plots")
RDSPlotPath <- file.path("..", "Output", "PlotsRDS")

FileEncode <- "UTF-8" 
Delimiter <- ""
HeaderRows <- 0
```

# List and read files

```{r Exported Rmd only first time in session}
list.files(path = DataIn, full.names = TRUE)
```

```{r read file}
MultiCultiGrowthFile <- "../Data/CleanData/CleanedMCData/PICO_NestedFitsData.Rds"

MultiCultiGrowthFileName <- str_split(string = MultiCultiGrowthFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds") 

MultiCultiGrowth <- readRDS(MultiCultiGrowthFile)  %>%
  ungroup()
```

# Select revelant variables and preparing for further analysis

```{r}
MultiCultiGrowth<-MultiCultiGrowth %>% 
  select(c(Tube, ExpDate, MC, Run, SampleID, Strain, Par_ue, Photoperiod, WL, O2, LightShape, PARPhotonDose_day, OD720_Lmu_se, OD720_Lmu_corr, deltaOD_Lmu_se, deltaOD_Lmu_corr))
  
MultiCultiGrowth<-MultiCultiGrowth %>% 
  mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077"))

MultiCultiGrowth1<-MultiCultiGrowth %>% 
  filter(Run==77) %>% 
  filter(Strain =="PC-rich_077")
MultiCultiGrowth2<-MultiCultiGrowth %>% 
  filter(Run==121) %>% 
  filter(Strain !="PC-rich_077")
MultiCultiGrowth3<-MultiCultiGrowth %>% 
  filter(Run!=121 & Run!= 77) 
MultiCultiGrowth<-rbind(MultiCultiGrowth1, MultiCultiGrowth2, MultiCultiGrowth3)
  rm(MultiCultiGrowth1, MultiCultiGrowth2, MultiCultiGrowth3)
```

# Load processed Olis&Jaz RDS

```{r set project variables}
Project <- "Baltic_Photoperiod"
DataIn <- file.path("..", "Data", "ProcessedData", "ProcessedOlisJazData", fsep = .Platform$file.sep)
```

# List and read processed Olis and Jaz files

```{r exported Rmd only first time in session}
list.files(path = DataIn, pattern = Project, full.names = TRUE)
```
```{r read imported Olis file}
OLISSpectraFile <- "../Data/ProcessedData/ProcessedOlisJazData/Baltic_Photoperiod_Processed_OlisSpectraTidy.Rds"
OLISSpectraFileName <- str_split(string = OLISSpectraFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")
OLISSpectra <- readRDS(OLISSpectraFile)  %>%
  ungroup()
```

# Combine growth rate and Tidy Olis to get PUR

```{r}
MultiCultiGrowthRate <- OLISSpectra %>% 
  left_join(., MultiCultiGrowth, by = c("Run" = "Run", "SampleID" = "SampleID","Strain" = "Strain", "Par_ue" = "Par_ue", "Photoperiod" = "Photoperiod",  "O2" = "O2", "WL" = "WL",  "MC" = "MC", "Tube" = "Tube", "ExpDate" = "ExpDate", "LightShape" = "LightShape", "PARPhotonDose_day" = "PARPhotonDose_day")) 
```

# Exstracted Exp PUR

```{r exstracted Exp PUR}

O1 <- MultiCultiGrowthRate %>%
  filter(Par_ue == 30 | Par_ue == 300 | Par_ue == 90 | Par_ue == 180) %>% 
  filter(Photoperiod == 24) %>% 
  filter(E_days < 4)

O2 <- MultiCultiGrowthRate %>%
  filter(Par_ue == 180 | Par_ue == 300) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days == 4)

O3 <- MultiCultiGrowthRate %>%
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days == 6)

O4 <- MultiCultiGrowthRate %>%
  filter(Par_ue == 30) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days == 12)

O5 <- MultiCultiGrowthRate %>%
  filter(Par_ue == 900 | Par_ue == 600) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days == 4)

O6 <- MultiCultiGrowthRate %>%
  filter(Par_ue == 30) %>% 
  filter(Photoperiod == 8 | Photoperiod == 12) %>% 
  filter(E_days == 12| E_days == 13)
  
O7 <- MultiCultiGrowthRate %>%
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 8) %>% 
  filter(E_days == 12 | E_days ==13)

O8 <- MultiCultiGrowthRate %>%
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 12) %>% 
  filter(Strain == "PE-rich_127" | Strain == "PE-rich_048" | Strain == "PC-rich_077") %>% 
  filter(E_days == 8 | E_days ==9)

O9 <- MultiCultiGrowthRate %>%
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 12) %>% 
  filter(Strain == "PC-rich_056") %>% 
  filter(E_days == 11)

O10 <- MultiCultiGrowthRate %>%
  filter(Par_ue == 180) %>% 
  filter(Photoperiod == 8) %>% 
  filter(E_days == 8 | E_days == 9)

O11 <- MultiCultiGrowthRate %>%
  filter(Par_ue == 180) %>% 
  filter(Photoperiod == 12) %>% 
  filter(E_days == 6 | E_days == 7)

O12 <- MultiCultiGrowthRate %>%
  filter(Par_ue == 300) %>% 
  filter(Photoperiod == 8) %>% 
  filter(Strain == "PE-rich_127" | Strain == "PE-rich_048" | Strain == "PC-rich_077") %>% 
  filter(E_days == 6 | E_days ==7)

O13 <- MultiCultiGrowthRate %>%
  filter(Par_ue == 300) %>% 
  filter(Photoperiod == 8) %>% 
  filter(Strain == "PC-rich_056") %>% 
  filter(E_days == 9)

O14 <- MultiCultiGrowthRate %>%
  filter(Par_ue == 300) %>% 
  filter(Photoperiod == 12) %>% 
  filter(Strain == "PE-rich_127" | Strain == "PE-rich_048" | Strain == "PC-rich_077") %>% 
  filter(E_days == 4 | E_days ==5)

O15 <- MultiCultiGrowthRate %>%
  filter(Par_ue == 300) %>% 
  filter(Photoperiod == 12) %>% 
  filter(Strain == "PC-rich_056") %>%  
  filter(E_days == 7)

O16 <- MultiCultiGrowthRate %>%
  filter(Par_ue == 900) %>% 
  filter(Photoperiod == 8 | Photoperiod == 12)

O17 <- MultiCultiGrowthRate %>%
  filter(Par_ue == 900 | Par_ue == 600) %>% 
  filter(Photoperiod == 24) %>% 
  filter(E_hours < 100 & E_hours > 48)

MultiCultiDataCleanGrowthAPUR <-rbind(O1, O2, O3, O4, O5, O6, O7, O8, O9, O10, O11, O12, O13, O14, O15, O16, O17)
  rm(O1, O2, O3, O4, O5, O6, O7, O8, O9, O10, O11, O12, O13, O14, O15, O16, O17)
```

```{r exstracted Exp PUR, changed variable names}
MultiCultiDataCleanGrowthAPUR<-MultiCultiDataCleanGrowthAPUR %>% 
  mutate(PURExp = PUR) %>% 
  mutate(PURPhotonDoseExp = PURPhotonDose_day) %>% 
  mutate(PURPARRatioExp = PURPARRatio) %>% 
  mutate(E_hoursExp = E_hours) %>% 
  mutate(E_daysExp = E_days) %>% 
  select(c(Strain, Par_ue, Photoperiod, PURExp, PURPhotonDoseExp, PURPARRatioExp, E_hoursExp, E_daysExp))
  
MultiCultiGrowthRatePURExp <- MultiCultiGrowthRate %>%
  full_join(., MultiCultiDataCleanGrowthAPUR, by = c("Strain"="Strain", "Par_ue"="Par_ue","Photoperiod"="Photoperiod"))

rm(MultiCultiDataCleanGrowthAPUR, MultiCultiGrowthRate)
```

# Load tmaxAG catalog 

```{r}
gs4_deauth()
tmaxAG<- read_sheet("https://docs.google.com/spreadsheets/d/1ksY7xlg9wOsICOBRmZkHPKdd9KOislNwPDzyuJ3UIUI/edit#gid=0")
as.data.frame(tmaxAG)
tmaxAG <- tmaxAG

tmaxAG<-tmaxAG %>% 
  mutate(Par_ue = as.numeric(Par_ue)) %>%
  mutate(Photoperiod = as.numeric(Photoperiod)) %>%
  mutate(tMaxAG = as.numeric(tMaxAG)) %>%
  mutate(dayRound_tmaxAG=tMaxAG/24) %>% 
  mutate(dayRound_tmaxAG = round(dayRound_tmaxAG, digits = 0)) %>% 
  mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077"))

tmaxAG$facetsPar_ue = factor(tmaxAG$O2, labels = c("PAR~(µmol~photons~m^{-2}~s^{-1})"))
tmaxAG$facetsPhotoperiod = factor(tmaxAG$WL, labels = c("Photoperiod~(h)"))
tmaxAG$facetsStrain = factor(tmaxAG$O2, labels = c("Strain"))
tmaxAG$facetsPARPhotonDose_day = factor(tmaxAG$WL, labels = c("PAR~photon~dose~(10^{5}~µmol~photons~m^{-2}~d^{-1})"))
```

```{r select revelant columns}
tMaxAGLines_056<-tmaxAG %>% 
  filter(Strain == "PC-rich_056") %>% 
  select(c(Par_ue, Photoperiod, tMaxAG)) %>% 
  unique()
tMaxAGLines_077<-tmaxAG %>% 
  filter(Strain == "PC-rich_077") %>% 
  select(c(Par_ue, Photoperiod, tMaxAG)) %>% 
  unique()
tMaxAGLines_048<-tmaxAG %>% 
  filter(Strain == "PE-rich_048") %>% 
  select(c(Par_ue, Photoperiod, tMaxAG)) %>% 
  unique()
tMaxAGLines_127<-tmaxAG %>% 
  filter(Strain == "PE-rich_127") %>% 
  select(c(Par_ue, Photoperiod, tMaxAG)) %>% 
  unique()
```

# Create preliminary plots

```{r preliminary plot}
lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))

MultiCultiGrowthRatePURExp %>%
  ggplot() +
  geom_point(aes(x = E_hours, y = PURPARRatio, colour = as.factor(Strain)), alpha = 0.9, size = 3, show.legend = T) +
  geom_vline(data = tMaxAGLines_056, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown4") +
  geom_vline(data = tMaxAGLines_077, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown1") +
  geom_vline(data = tMaxAGLines_048, aes(xintercept = tMaxAG), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = tMaxAGLines_127, aes(xintercept = tMaxAG), linetype="dotdash", colour = "palegreen3") +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  coord_cartesian(ylim = c(0, 1.7)) +
  ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 


MultiCultiGrowthRatePURExp %>%
  ggplot() +
  geom_point(aes(x = E_hoursExp, y = PURPARRatioExp, colour = as.factor(Strain)), alpha = 0.9, size = 3, show.legend = T) +
  geom_vline(data = tMaxAGLines_056, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown4") +
  geom_vline(data = tMaxAGLines_077, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown1") +
  geom_vline(data = tMaxAGLines_048, aes(xintercept = tMaxAG), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = tMaxAGLines_127, aes(xintercept = tMaxAG), linetype="dotdash", colour = "palegreen3") +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  coord_cartesian(ylim = c(0, 1.7)) +
  ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 
```

# Create preliminary plot 

```{r preliminary plot, warning = FALSE}
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))

O2.labs <- c("Strain")
names(O2.labs) <- c(21)
scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }

MultiCultiGrowthRatePURExp %>%
  ggplot() +
  geom_point(aes(x = PARPhotonDose_day, y = deltaOD_Lmu_corr, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.9, show.legend = T) +
  geom_errorbar(aes(x = PARPhotonDose_day, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se), alpha = 0.5, width=2000000) +
  scale_x_continuous(breaks=seq(0, 80000000, by = 20000000)) +
  coord_cartesian(xlim = c(-100, 83000000)) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  ggh4x::facet_nested(rows = vars(O2, Strain), labeller = labeller(O2 = O2.labs)) +
  scale_x_continuous(label=scientific_10) +
  guides(color = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_bw() 


MultiCultiGrowthRatePURExp %>%
  ggplot() +
  geom_point(aes(x = PURPhotonDoseExp, y = deltaOD_Lmu_corr, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.9, show.legend = T) +
  geom_errorbar(aes(x = PURPhotonDoseExp, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se), alpha = 0.5, width=2000000) +
  scale_x_continuous(breaks=seq(0, 80000000, by = 20000000)) +
  coord_cartesian(xlim = c(-100, 83000000)) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "PUR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  ggh4x::facet_nested(rows = vars(O2, Strain), labeller = labeller(O2 = O2.labs)) +
  scale_x_continuous(label=scientific_10) +
  guides(color = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_bw()

MultiCultiGrowthRatePURExp %>%
  ggplot() +
  geom_point(aes(x = PURPhotonDoseExp, y = OD720_Lmu_corr, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.9, show.legend = T) +
  geom_errorbar(aes(x = PURPhotonDoseExp, ymin = OD720_Lmu_corr - OD720_Lmu_se, ymax = OD720_Lmu_corr + OD720_Lmu_se), alpha = 0.5, width=2000000) +
  scale_x_continuous(breaks=seq(0, 80000000, by = 20000000)) +
  coord_cartesian(xlim = c(-100, 83000000)) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  ggh4x::facet_nested(rows = vars(O2, Strain), labeller = labeller(O2 = O2.labs)) +
  scale_x_continuous(label=scientific_10) +
  guides(color = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_bw()
```

# Added column PhotonDose_value and combine data to to PAR and PUR - long format (MultiCultiGrowthRatePURExpFit)

```{r}
MultiCultiGrowthRatePURExpFitPAR<-MultiCultiGrowthRatePURExp %>% 
  select(-c(PURPhotonDose_day)) %>% 
  mutate(PhotonDose_value = PARPhotonDose_day) %>% 
  mutate(PhotonDose = O2) %>% 
  mutate(PhotonDose = case_when(PhotonDose==21~"PAR")) %>% 
  select(-c(PARPhotonDose_day, PURPhotonDoseExp))
  
MultiCultiGrowthRatePURExpFitPUR<-MultiCultiGrowthRatePURExp %>% 
  select(-c(PARPhotonDose_day)) %>% 
  mutate(PhotonDose_value = PURPhotonDoseExp) %>% 
  mutate(PhotonDose = O2) %>% 
  mutate(PhotonDose = case_when(PhotonDose==21~"PUR")) %>% 
  select(-c(PURPhotonDose_day, PURPhotonDoseExp))

MultiCultiGrowthRatePURExpFit<-rbind(MultiCultiGrowthRatePURExpFitPAR, MultiCultiGrowthRatePURExpFitPUR)
  rm(MultiCultiGrowthRatePURExpFitPAR, MultiCultiGrowthRatePURExpFitPUR)
```

# Create preliminary plot

```{r preliminary plot, warning = FALSE}
scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))

O2.labs <- c("Strain")
names(O2.labs) <- c(21)

MultiCultiGrowthRatePURExpFit %>%
  ggplot() +
  geom_point(aes(x = PhotonDose_value, y = deltaOD_Lmu_corr, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.9, show.legend = T) +
  geom_errorbar(aes(x = PhotonDose_value, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se), alpha = 0.5, width=2000000) +
  scale_x_continuous(breaks=seq(0, 80000000, by = 20000000)) +
  coord_cartesian(xlim = c(-100, 83000000)) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "Photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  ggh4x::facet_nested(rows = vars(O2, Strain), cols = vars(PhotonDose), labeller = labeller(O2 = O2.labs)) +
  scale_x_continuous(label=scientific_10) +
  guides(color = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_bw()
```

# Add dummies points at 900 uE to df

```{r}
CleanGrowthPARPURfit900clean<-MultiCultiGrowthRatePURExpFit %>% 
  filter(Par_ue !=30 & Par_ue !=90 & Par_ue !=180 & Par_ue !=300) %>% 
  select(c(Strain, deltaOD_Lmu_corr, PhotonDose, PhotonDose_value))
  
gs4_deauth()
# this is the URL or ID of a Sheet readable by anyone (with a link)
Dummy <- read_sheet("https://docs.google.com/spreadsheets/d/1Ns_u26HagT-kDCy5WgjGA_U8R6qv4LqRPubtlWB8Cxc/edit#gid=0")   

CleanGrowthPARPURfit900<-rbind(CleanGrowthPARPURfit900clean, Dummy)
```
# Estimated Harrison & Platt, 1986 fit - for 900uE and the rest uE

```{r Added function}
grcplatt <- function(I, a, b, Pmax){Pmax * (1-exp(-a*I/Pmax)) * exp(-b*I/Pmax)}
```


```{r Estimated Harrison & Platt, 1986 fit}

CleanGrowthPARPURfit <- MultiCultiGrowthRatePURExpFit %>%    
  filter(Par_ue !=900) %>%  
  nest(data = -c("Strain", "PhotonDose")) %>%  
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PhotonDose_value, a, b, Pmax),
                                                    data = .x,
                                                    start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),
                                                    lower = c(0, 0, 0)))) %>%    
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance)))

GRCplatt_PredictGrowth <- CleanGrowthPARPURfit %>% 
  unnest(GRCplatt_Predict)




CleanGrowthPARPURfit900_two <- CleanGrowthPARPURfit900 %>%   
  #filter(Par_ue !=30 & Par_ue !=90 & Par_ue !=180 & Par_ue !=300) %>%  
  nest(data = -c("Strain", "PhotonDose")) %>%  
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PhotonDose_value, a, b, Pmax),
                                                    data = .x,
                                                    start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),
                                                    lower = c(0, 0, 0)))) %>%   
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance)))

GRCplatt_PredictGrowth900 <- CleanGrowthPARPURfit900_two %>% 
  unnest(GRCplatt_Predict)

  rm(CleanGrowthPARPURfit, CleanGrowthPARPURfit900_two)
```

# Create preliminary plot

```{r preliminary plot, warning = FALSE}
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("1 µE"), expression("2 µE"), expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))
scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }

ggplot(MultiCultiGrowthRatePURExpFit, aes(PhotonDose_value, deltaOD_Lmu_corr)) +
  geom_point(aes(PhotonDose_value, deltaOD_Lmu_corr, colour=as.factor(Par_ue), shape = as.factor(Photoperiod)), alpha = 0.9, size = 3.5, show.legend = T) +
  geom_errorbar(aes(x = PhotonDose_value, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se, colour = as.factor(Par_ue)), width=4000000, data = . %>% filter(deltaOD_Lmu_se<8.057558e-03), show.legend = F) +
  geom_line(aes(PhotonDose_value, .fitted), show.legend = F, GRCplatt_PredictGrowth) +
  geom_line(aes(PhotonDose_value, .fitted), show.legend = F, GRCplatt_PredictGrowth900) +
  scale_x_continuous(label=scientific_10) +
  scale_linetype_manual(values=c("equal900" = "dotted", "less900" = "solid"), breaks=c('8', '12', '16', "24", "", "")) +
  scale_colour_manual(values = c("", "", "darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2, breaks=c('', '', '30', "90", "180", "300", "900")) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "Photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  ggh4x::facet_nested(cols = vars(PhotonDose), rows = vars(Strain), labeller = label_parsed) +
  theme_bw() 
```

# Estimated Harrison & Platt, 1986 fit - for 900uE and the rest uE

```{r Added function}
grcplatt <- function(I, a, b, Pmax){Pmax * (1-exp(-a*I/Pmax)) * exp(-b*I/Pmax)}
```

```{r Estimated Harrison & Platt, 1986 fit}

CleanGrowthPARPURfitAll <- MultiCultiGrowthRatePURExpFit %>%    
  nest(data = -c("Strain", "PhotonDose")) %>%  
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PhotonDose_value, a, b, Pmax),
                                                    data = .x,
                                                    start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),
                                                    lower = c(0, 0, 0)))) %>%    
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance)))

GRCplatt_PredictGrowth <- CleanGrowthPARPURfitAll %>% 
  unnest(GRCplatt_Predict)

```

# Create preliminary plot

```{r preliminary plot, warning = FALSE}
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("1 µE"), expression("2 µE"), expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))
scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }

ggplot(MultiCultiGrowthRatePURExpFit, aes(PhotonDose_value, deltaOD_Lmu_corr)) +
  geom_point(aes(PhotonDose_value, deltaOD_Lmu_corr, colour=as.factor(Par_ue), shape = as.factor(Photoperiod)), alpha = 0.9, size = 3.5, show.legend = T) +
  geom_errorbar(aes(x = PhotonDose_value, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se, colour = as.factor(Par_ue)), width=4000000, data = . %>% filter(deltaOD_Lmu_se<8.057558e-03), show.legend = F) +
  geom_line(aes(PhotonDose_value, .fitted), show.legend = F, GRCplatt_PredictGrowth) +
  scale_x_continuous(label=scientific_10) +
  scale_linetype_manual(values=c("equal900" = "dotted", "less900" = "solid"), breaks=c('8', '12', '16', "24", "", "")) +
  scale_colour_manual(values = c("", "", "darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2, breaks=c('', '', '30', "90", "180", "300", "900")) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "Photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  ggh4x::facet_nested(cols = vars(PhotonDose), rows = vars(Strain), labeller = label_parsed) +
  theme_bw() 
```

# Estimated Harrison & Platt, 1986 fit - for each uE separately

```{r platt fit}

#Harrison & Platt, 1986
grcplatt <- function(I, a, b, Pmax){Pmax * (1-exp(-a*I/Pmax)) * exp(-b*I/Pmax)}


MultiCultiGrowthRatePURExpFit30 <- MultiCultiGrowthRatePURExpFit %>%   
  filter(Par_ue ==30) %>% 
  nest(data = -c("Strain", "PhotonDose")) %>%  
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PhotonDose_value, a, b, Pmax),
                                                    data = .x,
                                                    start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),
                                                    lower = c(0, 0, 0)))) %>%    
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance)))

GRCplatt_PredictGrowth30 <- MultiCultiGrowthRatePURExpFit30 %>% 
  unnest(GRCplatt_Predict)



MultiCultiGrowthRatePURExpFit90 <- MultiCultiGrowthRatePURExpFit %>%    
  filter(Par_ue ==90) %>%  
  nest(data = -c("Strain", "PhotonDose")) %>% 
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PhotonDose_value, a, b, Pmax),
                                                    data = .x,
                                                    start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),
                                                    lower = c(0, 0, 0)))) %>%    
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance)))

GRCplatt_PredictGrowth90 <- MultiCultiGrowthRatePURExpFit90 %>% 
  unnest(GRCplatt_Predict)


MultiCultiGrowthRatePURExpFit180 <- MultiCultiGrowthRatePURExpFit %>%    
  filter(Par_ue ==180) %>%  
  nest(data = -c("Strain", "PhotonDose")) %>%  
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PhotonDose_value, a, b, Pmax),
                                                    data = .x,
                                                    start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),
                                                    lower = c(0, 0, 0)))) %>%   
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance)))

GRCplatt_PredictGrowth180 <- MultiCultiGrowthRatePURExpFit180 %>% 
  unnest(GRCplatt_Predict)



MultiCultiGrowthRatePURExpFit300 <- MultiCultiGrowthRatePURExpFit %>%   
  filter(Par_ue ==300) %>% 
  nest(data = -c("Strain", "PhotonDose")) %>%  
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PhotonDose_value, a, b, Pmax),
                                                    data = .x,
                                                    start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),
                                                    lower = c(0, 0, 0)))) %>%    
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance)))

GRCplatt_PredictGrowth300 <- MultiCultiGrowthRatePURExpFit300 %>% 
  unnest(GRCplatt_Predict)


MultiCultiGrowthRatePURExpFit900 <- CleanGrowthPARPURfit900 %>%    
  # filter(Par_ue ==900) %>% 
  nest(data = -c("Strain", "PhotonDose")) %>%  
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PhotonDose_value, a, b, Pmax),
                                                    data = .x,
                                                    start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),
                                                    lower = c(0, 0, 0)))) %>%    
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance)))

GRCplatt_PredictGrowth900 <- MultiCultiGrowthRatePURExpFit900 %>% 
  unnest(GRCplatt_Predict)
```

# Added facets labels

```{r}
GRCplatt_PredictGrowth30$facetsStrain = factor(GRCplatt_PredictGrowth30$PhotonDose, labels = c("Strain", "Strain"))
GRCplatt_PredictGrowth90$facetsStrain = factor(GRCplatt_PredictGrowth90$PhotonDose, labels = c("Strain", "Strain"))
GRCplatt_PredictGrowth180$facetsStrain = factor(GRCplatt_PredictGrowth180$PhotonDose, labels = c("Strain", "Strain"))
GRCplatt_PredictGrowth300$facetsStrain = factor(GRCplatt_PredictGrowth300$PhotonDose, labels = c("Strain", "Strain"))
GRCplatt_PredictGrowth900$facetsStrain = factor(GRCplatt_PredictGrowth900$PhotonDose, labels = c("Strain", "Strain"))
```

# Create Growth Rate plot

```{r create growth rate plot, fig.height = 8, fig.width = 8, warning = FALSE}
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("1 µE"), expression("2 µE"), expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))
scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }

ggplot(MultiCultiGrowthRatePURExpFit, aes(PhotonDose_value, deltaOD_Lmu_corr)) +
  geom_point(aes(PhotonDose_value, deltaOD_Lmu_corr, colour=as.factor(Par_ue), shape = as.factor(Photoperiod)), alpha = 0.8, size = 3.5, show.legend = T) +
  geom_errorbar(aes(x = PhotonDose_value, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se, colour = as.factor(Par_ue)), width=0, size=0.3, data = . %>% filter(deltaOD_Lmu_se<8.057558e-03), show.legend = F) +
  geom_line(aes(PhotonDose_value, .fitted), colour = "darkslategray", show.legend = F, GRCplatt_PredictGrowth30) +
  geom_line(aes(PhotonDose_value, .fitted), colour = "lightblue4", show.legend = F, GRCplatt_PredictGrowth90) +
  geom_line(aes(PhotonDose_value, .fitted), colour = "hotpink4", show.legend = F, GRCplatt_PredictGrowth180) +
  geom_line(aes(PhotonDose_value, .fitted), colour = "indianred3", show.legend = F, GRCplatt_PredictGrowth300) +
  geom_line(aes(PhotonDose_value, .fitted), colour = "orange1", show.legend = F, GRCplatt_PredictGrowth900) +
  scale_x_continuous(breaks=seq(0, 60000000, by = 30000000), label=scientific_10) +
  coord_cartesian(xlim = c(0, 90000000)) +
  scale_linetype_manual(values=c("equal900" = "dotted", "less900" = "solid"), breaks=c('8', '12', '16', "24", "", "")) +
  scale_colour_manual(values = c("", "", "darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2, breaks=c('', '', '30', "90", "180", "300", "900")) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "Photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  ggh4x::facet_nested(cols = vars(PhotonDose), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=11),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.92,0.88),
        legend.key.height= unit(0.003, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        legend.spacing.x = unit(-0.1, 'cm'),
        legend.title = element_blank(),
        legend.text = element_text(size=9))
```

# Save RDS that create plot

```{r}
saveRDS(MultiCultiGrowthRatePURExpFit, file.path(RDSPlotPath, paste(Project, "Plot_Growthrate_1.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)

saveRDS(GRCplatt_PredictGrowth30, file.path(RDSPlotPath, paste(Project, "Plot_Growthrate_2.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)

saveRDS(GRCplatt_PredictGrowth90, file.path(RDSPlotPath, paste(Project, "Plot_Growthrate_3.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)

saveRDS(GRCplatt_PredictGrowth180, file.path(RDSPlotPath, paste(Project, "Plot_Growthrate_4.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)

saveRDS(GRCplatt_PredictGrowth300, file.path(RDSPlotPath, paste(Project, "Plot_Growthrate_5", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)
```

# Save plot 

```{r save plot}
ggsave(file = file.path(PlotsPath, paste("GrowthRate_Plot",".png",sep = "")), height=10, width= 8,  dpi = 300, limitsize = TRUE)
```

# Save rds for further analysis

```{r save rds}
saveRDS(MultiCultiGrowthRatePURExp, file.path(DataOut, paste(Project, "Processed_GrowthRate.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)
```



# Statistics

The likelihood-ratio test in statistics compares the goodness of fit of two nested regression models based on the ratio of their likelihoods, specifically one obtained by maximization over the entire parameter space and another obtained after imposing some constraint.
To see if these two models differ significantly, we can use a likelihood ratio test with the following null and alternative hypotheses.

H0: Both the full and nested models fit the data equally well. As a result, you should employ the nested model. #jezeli nie ma roznic, to nie trzeba dodawac ekstra czynnika
H1: The full model significantly outperforms the nested model in terms of data fit. As a result, you should use the entire model.


```{r}
fullmodel <- glm(mpg ~ cyl + disp + hp + wt, data = mtcars)
reducedmodel <- glm(mpg ~ cyl + disp, data = mtcars)

library(lmtest) #Likelihood Ratio Test
lrtest(fullmodel, reducedmodel)
```

ANOVA testing whether the more complex model is significantly better at capturing the data than the simpler model. 

```{r}
library(agricolae)
data("PlantGrowth")
plant.lm <- lm(weight ~ group, data = PlantGrowth)
plant.av <- aov(plant.lm)
#plant.av <- aov(weight ~ group, data = PlantGrowth) #gives the same result
summary(plant.av)

tukey.test <- TukeyHSD(plant.av)
tukey.test

summary(lm(weight ~ group, data = PlantGrowth))
```

```{r}
library(agricolae)
data(sweetpotato)
model<-aov(yield~virus, data=sweetpotato)
out <- HSD.test(model,"virus", group=TRUE,console=TRUE)
plot(out)
```







# Removed unneccessary df from the environment

```{r}
rm(MultiCultiGrowthRatePURExpFit30, MultiCultiGrowthRatePURExpFit90, MultiCultiGrowthRatePURExpFit180, MultiCultiGrowthRatePURExpFit300, MultiCultiGrowthRatePURExpFit900, GRCplatt_PredictGrowth30, GRCplatt_PredictGrowth90, GRCplatt_PredictGrowth180, GRCplatt_PredictGrowth300, GRCplatt_PredictGrowth900, OLISSpectra, MultiCultiGrowth, GRCplatt_PredictGrowth, MultiCultiGrowthRatePURExpFit, tmaxAG, tMaxAGLines_056, tMaxAGLines_077, tMaxAGLines_048, tMaxAGLines_127)
```



```{r}
MultiCultiGrowthRatePURExpFitNested <- MultiCultiGrowthRatePURExpFit %>%    
  # filter(Par_ue ==900) %>% 
  nest(data = -c("Strain", "PhotonDose", "Par_ue")) %>%  
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PhotonDose_value, a, b, Pmax),
                                                    data = .x,
                                                    start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),
                                                    lower = c(0, 0, 0)))) %>%    
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance)))
```

```{r}
MultiCultiGrowthRatePURExpFitNested %>% 
  unnest(GRCplatt_Predict, .sep = "_") %>% 
  unnest(data) %>% 
  ggplot() +
  geom_line(aes(x = GRCplatt_Predict_PhotonDose_value, y = GRCplatt_Predict_.fitted, color = as.factor(Par_ue))) +
  geom_point(aes(x = GRCplatt_Predict_PhotonDose_value, y = GRCplatt_Predict_deltaOD_Lmu_corr, color = as.factor(Par_ue))) +
  ggh4x::facet_nested(cols = vars(PhotonDose), rows = vars(Strain), labeller = label_parsed) +
  theme_bw()
```

```{r}
MultiCultiGrowthRatePURExpFitNested %>% 
  unnest(GRCplatt_Param) %>% 
  filter(PhotonDose %in% c("PAR")) %>% 
  # filter(term == "a") %>% 
  ggplot() +
  geom_point(aes(x = Par_ue, y = estimate, color = Strain)) +
  geom_line(aes(x = Par_ue, y = estimate, linetype = Strain)) +
  ggh4x::facet_nested(cols = vars(PhotonDose), rows = vars(term), labeller = label_parsed, scales = "free") +
  theme_bw()
```

```{r}
MultiCultiGrowthRatePURExpFitNested %>% 
  unnest(GRCplatt_Param) %>% 
  filter(PhotonDose %in% c("PAR")) %>% 
  # filter(term == "a") %>% 
  ggplot() +
  geom_point(aes(x = Strain, y = estimate, color = as.factor(Par_ue))) +
  # geom_line(aes(x = Par_ue, y = estimate, linetype = Strain)) +
  ggh4x::facet_nested(cols = vars(PhotonDose), rows = vars(term), labeller = label_parsed, scales = "free") +
  theme_bw()
```



