---
title: "Importing and tidying data from the <> fluorometer for Chl determination"
author: "Maximilian Berthold, Sylwia Sliwinska-Wilczewska, Naaman Oman, Mireille Savoie"
date: "`r format(Sys.Date())`"
output:
  html_document:
    df_print: paged
    code_folding: hide   
csl: plos-one.csl
---

*Some of the code used to create this R Notebook was refurbished from "PlateAbImport.Rmd" written by Maximilian Berthold, Douglas A. Campbell, Melissa L. Rioux, Sarah J Gore, and Alyson MacCormack.*



```{r}
Project <- "PicoBaltic"
DataOut <- file.path("..", "ImportedData", "Turner")
# DataType <- "Calibration"
# Catalog <- file.path("MURIS_catalog.csv")
# FileIDSingle <- "OD"
#ChloroGoogle <- "https://docs.google.com/spreadsheets/d/13mQm0B3siS65UuGjNdzvpHFomfuwn6aAg7dBoq1IqrM/edit#gid=0"
#DataIn <- file.path("..", "PicoDevice", "CC", fsep = .Platform$file.sep)

#FileID <- "ExperimentSummaryData"

FileEncode <- "UTF-8" 
Delimiter <- ","

HeaderRows <- 0
#AbsWL = c(680, 720, 750) #select OD's of interest from plategrowth.Rds
```

```{r}
library(tidyverse)
library(lubridate)
library(stringr)
library(broom)
library(knitr)
library(OneR)
library(zoo)
library(strucchange)

library(dplyr)
library(magrittr)
library(googledrive)
library(googlesheets4)
library(readxl)
```


Load metadatacatalog
```{r load local metadatacatalog, message = FALSE, warning = FALSE, echo=FALSE}
gs4_deauth()

# imagine this is the URL or ID of a Sheet readable by anyone (with a link)
# MultiCulti metadata
MetaData <- read_sheet("https://docs.google.com/spreadsheets/d/13mQm0B3siS65UuGjNdzvpHFomfuwn6aAg7dBoq1IqrM/edit#gid=0") %>%
  #mutate(Date = as.numeric(Date)) %>%
  mutate(DATE = ymd(`DATE`)) 
  #mutate(StartExDate = ymd(`StartExDate`)) 
  # mutate(StartExDate = ymd(`StartExDate`))
# %>%
```

Load Multiculti catalog
```{r load local multiculticatalog, message = FALSE, warning = FALSE, echo=FALSE}
gs4_deauth()

# imagine this is the URL or ID of a Sheet readable by anyone (with a link)
# MultiCulti metadata
Catalog <- read_sheet("https://docs.google.com/spreadsheets/d/1ZXpwR7Gfto-uRzVdXzMpQF4frbrvMLH_IyLqonFZRSw/edit#gid=0") %>%
  # read_sheet has an annoying "feature" to set the type of columns it can't parse to a list.
  # ggplot/dplyr doesn't like working with a dataframe of lists.
  # In this case WL is set to a list since some values are numbers, some are strings, some are blank.
  # To fix this, first drop all rows missing WL, then unlist.
  # Must first drop NA rows since unlist will collapse NULL lists, then the unlisted WL is a shorter length than original WL column, which mutate doesn't like.
  drop_na(WL) %>%
  mutate(WL = unlist(WL))

as.data.frame(Catalog)

Catalog <- Catalog %>%
   mutate(ExpDate = ymd(ExpDate),
          ExpEndDate = ymd_hms(`ExpEndDate`))
```

```{r set colours}
Wavelengths_nm = c(445, 470, 505, 535, 590)
Colours_nm = c("darkblue", "dodgerblue", "darkgreen", "yellowgreen",  "darkorange")


names(Colours_nm) <- Wavelengths_nm
Colours_nm
```

```{r}
MetaDataAll <- MetaData %>%
  left_join(., Catalog, by = c("CultureID" = "ID"))
```


```{r load local catalog, message = FALSE, warning = FALSE, echo=FALSE}
#col_types specified for some columns as only the last few rows of a large dataset contained values for these columns and the values were not being read in properly
#there is probably a more robust way to deal with this issue
# MetaData <- read_csv("../MURIS_catalog.csv") %>%
#   rename(CultureID = id)
# 
# MetaData <- MetaData %>%
#   mutate(ExpSalinity = (((culture_inocul_L * source_salinity)+(media_inocul_L*salinity))/(culture_inocul_L+media_inocul_L)))
# 
# GrowthLong <- readRDS(file = file.path(DataFolder,paste(Project,FileIDSingle, "GrowthLong.Rds", sep  = "_"),fsep = .Platform$file.sep)) %>%
#   rename(CultureID = id) %>% 
#   mutate(ObsDate = format(datetime, format = "%Y-%m-%d")) 
#   #filter(E_hours == '0') %>% #select only E-hour == 0, as starting point for plate inoculation and following Solisense-analyses
#   
# 
# 
# 
# MetaGrowthData <- full_join(MetaData, GrowthLong) %>%
#   filter(E_hours != 'NA')
# 
# MediaBlank <- readRDS(file = file.path(DataFolder,paste(Project, "MediaBlankAll.Rds", sep  = "_"),fsep = .Platform$file.sep)) %>%
#   group_by(Wavelength, ExpSalinity) %>%
#   summarise(MeanBlankOD = mean(OD))
# 
# MetaGrowthBlank <- left_join(MetaGrowthData, MediaBlank, by = c("ExpSalinity", "Wavelength")) %>%
#   filter(Wavelength %in% AbsWL) 
# 
# GrowthLong <- readRDS(file = file.path(DataFolder,paste(Project,FileIDSingle, "GrowthLong.Rds", sep  = "_"),fsep = .Platform$file.sep))
# 
# GrowthLong <- GrowthLong %>%
#   mutate(CorrOD = if_else(CorrOD < 0.001, 0.001, CorrOD)) %>% #experimentally test to set values below 0.001 to 0.001 (~detection limit device)
#   mutate(ObsDate = format(datetime, format = "%Y-%m-%d")) %>%
#   mutate(ObsDate = ymd(ObsDate)) %>%
#   filter(Wavelength %in% AbsWL)

```

```{r data read adds filename and cdate, warning=FALSE, message=FALSE, echo=FALSE}
gs4_deauth()
#ChloroData <- read_sheet(ChloroGoogle)

ChlTurner <- MetaDataAll %>%
  mutate(Chl_intercept = as.double(Chl_intercept)) %>%
  mutate(Chl_slope = as.double(Chl_slope)) %>%
  mutate(Reading_rfu = as.double(Reading_rfu)) %>%
    mutate(SolventVol_ul = as.double(SolventVol_ul)) %>%
    mutate(SampleVol_ul = as.double(SampleVol_ul)) %>%
  #mutate(ChlDateTime = ymd_hms(paste(DATE, TIME))) %>%
  #rename(ObsDate = DATE, ObsTime = TIME, id = CultureID) %>%
  #mutate(ObsDate = ymd(ObsDate)) %>%
  mutate(Chl_dil = (Reading_rfu - Chl_intercept)/Chl_slope,
         Chl_ugL = Chl_dil * ((SolventVol_ul + SampleVol_ul)/SampleVol_ul),
         Chl_ugmL = Chl_ugL/1000) 

```

```{r}
ChlTurnerAll <- ChlTurner %>%

group_by(CultureID, DATE, TIME) %>%

# summarize(CultureID, DATE, TIME, SampleVol_ul, SolventVol_ul, Reading_rfu, Chl_intercept, Chl_slope, Chl_dil, Chl_ugL, Chl_ugmL, meanChl_ugmL = mean(Chl_ugmL), seChl_ugmL = sd(Chl_ugmL)/n()^(1/2), sdChl_ugmL = sd(Chl_ugmL))

summarize(CultureID, DATE, TIME, SampleVol_ul, SolventVol_ul, Reading_rfu, Run, Strain, InnocDate, ExpDate, Par_ue, Photoperiod, `Calculated_µmolPhotons_m-2d-1`, Tube, O2, WL, LightShape, ExpEndDate, Chl_dil, Chl_ugL, Chl_ugmL, meanChl_ugmL = mean(Chl_ugmL), seChl_ugmL = sd(Chl_ugmL)/n()^(1/2), sdChl_ugmL = sd(Chl_ugmL)) %>%

ungroup() %>% 
  
group_by(CultureID) %>%
  arrange(DATE) %>%
  mutate(E_days = as.numeric((DATE - ExpDate[1]))) %>%
ungroup()

# Designations:
# StartExDate <- day indicating the start of the multiculti experiment
# DATE <- day the sample on the Turner was tested
# TIME <- hour the sample on the Turner was tested
# ExDay <- day of the experiment on which the sample was taken - metadata
# E_days <- day of the experiment on which the sample was taken using R
# InnocDate <- day indicating the innoculation of the multiculti experiment
# ExpDate <- day indicating the start of the multiculti experiment (same as StartExDate)
```


WW Photoperiod Plots
```{r prelimplots, warning=FALSE, fig.height = 6, fig.width = 8}

# Par_ue.labs <- c("30 µE", "90 µE", "180 µE", "300 µE", "900 µE")
# names(Par_ue.labs) <- c("30", "90", "180", "300", "900")


Plot <- ChlTurnerAll %>%
  filter(Strain != "BA120R",
         Strain != "BA124G",
         Strain != "BA132R",
         Strain != "BA60G",
         Strain != "MIT9313",
         Strain != "MED4",
         Strain != "SS120") %>%
  filter(WL == "WW") %>%
  filter(Par_ue != "600") %>%
  filter(Run != "32",
         Run != "34",
         Run != "37",
         Run != "38",
         Run != "54",
         Run != "55",
         Run != "58",
         Run != "64",
         Run != "67",
         Run != "75") %>%
    ggplot() +
  geom_point(aes(x = E_days, y = meanChl_ugmL, label = CultureID)) +
  geom_errorbar(aes(x = E_days, ymin = meanChl_ugmL-sdChl_ugmL, ymax = meanChl_ugmL+sdChl_ugmL)) +
  scale_color_manual(values = Colours_nm) +
  guides(colour = FALSE) +
  labs(y = "Chlorophyll content (µg" ~mL^-1~")", x = "Time (d)") +
  scale_x_continuous(breaks=seq(0, 8, by = 2)) +
  coord_cartesian(xlim = c (0, 8)) +
  ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Strain, Photoperiod), labeller = labeller(Ex_WL = label_both, strain = label_value, Par_ue = label_both, WL = label_both, Photoperiod = label_value)) +
  #scale_x_continuous(limits = c(0,160)) +
  theme_bw()
Plot


Plot <- ChlTurnerAll %>%
  filter(Strain == "BA48R"|
         Strain == "BA127R"|
         Strain == "BA56G"|
         Strain == "BA77G") %>%
  filter(Run != "64",
         Run != "67") %>%
  filter(WL == "WW") %>%
  filter(Par_ue != "60",
         Par_ue != "600") %>% 
  # filter (E_days != 14,
  #         E_days != 0,
  #         E_days != 1,
  #         E_days != 2,
  #         E_days != 5,
  #         E_days != 8,
  #         E_days != 4) %>% 
  filter (E_days == 3|
          E_days == 6|
          E_days == 7) %>%
    ggplot() +
  geom_point(aes(x = Par_ue, y = meanChl_ugmL, label = CultureID)) +
  geom_errorbar(aes(x = Par_ue, ymin = meanChl_ugmL-sdChl_ugmL, ymax = meanChl_ugmL+sdChl_ugmL)) +
  scale_color_manual(values = Colours_nm) +
  guides(colour = FALSE) +
  labs(y = "Chlorophyll content (µg" ~mL^-1~")", x = "Growth Light (µmol photons" ~m^-2 ~s^-1~")") +
  #scale_x_continuous(breaks=seq(8, 24, by = 4)) +
  #coord_cartesian(xlim = c (6, 26)) +
  ggh4x::facet_nested(rows = vars(Photoperiod), cols = vars(Strain), labeller = labeller(Ex_WL = label_both, strain = label_value, Par_ue = label_both, WL = label_both, Photoperiod = label_both)) +
  #scale_x_continuous(limits = c(0,160)) +
  theme_bw()
Plot


Plot <- ChlTurnerAll %>%
  filter(Strain == "BA48R"|
         Strain == "BA127R"|
         Strain == "BA56G"|
         Strain == "BA77G") %>%
  filter(Run != "64",
         Run != "67") %>%
  filter(WL == "WW") %>%
  filter(Par_ue != "60",
         Par_ue != "600") %>% 
  filter (E_days == 14) %>% 
    ggplot() +
  geom_point(aes(x = Par_ue, y = meanChl_ugmL, label = CultureID)) +
  geom_errorbar(aes(x = Par_ue, ymin = meanChl_ugmL-sdChl_ugmL, ymax = meanChl_ugmL+sdChl_ugmL)) +
  scale_color_manual(values = Colours_nm) +
  guides(colour = FALSE) +
  labs(y = "Chlorophyll content (µg" ~mL^-1~")", x = "Growth Light (µmol photons" ~m^-2 ~s^-1~")") +
  #scale_x_continuous(breaks=seq(8, 24, by = 4)) +
  #coord_cartesian(xlim = c (6, 26)) +
  ggh4x::facet_nested(rows = vars(Photoperiod), cols = vars(Strain, E_days), labeller = labeller(Ex_WL = label_both, strain = label_value, Par_ue = label_both, WL = label_both, Photoperiod = label_both, E_days = label_both)) +
  #scale_x_continuous(limits = c(0,160)) +
  theme_bw()
Plot




```

CCA Plot
```{r fig.height = 6, fig.width = 8, echo = FALSE}

Plot <- ChlTurnerAll %>%
  filter(Strain != "BA120R",
         Strain != "BA124G",
         Strain != "BA132R",
         Strain != "BA60G",
         Strain != "MIT9313",
         Strain != "MED4",
         Strain != "SS120") %>%
  filter(WL != "WW") %>%
  filter(Par_ue != "180") %>%
  filter(Run != "32",
         Run != "34",
         Run != "37",
         Run != "38",
         Run != "54",
         Run != "55",
         Run != "58",
         Run != "64",
         Run != "67",
         Run != "75") %>%
  # filter(Run != "59",
  #        Run != "63") %>%
  ggplot() +
  geom_point(aes(x = Par_ue, y = meanChl_ugmL, label = CultureID)) +
  geom_errorbar(aes(x = Par_ue, ymin = meanChl_ugmL-sdChl_ugmL, ymax = meanChl_ugmL+sdChl_ugmL)) +
  #geom_text(aes(x = E_days, y = meanChl_ugmL, label= Run),alpha = 0.5 ,hjust=0, vjust=0) +
  scale_color_manual(values = Colours_nm) +
  guides(colour = FALSE) +
  labs(y = "Chlorophyll content (µg" ~mL^-1~")", x = "Growth Light (µmol photons" ~m^-2 ~s^-1~")") +
  #scale_x_continuous(breaks=seq(8, 24, by = 4)) +
  #coord_cartesian(xlim = c (6, 26)) +
  ggh4x::facet_nested(rows = vars(Photoperiod), cols = vars(Strain, WL), labeller = labeller(Ex_WL = label_both, strain = label_value, Par_ue = label_both, WL = label_both, Photoperiod = label_both)) +
  #scale_x_continuous(limits = c(0,160)) +
  theme_bw()
Plot



Plot <- ChlTurnerAll %>%
  filter(Run == "56"|
         Run == "59"|
         Run == "63"|
         Run == "68"|
         Run == "70") %>%
  ggplot() +
  geom_point(aes(x = E_days, y = meanChl_ugmL, label = CultureID)) +
  geom_errorbar(aes(x = E_days, ymin = meanChl_ugmL-sdChl_ugmL, ymax = meanChl_ugmL+sdChl_ugmL)) +
  #geom_text(aes(x = E_days, y = meanChl_ugmL, label= Run),alpha = 0.5 ,hjust=0, vjust=0) +
  scale_color_manual(values = Colours_nm) +
  guides(colour = FALSE) +
  labs(y = "Chlorophyll content (µg" ~mL^-1~")", x = "Time (d)") +
  #scale_x_continuous(breaks=seq(8, 24, by = 4)) +
  #coord_cartesian(xlim = c (6, 26)) +
  ggh4x::facet_nested(rows = vars(WL), cols = vars(Strain, Par_ue), labeller = labeller(Ex_WL = label_both, strain = label_value, Par_ue = label_both, WL = label_both, Photoperiod = label_value)) +
  #scale_x_continuous(limits = c(0,160)) +
  theme_bw()
Plot



Plot <- ChlTurnerAll %>%
  filter(Run == "68") %>%
  ggplot() +
  geom_point(aes(x = Par_ue, y = meanChl_ugmL, label = CultureID)) +
  geom_errorbar(aes(x = Par_ue, ymin = meanChl_ugmL-sdChl_ugmL, ymax = meanChl_ugmL+sdChl_ugmL)) +
  #geom_text(aes(x = E_days, y = meanChl_ugmL, label= Run),alpha = 0.5 ,hjust=0, vjust=0) +
  scale_color_manual(values = Colours_nm) +
  guides(colour = FALSE) +
  labs(y = "Chlorophyll content (µg" ~mL^-1~")", x = "Growth Light (µmol photons" ~m^-2 ~s^-1~")") +
  #scale_x_continuous(breaks=seq(8, 24, by = 4)) +
  #coord_cartesian(xlim = c (6, 26)) +
  ggh4x::facet_nested(rows = vars(Photoperiod), cols = vars(Strain, WL), labeller = labeller(Ex_WL = label_both, strain = label_value, Par_ue = label_both, WL = label_both, Photoperiod = label_both)) +
  #scale_x_continuous(limits = c(0,160)) +
  theme_bw()
Plot

```



Color light Plot
```{r fig.height = 6, fig.width = 8, echo = FALSE}
O2.labs <- c("Oxygen level: high", "Oxygen level: low", "Oxygen level: high")
names(O2.labs) <- c("21", "0", "21")
Plot <- ChlTurnerAll %>%
  filter(Strain != "BA120R",
         Strain != "BA124G",
         Strain != "BA132R",
         Strain != "BA60G",
         Strain != "MIT9313",
         Strain != "MED4",
         Strain != "SS120") %>%
  filter(WL != "WW") %>%
  filter(Par_ue != "60",
         Par_ue != "300") %>%
  filter(Run != "32",
         Run != "34",
         Run != "37",
         Run != "38",
         Run != "54",
         Run != "55",
         Run != "58",
         Run != "64",
         Run != "67",
         Run != "75") %>%
  ggplot() +
  geom_point(aes(x = E_days, y = meanChl_ugmL, label = CultureID)) +
  geom_errorbar(aes(x = E_days, ymin = meanChl_ugmL-sdChl_ugmL, ymax = meanChl_ugmL+sdChl_ugmL)) +
  scale_color_manual(values = Colours_nm) +
  guides(colour = FALSE) +
  labs(y = "Chlorophyll content (µg" ~mL^-1~")", x = "Time (d)") +
  #scale_x_continuous(breaks=seq(8, 24, by = 4)) +
  #coord_cartesian(xlim = c (6, 26)) +
  ggh4x::facet_nested(rows = vars(WL), cols = vars(Strain, O2), labeller = labeller(Ex_WL = label_both, strain = label_value, Par_ue = label_both, WL = label_both, Photoperiod = label_both, O2 = O2.labs)) +
  #scale_x_continuous(limits = c(0,160)) +
  theme_bw()
Plot



O2.labs <- c("Oxygen level: high", "Oxygen level: low", "Oxygen level: high")
names(O2.labs) <- c("21", "0", "21")
Plot <- ChlTurnerAll %>%
  mutate(WLNum = if_else(WL == "WW", 750, as.numeric(WL))) %>%
  filter(Run == "57"|
         Run == "61"|
         Run == "76") %>%
  filter(WL != "WW") %>% 
  filter(E_days == 7|
         E_days == 8) %>% 
  ggplot() +
  geom_point(aes(x = WLNum, y = meanChl_ugmL, label = CultureID)) +
  geom_line(aes(x = WLNum, y = meanChl_ugmL, label = CultureID), color = 'black') +
  geom_errorbar(aes(x = WLNum, ymin = meanChl_ugmL-sdChl_ugmL, ymax = meanChl_ugmL+sdChl_ugmL)) +
  scale_color_manual(values = Colours_nm) +
  guides(colour = FALSE) +
  labs(y = "Chlorophyll content (µg" ~mL^-1~")", x = "Wavelength (nm)") +
  #scale_x_continuous(breaks=seq(8, 24, by = 4)) +
  #coord_cartesian(xlim = c (6, 26)) +
  ggh4x::facet_nested(rows = vars(Photoperiod), cols = vars(Strain, O2), labeller = labeller(Ex_WL = label_both, strain = label_value, Par_ue = label_both, WL = label_both, Photoperiod = label_both, O2 = O2.labs)) +
  #scale_x_continuous(limits = c(0,160)) +
  theme_bw()
Plot

```
```{r}
colnames(ChlTurnerAll)

ChlTurnerAll<-ChlTurnerAll %>% 
  rename(PhotonDose="Calculated_µmolPhotons_m-2d-1") %>%
  rename(ObsDate=DATE) %>%
  rename(ObsTime=TIME) %>%
  select(-c(Chl_dil,seChl_ugmL))
```


```{r}
saveRDS(ChlTurnerAll, file.path(DataOut, paste(Project, "ChlTurner.Rds", sep = "_"), fsep = .Platform$file.sep))

```






Chl Turner correlation file
```{r}
Project <- "PicoBaltic"
DataOut <- file.path("..", "ImportedData", "Turner")

FileEncode <- "UTF-8" 
Delimiter <- ","

HeaderRows <- 0
```

Chl Turner correlation file
```{r load local metadatacatalog, message = FALSE, warning = FALSE, echo=FALSE}
gs4_deauth()

MetaDataTurner <- read_sheet("https://docs.google.com/spreadsheets/d/1JvcZ8dgPwDMfF9SqTijzxCmXXPxCuXiwdgPqqlkTi4o/edit#gid=0") %>%
  #mutate(Date = as.numeric(Date)) %>%
  mutate(DATE = ymd(`DATE`)) 
```

Chl Turner correlation file
```{r}
gs4_deauth()

ChlTurner <- MetaDataTurner %>%
  mutate(Dilution = as.character(Dilution)) %>%
  mutate(Chl_intercept = as.double(Chl_intercept)) %>%
  mutate(Chl_slope = as.double(Chl_slope)) %>%
  mutate(Reading_rfu = as.double(Reading_rfu)) %>%
  
  mutate(Chl_dil = (Reading_rfu - Chl_intercept)/Chl_slope,
         Chl_ugL = Chl_dil * ((SolventVol_ul + SampleVol_ul)/SampleVol_ul),
         Chl_ugmL = Chl_ugL/1000) 
```

Chl Turner correlation file
```{r}
ChlTurnerCorrelation <- ChlTurner %>%

group_by(Strain, DATE, TIME) %>%
summarize(Strain, Dilution, DATE, TIME, Chl_dil, Chl_ugL, Chl_ugmL, meanChl_ugmL = mean(Chl_ugmL), seChl_ugmL = sd(Chl_ugmL)/n()^(1/2), sdChl_ugmL = sd(Chl_ugmL)) %>%
ungroup() 
```
```{r}
colnames(ChlTurnerCorrelation)

ChlTurnerCorrelation<-ChlTurnerCorrelation %>% 
  rename(ObsDate=DATE) %>%
  rename(ObsTime=TIME) %>%
  select(-c(Chl_dil,seChl_ugmL))
```


```{r}
saveRDS(ChlTurnerCorrelation, file.path(DataOut, paste(Project, "ChlTurnerCorrelation.Rds", sep = "_"), fsep = .Platform$file.sep))

```



