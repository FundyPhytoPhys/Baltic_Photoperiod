---
title: "Import OLIS spectral data data"
author: "Sylwia Sliwinska-Wilczewska"
date: "`r format(Sys.Date())`"
output:
  html_document:
    df_print: paged
---



```{r setup, include = FALSE}
# knitr::opts_chunk$set(echo = TRUE, message = FALSE)
# knitr::opts_chunk$set(fig.path='Figs/')
```

```{r set project variables}
Project <- "PicoBaltic"
DataOut <- file.path("..", "ImportedData", "SySlmanuscriptWWPhotoperiod")
#DataIn <- file.path("..", "OLISSpectraCorr", "WWPhotoperiodSingle", fsep = .Platform$file.sep)
#FileID <- "Smooth"
FileEncode <- "UTF-8" 
Delimiter <- ""
HeaderRows <- 0
```


```{r load libraries} 
# libraries; Note check actual dependencies
library(tidyverse)
library(lubridate)
library(stringr)
library(broom)
library(knitr)
library(OneR)
library(zoo)
library(strucchange)

library(dplyr)
library(magrittr)
library(googledrive)
library(googlesheets4)
library(readxl)

library(ggspectra)
library(ggpubr)
library(caret)

library(photobiologyWavebands)
library(reshape2)
library(photobiology)

library(gcookbook)
library(RColorBrewer)
library(viridis)
library(scales)

library(reshape)
library(patchwork)
library(minpack.lm)
library(Cairo) #for greek symbols

```


```{r set colours}
Wavelengths_nm = c(445, 470, 505, 535, 590)
Colours_nm = c("darkblue", "dodgerblue", "darkgreen", "yellowgreen",  "darkorange")

names(Colours_nm) <- Wavelengths_nm
Colours_nm

```
Load Multiculti catalog
```{r load local multiculticatalog, message = FALSE, warning = FALSE, echo=FALSE}
gs4_deauth()

MetaData <- read_sheet("https://docs.google.com/spreadsheets/d/1ZXpwR7Gfto-uRzVdXzMpQF4frbrvMLH_IyLqonFZRSw/edit#gid=0") %>%
  drop_na(WL) %>%
  mutate(WL = unlist(WL))

as.data.frame(MetaData)
MetaData <- MetaData %>%
   mutate(ExpDate = ymd(ExpDate),
          ExpEndDate = ymd_hms(`ExpEndDate`))
```


Open prevoius WWphotoperiod Rds 
```{r}
Project <- "PicoBaltic"
DataIn <- file.path("..", "ImportedData", "SySlmanuscriptWWPhotoperiod", fsep = .Platform$file.sep)
FileEncode <- "UTF-8"
Delimiter <- ","
HeaderRows <- 0
```


Exported Rmd only first time in session (I will clean this later)
```{r}
list.files(path = DataIn, pattern = Project, full.names = TRUE)
```
OLIS SPECTRA


Load previous choosen Olis file - for nice plot
```{r read ProcessFile}
#File choosen for spectra plot - 4 spectra only
OLISSpectraShortFile <- "../ImportedData/SySlmanuscriptWWPhotoperiod/PicoBaltic_OLISSpectraMetaAllPURShort.Rds"
OLISSpectraShortFileName <- str_split(string = OLISSpectraShortFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")
OLISSpectraShort <- readRDS(OLISSpectraShortFile)  %>%
  ungroup()

```

Changes in strain names - for nice plot
```{r}
OLISSpectraShort <- OLISSpectraShort %>%
      mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077"))
```

OLISSpectraMetaAllPURShort -> File choosen for spectra plot - 4 spectra only
Olis Plot
```{r fig.height = 6, fig.width = 8}

Par_ue.labs <- c("30 µE", "90 µE", "180 µE", "Phase of growth", "900 µE")
names(Par_ue.labs) <- c("30", "90", "180", "300", "900")

Photoperiod.labs <- c("8 h", "Photoperiod: 12 h", "16 h", "24 h")
names(Photoperiod.labs) <- c("8", "12", "16", "24")

E_days.labs <- c("Exponential", "Pre-stationary")
names(E_days.labs) <- c("3", "7")

Strain.labs <- c("PE-rich_127", "PC-rich_077")
names(Strain.labs) <- c("PE-rich_127", "PC-rich_077")

data_textPUR0 <- data.frame(Par_ue = c(300, 300), E_days = c(3, 7), Strain  = c("PE-rich_127", "PE-rich_127"), Photoperiod = c(12), label = c('PAR = 300 µE', 'PAR = 300 µE'))

data_textPUR1 <- data.frame(Par_ue = c(300, 300), E_days = c(3, 7), Strain  = c("PE-rich_127", "PE-rich_127"), Photoperiod = c(12), label = c('PUR (PE-rich) = 176 µE', 'PUR (PE-rich) = 129 µE'))

data_textPUR2 <- data.frame(Par_ue = c(300, 300), E_days = c(3, 7), Strain  = c("PE-rich_127", "PE-rich_127"), Photoperiod = c(12), label = c('PUR (PC-rich) = 139 µE', 'PUR (PC-rich) = 128 µE'))

data_textpigment1 <- data.frame(Par_ue = c(300), E_days = c(3), Strain  = c("PE-rich_127"), Photoperiod = c(12), label = c('Chl a 440 nm'))
data_textpigment2 <- data.frame(Par_ue = c(300), E_days = c(3), Strain  = c("PE-rich_127"), Photoperiod = c(12), label = c('PEB-rich PE 570 nm'))
data_textpigment3 <- data.frame(Par_ue = c(300), E_days = c(3), Strain  = c("PE-rich_127"), Photoperiod = c(12), label = c('Chl a 680 nm'))
data_textpigment4 <- data.frame(Par_ue = c(300), E_days = c(3), Strain  = c("PE-rich_127"), Photoperiod = c(12), label = c('PCB-rich PC 620 nm'))
data_textpigment5 <- data.frame(Par_ue = c(300), E_days = c(3), Strain  = c("PE-rich_127"), Photoperiod = c(12), label = c('Car 480 nm'))
data_textpigment6 <- data.frame(Par_ue = c(300), E_days = c(3), Strain  = c("PE-rich_127"), Photoperiod = c(12), label = c('PUB-rich PE or PC 500 nm'))

arrowdf1 <- tibble(Strain = "PE-rich_127", E_days = 3, Par_ue = 300)
arrowdf2 <- tibble(Strain = "PE-rich_127", E_days = 3, Par_ue = 300)
arrowdf3 <- tibble(Strain = "PE-rich_127", E_days = 3, Par_ue = 300)
arrowdf4 <- tibble(Strain = "PE-rich_127", E_days = 3, Par_ue = 300)
arrowdf5 <- tibble(Strain = "PE-rich_127", E_days = 3, Par_ue = 300)
arrowdf6 <- tibble(Strain = "PE-rich_127", E_days = 3, Par_ue = 300)


OLISSpectraShort %>%
  filter(Photoperiod == "12") %>%
  filter(Strain == "PE-rich_127" | Strain == "PC-rich_077") %>%
  filter(Par_ue == 300) %>%
  filter(E_days == "3" | E_days == "7") %>%
  ggplot() +
  geom_area(aes(x = nm, y = EmNormJaz439, fill = "gray84"), alpha = 0.6, show.legend = F) +
  geom_area(aes(x = nm, y = PURNormBA127R, fill = "brown4"), alpha = 0.5, show.legend = F) +
  geom_area(aes(x = nm, y = PURNormBA77G, fill = "palegreen3"), alpha = 0.5, show.legend = F) +
  geom_line(aes(x = nm, y = AbsNorm440, colour = as.factor(Strain), linetype = as.factor(Strain)), show.legend = F, size = 0.7) +

  geom_text(data=data_textPUR0, aes(x=435, y=1.26, label=label), size=3.5) +
  geom_text(data=data_textPUR1, aes(x=462, y=1.21, label=label), size=3.5) +
  geom_text(data=data_textPUR2, aes(x=462, y=1.16, label=label), size=3.5) +

  geom_text(data=data_textpigment1, aes(x=450, y=1.07, label=label), size=4, colour = "darkgreen") + #chla440
  geom_text(data=data_textpigment5, aes(x=430, y=0.36, label=label), size=4, colour = "coral3") + #Car
  geom_text(data=data_textpigment2, aes(x=520, y=0.92, label=label), size=4, colour = "darkmagenta") + #PE
  geom_text(data=data_textpigment3, aes(x=660, y=1.08, label=label), size=4, colour = "darkgreen") +#chla680
  geom_text(data=data_textpigment4, aes(x=605, y=1.0, label=label), size=4, colour = "deepskyblue4") + #PC
  geom_text(data=data_textpigment6, aes(x=485, y=0.08, label=label), size=4, colour = "sienna4") + #PUB

  geom_segment(data = arrowdf1,
               aes(x = 470, xend = 440, y = 1.04, yend = 1.02),
               colour = "darkgreen", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) + #chla440
    geom_segment(data = arrowdf5,
               aes(x = 450, xend = 470, y = 0.4, yend = 0.48),
               colour = "coral3", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) + #Car
  geom_segment(data = arrowdf2,
               aes(x = 538, xend = 568, y = 0.88, yend = 0.86),
               colour = "darkmagenta", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) + #PE
  geom_segment(data = arrowdf3,
               aes(x = 697, xend = 680, y = 1.05, yend = 0.92),
               colour = "darkgreen", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) + #chla680
  geom_segment(data = arrowdf4,
               aes(x = 632, xend = 630, y = 0.95, yend = 0.82),
               colour = "deepskyblue4", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) + #PC
  geom_segment(data = arrowdf4,
               aes(x = 465, xend = 500, y = 0.12, yend = 0.52),
               colour = "sienna4", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) + #PUB
  
  # scale_color_manual(values = c("BA127R" ="black", "BA48R" ="brown1", "BA56G" ="palegreen4", "BA77G" ="black")) +
  scale_color_manual(values = c("PE-rich_127" ="brown4", "PC-rich_077" ="palegreen3")) +
  scale_linetype_manual(values = c("PE-rich_127" ="longdash", "PC-rich_077" ="solid")) +
  stat_wl_strip(aes(x = nm), ymin = -Inf, ymax = -0.025, alpha = 0.5) + 
  scale_fill_identity() +
  
  labs(y = "Normalized absorbance", x = "Wavelength (nm)") +
  scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  coord_cartesian(ylim = c (-0.01, 1.25)) +

  
  ggh4x::facet_nested(cols = vars(Par_ue, E_days), labeller = labeller(Ex_WL = label_both, WL = label_both, E_days = E_days.labs, Photoperiod = Photoperiod.labs, Par_ue = Par_ue.labs, Strain = Strain.labs)) +
  
  theme_bw() +
      theme(panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          panel.spacing.x = unit(0.4, 'cm'),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.title = element_blank(),
        legend.direction="horizontal",
        legend.position = c(0.08,0.97),
        legend.spacing.x = unit(0.01, 'cm'),
        legend.text.align = 0,
        #legend.key.height= unit(0.005, 'cm'),
        legend.key.width= unit(0.3, 'cm'),
        #plot.background = element_rect(colour = "dodgerblue4", size = 3),
        legend.text = element_text(size=10))

#ggsave(filename = file.path("..", "Output", "Plots", "WholeCellSpectra.png"), plot = WholeCellSpectraPlot)

ggsave(filename = file.path("..", "Output", "Plots", "WholeCellSpectra.png"), plot = last_plot())


```

# Olis Plot
```{r fig.height = 10, fig.width = 8}
Par_ue.labs <- c("30 µE", "90 µE", "180 µE", "Phase of growth", "900 µE")
names(Par_ue.labs) <- c("30", "90", "180", "300", "900")

Photoperiod.labs <- c("8 h", "Photoperiod: 12 h", "16 h", "24 h")
names(Photoperiod.labs) <- c("8", "12", "16", "24")

E_days.labs <- c("Exponential", "Pre-stationary")
names(E_days.labs) <- c("3", "7")

Strain.labs <- c("PC-rich", "PE-rich")
names(Strain.labs) <- c("PC-rich_077", "PE-rich_127")

O2.labs <- c("Strain")
names(O2.labs) <- c(21)

data_textPUR0 <- data.frame(Par_ue = c(300, 300), E_days = c(3, 7), Strain  = c("PE-rich_127", "PE-rich_127"), Photoperiod = c(12), O2 = c(21), label = c('PAR = 300 µE', 'PAR = 300 µE'))

data_textPUR00 <- data.frame(Par_ue = c(300, 300), E_days = c(3, 7), Strain  = c("PC-rich_077", "PC-rich_077"), Photoperiod = c(12), O2 = c(21), label = c('PAR = 300 µE', 'PAR = 300 µE'))

data_textPUR1 <- data.frame(Par_ue = c(300, 300), E_days = c(3, 7), Strain  = c("PE-rich_127", "PE-rich_127"), Photoperiod = c(12), O2 = c(21), label = c('PUR = 176 µE', 'PUR = 129 µE'))

data_textPUR2 <- data.frame(Par_ue = c(300, 300), E_days = c(3, 7), Strain  = c("PC-rich_077", "PC-rich_077"), Photoperiod = c(12), O2 = c(21), label = c('PUR = 139 µE', 'PUR = 128 µE'))

data_textpigment1 <- data.frame(Par_ue = c(300), E_days = c(3), Strain  = c("PC-rich_077"), Photoperiod = c(12), O2 = c(21), label = c('Chl a 440 nm'))
data_textpigment3 <- data.frame(Par_ue = c(300), E_days = c(3), Strain  = c("PC-rich_077"), Photoperiod = c(12), O2 = c(21), label = c('Chl a 680 nm'))
data_textpigment4 <- data.frame(Par_ue = c(300), E_days = c(3), Strain  = c("PC-rich_077"), Photoperiod = c(12), O2 = c(21), label = c('PCB-rich PC 620 nm'))
data_textpigment5 <- data.frame(Par_ue = c(300), E_days = c(3), Strain  = c("PC-rich_077"), Photoperiod = c(12), O2 = c(21), label = c('Car 480 nm'))
data_textpigment6 <- data.frame(Par_ue = c(300), E_days = c(3), Strain  = c("PC-rich_077"), Photoperiod = c(12), O2 = c(21), label = c('PUB-rich PC 500 nm'))

arrowdf1 <- tibble(Strain = "PC-rich_077", E_days = 3, Par_ue = 300, O2 = c(21))
arrowdf3 <- tibble(Strain = "PC-rich_077", E_days = 3, Par_ue = 300, O2 = c(21))
arrowdf4 <- tibble(Strain = "PC-rich_077", E_days = 3, Par_ue = 300, O2 = c(21))
arrowdf5 <- tibble(Strain = "PC-rich_077", E_days = 3, Par_ue = 300, O2 = c(21))
arrowdf6 <- tibble(Strain = "PC-rich_077", E_days = 3, Par_ue = 300, O2 = c(21))


data_textpigment7 <- data.frame(Par_ue = c(300), E_days = c(3), Strain  = c("PE-rich_127"), Photoperiod = c(12), O2 = c(21), label = c('Chl a 440 nm'))
data_textpigment8 <- data.frame(Par_ue = c(300), E_days = c(3), Strain  = c("PE-rich_127"), Photoperiod = c(12), O2 = c(21), label = c('Car 480 nm'))
data_textpigment9 <- data.frame(Par_ue = c(300), E_days = c(3), Strain  = c("PE-rich_127"), Photoperiod = c(12), O2 = c(21), label = c('PEB-rich PE 570 nm'))
data_textpigment10 <- data.frame(Par_ue = c(300), E_days = c(3), Strain  = c("PE-rich_127"), Photoperiod = c(12), O2 = c(21), label = c('Chl a 680 nm'))
data_textpigment11 <- data.frame(Par_ue = c(300), E_days = c(3), Strain  = c("PE-rich_127"), Photoperiod = c(12), O2 = c(21), label = c('PCB-rich PC 620 nm'))
data_textpigment12 <- data.frame(Par_ue = c(300), E_days = c(3), Strain  = c("PE-rich_127"), Photoperiod = c(12), O2 = c(21), label = c('PUB-rich PE 500 nm'))

arrowdf7 <- tibble(Strain = "PE-rich_127", E_days = 3, Par_ue = 300, O2 = c(21))
arrowdf8 <- tibble(Strain = "PE-rich_127", E_days = 3, Par_ue = 300, O2 = c(21))
arrowdf9 <- tibble(Strain = "PE-rich_127", E_days = 3, Par_ue = 300, O2 = c(21))
arrowdf10 <- tibble(Strain = "PE-rich_127", E_days = 3, Par_ue = 300, O2 = c(21))
arrowdf11 <- tibble(Strain = "PE-rich_127", E_days = 3, Par_ue = 300, O2 = c(21))
arrowdf12 <- tibble(Strain = "PE-rich_127", E_days = 3, Par_ue = 300, O2 = c(21))


Plot <- OLISSpectraShort %>%
  filter(Photoperiod == "12") %>%
  filter(Strain == "PC-rich_077" | Strain == "PE-rich_127") %>%
  filter(Par_ue == 300) %>%
  filter(E_days == "3" | E_days == "7") %>%
  ggplot() +

  geom_area(aes(x = nm, y = EmNormJaz439, fill = "gray84"), alpha = 0.6, show.legend = F) +
  geom_area(aes(x = nm, y = PURNormBA127R, fill = "brown4"), alpha = 0.5, show.legend = F) +
  geom_area(aes(x = nm, y = PURNormBA77G, fill = "palegreen3"), alpha = 0.5, show.legend = F) +
  geom_line(aes(x = nm, y = AbsNorm440, colour = as.factor(Strain), linetype = as.factor(Strain)), show.legend = F, size = 0.7) +

  geom_text(data=data_textPUR0, aes(x=446, y=1.26, label=label), size=3.7) +
  geom_text(data=data_textPUR00, aes(x=446, y=1.26, label=label), size=3.7) +
  geom_text(data=data_textPUR1, aes(x=446, y=1.21, label=label), size=3.7) +
  geom_text(data=data_textPUR2, aes(x=446, y=1.21, label=label), size=3.7) +

  geom_text(data=data_textpigment1, aes(x=500, y=1.1, label=label), size=4, colour = "darkgreen") + #chla440
  geom_text(data=data_textpigment5, aes(x=500, y=0.8, label=label), size=4, colour = "orange") + #Car
  geom_text(data=data_textpigment3, aes(x=650, y=1.2, label=label), size=4, colour = "darkgreen") +#chla680
  geom_text(data=data_textpigment4, aes(x=590, y=0.95, label=label), size=4, colour = "deepskyblue4") + #PC
  geom_text(data=data_textpigment6, aes(x=485, y=0.25, label=label), size=4, colour = "sienna4") + #PUB

  geom_segment(data = arrowdf1,
               aes(x = 480, xend = 445, y = 1.05, yend = 1),
               colour = "darkgreen", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) + #chla440
  geom_segment(data = arrowdf5,
               aes(x = 480, xend = 475, y = 0.75, yend = 0.54),
               colour = "orange", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) + #Car
  geom_segment(data = arrowdf3,
               aes(x = 660, xend = 680, y = 1.14, yend = 0.95),
               colour = "darkgreen", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) + #chla680
  geom_segment(data = arrowdf4,
               aes(x = 610, xend = 630, y = 0.90, yend = 0.82),
               colour = "deepskyblue4", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) + #PC
  geom_segment(data = arrowdf4,
               aes(x = 480, xend = 494, y = 0.30, yend = 0.41),
               colour = "sienna4", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) + #PUB

  
  geom_text(data=data_textpigment7, aes(x=500, y=1.1, label=label), size=4, colour = "darkgreen") + #chla440
  geom_text(data=data_textpigment8, aes(x=500, y=0.8, label=label), size=4, colour = "orange") + #Car
  geom_text(data=data_textpigment9, aes(x=580, y=1.0, label=label), size=4, colour = "darkmagenta") + #PE
  geom_text(data=data_textpigment10, aes(x=650, y=1.2, label=label), size=4, colour = "darkgreen") +#chla680
  geom_text(data=data_textpigment11, aes(x=600, y=0.17, label=label), size=4, colour = "deepskyblue4") + #PC
  geom_text(data=data_textpigment12, aes(x=495, y=0.30, label=label), size=4, colour = "sienna4") + #PUB

  geom_segment(data = arrowdf7,
               aes(x = 480, xend = 445, y = 1.05, yend = 1),
               colour = "darkgreen", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) + #chla440
  geom_segment(data = arrowdf8,
               aes(x = 480, xend = 475, y = 0.75, yend = 0.55),
               colour = "orange", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) + #Car
  geom_segment(data = arrowdf9,
               aes(x = 590, xend = 575, y = 0.95, yend = 0.85),
               colour = "darkmagenta", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) + #PE
  geom_segment(data = arrowdf10,
               aes(x = 660, xend = 680, y = 1.14, yend = 0.85),
               colour = "darkgreen", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) + #chla680
  geom_segment(data = arrowdf11,
               aes(x = 610, xend = 630, y = 0.2, yend = 0.3),
               colour = "deepskyblue4", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) + #PC
  geom_segment(data = arrowdf12,
               aes(x = 490, xend = 500, y = 0.35, yend = 0.52),
               colour = "sienna4", size = 1, alpha=0.9, arrow = arrow(length=unit(0.2, 'cm'))) + #PUB
  
  
  
  scale_color_manual(values = c("PC-rich_077" ="palegreen3", "PE-rich_127" ="brown4")) +
  scale_linetype_manual(values = c("PC-rich_077" ="solid", "PE-rich_127" ="longdash")) +

  stat_wl_strip(aes(x = nm), ymin = -Inf, ymax = -0.025, alpha = 0.5) +
  scale_fill_identity() +

  labs(y = "Normalized absorbance", x = "Wavelength (nm)") +
  scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  coord_cartesian(ylim = c (-0.01, 1.25)) +
  ggh4x::facet_nested(cols = vars(Par_ue, E_days), rows = vars(O2, Strain),labeller = labeller(Ex_WL = label_both, WL = label_both, E_days = E_days.labs, Photoperiod = Photoperiod.labs, Par_ue = Par_ue.labs, Strain = Strain.labs, O2 = O2.labs, )) +
  theme_bw() +
      theme(panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          panel.spacing.x = unit(0.4, 'cm'),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.title = element_blank(),
        legend.direction="horizontal",
        legend.position = c(0.08,0.97),
        legend.spacing.x = unit(0.01, 'cm'),
        legend.text.align = 0,
        #legend.key.height= unit(0.005, 'cm'),
        legend.key.width= unit(0.3, 'cm'),
        #plot.background = element_rect(colour = "dodgerblue4", size = 3),
        legend.text = element_text(size=10))
Plot


```
Delete unused stuff from environment
```{r}

rm(data_textpigment1,data_textpigment2,data_textpigment3,data_textpigment4,data_textpigment5,data_textpigment6, data_textpigment7, data_textpigment8, data_textpigment9, data_textpigment10, data_textpigment11, data_textpigment12, arrowdf1,arrowdf2,arrowdf3,arrowdf4,arrowdf5,arrowdf6, arrowdf7, arrowdf8, arrowdf9, arrowdf10, arrowdf11, arrowdf12, data_textPUR0, data_textPUR00, data_textPUR1,data_textPUR2)

```


GROWTH CURVE

Load previos Growth curve 
```{r read ProcessFile}

#data necessary for plot growth curve (round time) for all runs - contained od750, od680 and Actinic Par data
GrowthCurveFile <- "../ImportedData/SySlmanuscriptWWPhotoperiod/PicoBaltic_MultiCultiDataAllStrainsokAll.Rds"
GrowthCurveFileName <- str_split(string = GrowthCurveFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")
GrowthCurve <- readRDS(GrowthCurveFile)  %>%
  ungroup()

```

Only for nice plot - lines for tmaxAG 
#I will fix this - take data from existed df!
```{r}

data_vline1 <- data.frame(Par_ue= c(30, 90, 180, 300, 900,30, 90, 180, 300, 900,30, 90, 180, 300, 900,30, 90, 180, 300, 900),Photoperiod= c(8,8,8,8,8,12,12,12,12,12,16,16,16,16,16,24,24,24,24,24),facetsPar_ue= c("PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})"),facetsPhotoperiod= c("Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)"), value = c(347,321.02,240.90,187.92,168,347,245.39,189.48,162.62,168,347,168.39,113.76,111.56,110,154.64,114.68,93.32,93.78,110))

data_vline2 <- data.frame(Par_ue= c(30, 90, 180, 300, 900,30, 90, 180, 300, 900,30, 90, 180, 300, 900,30, 90, 180, 300, 900),Photoperiod= c(8,8,8,8,8,12,12,12,12,12,16,16,16,16,16,24,24,24,24,24),facetsPar_ue= c("PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})"),facetsPhotoperiod= c("Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)"), value = c(346,319.92,240.81,214.41,168,346,216.33,163.44,136.03,168,299.38,166.28,137.32,111.28,109.45,119.35,103.77,100.38,79.20,94.23))

data_vline3 <- data.frame(Par_ue= c(30, 90, 180, 300, 900,30, 90, 180, 300, 900,30, 90, 180, 300, 900,30, 90, 180, 300, 900),Photoperiod= c(8,8,8,8,8,12,12,12,12,12,16,16,16,16,16,24,24,24,24,24),facetsPar_ue= c("PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})"),facetsPhotoperiod= c("Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)"), value = c(345,347,266.84,240.72,168,345,296.45,217.80,191.03,168,345,191.49,114.95,112.75,108,157.85,120.27,110.28,95.79,79.66))

data_vline4 <- data.frame(Par_ue= c(30, 90, 180, 300, 900,30, 90, 180, 300, 900,30, 90, 180, 300, 900,30, 90, 180, 300, 900),Photoperiod= c(8,8,8,8,8,12,12,12,12,12,16,16,16,16,16,24,24,24,24,24),facetsPar_ue= c("PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})"),facetsPhotoperiod= c("Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)"), value = c(344, 345, 266.93, 215.42, 168,344, 244.38,190.39,163.62,168,299.57, 168.85, 137.50, 112.29, 107,138.78, 120.18, 108.08, 98.36, 107))

```


Choose growth curve, remove unused stuff, add facets and change strain name for nice plot
```{r}

GrowthCurveSmall <- GrowthCurve %>% 
  group_by(ID, timeRound) %>% 
  mutate(DeltaOD = meanOD680-meanOD720) %>% 
  ungroup()

GrowthCurveSmall <- GrowthCurveSmall %>%
  filter(Par_ue != 600) 

MultiCultiData1 <- GrowthCurveSmall %>%
  filter(Par_ue==900 & Photoperiod == 24) %>%
  filter(Run == 121)

MultiCultiData2 <- GrowthCurveSmall %>%
  filter(Par_ue==900 & Photoperiod == 8 | Photoperiod == 12| Photoperiod == 16) 

MultiCultiData3 <- GrowthCurveSmall %>%
  filter(Photoperiod==24 & Par_ue == 30 | Par_ue == 90 | Par_ue == 180 | Par_ue == 300) 

MultiCultiData4 <- GrowthCurveSmall %>% 
  filter(Photoperiod!=24) %>% 
  filter(Par_ue!=900)

GrowthCurveAll<- rbind(MultiCultiData1, MultiCultiData2, MultiCultiData3, MultiCultiData4)

rm(MultiCultiData1, MultiCultiData2, MultiCultiData3, MultiCultiData4, GrowthCurveSmall, GrowthCurve)


GrowthCurveAll$facetsPar_ue = factor(GrowthCurveAll$O2, labels = c("PAR~(µmol~photons~m^{-2}~s^{-1})"))

GrowthCurveAll$facetsPhotoperiod = factor(GrowthCurveAll$WL, labels = c("Photoperiod~(h)"))

GrowthCurveAll <- GrowthCurveAll %>% 
    mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077")) 

```


GrowthCurveAll - contained Growth curve - per strain combine with max growth
Growth curve plot
```{r fig.height = 8, fig.width = 8, warning = FALSE}


Plot <- GrowthCurveAll %>%
  #filter(timeRound <= 110) %>%
  ggplot() +
  geom_area(aes(x = timeRound, y = meanActinic_par), size = 0.1, fill = "tan1", alpha = 0.6) +
  geom_line(aes(x = timeRound, y = meanOD680, colour = as.factor(Strain)), size = 0.7, show.legend = T) +

  geom_vline(data = data_vline1, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  geom_vline(data = data_vline2, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  geom_vline(data = data_vline3, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = data_vline4, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +

  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="") +
  labs(y = "Optical density ("~OD[680]~")", x = "Elapsed time (h)") +

    # ggh4x::facet_nested(rows = vars(WL, Photoperiod), cols = vars(O2, Par_ue), labeller = labeller(Photoperiod = Photoperiod.labs,  Strain = label_value, Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs), scale="free_x") +
  
  ggh4x::facet_nested(cols = vars(facetsPhotoperiod, Photoperiod), rows = vars(facetsPar_ue, Par_ue), labeller = label_parsed, scale="free_x") +

  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.085,0.96),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.x = unit(0.01, 'cm'),
        #plot.background = element_rect(colour = "dodgerblue4", size = 3),
        legend.text = element_text(size=10))

Plot




Plot <- GrowthCurveAll %>%
  #filter(timeRound <= 110) %>%
  ggplot() +
  geom_area(aes(x = timeRound, y = meanActinic_par), size = 0.1, fill = "tan1", alpha = 0.6) +
  geom_line(aes(x = timeRound, y = meanOD680, colour = as.factor(Strain)), size = 0.7, show.legend = T) +

  geom_vline(data = data_vline1, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  geom_vline(data = data_vline2, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  geom_vline(data = data_vline3, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = data_vline4, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +

  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="") +
  labs(y = "Optical density ("~OD[680]~")", x = "Elapsed time (h)") +

    # ggh4x::facet_nested(rows = vars(WL, Photoperiod), cols = vars(O2, Par_ue), labeller = labeller(Photoperiod = Photoperiod.labs,  Strain = label_value, Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs), scale="free_x") +
  
  ggh4x::facet_nested(cols = vars(facetsPhotoperiod, Photoperiod), rows = vars(facetsPar_ue, Par_ue), labeller = label_parsed) +

  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.085,0.96),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.x = unit(0.01, 'cm'),
        #plot.background = element_rect(colour = "dodgerblue4", size = 3),
        legend.text = element_text(size=10))

Plot
```



GROWTH SYMMETRY


Load GS catalog
```{r load local multiculticatalog, message = FALSE, warning = FALSE, echo=FALSE}
gs4_deauth()

# GScatalog<- read_sheet("https://docs.google.com/spreadsheets/d/1ggM66cScp1w4-hEfCVA7GSbgmpYz-pfJRkBZkMwzWlI/edit#gid=0") 


GScatalog<- read_sheet("https://docs.google.com/spreadsheets/d/1JG_GvHuJBtGf4NfWBSrgm0GxM7EpFVLQG-BARl8Lw8A/edit#gid=0")

as.data.frame(GScatalog)
GScatalog <- GScatalog 

```

Prepare data - mutate as numeric, calculate AccLen/DecLen ratio (growth symmetry; GS) and percent (AccDecRatio)
```{r}
GScatalog <- GScatalog %>% 
    mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077")) %>% 
  mutate(Acc_perc = as.numeric(Acc_perc)) %>% 
  mutate(Dec_perc = as.numeric(Dec_perc)) %>% 
  mutate(AccDecRatio = Acc_perc/Dec_perc) %>% 

  mutate(Par_ue = as.numeric(Par_ue)) %>% 
  mutate(Photoperiod = as.numeric(Photoperiod)) %>%
  mutate(tMaxAG = as.numeric(tMaxAG)) %>%
  mutate(tMaxDG = as.numeric(tMaxDG)) %>%

  mutate(PhotoperiodTstart_h=as.numeric(PhotoperiodTstart_h)) %>% 
  mutate(PhotoperiodTend_h=as.numeric(PhotoperiodTend_h)) %>% 

  mutate(AccLen = tMaxDG-PhotoperiodTstart_h) %>% 
  mutate(DecLen = PhotoperiodTend_h-tMaxDG) %>% 
  mutate(GS = AccLen/DecLen) %>% 
  mutate(TDG = as.numeric(TDG)) 

  #mutate(GS_hRound = round(GS_h, digits = 0)) %>% 
  #mutate(GS = as.numeric(GS)) %>% 

  # mutate(tMaxAGI = round(tMaxAGI, digits = 0)) %>% 
  # mutate(tMaxDGI = round(tMaxDGI, digits = 0)) %>% 
  #mutate(Acceleration_len=as.numeric(Acceleration_len)) %>% 

  # mutate(PeakDay = tMaxDG/24) %>% 
  # mutate(PeakDay = round(PeakDay, digits = 0)) %>% 
  # mutate(PeakDay = as.numeric(PeakDay)) %>% 
  # mutate(Ratio = as.numeric(Ratio)) %>% 
  # mutate(Ratio=Ratio/100) 
 
```

calculate mean of GS from every day (every peak in exp and pre-stationary phase)
```{r}
colnames(GScatalog)

GScatalog2<-GScatalog %>% 
  # filter(DecLen>=0) %>% 
  # filter(AccLen>=0) %>% 
  # filter(GS>=0) %>% 
  filter(AccDecRatio<10) %>% 
  group_by(Strain, Photoperiod, Par_ue, Phase) %>%
  
  summarize(PhotoperiodTstart_h, PhotoperiodTend_h,tMaxDG,tMaxAG, Phase, AchivePreStationary, MaxDG, MaxAG, Acc_perc, Dec_perc, Strain, Par_ue, Photoperiod, O2, WL, OD680start, OD680end, TDG, AccDecRatio, AccLen, DecLen, GS, 
    
            meanAcc_perc = mean(Acc_perc), 
            sdAcc_perc = sd(Acc_perc),
            meanDec_perc = mean(Dec_perc), 
            sdDec_perc = sd(Dec_perc),

            meanAccLen = mean(AccLen), 
            sdAccLen = sd(AccLen),
            meanDecLen = mean(DecLen), 
            sdDecLen = sd(DecLen)) %>%  
  
  mutate(meanGS = meanAccLen/meanDecLen) %>% 
  mutate(meanAccDecRatio = meanAcc_perc/meanDec_perc) %>% 
  ungroup() 

#only for now - join with df with PUR - later
  GScatalog21 <- GScatalog2 %>%
  filter(Photoperiod != "24") %>% 
  mutate(PARPhotonDose =(Par_ue/2)*Photoperiod*3600)
  
  GScatalog22 <- GScatalog2 %>%
  filter(Photoperiod == "24") %>% 
  mutate(PARPhotonDose = Par_ue*Photoperiod*3600) 
  
  GScatalogAll <-rbind(GScatalog21, GScatalog22)

  rm(GScatalog2, GScatalog21, GScatalog22)

```


vertical lines without 24 photoperiod
```{r}

data_vline9 <- data.frame(Par_ue= c(30, 90, 180, 300, 900,30, 90, 180, 300, 900,30, 90, 180, 300, 900),Photoperiod= c(8,8,8,8,8,12,12,12,12,12,16,16,16,16,16),facets= c("PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})"),facets2= c("Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)"), value = c(347,321.02,240.90,187.92,110,347,245.39,189.48,162.62,110,347,168.39,113.76,111.56,110))

data_vline10 <- data.frame(Par_ue= c(30, 90, 180, 300, 900,30, 90, 180, 300, 900,30, 90, 180, 300, 900),Photoperiod= c(8,8,8,8,8,12,12,12,12,12,16,16,16,16,16),facets= c("PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})"),facets2= c("Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)"), value = c(346,319.92,240.81,214.41,109.5,346,216.33,163.44,136.03,109.5,299.38,166.28,137.32,111.28,109.45))

data_vline11 <- data.frame(Par_ue= c(30, 90, 180, 300, 900,30, 90, 180, 300, 900,30, 90, 180, 300, 900),Photoperiod= c(8,8,8,8,8,12,12,12,12,12,16,16,16,16,16),facets= c("PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})"),facets2= c("Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)"), value = c(345,347,266.84,240.72,109,345,296.45,217.80,191.03,109,345,191.49,114.95,112.75,108))

data_vline12 <- data.frame(Par_ue= c(30, 90, 180, 300, 900,30, 90, 180, 300, 900,30, 90, 180, 300, 900),Photoperiod= c(8,8,8,8,8,12,12,12,12,12,16,16,16,16,16),facets= c("PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})","PAR~(µmol~photons~m^{-2}~s^{-1})"),facets2= c("Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)","Photoperiod~(h)"), value = c(344, 345, 266.93, 215.42, 108.5,344, 244.38,190.39,163.62,108.5,299.57, 168.85, 137.50, 112.29, 107))

```

Create facets for nice plot
```{r}

GScatalogAll$facetsPar_ue = factor(GScatalogAll$O2, labels = c("PAR~(µmol~photons~m^{-2}~s^{-1})"))

GScatalogAll$facetsPhotoperiod = factor(GScatalogAll$WL, labels = c("Photoperiod~(h)"))

GScatalogAll$facetsStrain = factor(GScatalogAll$O2, labels = c("Strain"))

GScatalogAll$facetsPhase = factor(GScatalogAll$WL, labels = c("Phase~of~growth"))
```



TDG plot
```{r fig.height = 8, fig.width = 8, warning = FALSE}



# lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
# 
# Strain.labs <- c("PE-rich_127", "PE-rich_048", "PC-rich_056", "PC-rich_077")
# names(Strain.labs) <- c("BA127R", "BA48R", "BA56G", "BA77G")
# 
# Par_ue.labs <- c("30 µE", "90 µE", "180 µE", "300 µE", "900 µE")
# names(Par_ue.labs) <- c("30", "90", "180", "300", "900")
# WL.labs <- c("Strain")
# names(WL.labs) <- c("WW")
# O2.labs <- c("Light level")
# names(O2.labs) <- c(21)

#scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
Plot <- GScatalogAll %>%
  #filter(Photoperiod != 24) %>% 
  ggplot() +
  geom_point(aes(x = PhotoperiodTend_h, y = TDG, colour = as.factor(Strain)), size = 3.5, alpha = 0.8, show.legend = T) +
  geom_vline(data = data_vline9, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  geom_vline(data = data_vline10, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  geom_vline(data = data_vline11, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = data_vline12, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +
labs(y = "TDG ("~OD[680]~")", x = "Elapsed time (h)") +
  # scale_x_continuous(breaks=seq(0, 4000000, by = 1000000)) +
  # coord_cartesian(xlim = c(-100, 3300000)) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #   scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  theme_bw() 
Plot
```

Create df to show hline
```{r}
data_hlineGS8 <- data.frame(Photoperiod= c(8),facets2= c("Photoperiod~(h)"),value = c(4))
data_hlineGS12 <- data.frame(Photoperiod= c(12),facets2= c("Photoperiod~(h)"),value = c(6))
data_hlineGS16 <- data.frame(Photoperiod= c(16),facets2= c("Photoperiod~(h)"),value = c(8))
```


GS
```{r fig.height = 8, fig.width = 8, warning = FALSE}


scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))



Plot<-GScatalogAll %>%
  filter(Phase != "TP") %>% 
  #filter(meanGS<3) %>% 
  ggplot() +
  geom_point(aes(x = PARPhotonDose, y = meanGS, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.8, show.legend = T) +
  # geom_errorbar(aes(x = PARPhotonDose, ymin = meanGS_h - sdGS_h, ymax = meanGS_h + sdGS_h, colour = as.factor(Par_ue)), show.legend = F) +
  # geom_hline(data = data_hlineGS8, aes(yintercept = value), linetype="dotted") +
  # geom_hline(data = data_hlineGS12, aes(yintercept = value), linetype="dotdash") +
  # geom_hline(data = data_hlineGS16, aes(yintercept = value), linetype="dashed") +
  geom_hline(yintercept = 1, linetype="dashed") +
   labs(y = "Diel growth symmetry (AccLen/DecLen)", x = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
 #labs(y = "Diel growth symmetry", x = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  scale_shape_manual(values = c(15, 16, 17), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  # scale_y_continuous(breaks=seq(0, 2, by = 0.5)) +
  # coord_cartesian(ylim = c(0, 2)) +
  scale_x_continuous(label=scientific_10) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #geom_hline(aes(yintercept = 50), linetype="dotted") +
  ggh4x::facet_nested(cols = vars(facetsPhase, Phase), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="white"),
        legend.position = c(0.92,0.89),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        # legend.spacing.x = unit(0.01, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=10))
Plot



GScatalogAll %>%
  #mutate(HalfPhotoperiod = Photoperiod/2) %>% 
  #filter(meanAccLen>=0) %>%
  filter(Phase != "TP") %>%
  #filter(sdGS_h<"4") %>% 
  ggplot() +
  geom_point(aes(x = Photoperiod, y = meanAccLen, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.8, show.legend = T) +
  # geom_errorbar(aes(x = PARPhotonDose, ymin = meanGS_h - sdGS_h, ymax = meanGS_h + sdGS_h, colour = as.factor(Par_ue)), show.legend = F) +
  # geom_hline(data = data_hlineGS8, aes(yintercept = value), linetype="dotted") +
  # geom_hline(data = data_hlineGS12, aes(yintercept = value), linetype="dotdash") +
  # geom_hline(data = data_hlineGS16, aes(yintercept = value), linetype="dashed") +
  #geom_hline(yintercept = 1, linetype="dashed") +
labs(y = "AccLen (h)", x = "Photoperiod (h)") +
  #scale_shape_manual(values = c(15, 16, 17), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  # scale_y_continuous(breaks=seq(0, 10, by = 2.5)) +
  # coord_cartesian(ylim = c(0, 10)) +
  # 
  # scale_x_continuous(breaks=seq(0, 10, by = 2.5)) +
  # coord_cartesian(xlim = c(0, 10)) +
  # geom_hline(yintercept = 0, linetype = "dashed") +
  # geom_vline(xintercept = 0, linetype = "dashed") +
  geom_abline(slope = 0.5, intercept = 0, linetype = "dashed") +
  #coord_fixed(ratio = 1, xlim = c (0, 16), ylim = c(0, 10) ) +
  #scale_x_continuous(label=scientific_10) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #geom_hline(aes(yintercept = 50), linetype="dotted") +
  ggh4x::facet_nested(cols = vars(facetsPhase, Phase), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        panel.spacing.x = unit(1,"lines"),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.88,0.89),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        # legend.spacing.x = unit(0.01, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=10))


```



AccLen vs PARphotondose Plot
```{r fig.height = 8, fig.width = 8, warning = FALSE}


scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))


GScatalogAll %>%
  filter(Phase != "TP") %>% 
  filter(meanAccLen>0) %>% 
  ggplot() +
  geom_point(aes(x = PARPhotonDose, y = meanAccLen, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.8, show.legend = T) +
    geom_line(aes(x = PARPhotonDose, y = meanAccLen, colour = as.factor(Par_ue)), size = 0.7, show.legend = F) +
  # geom_errorbar(aes(x = PARPhotonDose, ymin = meanGS_h - sdGS_h, ymax = meanGS_h + sdGS_h, colour = as.factor(Par_ue)), show.legend = F) +
  
  # geom_hline(data = data_hlineGS8, aes(yintercept = value), linetype="dotted") +
  # geom_hline(data = data_hlineGS12, aes(yintercept = value), linetype="dotdash") +
  # geom_hline(data = data_hlineGS16, aes(yintercept = value), linetype="dashed") +
  #geom_hline(yintercept = 1, linetype="dashed") +
   labs(y = "AccLen (h)", x = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
 #labs(y = "Diel growth symmetry", x = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  scale_shape_manual(values = c(15, 16, 17), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  
  # scale_y_continuous(breaks=seq(0, 2, by = 0.5)) +
  # coord_cartesian(ylim = c(0, 2)) +
  
  scale_x_continuous(label=scientific_10) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #geom_hline(aes(yintercept = 50), linetype="dotted") +
  ggh4x::facet_nested(cols = vars(facetsPhase, Phase), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="white"),
        legend.position = c(0.92,0.89),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        # legend.spacing.x = unit(0.01, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=10))



```

Calculate real Par_ue and PARphotondoseSine based on AccLen (because of sine shape of light)

change as character to extract first digit without round - b/c this is hours
```{r}
GScatalogAllSine<-GScatalogAll %>% 
  mutate(meanAccLen = as.character(meanAccLen)) 

  library(stringi)
GScatalogAllSine$meanAccLenRound<- substr(GScatalogAllSine$meanAccLen, 1, 1)

GScatalogAllSine<-GScatalogAllSine %>% 
  mutate(meanAccLen = as.numeric(meanAccLen)) %>% 
  mutate(meanAccLenRound = as.numeric(meanAccLenRound)) 

```
df with calculated Par_ue sine per hour
```{r}
gs4_deauth()

ParSine<- read_sheet("https://docs.google.com/spreadsheets/d/1oZLemHtd6H3j2MgXbgNzqtZ2Gy3EKH6Vnn14PnEpPTw/edit#gid=0")

as.data.frame(ParSine)
ParSine <- ParSine

ParSine<-ParSine %>%
  mutate(PAR_Sine = as.numeric(PAR_Sine)) %>%
  mutate(Par_ue = as.numeric(Par_ue)) %>%
  mutate(Photoperiod = as.numeric(Photoperiod)) %>%
  mutate(RealTime = as.numeric(RealTime)) %>%
  mutate(Photoperiod_h_Sine = as.numeric(Photoperiod_h_Sine)) %>%
  mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077")) %>% 
  mutate(PARPhotonDoseSine = (PAR_Sine*Photoperiod/2)*3600)

```

Combine GScatalogAllSine with ParSine
```{r}
GScatalogAllSineok <- GScatalogAllSine %>%
  left_join(., ParSine, by = c("Strain" = "Strain", "Photoperiod" = "Photoperiod", "Par_ue" = "Par_ue", "meanAccLenRound" = "Photoperiod_h_Sine"))

```

AccLen vs PARphotondose Plot
```{r fig.height = 8, fig.width = 8, warning = FALSE}


scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))



GScatalogAllSineok %>%
  filter(Phase != "TP") %>% 
  filter(meanAccLen>0) %>% 
  ggplot() +
  geom_point(aes(x = PARPhotonDoseSine, y = meanAccLen, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.8, show.legend = T) +
  geom_line(aes(x = PARPhotonDoseSine, y = meanAccLen, colour = as.factor(Par_ue)), size = 0.7, show.legend = F) +
  # geom_errorbar(aes(x = PARPhotonDose, ymin = meanGS_h - sdGS_h, ymax = meanGS_h + sdGS_h, colour = as.factor(Par_ue)), show.legend = F) +
  # geom_hline(data = data_hlineGS8, aes(yintercept = value), linetype="dotted") +
  # geom_hline(data = data_hlineGS12, aes(yintercept = value), linetype="dotdash") +
  # geom_hline(data = data_hlineGS16, aes(yintercept = value), linetype="dashed") +
  #geom_hline(yintercept = 1, linetype="dashed") +
   labs(y = "AccLen (h)", x = "Real PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
 #labs(y = "Diel growth symmetry", x = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  scale_shape_manual(values = c(15, 16, 17), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  # scale_y_continuous(breaks=seq(0, 2, by = 0.5)) +
  # coord_cartesian(ylim = c(0, 2)) +
  scale_x_continuous(label=scientific_10) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #geom_hline(aes(yintercept = 50), linetype="dotted") +
  ggh4x::facet_nested(cols = vars(facetsPhase, Phase), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  theme_bw()


GScatalogAllSineok %>%
  #mutate(HalfPhotoperiod = Photoperiod/2) %>% 
  #filter(meanAccLen>=0) %>%
  filter(Phase != "TP") %>%
  #filter(sdGS_h<"4") %>% 
  ggplot() +
  geom_point(aes(x = PAR_Sine, y = meanAccLen, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.8, show.legend = T) +
  # geom_errorbar(aes(x = PARPhotonDose, ymin = meanGS_h - sdGS_h, ymax = meanGS_h + sdGS_h, colour = as.factor(Par_ue)), show.legend = F) +
#labs(y = "AccLen (h)", x = "Photoperiod (h)") +
  scale_shape_manual(values = c(15, 16, 17), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  # scale_y_continuous(breaks=seq(0, 10, by = 2.5)) +
  # coord_cartesian(ylim = c(0, 10)) +
  # 
  # scale_x_continuous(breaks=seq(0, 10, by = 2.5)) +
  # coord_cartesian(xlim = c(0, 10)) +
  #scale_x_continuous(label=scientific_10) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #geom_hline(aes(yintercept = 50), linetype="dotted") +
  ggh4x::facet_nested(cols = vars(facetsPhase, Phase), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  theme_bw() 

```






PUR, PIGMENTS, GROWTH RATE

Export Olis file
```{r}
Project <- "PicoBaltic"
DataIn <- file.path("..", "ImportedData", "OLIS", fsep = .Platform$file.sep)
FileEncode <- "UTF-8"
Delimiter <- ","
HeaderRows <- 0
```

Olis file
Exported Rmd only first time in session
```{r}
list.files(path = DataIn, pattern = Project, full.names = TRUE)
```
Export Olis file (2 df b/c I was dumb) Unused contain 600uE
```{r read ProcessFile}
#File choosen for spectra plot - 4 spectra only
OLISSpectraMeta440File <- "../ImportedData/OLIS/PicoBaltic_OLISSpectraWWPhotoperiod.Rds"
OLISSpectraMeta440FileName <- str_split(string = OLISSpectraMeta440File, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")
OLISSpectraMeta440 <- readRDS(OLISSpectraMeta440File)  %>%
  ungroup()

OLISSpectraMeta440UnusedFile <- "../ImportedData/OLIS/PicoBaltic_OLISSpectraUnused.Rds"
OLISSpectraMeta440UnusedFileName <- str_split(string = OLISSpectraMeta440UnusedFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")
OLISSpectraMeta440Unused <- readRDS(OLISSpectraMeta440UnusedFile)  %>%
  ungroup()

```

Combine Olis WWPhotoperiod and Unused 
```{r}
OLISSpectraMeta440Unused<-OLISSpectraMeta440Unused %>% 
  filter(Par_ue == 600) 

OLISSpectraMeta440All<-rbind(OLISSpectraMeta440, OLISSpectraMeta440Unused)

rm(OLISSpectraMeta440, OLISSpectraMeta440Unused)

```



665 - chl
480 - car
565	- PE
620	- PC
650 - APC

pigments corelation - to get raw spectra (without dilution factor from olis, I multipied Absorbance *7; b/c I added 1ml culture and 7 ml of f2 media when measured olis)


Calculated pigment content (per mL) based on Olis calibration
```{r}

# OLISSPigment <- OLISSPigment %>% 
# 
#   mutate(ChlaugmL = (Abs665*13.411029)+0.154793) %>% 
#   mutate(CarugmL = (Abs480*5.469880)+0.089971) %>% 
#   mutate(PEugmL = (Abs565*26.760737)-0.143872) %>% 
#   mutate(PCugmL = (Abs620*29.979866)-0.182611) %>% 
#   mutate(APCugmL = (Abs650*3.873803)+0.021964) 

```

Smaller df to easy calculate pigments per cell
```{r}
#colnames(OLISSPigment)

# OLISSPigment <- OLISSPigment %>%
#   select(-c(nm, Project, Range, Cdatetime, Absorbance, Abs665, Abs650, Abs620, Abs565, Abs480, PrimaryOperator, Description, Motivation, doi, ProjectID, Media_mL, ExpCul, Inoc_mL, ExpStartTime, "Calculated_µmolPhotons_m-2d-1", Temp_c, Plate, Well, Salinity, N2, Ar, CO2, O2_Category, Media, MediaDate, 
#             Source, SourceSalinity, Optode, OptodeCh, InocpH, FinalpH, Par_ueAdjusted, DateOfAdjustment, ElaspedHoursAtAdjustment, "...44", "...45", EndDate)) %>%
# unique()
```




Export Jaz file
```{r}
Project <- "PicoBaltic"
DataIn <- file.path("..", "ImportedData", "Jaz", fsep = .Platform$file.sep)

FileEncode <- "UTF-8"
Delimiter <- ","

HeaderRows <- 0
```

Jaz file
Exported from PICO_SySlJazSpec_MultiCulti.Rmd only first time in session
```{r}
list.files(path = DataIn, pattern = Project, full.names = TRUE)
```

Jaz file
```{r read ProcessFile}
JazFile <- "../ImportedData/Jaz/PicoBaltic_MultiCultiSpectraSySlWWPhotoperiodAll.Rds"

JazFileName <- str_split(string = JazFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")

JazData <- readRDS(JazFile)  %>%
  ungroup()

colnames(JazData)
```

```{r}
JazData <- JazData %>%
   mutate(WavelengthRound = round(Wavelength))
colnames(JazData)

JazDataRound <- JazData %>%
group_by(Filename, WavelengthRound) %>%
  summarize(Counts, Filename, Instrument, Date, Strain, Par, WL, CDateTime, WavelengthRound, CountsMean = mean(Counts)) %>%
ungroup()

JazDataRound <- JazDataRound %>%
  summarize(Filename, Strain, Par, WL, WavelengthRound, CountsMean) %>%
  unique()

JazDataRound <- JazDataRound %>%
  filter(WavelengthRound >= 400 & WavelengthRound <= 700)

```
Normalization at 439
```{r}

EmissionJazWW <- JazDataRound %>%
  group_by(WL, Strain, Par) %>%
  filter(WavelengthRound == 439) %>%
  mutate(EmJaz439 = CountsMean) %>%
  select(Strain, EmJaz439, Par) %>%
  ungroup()

JazDataRoundMeta <- JazDataRound %>%
  left_join(., EmissionJazWW) %>%
  mutate(EmNormJaz439 = CountsMean / EmJaz439)
  
```
Combine Olis spectra and Jaz
```{r}

OLISSpectraMetaAll <- OLISSpectraMeta440All %>%
  left_join(., JazDataRoundMeta, by = c("Par_ue" = "Par", "nm" = "WavelengthRound", "Strain" = "Strain", "WL" = "WL")) %>%
  unique()

rm(JazDataRound, EmissionJazWW, JazData)
rm(OLISSpectraMeta440All, JazDataRoundMeta)
```

PUR Mireille idea
```{r}

OLISSpectraMetaAllPUR <- OLISSpectraMetaAll %>%

  mutate(PURNorm = (AbsNorm440*EmNormJaz439)) %>% # green line

  group_by(WL, Strain, Par_ue, Photoperiod, E_days) %>%
  mutate(PURNormSum = sum(PURNorm)) %>% #sum of the green line
  mutate(SumEmNormJaz439 = sum(EmNormJaz439)) %>% #sum of the blue line
  mutate(PUR = Par_ue*(PURNormSum/SumEmNormJaz439)) %>% 
  ungroup() 


OLISSpectraMetaAllPUR1 <- OLISSpectraMetaAllPUR %>%
  filter(Photoperiod != "24") %>% 
  mutate(PURPhotonDose =(PUR/2)*Photoperiod*3600)
  
OLISSpectraMetaAllPUR2 <- OLISSpectraMetaAllPUR %>%
  filter(Photoperiod == "24") %>% 
  mutate(PURPhotonDose = PUR*Photoperiod*3600) 
  
  OLISSpectraMetaAllPUR <-rbind(OLISSpectraMetaAllPUR1, OLISSpectraMetaAllPUR2)
  rm(OLISSpectraMetaAllPUR1,OLISSpectraMetaAllPUR2)


```

Clean OLISSpectraMetaAllPUR for WW photoperiod manuscript - contain absorbance and all nm
```{r}
#colnames(OLISSpectraMetaAllPURClean)

OLISSpectraMetaAllPURClean<-OLISSpectraMetaAllPUR %>% 
  filter(Strain == "BA127R" | Strain == "BA77G" | Strain == "BA48R" | Strain == "BA56G") %>%
  select(-c(PrimaryOperator, doi, ProjectID, Inoc_mL, Media_mL, Plate, Well, Salinity,  N2, Ar, CO2, Media, MediaDate, SourceSalinity, OptodeCh, InocpH, FinalpH, Par_ueAdjusted, DateOfAdjustment, ElaspedHoursAtAdjustment, ...44, ...45, Description, Motivation, EndDate,  ExpCul, ExpStartTime, Source, Optode, Range, Cdatetime, Project, "Calculated_µmolPhotons_m-2d-1", Temp_c, O2_Category, Filename.x, Filename.y, SumAb, SumAbNorm, CountsMean, PURNormSum, SumEmNormJaz439))

  OLISSpectraMetaAllPURClean1 <- OLISSpectraMetaAllPURClean %>%
  filter(Photoperiod != "24") %>% 
  mutate(PARPhotonDose =(Par_ue/2)*Photoperiod*3600)
  
  OLISSpectraMetaAllPURClean2 <- OLISSpectraMetaAllPURClean %>%
  filter(Photoperiod == "24") %>% 
  mutate(PARPhotonDose = Par_ue*Photoperiod*3600) 
  
  OLISAllPURLong <-rbind(OLISSpectraMetaAllPURClean1, OLISSpectraMetaAllPURClean2)
  
  rm(OLISSpectraMetaAllPURClean1,OLISSpectraMetaAllPURClean2, OLISSpectraMetaAllPURClean)
  rm(OLISSpectraMetaAll, OLISSpectraMetaAllPUR)
```


Clean OLISSpectraMetaAllPUR for WW photoperiod manuscript - without absorbance and all nm - smaller df
```{r}
#colnames(OLISSpectraMetaAllPURClean)

OLISAllPURShort<-OLISAllPURLong %>% 
  select(-c(Absorbance, nm, Abs440, AbsNorm440, EmJaz439, EmNormJaz439, PURNorm)) %>% 
  unique()

OLISAllPURShort<-OLISAllPURShort %>% 
  
  group_by(Strain, Par_ue, Photoperiod, E_days, MC, Run) %>%
  mutate(PURPARRatio = PUR/Par_ue) %>% 
ungroup()

OLISAllPURShort <- OLISAllPURShort %>% 
  mutate(E_hours = E_days*24) 
  
OLISAllPURShort <- OLISAllPURShort %>% 
  filter(PURPARRatio<=1) %>% 
  filter(PURPARRatio>0)
  
```


Prepare OLISAllPURShort for nice plot
```{r}
OLISAllPURShort <- OLISAllPURShort %>%
      mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077"))

OLISAllPURShort$facetsPar_ue = factor(OLISAllPURShort$O2, labels = c("PAR~(µmol~photons~m^{-2}~s^{-1})"))

OLISAllPURShort$facetsPhotoperiod = factor(OLISAllPURShort$WL, labels = c("Photoperiod~(h)"))

OLISAllPURShort$facetsStrain = factor(OLISAllPURShort$WL, labels = c("Strain"))

OLISAllPURShort$facetsPhase = factor(OLISAllPURShort$WL, labels = c("Phase~of~growth"))

```


PUR/PAR ratio - photoperiod and PAR
```{r fig.height = 8, fig.width = 8}


lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))

lab2=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab3=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))

Plot <- OLISAllPURShort %>%
  filter(Par_ue !=600) %>% 
  ggplot() +
  geom_point(aes(x = E_hours, y = PURPARRatio, colour = as.factor(Strain)), alpha = 0.9, size = 3, show.legend = T) +
  geom_vline(data = data_vline1, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  geom_vline(data = data_vline2, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  geom_vline(data = data_vline3, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = data_vline4, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  labs(y = "PUR/PAR ratio", x = "Elapsed time (h)") +
  scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  coord_cartesian(ylim = c(0, 1.7)) +
  ggh4x::facet_nested(cols = vars(facetsPhotoperiod, Photoperiod), rows = vars(facetsPar_ue, Par_ue), labeller = label_parsed) +
  # ggh4x::facet_nested(cols = vars(facets2, Photoperiod), rows = vars(facets, Par_ue), labeller = labeller(Photoperiod = Photoperiod.labs,  Strain = label_value, Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  theme_bw() 
Plot


```

Load tmaxAG
```{r}
gs4_deauth()

tmaxAG<- read_sheet("https://docs.google.com/spreadsheets/d/1WyB4jonJGW9uFzKHp1Z6DnkMv-CP1PerwQ6sSLK7O8I/edit#gid=0")

as.data.frame(tmaxAG)
tmaxAG <- tmaxAG

tmaxAG<-tmaxAG %>% 

  mutate(Par_ue = as.numeric(Par_ue)) %>%
  mutate(Photoperiod = as.numeric(Photoperiod)) %>%
  mutate(dayRound_tmaxAG = as.numeric(dayRound_tmaxAG)) %>%
  mutate(hRound_tmaxAG = as.numeric(hRound_tmaxAG)) %>% 
  mutate(day_tmaxAG = as.numeric(day_tmaxAG)) %>% 
  mutate(h_tmaxAG = as.numeric(h_tmaxAG)) %>%

  mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077"))

```
Combine OLISAllPURShort with tmaxAG data from google sheet

OLISAllPURShortPhase -> Divided PAR, PUR and PUR/PAR Ratio data to Exponential and Pre-stationary phase according to tmaxAG from google sheet
```{r}

OLISAllPURShortPhase <- OLISAllPURShort %>%
  left_join(., tmaxAG, by = c("Strain"="Strain","Par_ue"="Par_ue","Photoperiod"="Photoperiod")) 

OLISAllPURShortPhase <- OLISAllPURShortPhase %>%
  #filter(Par_ue!= 600) %>% 
  mutate(Phase = O2) %>% 
  mutate(Phase=case_when(E_days<=dayRound_tmaxAG~"Exponential",
         E_days>dayRound_tmaxAG~"Pre-stationary"))

```


Plot -> PUR/PAR ratio - photoperiod and PAR or PAR PhotonDose
```{r fig.height = 8, fig.width = 8}


lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))
lab2=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab3=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))


Plot <- OLISAllPURShortPhase %>%
  filter(Par_ue!= 600) %>% 
  filter(PURPARRatio>0.05) %>% 
  ggplot() +
  geom_point(aes(x = E_hours, y = PURPARRatio, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), alpha = 0.9, size = 3, show.legend = T) +
  geom_smooth(aes(x = E_hours, y = PURPARRatio, colour = as.factor(Par_ue)), size = 0.7, alpha = 0, show.legend = F, method = lm) +
  # geom_line(aes(x = E_hours, y = PURPARRatio, colour = as.factor(Par_ue)), alpha = 0.9, size = 0.7, show.legend = F) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab2) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab3) +
  # scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  labs(y = "PUR/PAR ratio", x = "Elapsed time (h)") +
  scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  coord_cartesian(ylim = c(0, 1.2)) +
  ggh4x::facet_nested(cols = vars(facetsPhase, Phase), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  theme_bw()
Plot


Plot <- OLISAllPURShortPhase %>%
  filter(Par_ue!= 600) %>% 
  filter(PURPARRatio>0.05) %>% 
  ggplot() +
  geom_point(aes(x = PARPhotonDose, y = PURPARRatio, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), alpha = 0.9, size = 3, show.legend = T) +
  # geom_line(aes(x = E_hours, y = PURPARRatio, colour = as.factor(Par_ue)), alpha = 0.9, size = 0.7, show.legend = F) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab2) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab3) +
  # scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  #labs(y = "PUR/PAR ratio", x = "Elapsed time (h)") +
  scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  coord_cartesian(ylim = c(0, 1.2)) +
  ggh4x::facet_nested(rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  theme_bw() 
Plot


Plot <- OLISAllPURShortPhase %>%
  #filter(Photoperiod != "24") %>%
  #filter(Par_ue != 900) %>%
  filter(PURPARRatio<=1) %>%
  filter(PARPhotonDose == 432000|
  PARPhotonDose == 864000|
  PARPhotonDose == 1944000|
  PARPhotonDose == 3888000|
  PARPhotonDose == 6480000|
  PARPhotonDose == 8640000|
  PARPhotonDose == 77760000) %>%
  #filter(E_days != "1") %>%
  ggplot() +
  # geom_smooth(aes(x = Time_h, y = PURPARRatio, colour = as.factor(Strain)),  alpha = 0, size = 0.2, linetype = "solid", show.legend = T) +
  geom_point(aes(x = E_hours, y = PURPARRatio, colour = as.factor(Strain)), alpha = 0.9, size = 3, show.legend = T) +
  # geom_vline(data = data_vline5, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  # geom_vline(data = data_vline6, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  # geom_vline(data = data_vline7, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  # geom_vline(data = data_vline8, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  labs(y = "PUR/PAR ratio", x = "Elapsed time (h)") +
  scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  coord_cartesian(ylim = c(0, 1.5)) +
  ggh4x::facet_nested(cols = vars(PARPhotonDose), labeller = label_parsed) +
  # ggh4x::facet_nested(cols = vars(facets, PhotonDose), labeller = labeller(Photoperiod = Photoperiod.labs,  Strain = label_value, Par_ue = Par_ue.labs, WL = label_parsed, O2 = O2.labs)) +
  theme_bw() 
Plot



```


df for choosen PAR photondose data
```{r}

# data_vline5 <- data.frame(PARPhotonDose= c(432000, 1944000, 3888000, 6480000, 864000, 8640000, 77760000),facets3=c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"), value = c(347, 245.39,189.48,162.62, 347, 111.56,110))
# 
# 
# data_vline6 <- data.frame(PARPhotonDose= c(432000, 1944000, 3888000, 6480000, 864000, 8640000, 77760000),facets3=c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"), value = c(346, 216.33,163.44,136.03, 299.38,111.28,94.23))
# 
# data_vline7 <- data.frame(PARPhotonDose= c(432000, 1944000, 3888000, 6480000, 864000, 8640000, 77760000),facets3=c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"), value = c(345, 296.45,217.80,191.03, 345,112.75,79.66))
# 
# data_vline8 <- data.frame(PARPhotonDose= c(432000, 1944000, 3888000, 6480000, 864000, 8640000, 77760000),facets3=c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})","PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"), value = c(344, 244.38,190.39,163.62, 299.57, 112.29, 107))

```




#Growth rate

MultiCulti Assesment
```{r}
Project <- "PicoBaltic"
DataIn <- file.path("..","GrowthAssessData", fsep = .Platform$file.sep)
FileEncode <- "UTF-8" 
Delimiter <- ","
HeaderRows <- 0
```


MultiCulti Assesment
Exported only first time in session
```{r}
list.files(path = DataIn, pattern = Project, full.names = TRUE)
```

GrowthAssessData/PICO_MultiAssesment_CCA contain WWPhotoperiod data!!! Genius - fix this Sylwia!!!!

MultiCulti Assesment
```{r read ProcessFile}
MultiCultiGrowthFile <- "../GrowthAssessData/PicoBaltic_MultiAssesment_CCA.Rds"

MultiCultiGrowthFileName <- str_split(string = MultiCultiGrowthFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds") 

MultiCultiGrowth <- readRDS(MultiCultiGrowthFile)  %>%
  ungroup()


MultiCultiGrowth121File <- "../GrowthAssessData/PicoBaltic_MultiAssesment_RUN121trunc.Rds"

MultiCultiGrowth121FileName <- str_split(string = MultiCultiGrowth121File, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds") 

MultiCultiGrowth121 <- readRDS(MultiCultiGrowth121File)  %>%
  ungroup()

#colnames(MultiCultiData)


```

clean MultiCulti data for WWPhotoperiod manuscript

Because I have a few growth data as replica I made mean to get one value of deltaOD_Lmu_corr
```{r}
MultiCultiGrowthClean <- MultiCultiGrowth %>%
  summarize(Filename, Run, ID, Strain, MC, Tube, Par_ue, Photoperiod, O2, WL, InnocDate, ExpDate, LightShape, OD720_Lmu_corr, deltaOD_Lmu_corr, OD720_LseGrowthFlag, deltaOD_LseGrowthFlag, GrowthAmpOD720Flag_14days, GrowthAmpdeltaODFlag_14days, OD720_Lmu_se, deltaOD_Lmu_se)

MultiCultiGrowthClean <- MultiCultiGrowthClean %>%
  filter(WL == "WW") %>% 
  #filter(Par_ue != 600) %>% 
  filter(O2 == 21) %>% 
  filter(Strain == "BA127R" | Strain == "BA48R" | Strain == "BA56G" | Strain == "BA77G") %>% 
  filter(Run != "61") %>% 
  filter(MC!= "MCMIX004" | MC!= "MCMIX006")
#OD720_Lmu_se, deltaOD_Lmu_se


MultiCultiGrowth121Clean <- MultiCultiGrowth121 %>%
  summarize(Filename, Run, ID, Strain, MC, Tube, Par_ue, Photoperiod, O2, WL, InnocDate, ExpDate, LightShape, OD720_Lmu_corr, deltaOD_Lmu_corr, OD720_LseGrowthFlag, deltaOD_LseGrowthFlag, GrowthAmpOD720Flag_14days, GrowthAmpdeltaODFlag_14days, OD720_Lmu_se, deltaOD_Lmu_se)

MultiCultiGrowthAll<-rbind(MultiCultiGrowthClean, MultiCultiGrowth121Clean)

MultiCultiGrowthAll<-MultiCultiGrowthAll %>% 
  group_by(Strain,Photoperiod,Par_ue) %>% 
    summarize(Filename, Run, ID, Strain, MC, Tube, Par_ue, Photoperiod, O2, WL, InnocDate, ExpDate, LightShape, OD720_Lmu_corr, deltaOD_Lmu_corr, OD720_LseGrowthFlag, deltaOD_LseGrowthFlag, GrowthAmpOD720Flag_14days, GrowthAmpdeltaODFlag_14days, OD720_Lmu_se, deltaOD_Lmu_se,
              meandeltaOD_Lmu_corr=mean(deltaOD_Lmu_corr),
              sddeltaOD_Lmu_corr=sd(deltaOD_Lmu_corr)) %>% 
  ungroup()


rm(MultiCultiGrowthClean, MultiCultiGrowth121Clean)
```

Add PAR PhotonDose and correct name of strains
```{r}

MultiCultiGrowthAll<-MultiCultiGrowthAll %>% 
  mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077"))

  MultiCultiDataCleanAll1 <- MultiCultiGrowthAll %>%
  filter(Photoperiod != "24") %>% 
  mutate(PARPhotonDose =(Par_ue/2)*Photoperiod*3600)
  
  MultiCultiDataCleanAll2 <- MultiCultiGrowthAll %>%
  filter(Photoperiod == "24") %>% 
  mutate(PARPhotonDose = Par_ue*Photoperiod*3600) 
  
  MultiCultiGrowthAll <-rbind(MultiCultiDataCleanAll1, MultiCultiDataCleanAll2)
  rm(MultiCultiDataCleanAll1, MultiCultiDataCleanAll2)
  
```


Combine growth rate and all PUR
```{r}
#colnames(OLISSpectraMetaAllPURPARRatioCleanExpPUR)

#All PUR (divided to Phase) and growth rate
MultiCultiGrowthRate <- OLISAllPURShortPhase %>% 
  left_join(., MultiCultiGrowthAll, by = c("Run" = "Run", "ID" = "ID","Strain" = "Strain", "Par_ue" = "Par_ue", "Photoperiod" = "Photoperiod",  "O2" = "O2", "WL" = "WL",  "MC" = "MC", "Tube" = "Tube", "InnocDate" =  "InnocDate", "ExpDate" = "ExpDate", "LightShape" = "LightShape", "PARPhotonDose" = "PARPhotonDose")) 


```



Combine growth rate and exp PUR
```{r}
MultiCultiDataCleanGrowthAll2<-MultiCultiGrowthRate 
  
O1 <- MultiCultiDataCleanGrowthAll2 %>%
  filter(Par_ue == 30 | Par_ue == 300 | Par_ue == 90 | Par_ue == 180) %>% 
  filter(Photoperiod == 24) %>% 
  filter(E_days < 4)

O2 <- MultiCultiDataCleanGrowthAll2 %>%
  filter(Par_ue == 180 | Par_ue == 300) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days == 4)

O3 <- MultiCultiDataCleanGrowthAll2 %>%
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days == 6)

O4 <- MultiCultiDataCleanGrowthAll2 %>%
  filter(Par_ue == 30) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days == 12)

O5 <- MultiCultiDataCleanGrowthAll2 %>%
  filter(Par_ue == 900 | Par_ue == 600) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days == 4)

O6 <- MultiCultiDataCleanGrowthAll2 %>%
  filter(Par_ue == 30) %>% 
  filter(Photoperiod == 8 | Photoperiod == 12) %>% 
  filter(E_days == 12| E_days == 13)
  
O7 <- MultiCultiDataCleanGrowthAll2 %>%
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 8) %>% 
  filter(E_days == 12 | E_days ==13)

O8 <- MultiCultiDataCleanGrowthAll2 %>%
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 12) %>% 
  filter(Strain == "PE-rich_127" | Strain == "PE-rich_048" | Strain == "PC-rich_077") %>% 
  filter(E_days == 8 | E_days ==9)

O9 <- MultiCultiDataCleanGrowthAll2 %>%
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 12) %>% 
  filter(Strain == "PC-rich_056") %>% 
  filter(E_days == 11)

O10 <- MultiCultiDataCleanGrowthAll2 %>%
  filter(Par_ue == 180) %>% 
  filter(Photoperiod == 8) %>% 
  filter(E_days == 8 | E_days == 9)

O11 <- MultiCultiDataCleanGrowthAll2 %>%
  filter(Par_ue == 180) %>% 
  filter(Photoperiod == 12) %>% 
  filter(E_days == 6 | E_days == 7)

O12 <- MultiCultiDataCleanGrowthAll2 %>%
  filter(Par_ue == 300) %>% 
  filter(Photoperiod == 8) %>% 
  filter(Strain == "PE-rich_127" | Strain == "PE-rich_048" | Strain == "PC-rich_077") %>% 
  filter(E_days == 6 | E_days ==7)

O13 <- MultiCultiDataCleanGrowthAll2 %>%
  filter(Par_ue == 300) %>% 
  filter(Photoperiod == 8) %>% 
  filter(Strain == "PC-rich_056") %>% 
  filter(E_days == 9)

O14 <- MultiCultiDataCleanGrowthAll2 %>%
  filter(Par_ue == 300) %>% 
  filter(Photoperiod == 12) %>% 
  filter(Strain == "PE-rich_127" | Strain == "PE-rich_048" | Strain == "PC-rich_077") %>% 
  filter(E_days == 4 | E_days ==5)

O15 <- MultiCultiDataCleanGrowthAll2 %>%
  filter(Par_ue == 300) %>% 
  filter(Photoperiod == 12) %>% 
  filter(Strain == "PC-rich_056") %>%  
  filter(E_days == 7)

O16 <- MultiCultiDataCleanGrowthAll2 %>%
  filter(Par_ue == 900) %>% 
  filter(Photoperiod == 8 | Photoperiod == 12)

O17 <- MultiCultiDataCleanGrowthAll2 %>%
  filter(Par_ue == 900 | Par_ue == 600) %>% 
  filter(Photoperiod == 24) %>% 
  filter(E_hours < 100 & E_hours > 48)

MultiCultiDataCleanGrowthAll3 <-rbind(O1, O2, O3, O4, O5, O6, O7, O8, O9, O10, O11, O12, O13, O14, O15, O16, O17)

rm(O1, O2, O3, O4, O5, O6, O7, O8, O9, O10, O11, O12, O13, O14, O15, O16, O17)

  
```

Because I have replica in growt rate - I combine one choosen PUR exp to all growth rate data
```{r}
#colnames(MultiCultiDataCleanGrowthAll4)
MultiCultiDataCleanGrowthAll4<-MultiCultiDataCleanGrowthAll3 %>% 
  mutate(PURExp = PUR) %>% 
  mutate(PURPhotonDoseExp = PURPhotonDose) %>% 
  mutate(PURPARRatioExp = PURPARRatio) %>% 
  mutate(E_hoursExp = E_hours) %>% 
  mutate(E_daysExp = E_days) %>% 
  select(c(Strain, Par_ue, Photoperiod, PURExp, PURPhotonDoseExp, PURPARRatioExp, E_hoursExp, E_daysExp))
  
MultiCultiGrowthRatePURExp <- MultiCultiGrowthRate %>%
  full_join(., MultiCultiDataCleanGrowthAll4, by = c("Strain"="Strain", "Par_ue"="Par_ue","Photoperiod"="Photoperiod"))


```

rm additional df
```{r}
rm(MultiCultiGrowthAll, MultiCultiGrowth, MultiCultiGrowth121, MultiCultiDataCleanGrowthAll2, MultiCultiDataCleanGrowthAll4)
```



PUR/PAR ratio - all data and only exp
```{r fig.height = 8, fig.width = 8}


lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))

Plot <- MultiCultiGrowthRatePURExp %>%
  filter(Par_ue!=600) %>% 
  ggplot() +
  # geom_smooth(aes(x = Time_h, y = PURPARRatio, colour = as.factor(Strain)),  alpha = 0, size = 0.2, linetype = "solid", show.legend = T) +
  geom_point(aes(x = E_hoursExp, y = PURPARRatioExp, colour = as.factor(Strain)), alpha = 0.9, size = 3, show.legend = T) +
  geom_vline(data = data_vline1, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  geom_vline(data = data_vline2, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  geom_vline(data = data_vline3, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = data_vline4, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  labs(y = "PUR/PAR ratio", x = "Elapsed time (h)") +
  # geom_errorbar(aes(x = Photoperiod, ymin = OD720_Lmu_corr - OD720_Lmu_se, ymax = OD720_Lmu_corr + OD720_Lmu_se), size = 0.3, width=3, color = '#3C3B53', data = . %>% filter(GrowthAmpOD720Flag_14days  == 1)) +
  scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  coord_cartesian(ylim = c(0, 1.7)) +
  ggh4x::facet_nested(cols = vars(facetsPhotoperiod, Photoperiod), rows = vars(facetsPar_ue, Par_ue), labeller = label_parsed) +
  theme_bw() 
Plot





lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))

Plot <- MultiCultiGrowthRatePURExp %>%
  filter(Par_ue!=600) %>% 
  filter(PURPARRatio>0.05) %>% 
  ggplot() +
  # geom_smooth(aes(x = Time_h, y = PURPARRatio, colour = as.factor(Strain)),  alpha = 0, size = 0.2, linetype = "solid", show.legend = T) +
  geom_point(aes(x = E_hours, y = PURPARRatio, colour = as.factor(Strain)), alpha = 0.9, size = 3, show.legend = T) +
  geom_vline(data = data_vline1, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  geom_vline(data = data_vline2, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  geom_vline(data = data_vline3, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = data_vline4, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  labs(y = "PUR/PAR ratio", x = "Elapsed time (h)") +
  # geom_errorbar(aes(x = Photoperiod, ymin = OD720_Lmu_corr - OD720_Lmu_se, ymax = OD720_Lmu_corr + OD720_Lmu_se), size = 0.3, width=3, color = '#3C3B53', data = . %>% filter(GrowthAmpOD720Flag_14days  == 1)) +
  scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  coord_cartesian(ylim = c(0, 1.7)) +
  ggh4x::facet_nested(cols = vars(facetsPhotoperiod, Photoperiod), rows = vars(facetsPar_ue, Par_ue), labeller = label_parsed) +
  # ggh4x::facet_nested(cols = vars(facets2, Photoperiod), rows = vars(facets, Par_ue), labeller = labeller(Photoperiod = Photoperiod.labs,  Strain = label_value, Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  theme_bw() 
Plot


```


```{r fig.height = 5.5, fig.width = 8, warning = FALSE}

lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("600 µE"), expression("900 µE"))


O2.labs <- c("Strain")
names(O2.labs) <- c(21)
scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }

Plot <- MultiCultiGrowthRatePURExp %>%
  filter(deltaOD_Lmu_corr == 0 | deltaOD_Lmu_corr != 0 & deltaOD_LseGrowthFlag == 1) %>%
  # filter(OD720_Lmu_corr == 0 | OD720_Lmu_corr != 0 & OD720_LseGrowthFlag == 1) %>%
  ggplot() +
  geom_point(aes(x = PARPhotonDose, y = deltaOD_Lmu_corr, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.9, show.legend = T) +
labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  # labs(shape="Photoperiod (h)", colour="Strain") +
   geom_errorbar(aes(x = PARPhotonDose, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se), alpha = 0.5, width=2000000, data = . %>% filter(GrowthAmpdeltaODFlag_14days  == 1)) +
  #geom_text(data=data_textA, aes(x=78000000, y=0.25, label=label), size=5) +
  scale_x_continuous(breaks=seq(0, 80000000, by = 20000000)) +
  coord_cartesian(xlim = c(-100, 83000000)) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1", "yellow"), name="", labels = lab2) +
  ggh4x::facet_nested(rows = vars(O2, Strain), labeller = labeller(O2 = O2.labs)) +
  scale_x_continuous(label=scientific_10) +
  guides(color = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_bw() 
Plot



Plot <- MultiCultiGrowthRate %>%
  filter(deltaOD_Lmu_corr == 0 | deltaOD_Lmu_corr != 0 & deltaOD_LseGrowthFlag == 1) %>%
  # filter(OD720_Lmu_corr == 0 | OD720_Lmu_corr != 0 & OD720_LseGrowthFlag == 1) %>%
  ggplot() +
  geom_point(aes(x = PURPhotonDose, y = deltaOD_Lmu_corr, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.9, show.legend = T) +
labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "PUR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  # labs(shape="Photoperiod (h)", colour="Strain") +
   geom_errorbar(aes(x = PURPhotonDose, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se), alpha = 0.5, width=2000000, data = . %>% filter(GrowthAmpdeltaODFlag_14days  == 1)) +
  scale_x_continuous(breaks=seq(0, 80000000, by = 20000000)) +
  coord_cartesian(xlim = c(-100, 83000000)) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1", "yellow"), name="", labels = lab2) +
  ggh4x::facet_nested(rows = vars(O2, Strain), labeller = labeller(O2 = O2.labs)) +
  scale_x_continuous(label=scientific_10) +
  guides(color = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_bw() 
Plot

Plot <- MultiCultiGrowthRatePURExp %>%
  filter(deltaOD_Lmu_corr == 0 | deltaOD_Lmu_corr != 0 & deltaOD_LseGrowthFlag == 1) %>%
  # filter(OD720_Lmu_corr == 0 | OD720_Lmu_corr != 0 & OD720_LseGrowthFlag == 1) %>%
  ggplot() +
  geom_point(aes(x = PURPhotonDoseExp, y = deltaOD_Lmu_corr, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.9, show.legend = T) +
labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "PUR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  # labs(shape="Photoperiod (h)", colour="Strain") +
   geom_errorbar(aes(x = PURPhotonDoseExp, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se), alpha = 0.5, width=2000000, data = . %>% filter(GrowthAmpdeltaODFlag_14days  == 1)) +
  scale_x_continuous(breaks=seq(0, 80000000, by = 20000000)) +
  coord_cartesian(xlim = c(-100, 83000000)) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1", "yellow"), name="", labels = lab2) +
  ggh4x::facet_nested(rows = vars(O2, Strain), labeller = labeller(O2 = O2.labs)) +
  scale_x_continuous(label=scientific_10) +
  guides(color = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_bw()
Plot

Plot <- MultiCultiGrowthRatePURExp %>%
  #filter(deltaOD_Lmu_corr == 0 | deltaOD_Lmu_corr != 0 & deltaOD_LseGrowthFlag == 1) %>%
  # filter(OD720_Lmu_corr == 0 | OD720_Lmu_corr != 0 & OD720_LseGrowthFlag == 1) %>%
  ggplot() +
  geom_point(aes(x = PURPhotonDoseExp, y = meandeltaOD_Lmu_corr, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.9, show.legend = T) +
labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "PUR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  # labs(shape="Photoperiod (h)", colour="Strain") +
   geom_errorbar(aes(x = PURPhotonDoseExp, ymin = meandeltaOD_Lmu_corr - sddeltaOD_Lmu_corr, ymax = meandeltaOD_Lmu_corr + sddeltaOD_Lmu_corr), alpha = 0.5, width=2000000, data = . %>% filter(GrowthAmpdeltaODFlag_14days  == 1)) +
  scale_x_continuous(breaks=seq(0, 80000000, by = 20000000)) +
  coord_cartesian(xlim = c(-100, 83000000)) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1", "yellow"), name="", labels = lab2) +
  ggh4x::facet_nested(rows = vars(O2, Strain), labeller = labeller(O2 = O2.labs)) +
  scale_x_continuous(label=scientific_10) +
  guides(color = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_bw()
Plot



```


Clean unused Lmu from MultiCultiDataCleanGrowthExp
```{r}

# MultiCultiDataCleanGrowth31 <- MultiCultiDataCleanGrowthAll3 %>%
#   filter(Run==77) %>% 
#   filter(Tube != 6) %>% 
#   filter(Tube != 3) 
#   
# MultiCultiDataCleanGrowth32 <- MultiCultiDataCleanGrowthAll3 %>%
#   filter(Run==121) %>% 
#   filter(Tube != 6) %>% 
#   filter(Tube != 3) 
# 
# MultiCultiDataCleanGrowth33 <- MultiCultiDataCleanGrowthAll3 %>%
#   filter(Run!=77) %>% 
#   filter(Run!=121)  
# 
# MultiCultiDataCleanGrowthFilter<-rbind(MultiCultiDataCleanGrowth31,
#                                        MultiCultiDataCleanGrowth32,
#                                        MultiCultiDataCleanGrowth33)

```

Added column PhotonDose_value and combine data to to PAR and PUR - long format (MultiCultiGrowthRatePURExpFit)
```{r}
MultiCultiGrowthRatePURExpFitPAR<-MultiCultiGrowthRatePURExp %>% 
  select(-c(PURPhotonDose)) %>% 
  mutate(PhotonDose_value = PARPhotonDose) %>% 
  mutate(PhotonDose = O2) %>% 
  mutate(PhotonDose = case_when(PhotonDose==21~"PAR")) %>% 
  select(-c(PARPhotonDose, PURPhotonDoseExp))
  
MultiCultiGrowthRatePURExpFitPUR<-MultiCultiGrowthRatePURExp %>% 
  select(-c(PARPhotonDose)) %>% 
  mutate(PhotonDose_value = PURPhotonDoseExp) %>% 
  mutate(PhotonDose = O2) %>% 
  mutate(PhotonDose = case_when(PhotonDose==21~"PUR")) %>% 
  select(-c(PURPhotonDose, PURPhotonDoseExp))

MultiCultiGrowthRatePURExpFit<-rbind(MultiCultiGrowthRatePURExpFitPAR, MultiCultiGrowthRatePURExpFitPUR)
rm(MultiCultiGrowthRatePURExpFitPAR, MultiCultiGrowthRatePURExpFitPUR)

```


```{r fig.height = 8, fig.width = 8, warning = FALSE}

lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("600 µE"), expression("900 µE"))


O2.labs <- c("Strain")
names(O2.labs) <- c(21)
scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }

Plot <- MultiCultiGrowthRatePURExpFit %>%
  filter(deltaOD_Lmu_corr == 0 | deltaOD_Lmu_corr != 0 & deltaOD_LseGrowthFlag == 1) %>%
  # filter(OD720_Lmu_corr == 0 | OD720_Lmu_corr != 0 & OD720_LseGrowthFlag == 1) %>%
  ggplot() +
  geom_point(aes(x = PhotonDose_value, y = deltaOD_Lmu_corr, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.9, show.legend = T) +
labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "Photon dose ( µmol photons "~m^-2~""~d^-1~")") +
   # geom_errorbar(aes(x = PARPhotonDose, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se), alpha = 0.5, width=2000000, data = . %>% filter(GrowthAmpdeltaODFlag_14days  == 1)) +
  scale_x_continuous(breaks=seq(0, 80000000, by = 20000000)) +
  coord_cartesian(xlim = c(-100, 83000000)) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1", "yellow"), name="", labels = lab2) +
  ggh4x::facet_nested(rows = vars(O2, Strain), cols = vars(PhotonDose), labeller = labeller(O2 = O2.labs)) +
    # ggh4x::facet_nested(cols = vars(Strain), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs, Strain = Strain.labs)) +
  scale_x_continuous(label=scientific_10) +
  guides(color = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=12, angle = 45, vjust = 1, hjust = 1),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.91,0.88),
        legend.key.height= unit(0.003, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        # legend.spacing.x = unit(0.01, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=9))
Plot


Plot <- MultiCultiGrowthRatePURExpFit %>%
  #filter(deltaOD_Lmu_corr == 0 | deltaOD_Lmu_corr != 0 & deltaOD_LseGrowthFlag == 1) %>%
  # filter(OD720_Lmu_corr == 0 | OD720_Lmu_corr != 0 & OD720_LseGrowthFlag == 1) %>%
  ggplot() +
  geom_point(aes(x = PhotonDose_value, y = meandeltaOD_Lmu_corr, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.9, show.legend = T) +
labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "Photon dose ( µmol photons "~m^-2~""~d^-1~")") +
   # geom_errorbar(aes(x = PARPhotonDose, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se), alpha = 0.5, width=2000000, data = . %>% filter(GrowthAmpdeltaODFlag_14days  == 1)) +
  scale_x_continuous(breaks=seq(0, 80000000, by = 20000000)) +
  coord_cartesian(xlim = c(-100, 83000000)) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1", "yellow"), name="", labels = lab2) +
  ggh4x::facet_nested(rows = vars(O2, Strain), cols = vars(PhotonDose), labeller = labeller(O2 = O2.labs)) +
    # ggh4x::facet_nested(cols = vars(Strain), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs, Strain = Strain.labs)) +
  scale_x_continuous(label=scientific_10) +
  guides(color = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=12, angle = 45, vjust = 1, hjust = 1),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.91,0.88),
        legend.key.height= unit(0.003, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        # legend.spacing.x = unit(0.01, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=9))
Plot

```

FIT curve

```{r test inhibition plot}

#Harrison & Platt, 1986
grcplatt <- function(I, a, b, Pmax){Pmax * (1-exp(-a*I/Pmax)) * exp(-b*I/Pmax)}

```



Harrison & Platt, 1986 
```{r platt fit}

CleanGrowthPARPURfit <- MultiCultiGrowthRatePURExpFit |>   
  filter(Par_ue !=900 & Par_ue !=600) |> 
  #filter(PhotonDose == "PAR") |>
  nest(data = -c("Strain", "PhotonDose")) |> 
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PhotonDose_value, a, b, Pmax),
                                                    data = .x,
                                                    start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),
                                                    lower = c(0, 0, 0)))
                                                    #upper = c(1,1,100)), 
                                                    #0))
         ) |>   
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance))
         )

GRCplatt_PredictGrowth <- CleanGrowthPARPURfit |>
  unnest(GRCplatt_Predict)

```


Harrison & Platt, 1986 
```{r platt fit}


CleanGrowthPARPURfit900 <- MultiCultiGrowthRatePURExpFit |>   
  filter(Par_ue !=30 & Par_ue !=90 & Par_ue !=180 & Par_ue !=300) |> 
  # filter(Par_ue == 900) |>
  #filter(PhotonDose == "PAR") |>
  nest(data = -c("Strain", "PhotonDose")) |> 
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PhotonDose_value, a, b, Pmax),
                                                    data = .x,
                                                    start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),
                                                    lower = c(0, 0, 0)))
                                                    #upper = c(1,1,100)), 
                                                    #0))
         ) |>   
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance))
         )

GRCplatt_PredictGrowth900 <- CleanGrowthPARPURfit900 |>
  unnest(GRCplatt_Predict)

```


add columns to get nice facet
```{r}

GRCplatt_PredictGrowth$facetsStrain = factor(GRCplatt_PredictGrowth$PhotonDose, labels = c("Strain", "Strain"))

GRCplatt_PredictGrowth900$facetsStrain = factor(GRCplatt_PredictGrowth900$PhotonDose, labels = c("Strain", "Strain"))

```


```{r}
# CleanGrowthPARPURfitbez900 <- CleanGrowthPARPUR %>%    
#   filter(Par_ue !=900) 
# 
# CleanGrowthPARPURfittylko900 <- CleanGrowthPARPUR %>%    
#   filter(Par_ue ==900) %>% 
#   filter(deltaOD_Lmu_se<8.057558e-03)
```



```{r fig.height = 8, fig.width = 8, warning = FALSE}

# O2.labs <- c("Strain")
# names(O2.labs) <- c(21)

lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("1 µE"), expression("2 µE"), expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("600 µE"), expression("900 µE"))
scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }


ggplot(MultiCultiGrowthRatePURExpFit, aes(PhotonDose_value, meandeltaOD_Lmu_corr)) +
  geom_point(aes(PhotonDose_value, meandeltaOD_Lmu_corr, colour=as.factor(Par_ue), shape = as.factor(Photoperiod)), alpha = 0.9, size = 3.5, show.legend = T) +
# 
#   geom_errorbar(aes(x = PhotonDose_value, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se, colour = as.factor(Par_ue)), width=4000000, data = . %>% filter(deltaOD_Lmu_se<8.057558e-03), show.legend = F) +
  geom_line(aes(PhotonDose_value, .fitted), show.legend = F, GRCplatt_PredictGrowth) +
  geom_line(aes(PhotonDose_value, .fitted), show.legend = F, GRCplatt_PredictGrowth900) +
  scale_y_continuous(breaks=seq(0, 0.25, by = 0.1)) +
  coord_cartesian(ylim = c(0, 0.25)) +
  scale_x_continuous(label=scientific_10) +
  scale_linetype_manual(values=c("equal900" = "dotted", "less900" = "solid"), breaks=c('8', '12', '16', "24", "", "")) +
  scale_colour_manual(values = c("", "", "darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1", "yellow"), name="", labels = lab2, breaks=c('', '', '30', "90", "180", "300", "600", "900")) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "Photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  #geom_hline(aes(yintercept = 0), linetype = 2) +
    ggh4x::facet_nested(cols = vars(PhotonDose), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  #ggh4x::facet_nested(rows = vars(O2, Strain), cols = vars(PhotonDose), labeller = labeller(O2 = O2.labs)) +
  # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  theme_bw() 

```


Fit for every Par_ue

Harrison & Platt, 1986 
```{r platt fit}

#Harrison & Platt, 1986
grcplatt <- function(I, a, b, Pmax){Pmax * (1-exp(-a*I/Pmax)) * exp(-b*I/Pmax)}

MultiCultiGrowthRatePURExpFitok<-MultiCultiGrowthRatePURExpFit %>% 
  #filter(deltaOD_Lmu_corr<0.21) %>% 
  filter(Par_ue !=600)

MultiCultiGrowthRatePURExpFit30 <- MultiCultiGrowthRatePURExpFitok |>   
  filter(Par_ue ==30) |> 
  #filter(PhotonDose == "PAR") |>
  nest(data = -c("Strain", "PhotonDose")) |> 
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PhotonDose_value, a, b, Pmax),
                                                    data = .x,
                                                    start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),
                                                    lower = c(0, 0, 0)))
                                                    #upper = c(1,1,100)), 
                                                    #0))
         ) |>   
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance))
         )

GRCplatt_PredictGrowth30 <- MultiCultiGrowthRatePURExpFit30 |>
  unnest(GRCplatt_Predict)




MultiCultiGrowthRatePURExpFit90 <- MultiCultiGrowthRatePURExpFitok |>   
  filter(Par_ue ==90) |> 
  #filter(PhotonDose == "PAR") |>
  nest(data = -c("Strain", "PhotonDose")) |> 
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PhotonDose_value, a, b, Pmax),
                                                    data = .x,
                                                    start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),
                                                    lower = c(0, 0, 0)))
                                                    #upper = c(1,1,100)), 
                                                    #0))
         ) |>   
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance))
         )

GRCplatt_PredictGrowth90 <- MultiCultiGrowthRatePURExpFit90 |>
  unnest(GRCplatt_Predict)


MultiCultiGrowthRatePURExpFit180 <- MultiCultiGrowthRatePURExpFitok |>   
  filter(Par_ue ==180) |> 
  #filter(PhotonDose == "PAR") |>
  nest(data = -c("Strain", "PhotonDose")) |> 
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PhotonDose_value, a, b, Pmax),
                                                    data = .x,
                                                    start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),
                                                    lower = c(0, 0, 0)))
                                                    #upper = c(1,1,100)), 
                                                    #0))
         ) |>   
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance))
         )

GRCplatt_PredictGrowth180 <- MultiCultiGrowthRatePURExpFit180 |>
  unnest(GRCplatt_Predict)



MultiCultiGrowthRatePURExpFit300 <- MultiCultiGrowthRatePURExpFitok |>   
  filter(Par_ue ==300) |> 
  #filter(PhotonDose == "PAR") |>
  nest(data = -c("Strain", "PhotonDose")) |> 
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PhotonDose_value, a, b, Pmax),
                                                    data = .x,
                                                    start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),
                                                    lower = c(0, 0, 0)))
                                                    #upper = c(1,1,100)), 
                                                    #0))
         ) |>   
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance))
         )

GRCplatt_PredictGrowth300 <- MultiCultiGrowthRatePURExpFit300 |>
  unnest(GRCplatt_Predict)


MultiCultiGrowthRatePURExpFit900 <- MultiCultiGrowthRatePURExpFitok |>   
  filter(Par_ue ==900) |> 
  #filter(PhotonDose == "PAR") |>
  nest(data = -c("Strain", "PhotonDose")) |> 
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PhotonDose_value, a, b, Pmax),
                                                    data = .x,
                                                    start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),
                                                    lower = c(0, 0, 0)))
                                                    #upper = c(1,1,100)), 
                                                    #0))
         ) |>   
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance))
         )

GRCplatt_PredictGrowth900 <- MultiCultiGrowthRatePURExpFit900 |>
  unnest(GRCplatt_Predict)


```


```{r}
# GRCplatt_PredictGrowth900An <- MultiCultiGrowthRatePURExpFit900 %>% 
#   unnest(cols = c(GRCplatt_Predict)) %>% 
#   unnest(cols = c(GRCplatt_Param)) %>% 
#   rownames_to_column() %>% 
#   nest(data2 = -c(Par_ue, term))


  # pivot_wider(., names_from = c(term), values_from = c(std.error, estimate, statistic, p.value, .resid, .fitted))# %>% 
  # mutate(estimate_ax = unlist((estimate_a)))

```



add columns to get nice facet
```{r}

GRCplatt_PredictGrowth30$facetsStrain = factor(GRCplatt_PredictGrowth30$PhotonDose, labels = c("Strain", "Strain"))
GRCplatt_PredictGrowth90$facetsStrain = factor(GRCplatt_PredictGrowth90$PhotonDose, labels = c("Strain", "Strain"))
GRCplatt_PredictGrowth180$facetsStrain = factor(GRCplatt_PredictGrowth180$PhotonDose, labels = c("Strain", "Strain"))
GRCplatt_PredictGrowth300$facetsStrain = factor(GRCplatt_PredictGrowth300$PhotonDose, labels = c("Strain", "Strain"))
GRCplatt_PredictGrowth900$facetsStrain = factor(GRCplatt_PredictGrowth900$PhotonDose, labels = c("Strain", "Strain"))
```


Nice plot
```{r fig.height = 8, fig.width = 8, warning = FALSE}

# O2.labs <- c("Strain")
# names(O2.labs) <- c(21)

lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("1 µE"), expression("2 µE"), expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))
scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }


ggplot(MultiCultiGrowthRatePURExpFitok, aes(PhotonDose_value, deltaOD_Lmu_corr)) +
  geom_point(aes(PhotonDose_value, deltaOD_Lmu_corr, colour=as.factor(Par_ue), shape = as.factor(Photoperiod)), alpha = 0.9, size = 3.5, show.legend = T) +
# 
#   geom_errorbar(aes(x = PhotonDose_value, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se, colour = as.factor(Par_ue)), width=4000000, data = . %>% filter(deltaOD_Lmu_se<8.057558e-03), show.legend = F) +
  geom_line(aes(PhotonDose_value, .fitted), colour = "darkslategray", show.legend = F, GRCplatt_PredictGrowth30) +
  geom_line(aes(PhotonDose_value, .fitted), colour = "lightblue4", show.legend = F, GRCplatt_PredictGrowth90) +
  geom_line(aes(PhotonDose_value, .fitted), colour = "hotpink4", show.legend = F, GRCplatt_PredictGrowth180) +
  geom_line(aes(PhotonDose_value, .fitted), colour = "indianred3", show.legend = F, GRCplatt_PredictGrowth300) +
  geom_line(aes(PhotonDose_value, .fitted), colour = "orange1", show.legend = F, GRCplatt_PredictGrowth900) +
  scale_y_continuous(breaks=seq(0, 0.25, by = 0.1)) +
  coord_cartesian(ylim = c(0, 0.25)) +
  scale_x_continuous(label=scientific_10) +
  scale_linetype_manual(values=c("equal900" = "dotted", "less900" = "solid"), breaks=c('8', '12', '16', "24", "", "")) +
  scale_colour_manual(values = c("", "", "darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2, breaks=c('', '', '30', "90", "180", "300", "900")) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "Photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  #geom_hline(aes(yintercept = 0), linetype = 2) +
    ggh4x::facet_nested(cols = vars(PhotonDose), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  #ggh4x::facet_nested(rows = vars(O2, Strain), cols = vars(PhotonDose), labeller = labeller(O2 = O2.labs)) +
  # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=12, angle = 45, vjust = 1, hjust = 1),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.92,0.88),
        #legend.position = c(0.06,0.85),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.y = unit(-0.15, "cm"),
        # legend.spacing.x = unit(0.01, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=10))



ggplot(MultiCultiGrowthRatePURExpFitok, aes(PhotonDose_value, meandeltaOD_Lmu_corr)) +
  geom_point(aes(PhotonDose_value, meandeltaOD_Lmu_corr, colour=as.factor(Par_ue), shape = as.factor(Photoperiod)), alpha = 0.9, size = 3.5, show.legend = T) +
# 
#   geom_errorbar(aes(x = PhotonDose_value, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se, colour = as.factor(Par_ue)), width=4000000, data = . %>% filter(deltaOD_Lmu_se<8.057558e-03), show.legend = F) +
  geom_line(aes(PhotonDose_value, .fitted), colour = "darkslategray", show.legend = F, GRCplatt_PredictGrowth30) +
  geom_line(aes(PhotonDose_value, .fitted), colour = "lightblue4", show.legend = F, GRCplatt_PredictGrowth90) +
  geom_line(aes(PhotonDose_value, .fitted), colour = "hotpink4", show.legend = F, GRCplatt_PredictGrowth180) +
  geom_line(aes(PhotonDose_value, .fitted), colour = "indianred3", show.legend = F, GRCplatt_PredictGrowth300) +
  geom_line(aes(PhotonDose_value, .fitted), colour = "orange1", show.legend = F, GRCplatt_PredictGrowth900) +
  scale_y_continuous(breaks=seq(0, 0.25, by = 0.1)) +
  coord_cartesian(ylim = c(0, 0.25)) +
  scale_x_continuous(label=scientific_10) +
  scale_linetype_manual(values=c("equal900" = "dotted", "less900" = "solid"), breaks=c('8', '12', '16', "24", "", "")) +
  scale_colour_manual(values = c("", "", "darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2, breaks=c('', '', '30', "90", "180", "300", "900")) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "Photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  #geom_hline(aes(yintercept = 0), linetype = 2) +
    ggh4x::facet_nested(cols = vars(PhotonDose), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  #ggh4x::facet_nested(rows = vars(O2, Strain), cols = vars(PhotonDose), labeller = labeller(O2 = O2.labs)) +
  # ggh4x::facet_nested(rows = vars(Par_ue), cols = vars(Photoperiod), labeller = labeller(Photoperiod = Photoperiod.labs,  Par_ue = Par_ue.labs, WL = WL.labs, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=12, angle = 45, vjust = 1, hjust = 1),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.92,0.88),
        #legend.position = c(0.06,0.85),
        legend.key.height= unit(0.005, 'cm'),
        legend.spacing.y = unit(-0.15, "cm"),
        # legend.spacing.x = unit(0.01, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=10))

```

```{r}
rm(MultiCultiGrowthRatePURExpFit30, MultiCultiGrowthRatePURExpFit90, MultiCultiGrowthRatePURExpFit180, MultiCultiGrowthRatePURExpFit300, MultiCultiGrowthRatePURExpFit900)
```




PIGMENTS

There are a few negative value of pigments (based on correlation) - I replaced them by 0

Growth file
```{r}
Project <- "PicoBaltic"
DataIn <- file.path("..", "ImportedData", "SySlmanuscriptWWPhotoperiod", fsep = .Platform$file.sep)
FileEncode <- "UTF-8"
Delimiter <- ","
HeaderRows <- 0
```

Growth file
Exported Rmd only first time in session
```{r}
list.files(path = DataIn, pattern = Project, full.names = TRUE)
```

Growth file
```{r read ProcessFile}

#contained mean OD per day from Multiculti and based on this OD calculated pigments per mL and per cell (pg/cell)
MultiCultiPigmentMaxFile <- "../ImportedData/SySlmanuscriptWWPhotoperiod/PicoBaltic_MultiCultiPigmentMax.Rds"
MultiCultiPigmentMaxFileName <- str_split(string = MultiCultiPigmentMaxFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")
MultiCultiPigmentMax <- readRDS(MultiCultiPigmentMaxFile)  %>%
  ungroup()

```

combine pigments data (for Solisense) and number of cells (based on MultiCulti OD) with PUR and Growth rate
```{r}
#colnames(MultiCultiGrowthRatePURExp)

MultiCultiPigmentMax<-MultiCultiPigmentMax %>% 
  mutate(MultiDay=E_days) %>% 
  mutate(OlisDate = Date) %>% 
  select(-c(FilenameMultiCulti,Filename,E_days,Date)) %>% 
    mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077")) %>% 
  select(-c(InnocDate,Abs440, Abs480, Abs565, Abs620, Abs650, Abs665))

MultiCultiGrowthRatePURExp<-MultiCultiGrowthRatePURExp %>% 
  select(-c(Filename, OD720_Lmu_corr, OD720_Lmu_se, OD720_LseGrowthFlag, GrowthAmpOD720Flag_14days))

MultiCultiPigmentMaxAll <- MultiCultiGrowthRatePURExp %>%
  left_join(., MultiCultiPigmentMax, by = c("Run"="Run","ID"="ID", "Tube"="Tube", "Strain"="Strain", "ExpDate"="ExpDate","Par_ue"="Par_ue","Photoperiod"="Photoperiod","O2"="O2","WL"="WL","LightShape"="LightShape","ExpEndDate"="ExpEndDate", "E_days"="MultiDay", "E_hours"="Time_h", "PARPhotonDose"="PARPhotonDose", "MC"="MC")) 

MultiCultiPigmentMaxAll <- MultiCultiPigmentMaxAll %>%
  mutate(cellL=cellml*1000) %>% 
  mutate(ChlaugL = ChlaugmL*1000) %>% 
  mutate(PhycougL = (PCugmL+PEugmL+APCugmL)*1000) 

```


Replace negative values in data frame by zero
```{r}
MultiCultiPigmentMaxAll <- MultiCultiPigmentMaxAll                     # Duplicate data frame
MultiCultiPigmentMaxAll[MultiCultiPigmentMaxAll < 0] <- 0     # Set negative values to 0

```
Combine Chla and phyco in one column for nice plot
```{r}
MultiCultiPigmentMaxAllChlaPhyco1<-MultiCultiPigmentMaxAll %>% 
  select(-c(Chlapgcell, Carpgcell)) %>% 
  mutate(Pigmentspgcell=Phycopgcell*1) %>% 
  select(-c(Phycopgcell))
# MultiCultiPigmentMaxAllChlaPhyco1$PigmentsName = factor(MultiCultiPigmentMaxAllChlaPhyco1$O2, labels = c("Total~Phyco~(pg~cell^{-1})"))
MultiCultiPigmentMaxAllChlaPhyco1$PigmentsName = "Phyco"

MultiCultiPigmentMaxAllChlaPhyco2<-MultiCultiPigmentMaxAll %>% 
  select(-c(Phycopgcell, Carpgcell)) %>% 
  mutate(Pigmentspgcell=Chlapgcell*1) %>% 
  select(-c(Chlapgcell))
# MultiCultiPigmentMaxAllChlaPhyco2$PigmentsName = factor(MultiCultiPigmentMaxAllChlaPhyco2$O2, labels = c("Chl~a~(pg~cell^{-1})"))
MultiCultiPigmentMaxAllChlaPhyco2$PigmentsName = "Chla"

MultiCultiPigmentMaxAllChlaPhyco3<-MultiCultiPigmentMaxAll %>% 
  select(-c(Chlapgcell, Phycopgcell)) %>% 
  mutate(Pigmentspgcell=Carpgcell*1) %>% 
  select(-c(Carpgcell))
# MultiCultiPigmentMaxAllChlaPhyco3$PigmentsName = factor(MultiCultiPigmentMaxAllChlaPhyco3$O2, labels = c("Car~(pg~cell^{-1})"))
MultiCultiPigmentMaxAllChlaPhyco3$PigmentsName = "Car"
  
MultiCultiPigmentMaxAllChlaPhyco<-rbind(MultiCultiPigmentMaxAllChlaPhyco1, MultiCultiPigmentMaxAllChlaPhyco2, MultiCultiPigmentMaxAllChlaPhyco3)

rm(MultiCultiPigmentMaxAllChlaPhyco1, MultiCultiPigmentMaxAllChlaPhyco2, MultiCultiPigmentMaxAllChlaPhyco3)
```


Plot -> pigments per cell - PAR PhotonDose and time
```{r fig.height = 8, fig.width = 8}

scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }

lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))

lab2=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab3=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))


# Plot <- MultiCultiPigmentMaxAll %>%
#   filter(Par_ue!= 600) %>% 
#   ggplot() +
#   geom_point(aes(x = E_hours, y = Chlapgcell, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), alpha = 0.9, size = 3, show.legend = T) +
#   scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab2) +
#   scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab3) +
#   labs(y = "Chl" ~italic(a)~ "content ( pg  " ~ cell^-1~")", x = "Elapsed time (h)") +
#   ggh4x::facet_nested(cols = vars(facetsPhase, Phase), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
#   theme_bw() 
# Plot


Plot <- MultiCultiPigmentMaxAllChlaPhyco %>%
  filter(Par_ue!= 600) %>% 
  ggplot() +
  geom_point(aes(x = PARPhotonDose, y = Pigmentspgcell, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), alpha = 0.9, size = 3, show.legend = T) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab2) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab3) +
  # scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  #labs(y = "Chl" ~italic(a)~ "content ( pg  " ~ cell^-1~")", x = "PARPhotonDOse") +
  # scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  # coord_cartesian(ylim = c(0, 1.2)) +
  ggh4x::facet_nested(rows = vars(facetsStrain, Strain), cols = vars(PigmentsName), labeller = label_parsed) +
  theme_bw() 
Plot



Plot <- MultiCultiPigmentMaxAll %>%
  filter(Par_ue!=600) %>% 
  ggplot() +
  # geom_smooth(aes(x = Time_h, y = PURPARRatio, colour = as.factor(Strain)),  alpha = 0, size = 0.2, linetype = "solid", show.legend = T) +
  geom_point(aes(x = E_hours, y = Phycopgcell, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
  geom_vline(data = data_vline1, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  geom_vline(data = data_vline2, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  geom_vline(data = data_vline3, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = data_vline4, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  labs(y = "Total phycobilins content ( pg  " ~ cell^-1~")", x = "Elapsed time (h)") +
  # geom_errorbar(aes(x = Photoperiod, ymin = OD720_Lmu_corr - OD720_Lmu_se, ymax = OD720_Lmu_corr + OD720_Lmu_se), size = 0.3, width=3, color = '#3C3B53', data = . %>% filter(GrowthAmpOD720Flag_14days  == 1)) +
  # scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  # coord_cartesian(ylim = c(0, 1.7)) +
  ggh4x::facet_nested(cols = vars(facetsPhotoperiod, Photoperiod), rows = vars(facetsPar_ue, Par_ue), labeller = label_parsed) +
  theme_bw()
Plot


Plot <- MultiCultiPigmentMaxAllChlaPhyco %>%
  filter(PURPARRatio<=1) %>%
  filter(PARPhotonDose == 432000|
  PARPhotonDose == 864000|
  PARPhotonDose == 1944000|
  PARPhotonDose == 3888000|
  PARPhotonDose == 6480000|
  PARPhotonDose == 8640000|
  PARPhotonDose == 77760000) %>%
  ggplot() +
  geom_point(aes(x = E_hours, y = Pigmentspgcell, colour = as.factor(Strain)), alpha = 0.9, size = 3, show.legend = T) +
  # geom_vline(data = data_vline5, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  # geom_vline(data = data_vline6, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  # geom_vline(data = data_vline7, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  # geom_vline(data = data_vline8, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  labs(y = "Pigments content ( pg  " ~ cell^-1~")", x = "Elapsed time (h)") +
  # scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  # coord_cartesian(ylim = c(0, 1.5)) +
  ggh4x::facet_nested(cols = vars(PARPhotonDose), rows = vars(PigmentsName), labeller = label_parsed) +
  # ggh4x::facet_nested(cols = vars(facets, PhotonDose), labeller = labeller(Photoperiod = Photoperiod.labs,  Strain = label_value, Par_ue = Par_ue.labs, WL = label_parsed, O2 = O2.labs)) +
  theme_bw()
Plot


Plot <- MultiCultiPigmentMaxAllChlaPhyco %>%
  filter(PURPARRatio<=1) %>%
  filter(PARPhotonDose == 432000|
  PARPhotonDose == 864000|
  PARPhotonDose == 1944000|
  PARPhotonDose == 3888000|
  PARPhotonDose == 6480000|
  PARPhotonDose == 8640000|
  PARPhotonDose == 77760000) %>%
  ggplot() +
  geom_point(aes(x = E_hours, y = Pigmentspgcell, colour = as.factor(PigmentsName)), alpha = 0.9, size = 3, show.legend = T) +
  labs(y = "Pigments content ( pg  " ~ cell^-1~")", x = "Elapsed time (h)") +
  ggh4x::facet_nested(cols = vars(PARPhotonDose), rows = vars(Strain), labeller = label_parsed) +
  theme_bw() 
Plot

```

Combine phyco/Chla ratio and car/chla ratio in one column for nice plot
```{r}
MultiCultiPigmentMaxAllChlaPhycoratio1<-MultiCultiPigmentMaxAll %>% 
  select(-c(PhycoChlaRatio)) %>% 
  mutate(PigmentsRatio=CarChlaRatio*1) %>% 
  select(-c(CarChlaRatio))
# MultiCultiPigmentMaxAllChlaPhyco1$PigmentsName = factor(MultiCultiPigmentMaxAllChlaPhyco1$O2, labels = c("Total~Phyco~(pg~cell^{-1})"))
MultiCultiPigmentMaxAllChlaPhycoratio1$PigmentsRatioName = "CarChlaRatio"

MultiCultiPigmentMaxAllChlaPhycoratio2<-MultiCultiPigmentMaxAll %>% 
  select(-c(CarChlaRatio)) %>% 
  mutate(PigmentsRatio=PhycoChlaRatio*1) %>% 
  select(-c(PhycoChlaRatio))
# MultiCultiPigmentMaxAllChlaPhyco2$PigmentsName = factor(MultiCultiPigmentMaxAllChlaPhyco2$O2, labels = c("Chl~a~(pg~cell^{-1})"))
MultiCultiPigmentMaxAllChlaPhycoratio2$PigmentsRatioName = "PhycoChlaRatio"


  
MultiCultiPigmentMaxAllChlaPhycoratio<-rbind(MultiCultiPigmentMaxAllChlaPhycoratio1, MultiCultiPigmentMaxAllChlaPhycoratio2)

rm(MultiCultiPigmentMaxAllChlaPhycoratio1, MultiCultiPigmentMaxAllChlaPhycoratio2)
```



Plot -> pigments ratio - PAR PhotonDose and time
```{r fig.height = 8, fig.width = 8}


lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))

lab2=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab3=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))


# Plot <- MultiCultiPigmentMaxAll %>%
#   filter(Par_ue!= 600) %>% 
#   ggplot() +
#   geom_point(aes(x = E_hours, y = PhycoChlaRatio, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), alpha = 0.9, size = 3, show.legend = T) +
#   scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab2) +
#   scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab3) +
#   labs(y = "Total Phyco/Chl " ~italic(a)~ "ratio", x = "Elapsed time (h)") +
#   ggh4x::facet_nested(cols = vars(facetsPhase, Phase), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
#   theme_bw() 
# Plot

Plot <- MultiCultiPigmentMaxAllChlaPhycoratio %>%
  filter(Par_ue!= 600) %>% 
  ggplot() +
  geom_point(aes(x = PARPhotonDose, y = PigmentsRatio, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), alpha = 0.9, size = 3, show.legend = T) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab2) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab3) +
  # scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  #labs(y = "Chl" ~italic(a)~ "content ( pg  " ~ cell^-1~")", x = "PARPhotonDOse") +
  # scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  # coord_cartesian(ylim = c(0, 1.2)) +
  ggh4x::facet_nested(rows = vars(facetsStrain, Strain), cols = vars(PigmentsRatioName), labeller = label_parsed) +
  theme_bw() 
Plot


Plot <- MultiCultiPigmentMaxAll %>%
  filter(Par_ue!=600) %>% 
  ggplot() +
  geom_point(aes(x = E_hours, y = PhycoChlaRatio, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
  geom_vline(data = data_vline1, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  geom_vline(data = data_vline2, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  geom_vline(data = data_vline3, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = data_vline4, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  labs(y = "Total Phyco/Chl " ~italic(a)~ "ratio", x = "Elapsed time (h)") +
  # scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  # coord_cartesian(ylim = c(0, 1.7)) +
  ggh4x::facet_nested(cols = vars(facetsPhotoperiod, Photoperiod), rows = vars(facetsPar_ue, Par_ue), labeller = label_parsed) +
  theme_bw()
Plot



Plot <- MultiCultiPigmentMaxAllChlaPhycoratio %>%
  filter(PURPARRatio<=1) %>%
  filter(PARPhotonDose == 432000|
  PARPhotonDose == 864000|
  PARPhotonDose == 1944000|
  PARPhotonDose == 3888000|
  PARPhotonDose == 6480000|
  PARPhotonDose == 8640000|
  PARPhotonDose == 77760000) %>%
  ggplot() +
  geom_point(aes(x = E_hours, y = PigmentsRatio, colour = as.factor(Strain)), alpha = 0.9, size = 3, show.legend = T) +
  # geom_vline(data = data_vline5, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  # geom_vline(data = data_vline6, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  # geom_vline(data = data_vline7, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  # geom_vline(data = data_vline8, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #labs(y = "Total Phyco/Chl " ~italic(a)~ "ratio", x = "Elapsed time (h)") +
  # scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  # coord_cartesian(ylim = c(0, 1.5)) +
  ggh4x::facet_nested(cols = vars(PARPhotonDose), rows = vars(PigmentsRatioName), labeller = label_parsed) +
  # ggh4x::facet_nested(cols = vars(facets, PhotonDose), labeller = labeller(Photoperiod = Photoperiod.labs,  Strain = label_value, Par_ue = Par_ue.labs, WL = label_parsed, O2 = O2.labs)) +
  theme_bw() 
Plot



Plot <- MultiCultiPigmentMaxAllChlaPhycoratio %>%
  filter(PURPARRatio<=1) %>%
  filter(PARPhotonDose == 432000|
  PARPhotonDose == 864000|
  PARPhotonDose == 1944000|
  PARPhotonDose == 3888000|
  PARPhotonDose == 6480000|
  PARPhotonDose == 8640000|
  PARPhotonDose == 77760000) %>%
  ggplot() +
  geom_point(aes(x = E_hours, y = PigmentsRatio, colour = as.factor(PigmentsRatioName)), alpha = 0.9, size = 3, show.legend = T) +
  #labs(y = "Pigments content ( pg  " ~ cell^-1~")", x = "Elapsed time (h)") +
  ggh4x::facet_nested(cols = vars(PARPhotonDose), rows = vars(Strain), labeller = label_parsed) +
  theme_bw() 
Plot


```


Create only one pigment in exp - for Solisense data
Combine growth rate and exp pigments
```{r}
MultiCultiPigmentMaxAllExp<-MultiCultiPigmentMaxAll 
  
O1 <- MultiCultiPigmentMaxAllExp %>%
  filter(Par_ue == 30 | Par_ue == 300 | Par_ue == 90 | Par_ue == 180) %>% 
  filter(Photoperiod == 24) %>% 
  filter(E_days < 4)

O2 <- MultiCultiPigmentMaxAllExp %>%
  filter(Par_ue == 180 | Par_ue == 300) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days == 4)

O3 <- MultiCultiPigmentMaxAllExp %>%
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days == 6)

O4 <- MultiCultiPigmentMaxAllExp %>%
  filter(Par_ue == 30) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days == 12)

O5 <- MultiCultiPigmentMaxAllExp %>%
  filter(Par_ue == 900 | Par_ue == 600) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days == 4)

O6 <- MultiCultiPigmentMaxAllExp %>%
  filter(Par_ue == 30) %>% 
  filter(Photoperiod == 8 | Photoperiod == 12) %>% 
  filter(E_days == 12| E_days == 13)
  
O7 <- MultiCultiPigmentMaxAllExp %>%
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 8) %>% 
  filter(E_days == 12 | E_days ==13)

O8 <- MultiCultiPigmentMaxAllExp %>%
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 12) %>% 
  filter(Strain == "PE-rich_127" | Strain == "PE-rich_048" | Strain == "PC-rich_077") %>% 
  filter(E_days == 8 | E_days ==9)

O9 <- MultiCultiPigmentMaxAllExp %>%
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 12) %>% 
  filter(Strain == "PC-rich_056") %>% 
  filter(E_days == 11)

O10 <- MultiCultiPigmentMaxAllExp %>%
  filter(Par_ue == 180) %>% 
  filter(Photoperiod == 8) %>% 
  filter(E_days == 8 | E_days == 9)

O11 <- MultiCultiPigmentMaxAllExp %>%
  filter(Par_ue == 180) %>% 
  filter(Photoperiod == 12) %>% 
  filter(E_days == 6 | E_days == 7)

O12 <- MultiCultiPigmentMaxAllExp %>%
  filter(Par_ue == 300) %>% 
  filter(Photoperiod == 8) %>% 
  filter(Strain == "PE-rich_127" | Strain == "PE-rich_048" | Strain == "PC-rich_077") %>% 
  filter(E_days == 6 | E_days ==7)

O13 <- MultiCultiPigmentMaxAllExp %>%
  filter(Par_ue == 300) %>% 
  filter(Photoperiod == 8) %>% 
  filter(Strain == "PC-rich_056") %>% 
  filter(E_days == 9)

O14 <- MultiCultiPigmentMaxAllExp %>%
  filter(Par_ue == 300) %>% 
  filter(Photoperiod == 12) %>% 
  filter(Strain == "PE-rich_127" | Strain == "PE-rich_048" | Strain == "PC-rich_077") %>% 
  filter(E_days == 4 | E_days ==5)

O15 <- MultiCultiPigmentMaxAllExp %>%
  filter(Par_ue == 300) %>% 
  filter(Photoperiod == 12) %>% 
  filter(Strain == "PC-rich_056") %>%  
  filter(E_days == 7)

O16 <- MultiCultiPigmentMaxAllExp %>%
  filter(Par_ue == 900) %>% 
  filter(Photoperiod == 8 | Photoperiod == 12)

O17 <- MultiCultiPigmentMaxAllExp %>%
  filter(Par_ue == 900 | Par_ue == 600) %>% 
  filter(Photoperiod == 24) %>% 
  filter(E_hours < 100 & E_hours > 48)

MultiCultiPigmentMaxAllExp2 <-rbind(O1, O2, O3, O4, O5, O6, O7, O8, O9, O10, O11, O12, O13, O14, O15, O16, O17)

rm(O1, O2, O3, O4, O5, O6, O7, O8, O9, O10, O11, O12, O13, O14, O15, O16, O17)

  
```

Because I have replica in growt rate - I combine one choosen pigmen exp to all growth rate data
```{r}
#colnames(MultiCultiDataCleanGrowthAll4)
MultiCultiPigmentMaxAllExp4<-MultiCultiPigmentMaxAllExp2 %>% 
  # mutate(cellL=cellml*1000) %>% 
  # mutate(ChlaugL = ChlaugmL*1000) %>% 
  # mutate(PhycougL = (PCugmL+PEugmL+APCugmL)*1000) %>% 
  mutate(cellLExp = cellL) %>%
  mutate(ChlapgcellExp = Chlapgcell) %>% 
  mutate(PhycopgcellExp = Phycopgcell) %>% 
  mutate(ChlaugLExp = ChlaugL) %>% 
  mutate(PhycougLExp = PhycougL) %>% 
  mutate(PhycoChlaRatioExp = PhycopgcellExp/ChlapgcellExp) %>% 
  select(c(Strain, Par_ue, Photoperiod, ChlapgcellExp, PhycopgcellExp, ChlaugLExp, PhycougLExp, PhycoChlaRatioExp, cellLExp))
  
MultiCultiPigmentMaxAllExp <- MultiCultiPigmentMaxAll %>%
  full_join(., MultiCultiPigmentMaxAllExp4, by = c("Strain"="Strain", "Par_ue"="Par_ue","Photoperiod"="Photoperiod"))


```

rm additional df
```{r}
# rm(MultiCultiGrowthAll, MultiCultiGrowth, MultiCultiGrowth121, MultiCultiDataCleanGrowthAll2, MultiCultiDataCleanGrowthAll4)
```

Plot -> only exp Phyco, Chla, and Phyco/chla ratio
```{r fig.height = 8, fig.width = 8}


lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))

lab2=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab3=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))



Plot <- MultiCultiPigmentMaxAllExp %>%
   filter(Par_ue!=600) %>% 
  ggplot() +
  geom_point(aes(x = E_hoursExp, y = PhycopgcellExp, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
  geom_vline(data = data_vline1, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  geom_vline(data = data_vline2, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  geom_vline(data = data_vline3, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = data_vline4, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  #labs(y = "Total Phyco/Chl " ~italic(a)~ "ratio", x = "Elapsed time (h)") +
  # scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  # coord_cartesian(ylim = c(0, 1.7)) +
  ggh4x::facet_nested(cols = vars(facetsPhotoperiod, Photoperiod), rows = vars(facetsPar_ue, Par_ue), labeller = label_parsed) +
  theme_bw()
Plot



Plot <- MultiCultiPigmentMaxAllExp %>%
   filter(Par_ue!=600) %>% 
  ggplot() +
  geom_point(aes(x = E_hoursExp, y = ChlapgcellExp, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
  geom_vline(data = data_vline1, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  geom_vline(data = data_vline2, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  geom_vline(data = data_vline3, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = data_vline4, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  #labs(y = "Total Phyco/Chl " ~italic(a)~ "ratio", x = "Elapsed time (h)") +
  # scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  # coord_cartesian(ylim = c(0, 1.7)) +
  ggh4x::facet_nested(cols = vars(facetsPhotoperiod, Photoperiod), rows = vars(facetsPar_ue, Par_ue), labeller = label_parsed) +
  theme_bw() 
Plot


Plot <- MultiCultiPigmentMaxAllExp %>%
  filter(Par_ue!=600) %>% 
  ggplot() +
  geom_point(aes(x = E_hoursExp, y = PhycoChlaRatioExp, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
  geom_vline(data = data_vline1, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  geom_vline(data = data_vline2, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  geom_vline(data = data_vline3, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = data_vline4, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  #labs(y = "Total Phyco/Chl " ~italic(a)~ "ratio", x = "Elapsed time (h)") +
  # scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  # coord_cartesian(ylim = c(0, 1.7)) +
  ggh4x::facet_nested(cols = vars(facetsPhotoperiod, Photoperiod), rows = vars(facetsPar_ue, Par_ue), labeller = label_parsed) +
  theme_bw() 
Plot


```

Create df with only exp data for PUR, PUR/PAR ratio, pigments and cell/L
```{r}
#colnames(MultiCultiPigmentMaxAllExp)
GrowthPigmentPURonlyExp<-MultiCultiPigmentMaxAllExp %>% 
  select(-c(SpectraDate, E_days, PUR, PURPhotonDose, PURPARRatio, E_hours, meanActinic_parDay, meanOD680Day, meanOD720Day, cellml, ChlaugmL, CarugmL, PEugmL, PCugmL, APCugmL, Chlapgcell, Carpgcell, PEpgcell, OlisDate, cellL, ChlaugL, PhycougL, PCpgcell, APCpgcell, Phycopgcell, CarChlaRatio, PhycoChlaRatio, PEPCRatio)) %>% 
  unique()
  
```





SOLISENSE
RDS already contained only data from corresponding growth light 
Also, conteined mean for sig and JVPSII - for replica measured on the same day
Also, contained mean for chla (ug/L) and cell per L based on Turner and MD Pico

Second df contained only sigma in 1s of dark after corresponding light (it caused problems when I tried to combain them)

Solisense file
```{r}
Project <- "PicoBaltic"
DataIn <- file.path("..", "ImportedData", "SolisenseDoubletap", fsep = .Platform$file.sep)
FileEncode <- "UTF-8"
Delimiter <- ","
HeaderRows <- 0
```

Solisense file
Exported only first time in session
```{r}
list.files(path = DataIn, pattern = Project, full.names = TRUE)
```


```{r read ProcessFile}
#Solisense file
SolisenseFile <- "../ImportedData/SolisenseDoubletap/PicoBaltic_SySlWWPhotoperiodAll.Rds"  

SolisenseFileName <- str_split(string = SolisenseFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")

SolFits <- readRDS(SolisenseFile)  %>%
  ungroup()


#Solisense file -> data from a new Solisense computer
Solisense2File <- "../ImportedData/SolisenseDoubletap/PicoBaltic_90024.Rds"

Solisense2FileName <- str_split(string = Solisense2File, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")

SolFits2 <- readRDS(Solisense2File)  %>%
  ungroup()

SolFits3<-rbind(SolFits,SolFits2)
rm(SolFits,SolFits2)
```





```{r read ProcessFile}
#Solisense file sigma 1s
Solisense1sFile <- "../ImportedData/SolisenseDoubletap/PicoBaltic_SySlWWPhotoperiodAllDarkafterLight.Rds"  

Solisense1sFileName <- str_split(string = Solisense1sFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")

SolFits1s <- readRDS(Solisense1sFile)  %>%
  ungroup()


#Solisense file -> sigma 1s from a new Solisense computer
Solisense21sFile <- "../ImportedData/SolisenseDoubletap/PicoBaltic_90024DarkafterLight.Rds"

Solisense21sFileName <- str_split(string = Solisense21sFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")

SolFits21s <- readRDS(Solisense21sFile)  %>%
  ungroup()

SolFits31s<-rbind(SolFits1s,SolFits21s)
rm(SolFits1s,SolFits21s)
```

combain two df contain sig in the light and sig1s in the dark after corresponding light
```{r}
# SolFits3<-SolFits3 %>%
# select(-c(ObsDateTime, Step_s, Dark1s, ActPAR, ActPARCorr, LR_s))
# 
# SolFits31s<-SolFits31s %>%
# select(-c(ObsDateTime, Step_s, Dark1s, ActPAR, ActPARCorr, LR_s, nm445, nm590, nm445Corr, nm590Corr, ActPARCorr_photonsm2s, Sig1s_m2psii))
# 
# SolFitsAlltest <- SolFits3 %>%
#   left_join(., SolFits31s, by = c("CultureID"="CultureID", "Ex_WL"="Ex_WL", "ObsDate"="ObsDate", "Par_ue"="Par_ue", "Photoperiod"="Photoperiod", "WL"="WL", "O2"="O2", "Filename"="Filename", "Run"="Run", "Strain"="Strain", "InnocDate"="InnocDate", "ExpDate"="ExpDate", "PARPhotonDose"="PARPhotonDose", "DATE"="DATE", "MDcellsL"="MDcellsL", "meanMDcellsL"="meanMDcellsL", "sdMDcellsL"="sdMDcellsL", "TurnerChl_ugL"="TurnerChl_ugL", "meanTurnerChl_ugL"="meanTurnerChl_ugL", "sdTurnerChl_ugL"="sdTurnerChl_ugL", "E_days"="E_days", "Time_h"="Time_h"))

```





```{r}
SolFitsAll <-SolFits3 %>% 
  filter(Strain=="BA127R"| Strain=="BA48R"| Strain=="BA56G"| Strain=="BA77G") %>% 
  filter(WL=="WW") %>% 
  filter(O2==21) %>% 
    mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077")) 

SolFitsAll$facetsPhotonDose = factor(SolFitsAll$WL, labels = c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"))

SolFitsAll$facetsExcitation = factor(SolFitsAll$WL, labels = c("Excitation~(nm)"))

SolFitsAll$facetsStrain = factor(SolFitsAll$WL, labels = c("Strain"))


# the same for second df contained sigma 1s
SolFits31s <-SolFits31s %>% 
  filter(Strain=="BA127R"| Strain=="BA48R"| Strain=="BA56G"| Strain=="BA77G") %>% 
  filter(WL=="WW") %>% 
  filter(O2==21) %>% 
    mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077")) 

```

Filter one weird data point 445nm, 16h, 900uE
```{r}
SolFitsAll445<-SolFitsAll %>% 
  filter(Ex_WL == 445) %>% 
  filter(Sig<250)  %>% 
  filter(meanSig_nm2psii<2.5) 

SolFitsAll590<-SolFitsAll %>% 
  filter(Ex_WL == 590) 
  
SolFitsAllChoosen<-rbind(SolFitsAll445,SolFitsAll590)
  rm(SolFitsAll445,SolFitsAll590)
  

```


choose only exp data for sigma and JVPSII in the corresponding light
```{r}
SolFitsAllChoosen2<- SolFitsAllChoosen 
  
O1 <- SolFitsAllChoosen2 %>%
  filter(Par_ue == 30 | Par_ue == 300 | Par_ue == 90 | Par_ue == 180 | Par_ue == 900) %>% 
  filter(Photoperiod == 24) %>% 
  filter(E_days <= 4)

O2 <- SolFitsAllChoosen2 %>%
  filter(Par_ue == 90 | Par_ue == 180 | Par_ue == 300) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days < 9)

O3 <- SolFitsAllChoosen2 %>%
  filter(Par_ue == 900) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days <= 4)

O4 <- SolFitsAllChoosen2 %>%
  filter(Par_ue == 30) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days <= 14)

O5 <- SolFitsAllChoosen2 %>%
  filter(Par_ue == 30) %>% 
  filter(Photoperiod == 8 | Photoperiod == 12) %>% 
  filter(E_days <=14)
  
O6 <- SolFitsAllChoosen2 %>%
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 8) %>% 
  filter(E_days <=14)

O7 <- SolFitsAllChoosen2 %>%
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 12) %>% 
  filter(E_days <=10)

O8 <- SolFitsAllChoosen2 %>%
  filter(Par_ue == 180 | Par_ue == 300) %>% 
  filter(Photoperiod == 8 | Photoperiod == 12) %>% 
  filter(E_days <=10)

O9 <- SolFitsAllChoosen2 %>%
  filter(Par_ue == 900) %>% 
  filter(Photoperiod == 8 | Photoperiod == 12) %>% 
  filter(E_days <=7)


SolFitsAllChoosenExp <-rbind(O1, O2, O3, O4, O5, O6, O7, O8, O9)

rm(O1, O2, O3, O4, O5, O6, O7, O8, O9, SolFitsAllChoosen2)


```



choose only exp data for Sig 1s
```{r}
SolFitsAllChoosen2<- SolFits31s 
  
O1 <- SolFitsAllChoosen2 %>%
  filter(Par_ue == 30 | Par_ue == 300 | Par_ue == 90 | Par_ue == 180 | Par_ue == 900) %>% 
  filter(Photoperiod == 24) %>% 
  filter(E_days <= 4)

O2 <- SolFitsAllChoosen2 %>%
  filter(Par_ue == 90 | Par_ue == 180 | Par_ue == 300) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days < 9)

O3 <- SolFitsAllChoosen2 %>%
  filter(Par_ue == 900) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days <= 4)

O4 <- SolFitsAllChoosen2 %>%
  filter(Par_ue == 30) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days <= 14)

O5 <- SolFitsAllChoosen2 %>%
  filter(Par_ue == 30) %>% 
  filter(Photoperiod == 8 | Photoperiod == 12) %>% 
  filter(E_days <=14)
  
O6 <- SolFitsAllChoosen2 %>%
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 8) %>% 
  filter(E_days <=14)

O7 <- SolFitsAllChoosen2 %>%
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 12) %>% 
  filter(E_days <=10)

O8 <- SolFitsAllChoosen2 %>%
  filter(Par_ue == 180 | Par_ue == 300) %>% 
  filter(Photoperiod == 8 | Photoperiod == 12) %>% 
  filter(E_days <=10)

O9 <- SolFitsAllChoosen2 %>%
  filter(Par_ue == 900) %>% 
  filter(Photoperiod == 8 | Photoperiod == 12) %>% 
  filter(E_days <=7)


SolFitsAllChoosenExp1s <-rbind(O1, O2, O3, O4, O5, O6, O7, O8, O9)

rm(O1, O2, O3, O4, O5, O6, O7, O8, O9, SolFitsAllChoosen2)


```


SolFitsAllChoosenExp and SolFitsAllChoosenExp1s - contained only exp data

Plot
```{r fig.height = 8, fig.width = 8, warning = FALSE}


Plot <- SolFitsAllChoosen %>%
  ggplot() +
  geom_point(aes(x = Time_h, y = Sig, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
  geom_vline(data = data_vline1, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  geom_vline(data = data_vline2, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  geom_vline(data = data_vline3, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = data_vline4, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 
Plot


Plot <- SolFitsAllChoosenExp %>%
  ggplot() +
  geom_point(aes(x = Time_h, y = Sig, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
  geom_vline(data = data_vline1, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  geom_vline(data = data_vline2, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  geom_vline(data = data_vline3, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = data_vline4, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 
Plot


Plot <- SolFitsAllChoosenExp %>%
  ggplot() +
  geom_point(aes(x = Time_h, y = meanSig, colour = as.factor(Strain)),  alpha = 0.8, size = 3, show.legend = T) +
  geom_vline(data = data_vline1, aes(xintercept = value), linetype="dotdash", colour = "brown4") +
  geom_vline(data = data_vline2, aes(xintercept = value), linetype="dotdash", colour = "brown1") +
  geom_vline(data = data_vline3, aes(xintercept = value), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = data_vline4, aes(xintercept = value), linetype="dotdash", colour = "palegreen3") +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  #labs(y = "Total Phyco/Chl " ~italic(a)~ "ratio", x = "Elapsed time (h)") +
  ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 
Plot
```




Make "one big" mean to combine all days (only from exp) and all replica when samples were measured 
(This give me only one value of JVPSII for further growth vs JVPSII plot and nice sig plot as well)

I select only data from exp phase here

Step_s, Dark1s, ActPAR, ActPARCorr, ActPARCorr_photonsm2s, LR_s, ETRCtauav, ETRqpOxbo,
```{r}
#colnames(SolFitsAllChoosenExp)
#SolFitsAllChoosen<-SolFitsAllChoosen %>% -contained all solisense data 

SolFitsAllChoosenExp<-SolFitsAllChoosenExp %>% 

  group_by(Strain, Ex_WL, Par_ue, Photoperiod) %>%

  summarize(CultureID, Ex_WL, Par_ue, Photoperiod, WL, O2, Filename, Run, Strain, InnocDate, ExpDate, PARPhotonDose, DATE, MDcellsL, meanMDcellsL, sdMDcellsL, TurnerChl_ugL, meanTurnerChl_ugL, sdTurnerChl_ugL, ObsDate, ObsDateTime, FvFm, Sig, meanSig, sdSig, Sig_nm2psii, meanSig_nm2psii, sdSig_nm2psii, Sigdark, meanSigdark_nm2psii, sdSigdark_nm2psii, Sigmax, FoOxbo, Fm, Fo, Fodark, Fomin, 
            
JVPSII_aLHIIOxbomax, JVPSII_ETRtauav_FoSig, JVPSII_ETRqpOxbo_FoSig, JVPSII_ETRtauav_aLHII_Sig, JVPSII_ETRqpOxbo_aLHII_Sig,

meanJVPSII_aLHIIOxbomax, sdJVPSII_aLHIIOxbomax, meanJVPSII_ETRtauav_FoSig, sdJVPSII_ETRtauav_FoSig, meanJVPSII_ETRqpOxbo_FoSig, sdJVPSII_ETRqpOxbo_FoSig, meanJVPSII_ETRtauav_aLHII_Sig, sdJVPSII_ETRtauav_aLHII_Sig, meanJVPSII_ETRqpOxbo_aLHII_Sig, sdJVPSII_ETRqpOxbo_aLHII_Sig, E_days, Time_h, facetsPhotonDose, facetsExcitation, facetsStrain, 

             AllmeanJVPSII_aLHIIOxbomax= mean(JVPSII_aLHIIOxbomax),
             AllmeanJVPSII_ETRtauav_FoSig= mean(JVPSII_ETRtauav_FoSig),
             AllmeanJVPSII_ETRqpOxbo_FoSig= mean(JVPSII_ETRqpOxbo_FoSig),
            AllmeanJVPSII_ETRtauav_aLHII_Sig = mean(JVPSII_ETRtauav_aLHII_Sig),
             AllmeanJVPSII_ETRqpOxbo_aLHII_Sig= mean(JVPSII_ETRqpOxbo_aLHII_Sig),
            AllmeanTurnerChl_ugL = mean(TurnerChl_ugL),
            AllsdTurnerChl_ugL = sd(TurnerChl_ugL),
            AllmeanMDcellsL= mean(MDcellsL),
            AllsdMDcellsL= sd(MDcellsL),
            AllmeanSig_nm2psii = mean(Sig_nm2psii),
            AllsdSig_nm2psii = sd(Sig_nm2psii),
            AllmeanSigdark_nm2psii = mean(Sigdark_nm2psii),
            AllsdSigdark_nm2psii = sd(Sigdark_nm2psii)) %>%
  ungroup()



```
Plot-> sigma vs time and sigma vs photon dose 
```{r fig.height = 8, fig.width = 8, warning = FALSE}


scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))


Plot<-SolFitsAllChoosenExp %>% 
  ggplot() +
  geom_point(aes(x = Time_h, y = Sig, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  labs(y = "Sigma", x = "Elapsed time (h)") +
  scale_y_continuous(breaks=seq(0, 1000, by = 200)) +
  coord_cartesian(ylim = c(0, 1000)) +
  ggh4x::facet_nested(cols = vars(facetsExcitation,Ex_WL), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  theme_bw() 
Plot



Plot<-SolFitsAllChoosenExp %>% 
  filter(Ex_WL==590) %>% 
  ggplot() +
  geom_point(aes(x = Time_h, y = Sig, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  labs(y = "Sigma", x = "Elapsed time (h)") +
  scale_y_continuous(breaks=seq(0, 1000, by = 200)) +
  coord_cartesian(ylim = c(0, 1000)) +
  ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 
Plot



Plot<-SolFitsAllChoosenExp %>% 
  ggplot() +
  geom_point(aes(x = PARPhotonDose, y = meanSig_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  geom_errorbar(aes(x = PARPhotonDose, ymin = meanSig_nm2psii - sdSig_nm2psii, ymax = meanSig_nm2psii + sdSig_nm2psii, colour=as.factor(Par_ue))) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  labs(y=expression(paste(sigma,""["PSII"]*"'(nm"^"2"*")")), x = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  # scale_y_continuous(breaks=seq(0, 1000, by = 200)) +
  # coord_cartesian(ylim = c(0, 1000)) +
  scale_x_continuous(label=scientific_10) +
  ggh4x::facet_nested(cols = vars(facetsExcitation,Ex_WL), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  theme_bw() 
Plot


Plot<-SolFitsAllChoosenExp %>% 
  ggplot() +
  geom_point(aes(x = PARPhotonDose, y = meanSigdark_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  geom_errorbar(aes(x = PARPhotonDose, ymin = meanSigdark_nm2psii - sdSigdark_nm2psii, ymax = meanSigdark_nm2psii + sdSigdark_nm2psii, colour=as.factor(Par_ue))) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  labs(y=expression(paste(sigma,""["PSII"]*" (nm"^"2"*")")), x = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  # scale_y_continuous(breaks=seq(0, 1000, by = 200)) +
  # coord_cartesian(ylim = c(0, 1000)) +
  scale_x_continuous(label=scientific_10) +
  ggh4x::facet_nested(cols = vars(facetsExcitation,Ex_WL), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  theme_bw() 
Plot


Plot<-SolFitsAllChoosenExp1s %>% # data from second df contained sig 1s
  filter(Par_ue !=600) %>% 
  ggplot() +
  geom_point(aes(x = PARPhotonDose, y = meanSig1s_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  # geom_errorbar(aes(x = PARPhotonDose, ymin = meanSig1s_nm2psii - sdSig1s_nm2psii, ymax = meanSig1s_nm2psii + sdSig1s_nm2psii, colour=as.factor(Par_ue))) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  # labs(y=expression(paste(sigma,""["PSII"]*" (nm"^"2"*")")), x = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  # scale_y_continuous(breaks=seq(0, 1000, by = 200)) +
  # coord_cartesian(ylim = c(0, 1000)) +
  scale_x_continuous(label=scientific_10) +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Strain), labeller = label_parsed) +
  theme_bw() 
Plot
```




"We recalculated all the half-life values (T 1/2 ) by using the following equation for one phase decay: Y = (Y0 -Plateau)*exp(-K*X) + Plateau, where X = Time, Y = RNA levels, starting at Y0 and decaying (with one phase) down to plateau; Y0 and plateau have same units as Y; K = Rate constant equal to the recip-
rocal of the X-axis units"

k= the rate constant for Sigma decay (i.e., percent change over time), 

https://www.researchgate.net/figure/The-one-phase-decay-curve-A-and-the-mRNA-quantification-curve-B-from-the-pulse-chase_fig1_235381210

Y = (Y0 -Plateau)*exp(-K*X) + Plateau,
Y - Sigma levels
Y0 - max Sigma
Plateau - min Sigma
X - photon dose


https://stackoverflow.com/questions/50510797/exponential-decay-fit-in-r
https://douglas-watson.github.io/post/2018-09_exponential_curve_fitting/

one phase decay

multiple curves PAR photon Dose 590 ->sin in the light
```{r}

SolFitsAllfit590 <-SolFitsAllChoosen %>% 
  filter(Ex_WL == 590) %>% 
  # filter(E_days<10) %>% 
  filter(E_days !=2) %>%
  #filter(E_days !=3) %>%
  select(c(meanSig_nm2psii, PARPhotonDose, Photoperiod, Par_ue, Strain, Ex_WL)) %>% 
  mutate(y=meanSig_nm2psii) %>% 
  mutate(t=PARPhotonDose) 
  


# Fit the data
fitted <- SolFitsAllfit590 %>% 
  nest(-Strain) %>%
  mutate(
    fit = map(data, ~nls(y ~ SSasymp(t, yf, y0, log_alpha), data = .)),
    tidied = map(fit, tidy),
    augmented590 = map(fit, augment),
  )  

# Produce a table of fit parameters: y0, yf, alpha - doesnt work for now - fix this later!
# fitted %>% 
#   unnest(tidied) %>% 
#   select(term, estimate) %>% 
#   spread(term, estimate) %>% 
#   mutate(alpha = exp(log_alpha))

#Plotting with gglot2
augmented590 <- fitted %>% 
  unnest(augmented590)
# qplot(t, y, data = augmented590, geom = 'point', colour = Strain) +
#   geom_line(aes(y=.fitted))
```

multiple curves PAR photon Dose 590 ->sig dark
```{r}

SolFitsAllfit590dark <-SolFitsAllChoosen %>% 
  filter(Ex_WL == 590) %>% 
  # filter(E_days<10) %>% 
  filter(E_days !=2) %>%
  #filter(E_days !=3) %>%
  select(c(meanSigdark_nm2psii, PARPhotonDose, Photoperiod, Par_ue, Strain, Ex_WL)) %>% 
  mutate(y=meanSigdark_nm2psii) %>% 
  mutate(t=PARPhotonDose) 
  


# Fit the data
fittedark <- SolFitsAllfit590dark %>% 
  nest(-Strain) %>%
  mutate(
    fit = map(data, ~nls(y ~ SSasymp(t, yf, y0, log_alpha), data = .)),
    tidied = map(fit, tidy),
    augmented590dark = map(fit, augment),
  )  


augmented590dark <- fittedark %>% 
  unnest(augmented590dark)
```
multiple curves PAR photon Dose 590 ->sig 1s -> doesn't work
```{r}

# SolFitsAllfit5901s <-SolFitsAllChoosenExp1s %>% 
#   filter(Ex_WL == 590) %>% 
#   filter(Par_ue != 900) %>% 
#   filter(E_days==7) %>% 
#   # filter(E_days !=2) %>%
#   # filter(E_days !=3) %>%
#   select(c(meanSig1s_nm2psii, PARPhotonDose, Photoperiod, Par_ue, Strain, Ex_WL)) %>% 
#   mutate(y=meanSig1s_nm2psii) %>% 
#   mutate(t=PARPhotonDose) 
#   
# 
# 
# # Fit the data
# fitted1s <- SolFitsAllfit5901s %>% 
#   nest(-Strain) %>%
#   mutate(
#     fit = map(data, ~nls(y ~ SSasymp(t, yf, y0, log_alpha), data = .)),
#     tidied = map(fit, tidy),
#     augmented5901s = map(fit, augment),
#   )  
# 
# 
# augmented5901s <- fitted1s %>% 
#   unnest(augmented5901s)
```


multiple curves PAR photon Dose 445 -> doesnt work
```{r}

# SolFitsAllfit445 <-SolFitsAllChoosen %>% 
#   filter(Ex_WL == 445) %>% 
#   filter(E_days==7) %>% 
#   select(c(meanSig_nm2psii, PARPhotonDose, Photoperiod, Par_ue, Strain, Ex_WL)) %>% 
#   mutate(y=meanSig_nm2psii) %>% 
#   mutate(t=PARPhotonDose) 
#   
# 
# # Fit the data
# fitted <- SolFitsAllfit445 %>% 
#   nest(-Strain) %>%
#   mutate(
#     fit = map(data, ~nls(y ~ SSasymp(t, yf, y0, log_alpha), data = .)),
#     tidied = map(fit, tidy),
#     augmented445 = map(fit, augment),
#   )  
# 
# 
# augmented445 <- fitted %>% 
#   unnest(augmented445)
# # qplot(t, y, data = augmented445, geom = 'point', colour = Strain) +
# #   geom_line(aes(y=.fitted))

```




mutate for nice plot PAR photon Dose 590 and 445
```{r}
augmented590 <- augmented590 %>% 
  mutate(Ex_WL=Strain) %>% 
      mutate(Ex_WL=case_when(Ex_WL=="PE-rich_127"~590,
         Ex_WL=="PE-rich_048"~590,
        Ex_WL=="PC-rich_056"~590,
         Ex_WL=="PC-rich_077"~590)) %>% 
  mutate(Ex_WL = as.factor(Ex_WL)) %>% 
  mutate(O2=Ex_WL) %>% 
  mutate(O2=case_when(O2==590~21)) %>% 
  mutate(WL=Ex_WL) %>% 
  mutate(WL=case_when(WL==590~"WW")) 

augmented590dark <- augmented590dark %>% 
  mutate(Ex_WL=Strain) %>% 
      mutate(Ex_WL=case_when(Ex_WL=="PE-rich_127"~590,
         Ex_WL=="PE-rich_048"~590,
        Ex_WL=="PC-rich_056"~590,
         Ex_WL=="PC-rich_077"~590)) %>% 
  mutate(Ex_WL = as.factor(Ex_WL)) %>% 
  mutate(O2=Ex_WL) %>% 
  mutate(O2=case_when(O2==590~21)) %>% 
  mutate(WL=Ex_WL) %>% 
  mutate(WL=case_when(WL==590~"WW")) 

# augmented445 <- augmented445 %>% 
#   mutate(Ex_WL=Strain) %>% 
#       mutate(Ex_WL=case_when(Ex_WL=="PE-rich_127"~445,
#          Ex_WL=="PE-rich_048"~445,
#         Ex_WL=="PC-rich_056"~445,
#          Ex_WL=="PC-rich_077"~445)) %>% 
#   mutate(Ex_WL = as.factor(Ex_WL)) %>% 
#   mutate(O2=Ex_WL) %>% 
#   mutate(O2=case_when(O2==445~21)) %>% 
#   mutate(WL=Ex_WL) %>% 
#   mutate(WL=case_when(WL==445~"WW")) 

```



Delete unused df
```{r}
rm(SolFitsAllfit445, SolFitsAllfit590)
```


Plot sigma vs photondose - mean only replica (shows different days from exp phase)
```{r fig.height = 8, fig.width = 8, warning = FALSE}


WL.labs <- c("Excitation (nm)")
names(WL.labs) <- c("WW")
O2.labs <- c("Strain")
names(O2.labs) <- c(21)


scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))



  ggplot(SolFitsAllChoosenExp, aes(x = PARPhotonDose, y = meanSig_nm2psii)) +
  geom_point(aes(x = PARPhotonDose, y = meanSig_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  geom_errorbar(aes(x = PARPhotonDose, ymin = meanSig_nm2psii - sdSig_nm2psii, ymax = meanSig_nm2psii + sdSig_nm2psii, colour=as.factor(Par_ue))) +
  geom_line(aes(t, .fitted), show.legend = F, augmented590) +
  #geom_line(aes(t, .fitted), show.legend = F, augmented445) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #labs(y = "Sigma", x = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  labs(y=expression(paste(sigma,""["PSII"]*"'(nm"^"2"*")")), x = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  # scale_y_continuous(breaks=seq(0, 1000, by = 200)) +
  # coord_cartesian(ylim = c(0, 1000)) +
  scale_x_continuous(label=scientific_10) +
  ggh4x::facet_nested(rows = vars(O2,Strain), cols = vars(WL,Ex_WL), labeller = labeller(WL = WL.labs, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=11),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.44,0.89),
        legend.key.height= unit(0.003, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        legend.spacing.x = unit(-0.1, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=9))
  
  
  
  ggplot(SolFitsAllChoosenExp, aes(x = PARPhotonDose, y = meanSigdark_nm2psii)) +
  geom_point(aes(x = PARPhotonDose, y = meanSigdark_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  geom_errorbar(aes(x = PARPhotonDose, ymin = meanSigdark_nm2psii - sdSigdark_nm2psii, ymax = meanSigdark_nm2psii + sdSigdark_nm2psii, colour=as.factor(Par_ue))) +
  geom_line(aes(t, .fitted), show.legend = F, augmented590dark) +
  #geom_line(aes(t, .fitted), show.legend = F, augmented445) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  labs(y=expression(paste(sigma,""["PSII"]*" (nm"^"2"*")")), x = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  scale_x_continuous(label=scientific_10) +
  ggh4x::facet_nested(rows = vars(O2,Strain), cols = vars(WL,Ex_WL), labeller = labeller(WL = WL.labs, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=11),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.44,0.89),
        legend.key.height= unit(0.003, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        legend.spacing.x = unit(-0.1, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=9))
  
  
    ggplot(SolFitsAllChoosenExp1s, aes(x = PARPhotonDose, y = meanSig1s_nm2psii)) +
  geom_point(aes(x = PARPhotonDose, y = meanSig1s_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  geom_errorbar(aes(x = PARPhotonDose, ymin = meanSig1s_nm2psii - sdSig1s_nm2psii, ymax = meanSig1s_nm2psii + sdSig1s_nm2psii, colour=as.factor(Par_ue))) +
  # geom_line(aes(t, .fitted), show.legend = F, augmented590dark) +
  #geom_line(aes(t, .fitted), show.legend = F, augmented445) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  labs(y=expression(paste(sigma,""["PSII"]*" (nm"^"2"*")")), x = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  scale_x_continuous(label=scientific_10) +
  ggh4x::facet_nested(rows = vars(O2,Strain), cols = vars(WL,Ex_WL), labeller = labeller(WL = WL.labs, O2 = O2.labs)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=11),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.44,0.89),
        legend.key.height= unit(0.003, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        legend.spacing.x = unit(-0.1, 'cm'),
        # legend.direction = "vertical", legend.box = "vertical",
        legend.title = element_blank(),
        legend.text = element_text(size=9))
    
    
    
```


https://www.r-bloggers.com/2020/02/a-collection-of-self-starters-for-nonlinear-regression-in-r/


sigma vs pigments

Issue - not always pigment based on Olis correspond to Solisense data-> I combine these two df with only selected exp data

Later - come back to OD680data from Multiculti and choose cell/ml (based on pamas corr) corresponding with the same day of sigma and JVPSII!!! Before calculations! Fix this Sylwia!!!!!
```{r}

SolFitsAllPigment <- SolFitsAllChoosenExp %>% 
  left_join(., GrowthPigmentPURonlyExp, by = c("Run"="Run","CultureID"="ID","Strain"="Strain","InnocDate"="InnocDate","ExpDate"="ExpDate","Par_ue"="Par_ue","Photoperiod"="Photoperiod","O2"="O2","WL"="WL","PARPhotonDose"="PARPhotonDose", "facetsStrain" = "facetsStrain")) 


SolFitsAllPigment1s <- SolFitsAllChoosenExp1s %>% 
  left_join(., GrowthPigmentPURonlyExp, by = c("Run"="Run","CultureID"="ID","Strain"="Strain","InnocDate"="InnocDate","ExpDate"="ExpDate","Par_ue"="Par_ue","Photoperiod"="Photoperiod","O2"="O2","WL"="WL","PARPhotonDose"="PARPhotonDose")) 
```




plot - one value of exp sigma and one value of exp pigment
```{r fig.height = 8, fig.width = 8, warning = FALSE}


scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))


SolFitsAllPigment %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = AllmeanSig_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
    geom_smooth(aes(x = PhycoChlaRatioExp, y = AllmeanSig_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 1, alpha =0, show.legend = F, method="lm") +
  geom_errorbar(aes(x = PhycoChlaRatioExp, ymin = AllmeanSig_nm2psii - AllsdSig_nm2psii, ymax = AllmeanSig_nm2psii + AllsdSig_nm2psii, colour=as.factor(Par_ue))) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #labs(y = "Sigma", x = "Chl" ~italic(a)~ "content ( pg  " ~ cell^-1~")") +
  labs(y=expression(paste(sigma,""["PSII"]*"' (nm"^"2"*")")), x = "Total phycobilins/Chl" ~italic(a)~ "ratio") +
  ggh4x::facet_nested(cols = vars(facetsExcitation, Ex_WL), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  theme_bw()


SolFitsAllPigment %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = AllmeanSig_nm2psii, colour = as.factor(Strain)), size = 3.5, show.legend = T) +
    geom_errorbar(aes(x = PhycoChlaRatioExp, ymin = AllmeanSig_nm2psii - AllsdSig_nm2psii, ymax = AllmeanSig_nm2psii + AllsdSig_nm2psii, colour=as.factor(Strain))) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #labs(y = "Sigma", x = "Chl" ~italic(a)~ "content ( pg  " ~ cell^-1~")") +
  labs(y=expression(paste(sigma,""["PSII"]*"' (nm"^"2"*")")), x = "Total phycobilins/Chl" ~italic(a)~ "ratio") +
  ggh4x::facet_nested(cols = vars(facetsExcitation, Ex_WL), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 


SolFitsAllPigment %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = AllmeanSigdark_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  geom_errorbar(aes(x = PhycoChlaRatioExp, ymin = AllmeanSigdark_nm2psii - AllsdSigdark_nm2psii, ymax = AllmeanSigdark_nm2psii + AllsdSigdark_nm2psii, colour=as.factor(Par_ue))) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #labs(y = "Sigma", x = "Chl" ~italic(a)~ "content ( pg  " ~ cell^-1~")") +
  labs(y=expression(paste(sigma,""["PSII"]*" (nm"^"2"*")")), x = "Total phycobilins/Chl" ~italic(a)~ "ratio") +
  ggh4x::facet_nested(cols = vars(facetsExcitation, Ex_WL), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  theme_bw() 


SolFitsAllPigment %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = AllmeanSigdark_nm2psii, colour = as.factor(Strain)), size = 3.5, show.legend = T) +
    geom_errorbar(aes(x = PhycoChlaRatioExp, ymin = AllmeanSigdark_nm2psii - AllsdSigdark_nm2psii, ymax = AllmeanSigdark_nm2psii + AllsdSigdark_nm2psii, colour=as.factor(Strain))) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #labs(y = "Sigma", x = "Chl" ~italic(a)~ "content ( pg  " ~ cell^-1~")") +
  labs(y=expression(paste(sigma,""["PSII"]*" (nm"^"2"*")")), x = "Total phycobilins/Chl" ~italic(a)~ "ratio") +
  ggh4x::facet_nested(cols = vars(facetsExcitation, Ex_WL), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 




SolFitsAllPigment1s %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = meanSig1s_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  geom_errorbar(aes(x = PhycoChlaRatioExp, ymin = meanSig1s_nm2psii - sdSig1s_nm2psii, ymax = meanSig1s_nm2psii + sdSig1s_nm2psii, colour=as.factor(Par_ue))) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #labs(y = "Sigma", x = "Chl" ~italic(a)~ "content ( pg  " ~ cell^-1~")") +
  labs(y=expression(paste(sigma,""["PSII"]*" (nm"^"2"*")")), x = "Total phycobilins/Chl" ~italic(a)~ "ratio") +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Strain), labeller = label_parsed) +
  theme_bw() 


SolFitsAllPigment1s %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = meanSig1s_nm2psii, colour = as.factor(Strain)), size = 3.5, show.legend = T) +
    geom_errorbar(aes(x = PhycoChlaRatioExp, ymin = meanSig1s_nm2psii - sdSig1s_nm2psii, ymax = meanSig1s_nm2psii + sdSig1s_nm2psii, colour=as.factor(Strain))) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #labs(y = "Sigma", x = "Chl" ~italic(a)~ "content ( pg  " ~ cell^-1~")") +
  labs(y=expression(paste(sigma,""["PSII"]*" (nm"^"2"*")")), x = "Total phycobilins/Chl" ~italic(a)~ "ratio") +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 



```



Soisense fit -> sig vs Phycobilins and chla
```{r test inhibition plot}

# #Harrison & Platt, 1986 
# grcplatt <- function(I, a, b, Pmax){Pmax * (1-exp(-a*I/Pmax)) * exp(-b*I/Pmax)} 

```


```{r platt fit}
# SolFitsAllPigmentfitPhyco <- SolFitsAllPigment |>  
#   select(c(Strain, Par_ue, Photoperiod, Ex_WL, AllmeanSig_nm2psii, PhycopgcellExp, ChlapgcellExp, PhycoChlaRatioExp, O2, WL)) |> 
#   nest(data = -c("Strain", "Ex_WL")) |>  
#   mutate(GRCplatt_Model = map(data, ~nlsLM(AllmeanSig_nm2psii ~ grcplatt(I = PhycopgcellExp, a, b, Pmax),
#                                                     data = .x,
#                                                     start = list(a = 1/10, b = 10/40, Pmax = 8),
#                                                     lower = c(0, 0, 0)))
#                                                     #upper = c(1,1,100)), 
#                                                     #0))
#          ) |>    
#   mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
#          GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
#          GRCplatt_Glance = map(GRCplatt_Model, possibly(glance))
#          )
# 
# GRCplatt_PredictPhyco <- SolFitsAllPigmentfitPhyco |>
#   unnest(GRCplatt_Predict)
# 
# 
# 
# 
# SolFitsAllPigmentfitChla <- SolFitsAllPigment |>  
#   select(c(Strain, Par_ue, Photoperiod, Ex_WL, AllmeanSig_nm2psii, PhycopgcellExp, ChlapgcellExp, PhycoChlaRatioExp, O2, WL)) |> 
#   nest(data = -c("Strain", "Ex_WL")) |>  
#   mutate(GRCplatt_Model = map(data, ~nlsLM(AllmeanSig_nm2psii ~ grcplatt(I = ChlapgcellExp, a, b, Pmax),
#                                                     data = .x,
#                                                     start = list(a = 2/20, b = 10/20, Pmax = 8),
#                                                     lower = c(0, 0, 0)))
#                                                     #upper = c(1,1,100)), 
#                                                     #0))
#          ) |>    
#   mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
#          GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
#          GRCplatt_Glance = map(GRCplatt_Model, possibly(glance))
#          )
# 
# GRCplatt_PredictChla <- SolFitsAllPigmentfitChla |>
#   unnest(GRCplatt_Predict)
# 
# 
# 
# 
# SolFitsAllPigmentfitPhycoChla <- SolFitsAllPigment |>  
#   select(c(Strain, Par_ue, Photoperiod, Ex_WL, AllmeanSig_nm2psii, PhycopgcellExp, ChlapgcellExp, PhycoChlaRatioExp, O2, WL)) |> 
#   nest(data = -c("Strain", "Ex_WL")) |>  
#   mutate(GRCplatt_Model = map(data, ~nlsLM(AllmeanSig_nm2psii ~ grcplatt(I = PhycoChlaRatioExp, a, b, Pmax),
#                                                     data = .x,
#                                                     start = list(a = 1/10, b = 2/10, Pmax = 8),
#                                                     lower = c(0, 0, 0)))
#                                                     #upper = c(1,1,100)), 
#                                                     #0))
#          ) |>    
#   mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
#          GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
#          GRCplatt_Glance = map(GRCplatt_Model, possibly(glance))
#          )
# 
# GRCplatt_PredictPhycoChla <- SolFitsAllPigmentfitPhycoChla |>
#   unnest(GRCplatt_Predict)
# #Remember Sylwia of changing start parameter if you change variables!

```


Add extra facets to create a nice plot
```{r}
# GRCplatt_PredictPhyco$facetsPhotonDose = factor(GRCplatt_PredictPhyco$Ex_WL, labels = c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})", "PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"))
# GRCplatt_PredictPhyco$facetsExcitation = factor(GRCplatt_PredictPhyco$Ex_WL, labels = c("Excitation~(nm)", "Excitation~(nm)"))
# GRCplatt_PredictPhyco$facetsStrain = factor(GRCplatt_PredictPhyco$Ex_WL, labels = c("Strain","Strain"))
# 
# GRCplatt_PredictChla$facetsPhotonDose = factor(GRCplatt_PredictChla$Ex_WL, labels = c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})", "PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"))
# GRCplatt_PredictChla$facetsExcitation = factor(GRCplatt_PredictChla$Ex_WL, labels = c("Excitation~(nm)", "Excitation~(nm)"))
# GRCplatt_PredictChla$facetsStrain = factor(GRCplatt_PredictChla$Ex_WL, labels = c("Strain", "Strain"))
# 
# GRCplatt_PredictPhycoChla$facetsPhotonDose = factor(GRCplatt_PredictPhycoChla$Ex_WL, labels = c("PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})", "PAR~photon~dose~(µmol~photons~m^{-2}~d^{-1})"))
# GRCplatt_PredictPhycoChla$facetsExcitation = factor(GRCplatt_PredictPhycoChla$Ex_WL, labels = c("Excitation~(nm)", "Excitation~(nm)"))
# GRCplatt_PredictPhycoChla$facetsStrain = factor(GRCplatt_PredictPhycoChla$Ex_WL, labels = c("Strain", "Strain"))
```



Nice Plot sig vs Chla and vs Phyco -> Platt fit
```{r fig.height = 8, fig.width = 8, warning = FALSE}


# scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
# lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
# lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))
# 
# 
# SolFitsAllPigmentfitPhyco  %>%
#   filter(!map_lgl(GRCplatt_Model, is.null))  %>%
#   unnest(GRCplatt_Predict)
#   
#   ggplot(SolFitsAllPigment, aes(x = PhycopgcellExp, y = AllmeanSig_nm2psii)) +
#   geom_point(aes(x = PhycopgcellExp, y = AllmeanSig_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) + 
#   geom_errorbar(aes(x = PhycopgcellExp, ymin = AllmeanSig_nm2psii - AllsdSig_nm2psii, ymax = AllmeanSig_nm2psii + AllsdSig_nm2psii, colour=as.factor(Par_ue))) +
#   geom_line(aes(x = PhycopgcellExp, y = `.fitted`), show.legend = F, GRCplatt_PredictPhyco) +   
#   scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
#   scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
#   #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
#   #labs(y = "Sigma", x = "Total phycobilin content ( pg "~cell^-1~")") +
#   labs(y=expression(paste(sigma,""["PSII"]*"'(nm"^"2"*")")), x = "Total phycobilin content ( pg "~cell^-1~")") +
#   ggh4x::facet_nested(cols = vars(facetsExcitation, Ex_WL), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
#   theme_bw() +
#   theme(panel.grid.minor = element_blank(),
#         panel.grid.major = element_blank(),
#         axis.text = element_text(size=12),
#         axis.text.x = element_text(size=12),
#         axis.title = element_text(size=16),
#         strip.background = element_rect(fill="white"),
#         strip.text = element_text(size=12),
#         axis.title.y = element_text(margin=margin(r=10)),
#         axis.title.x = element_text(margin=margin(t=10)),
#         legend.background = element_rect(fill="transparent"),
#         legend.position = c(0.44,0.89),
#         legend.key.height= unit(0.003, 'cm'),
#         legend.spacing.y = unit(-0.1, "cm"),
#         legend.spacing.x = unit(-0.1, 'cm'),
#         # legend.direction = "vertical", legend.box = "vertical",
#         legend.title = element_blank(),
#         legend.text = element_text(size=9))
# 
#   
#   
# SolFitsAllPigmentfitChla  %>%     
#   filter(!map_lgl(GRCplatt_Model, is.null))  %>%     
#   unnest(GRCplatt_Predict)   
#   
#   ggplot(SolFitsAllPigment, aes(x = ChlapgcellExp, y = AllmeanSig_nm2psii)) +
#   geom_point(aes(x = ChlapgcellExp, y = AllmeanSig_nm2psii, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +   
#   geom_errorbar(aes(x = ChlapgcellExp, ymin = AllmeanSig_nm2psii - AllsdSig_nm2psii, ymax = AllmeanSig_nm2psii + AllsdSig_nm2psii, colour=as.factor(Par_ue))) +
#   geom_line(aes(x = ChlapgcellExp, y = `.fitted`), show.legend = F, GRCplatt_PredictChla) +   
#   scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
#   scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
#   #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
#   #labs(y = "Sigma", x = "Chl" ~italic(a)~ "content ( pg  " ~ cell^-1~")") +
#   labs(y=expression(paste(sigma,""["PSII"]*"'(nm"^"2"*")")), x = "Chl" ~italic(a)~ "content ( pg  " ~ cell^-1~")") +
#   ggh4x::facet_nested(cols = vars(facetsExcitation, Ex_WL), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
#   theme_bw() +
#   theme(panel.grid.minor = element_blank(),
#         panel.grid.major = element_blank(),
#         axis.text = element_text(size=12),
#         axis.text.x = element_text(size=12),
#         axis.title = element_text(size=16),
#         strip.background = element_rect(fill="white"),
#         strip.text = element_text(size=12),
#         axis.title.y = element_text(margin=margin(r=10)),
#         axis.title.x = element_text(margin=margin(t=10)),
#         legend.background = element_rect(fill="transparent"),
#         legend.position = c(0.44,0.89),
#         legend.key.height= unit(0.003, 'cm'),
#         legend.spacing.y = unit(-0.1, "cm"),
#         legend.spacing.x = unit(-0.1, 'cm'),
#         # legend.direction = "vertical", legend.box = "vertical",
#         legend.title = element_blank(),
#         legend.text = element_text(size=9))

```


Combine PC and PE-rich strains together and filter day 2 and 3 b/c they caused problems
```{r}
SolFitsAllPigmentPC<-SolFitsAllPigment %>% 
  filter(E_days!=2) %>% 
  filter(E_days!=3) %>% 
  filter(Strain == "PC-rich_056" | Strain == "PC-rich_077") 
SolFitsAllPigmentPC$StrainGroup = "PC-rich"

SolFitsAllPigmentPE<-SolFitsAllPigment %>% 
  filter(E_days!=2) %>% 
  filter(E_days!=3) %>% 
  filter(Strain == "PE-rich_048" | Strain == "PE-rich_127")  
SolFitsAllPigmentPE$StrainGroup = "PE-rich"
  
SolFitsAllPigmentPCPE<-rbind(SolFitsAllPigmentPC, SolFitsAllPigmentPE)



SolFitsAllPigmentPC1s<-SolFitsAllPigment1s %>% 
  filter(E_days!=2) %>% 
  filter(E_days!=3) %>% 
  filter(Strain == "PC-rich_056" | Strain == "PC-rich_077") 
SolFitsAllPigmentPC1s$StrainGroup = "PC-rich"

SolFitsAllPigmentPE1s<-SolFitsAllPigment1s %>% 
  filter(E_days!=2) %>% 
  filter(E_days!=3) %>% 
  filter(Strain == "PE-rich_048" | Strain == "PE-rich_127")  
SolFitsAllPigmentPE1s$StrainGroup = "PE-rich"
  
SolFitsAllPigmentPCPE1s<-rbind(SolFitsAllPigmentPC1s, SolFitsAllPigmentPE1s)
```



Linear fit per par_ue
```{r linear fit}
SolFitsAllPigmentfitPhycoChlalinear <- SolFitsAllPigmentPCPE |>  
  select(c(Strain, Par_ue, Photoperiod, Ex_WL, meanSig_nm2psii, PhycoChlaRatioExp, O2, WL)) |> 
  #nest(data = -c("Strain", "Ex_WL")) |> 
  nest(data = -c("Par_ue", "Ex_WL")) |>  
  mutate(Linear_Model = map(data, ~lm(meanSig_nm2psii ~ PhycoChlaRatioExp,
                                                    data = .x))
                                                    # start = list(a = 1/10, b = 2/10, Pmax = 8),
                                                    # lower = c(0, 0, 0)))
                                                    #upper = c(1,1,100)), 
                                                    #0))
         ) |>    
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance))
         )

# Linear_Model_PredictPhycoChla <- SolFitsAllPigmentfitPhycoChlalinear |>
#   unnest(Linear_Model_Predict)


SolFitsAllPigmentfitPhycoChlalineardark <- SolFitsAllPigmentPCPE |>  
  select(c(Strain, Par_ue, Photoperiod, Ex_WL, meanSigdark_nm2psii, PhycoChlaRatioExp, O2, WL)) |> 
  #nest(data = -c("Strain", "Ex_WL")) |> 
  nest(data = -c("Par_ue", "Ex_WL")) |>  
  mutate(Linear_Model = map(data, ~lm(meanSigdark_nm2psii ~ PhycoChlaRatioExp,
                                                    data = .x))
                                                    # start = list(a = 1/10, b = 2/10, Pmax = 8),
                                                    # lower = c(0, 0, 0)))
                                                    #upper = c(1,1,100)), 
                                                    #0))
         ) |>    
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance))
         )



SolFitsAllPigmentfitPhycoChlalinear1s <- SolFitsAllPigmentPCPE1s |>  
  select(c(Strain, Par_ue, Photoperiod, Ex_WL, meanSig1s_nm2psii, PhycoChlaRatioExp, O2, WL)) |> 
  #nest(data = -c("Strain", "Ex_WL")) |> 
  nest(data = -c("Par_ue", "Ex_WL")) |>  
  mutate(Linear_Model = map(data, ~lm(meanSig1s_nm2psii ~ PhycoChlaRatioExp,
                                                    data = .x))
                                                    # start = list(a = 1/10, b = 2/10, Pmax = 8),
                                                    # lower = c(0, 0, 0)))
                                                    #upper = c(1,1,100)), 
                                                    #0))
         ) |>    
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance))
         )




SolFitsAllPigmentfitPhycoChlalinearPCPE1s <- SolFitsAllPigmentPCPE1s |>  
  select(c(StrainGroup, Par_ue, Photoperiod, Ex_WL, meanSig1s_nm2psii, PhycoChlaRatioExp, O2, WL)) |> 
  #nest(data = -c("Strain", "Ex_WL")) |> 
  nest(data = -c("Par_ue", "Ex_WL", "StrainGroup")) |>  
  mutate(Linear_Model = map(data, ~lm(meanSig1s_nm2psii ~ PhycoChlaRatioExp,
                                                    data = .x))
                                                    # start = list(a = 1/10, b = 2/10, Pmax = 8),
                                                    # lower = c(0, 0, 0)))
                                                    #upper = c(1,1,100)), 
                                                    #0))
         ) |>    
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance))
         )

```

Plot sig vs phyco/Chla ratio -> linear fit
```{r fig.height = 8, fig.width = 8, warning = FALSE}


scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))

SolFitsAllPigmentfitPhycoChlalinear |>
  unnest(Linear_Model_Predict) %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = meanSig_nm2psii, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE) + 
  geom_errorbar(aes(x = PhycoChlaRatioExp, ymin = meanSig_nm2psii - sdSig_nm2psii, ymax = meanSig_nm2psii + sdSig_nm2psii, colour=as.factor(Strain)), SolFitsAllPigmentPCPE) +
  geom_line(aes(x = PhycoChlaRatioExp, y = `.fitted`), show.legend = F) +   
  # scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  # scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  scale_y_continuous(breaks=seq(0, 8, by = 2)) +
  coord_cartesian(ylim = c(0, 9)) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #labs(y = "Sigma", x = "Total phycobilin content ( pg "~cell^-1~")") +
  #labs(y=expression(paste(sigma,""["PSII"]*"'(nm"^"2"*")")), x = "Total phycobilins/Chl" ~italic(a)~ "ratio") +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 


  SolFitsAllPigmentfitPhycoChlalineardark |>
  unnest(Linear_Model_Predict) %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = meanSigdark_nm2psii, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE) + 
  geom_errorbar(aes(x = PhycoChlaRatioExp, ymin = meanSigdark_nm2psii - sdSigdark_nm2psii, ymax = meanSigdark_nm2psii + sdSigdark_nm2psii, colour=as.factor(Strain)), SolFitsAllPigmentPCPE) +
  geom_line(aes(x = PhycoChlaRatioExp, y = `.fitted`), show.legend = F) + 
  scale_y_continuous(breaks=seq(0, 8, by = 2)) +
  coord_cartesian(ylim = c(0, 9)) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 


  SolFitsAllPigmentfitPhycoChlalinear1s |>
  unnest(Linear_Model_Predict) %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = meanSig1s_nm2psii, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE1s) + 
  geom_errorbar(aes(x = PhycoChlaRatioExp, ymin = meanSig1s_nm2psii - sdSig1s_nm2psii, ymax = meanSig1s_nm2psii + sdSig1s_nm2psii, colour=as.factor(Strain)), SolFitsAllPigmentPCPE1s) +
  geom_line(aes(x = PhycoChlaRatioExp, y = `.fitted`), show.legend = F) + 
  scale_y_continuous(breaks=seq(0, 8, by = 2)) +
  coord_cartesian(ylim = c(0, 9)) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 
  
  
```



Linear fit Strain
```{r linear fit}
SolFitsAllPigmentfitPhycoChlalinearStrain <- SolFitsAllPigmentPCPE |>  
  select(c(Strain, Par_ue, Photoperiod, Ex_WL, meanSig_nm2psii, PhycoChlaRatioExp, O2, WL)) |> 
  nest(data = -c("Strain", "Ex_WL")) |> 
  #nest(data = -c("Par_ue", "Ex_WL")) |>  
  # nest(data = -c("Ex_WL")) |> 
  mutate(Linear_Model = map(data, ~lm(meanSig_nm2psii ~ PhycoChlaRatioExp,
                                                    data = .x))
                                                    # start = list(a = 1/10, b = 2/10, Pmax = 8),
                                                    # lower = c(0, 0, 0)))
                                                    #upper = c(1,1,100)), 
                                                    #0))
         ) |>    
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance))
         )




SolFitsAllPigmentfitPhycoChlalineardarkStrain <- SolFitsAllPigmentPCPE |>  
  select(c(Strain, Par_ue, Photoperiod, Ex_WL, meanSigdark_nm2psii, PhycoChlaRatioExp, O2, WL)) |> 
  nest(data = -c("Strain", "Ex_WL")) |> 
  #nest(data = -c("Par_ue", "Ex_WL")) |> 
  # nest(data = -c("Ex_WL")) |> 
  mutate(Linear_Model = map(data, ~lm(meanSigdark_nm2psii ~ PhycoChlaRatioExp,
                                                    data = .x))
                                                    # start = list(a = 1/10, b = 2/10, Pmax = 8),
                                                    # lower = c(0, 0, 0)))
                                                    #upper = c(1,1,100)), 
                                                    #0))
         ) |>    
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance))
         )



SolFitsAllPigmentfitPhycoChlalinearStrain1s <- SolFitsAllPigmentPCPE1s |>  
  select(c(Strain, Par_ue, Photoperiod, Ex_WL, meanSig1s_nm2psii, PhycoChlaRatioExp, O2, WL)) |> 
  nest(data = -c("Strain", "Ex_WL")) |> 
  #nest(data = -c("Par_ue", "Ex_WL")) |>  
  # nest(data = -c("Ex_WL")) |> 
  mutate(Linear_Model = map(data, ~lm(meanSig1s_nm2psii ~ PhycoChlaRatioExp,
                                                    data = .x))
                                                    # start = list(a = 1/10, b = 2/10, Pmax = 8),
                                                    # lower = c(0, 0, 0)))
                                                    #upper = c(1,1,100)), 
                                                    #0))
         ) |>    
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance))
         )

#xxxxxx


SolFitsAllPigmentfitPhycoChlalinearStrainGroup <- SolFitsAllPigmentPCPE |>  
  select(c(StrainGroup, Par_ue, Photoperiod, Ex_WL, meanSig_nm2psii, PhycoChlaRatioExp, O2, WL)) |> 
  nest(data = -c("StrainGroup", "Ex_WL")) |> 
  #nest(data = -c("Par_ue", "Ex_WL")) |>  
  # nest(data = -c("Ex_WL")) |> 
  mutate(Linear_Model = map(data, ~lm(meanSig_nm2psii ~ PhycoChlaRatioExp,
                                                    data = .x))
         ) |>    
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance))
         )


SolFitsAllPigmentfitPhycoChlalineardarkStrainGroup <- SolFitsAllPigmentPCPE |>  
  select(c(StrainGroup, Par_ue, Photoperiod, Ex_WL, meanSigdark_nm2psii, PhycoChlaRatioExp, O2, WL)) |> 
  nest(data = -c("StrainGroup", "Ex_WL")) |> 
  #nest(data = -c("Par_ue", "Ex_WL")) |> 
  # nest(data = -c("Ex_WL")) |> 
  mutate(Linear_Model = map(data, ~lm(meanSigdark_nm2psii ~ PhycoChlaRatioExp,
                                                    data = .x))
         ) |>    
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance))
         )


SolFitsAllPigmentfitPhycoChlalinearStrainGroup1s <- SolFitsAllPigmentPCPE1s |>  
  select(c(StrainGroup, Par_ue, Photoperiod, Ex_WL, meanSig1s_nm2psii, PhycoChlaRatioExp, O2, WL)) |> 
  nest(data = -c("StrainGroup", "Ex_WL")) |> 
  #nest(data = -c("Par_ue", "Ex_WL")) |>  
  # nest(data = -c("Ex_WL")) |> 
  mutate(Linear_Model = map(data, ~lm(meanSig1s_nm2psii ~ PhycoChlaRatioExp,
                                                    data = .x))
         ) |>    
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance))
         )
```

Plot sig vs phyco/Chla ratio -> linear fit
```{r fig.height = 8, fig.width = 8, warning = FALSE}

scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))


SolFitsAllPigmentfitPhycoChlalinearStrain |>
  unnest(Linear_Model_Predict) %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = meanSig_nm2psii, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE) + 
  geom_errorbar(aes(x = PhycoChlaRatioExp, ymin = meanSig_nm2psii - sdSig_nm2psii, ymax = meanSig_nm2psii + sdSig_nm2psii, colour=as.factor(Strain)), SolFitsAllPigmentPCPE) +
  geom_line(aes(x = PhycoChlaRatioExp, y = `.fitted`), show.legend = F) +   
  # scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  # scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  scale_y_continuous(breaks=seq(0, 8, by = 2)) +
  coord_cartesian(ylim = c(0, 9)) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Strain), labeller = label_parsed) +
  theme_bw() 


  SolFitsAllPigmentfitPhycoChlalineardarkStrain |>
  unnest(Linear_Model_Predict) %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = meanSigdark_nm2psii, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE) + 
  geom_errorbar(aes(x = PhycoChlaRatioExp, ymin = meanSigdark_nm2psii - sdSigdark_nm2psii, ymax = meanSigdark_nm2psii + sdSigdark_nm2psii, colour=as.factor(Strain)), SolFitsAllPigmentPCPE) +
  geom_line(aes(x = PhycoChlaRatioExp, y = `.fitted`), show.legend = F) + 
  scale_y_continuous(breaks=seq(0, 8, by = 2)) +
  coord_cartesian(ylim = c(0, 9)) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Strain),labeller = label_parsed) +
  theme_bw() 
  
  
  SolFitsAllPigmentfitPhycoChlalinearStrain1s |>
  unnest(Linear_Model_Predict) %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = meanSig1s_nm2psii, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE1s) + 
  geom_errorbar(aes(x = PhycoChlaRatioExp, ymin = meanSig1s_nm2psii - sdSig1s_nm2psii, ymax = meanSig1s_nm2psii + sdSig1s_nm2psii, colour=as.factor(Strain)), SolFitsAllPigmentPCPE1s) +
  geom_line(aes(x = PhycoChlaRatioExp, y = `.fitted`), show.legend = F) +   
  scale_y_continuous(breaks=seq(0, 8, by = 2)) +
  coord_cartesian(ylim = c(0, 9)) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Strain), labeller = label_parsed) +
  theme_bw() 
  
  #xxxxxxxx
  
  SolFitsAllPigmentfitPhycoChlalineardarkStrainGroup |>
  unnest(Linear_Model_Predict) %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = meanSigdark_nm2psii, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE) + 
  geom_errorbar(aes(x = PhycoChlaRatioExp, ymin = meanSigdark_nm2psii - sdSigdark_nm2psii, ymax = meanSigdark_nm2psii + sdSigdark_nm2psii, colour=as.factor(Strain)), SolFitsAllPigmentPCPE) +
  geom_line(aes(x = PhycoChlaRatioExp, y = `.fitted`), show.legend = F) + 
  scale_y_continuous(breaks=seq(0, 8, by = 2)) +
  coord_cartesian(ylim = c(0, 9)) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(StrainGroup),labeller = label_parsed) +
  theme_bw() 
  
```

Linear fit Ex_WL
```{r linear fit}
SolFitsAllPigmentfitPhycoChlalinearExWL <- SolFitsAllPigmentPCPE |>  
  select(c(Strain, Par_ue, Photoperiod, Ex_WL, meanSig_nm2psii, PhycoChlaRatioExp, O2, WL)) |> 
  #nest(data = -c("Strain", "Ex_WL")) |> 
  #nest(data = -c("Par_ue", "Ex_WL")) |>  
  nest(data = -c("Ex_WL")) |> 
  mutate(Linear_Model = map(data, ~lm(meanSig_nm2psii ~ PhycoChlaRatioExp,
                                                    data = .x))
                                                    # start = list(a = 1/10, b = 2/10, Pmax = 8),
                                                    # lower = c(0, 0, 0)))
                                                    #upper = c(1,1,100)), 
                                                    #0))
         ) |>    
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance))
         )



SolFitsAllPigmentfitPhycoChlalineardarkExWL <- SolFitsAllPigmentPCPE |>  
  select(c(Strain, Par_ue, Photoperiod, Ex_WL, meanSigdark_nm2psii, PhycoChlaRatioExp, O2, WL)) |> 
  #nest(data = -c("Strain", "Ex_WL")) |> 
  #nest(data = -c("Par_ue", "Ex_WL")) |> 
  nest(data = -c("Ex_WL")) |> 
  mutate(Linear_Model = map(data, ~lm(meanSigdark_nm2psii ~ PhycoChlaRatioExp,
                                                    data = .x))
                                                    # start = list(a = 1/10, b = 2/10, Pmax = 8),
                                                    # lower = c(0, 0, 0)))
                                                    #upper = c(1,1,100)), 
                                                    #0))
         ) |>    
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance))
         )



SolFitsAllPigmentfitPhycoChlalinearExWL1s <- SolFitsAllPigmentPCPE1s |>  
  select(c(Strain, Par_ue, Photoperiod, Ex_WL, meanSig1s_nm2psii, PhycoChlaRatioExp, O2, WL)) |> 
  #nest(data = -c("Strain", "Ex_WL")) |> 
  #nest(data = -c("Par_ue", "Ex_WL")) |>  
  nest(data = -c("Ex_WL")) |> 
  mutate(Linear_Model = map(data, ~lm(meanSig1s_nm2psii ~ PhycoChlaRatioExp,
                                                    data = .x))
                                                    # start = list(a = 1/10, b = 2/10, Pmax = 8),
                                                    # lower = c(0, 0, 0)))
                                                    #upper = c(1,1,100)), 
                                                    #0))
         ) |>    
  mutate(Linear_Model_Param = map(Linear_Model, tidy),          
         Linear_Model_Predict = map(Linear_Model, possibly(augment)),          
         Linear_Model_Glance = map(Linear_Model, possibly(glance))
         )





```

Plot sig vs phyco/Chla ratio -> linear fit
```{r fig.height = 8, fig.width = 8, warning = FALSE}

scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))


SolFitsAllPigmentfitPhycoChlalinearExWL |>
  unnest(Linear_Model_Predict) %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = meanSig_nm2psii, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE) + 
  # geom_errorbar(aes(x = PhycoChlaRatioExp, ymin = AllmeanSigdark_nm2psii - AllsdSigdark_nm2psii, ymax = AllmeanSigdark_nm2psii + AllsdSigdark_nm2psii, colour=as.factor(Par_ue))) +
  geom_line(aes(x = PhycoChlaRatioExp, y = `.fitted`), show.legend = F) +   
  # scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  # scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  scale_y_continuous(breaks=seq(0, 8, by = 2)) +
  coord_cartesian(ylim = c(0, 9)) +
  ggh4x::facet_nested(cols = vars(Ex_WL), labeller = label_parsed) +
  theme_bw() 



  SolFitsAllPigmentfitPhycoChlalineardarkExWL |>
  unnest(Linear_Model_Predict) %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = meanSigdark_nm2psii, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE) + 
  geom_line(aes(x = PhycoChlaRatioExp, y = `.fitted`), show.legend = F) +  
  scale_y_continuous(breaks=seq(0, 8, by = 2)) +
  coord_cartesian(ylim = c(0, 9)) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  ggh4x::facet_nested(cols = vars(Ex_WL), labeller = label_parsed) +
  theme_bw() 

  
  SolFitsAllPigmentfitPhycoChlalinearExWL1s |>
  unnest(Linear_Model_Predict) %>% 
  ggplot() +
  geom_point(aes(x = PhycoChlaRatioExp, y = meanSig1s_nm2psii, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigmentPCPE1s) + 
  geom_line(aes(x = PhycoChlaRatioExp, y = `.fitted`), show.legend = F) +   
  scale_y_continuous(breaks=seq(0, 8, by = 2)) +
  coord_cartesian(ylim = c(0, 9)) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  ggh4x::facet_nested(cols = vars(Ex_WL), labeller = label_parsed) +
  theme_bw() 

  
  
  # SolFitsAllPigmentfitPhycoChlalineardarkExWL |>
  # unnest(Linear_Model_Predict) %>% 
  # 
  # ggplot() +
  # geom_point(aes(x = PhycoChlaRatioExp, y = AllmeanSigdark_nm2psii, colour=as.factor(Strain)), size = 3.5, show.legend = T, SolFitsAllPigment) + 
  # geom_errorbar(aes(x = PhycoChlaRatioExp, ymin = AllmeanSigdark_nm2psii - AllsdSigdark_nm2psii, ymax = AllmeanSigdark_nm2psii + AllsdSigdark_nm2psii, colour=as.factor(Strain)), SolFitsAllPigment) +
  # geom_line(aes(x = PhycoChlaRatioExp, y = `.fitted`), show.legend = F) +   
  # scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  # ggh4x::facet_nested(cols = vars(Ex_WL), rows = vars(Strain),labeller = label_parsed) +
  # theme_bw() 
  
```

STATISTICS

fullmodel <- lm(mpg ~ cyl + disp + hp + wt, data = mtcars)
reducedmodel <- lm(mpg ~ cyl + disp, data = mtcars)

library(lmtest) ->Likelihood Ratio Test
lrtest(fullmodel, reducedmodel)


The likelihood-ratio test in statistics compares the goodness of fit of two nested regression models based on the ratio of their likelihoods, specifically one obtained by maximization over the entire parameter space and another obtained after imposing some constraint.
To see if these two models differ significantly, we can use a likelihood ratio test with the following null and alternative hypotheses.

H0: Both the full and nested models fit the data equally well. As a result, you should employ the nested model.
H1: The full model significantly outperforms the nested model in terms of data fit. As a result, you should use the entire model.


Significant difference between two linear regression lines
There are two methods,
1: fit everything under a linear model and test for the interaction term
2: calculate z statistic between the two means
?3: Fit a model of both lines independently and then fit a model which uses the same intercept and slope for each and then use anova to test the difference of the two models

https://stats.stackexchange.com/questions/435644/is-there-a-method-to-look-for-significant-difference-between-two-linear-regressi  
```{r}
library(lmtest)
library(nlme)
library(agricolae)
# lrtest(Linear_Model_PredictPhycoChlalinearExWL1s, Linear_Model_PredictPhycoChlalinearExWL1s) 

# ggplot(SolFitsAllPigmentfitPhycoChlalineardarkStrainGroupPE,aes(y=meanSigdark_nm2psii,x=PhycoChlaRatioExp,col=StrainGroup)) + geom_point() + geom_smooth(method="lm")

#Method 1: t-test ->fitting everything under a linear model and test for the interaction term
SolFitsAllPigmentfitPhycoChlalineardarkStrainGroupPE <- SolFitsAllPigmentPCPE |>
  filter(Ex_WL==590) %>%
  select(c(StrainGroup, Ex_WL, meanSigdark_nm2psii, PhycoChlaRatioExp))

summary(lm(meanSigdark_nm2psii ~ PhycoChlaRatioExp + StrainGroup + PhycoChlaRatioExp:StrainGroup, data = SolFitsAllPigmentfitPhycoChlalineardarkStrainGroupPE))

#zMethod2:  score test-> calculate z statistic between the two means (finding the difference between the two coefficients, and then dividing by a pooled standard error)
# compare.coeff <- function(b1,se1,b2,se2){
# return((b1-b2)/sqrt(se1^2+se2^2))
# }
# 
# lm1 = lm(meanSigdark_nm2psii ~ PhycoChlaRatioExp,data=subset(SolFitsAllPigmentfitPhycoChlalineardarkStrainGroupPE,SolFitsAllPigmentfitPhycoChlalineardarkStrainGroupPE$StrainGroup=="PC-rich"))
# lm2 = lm(meanSigdark_nm2psii ~ PhycoChlaRatioExp,data=subset(SolFitsAllPigmentfitPhycoChlalineardarkStrainGroupPE,SolFitsAllPigmentfitPhycoChlalineardarkStrainGroupPE$StrainGroup=="PE-rich"))
# 
# b1 <- summary(lm1)$coefficients[2,1]
# se1 <- summary(lm1)$coefficients[2,2]
# b2 <- summary(lm2)$coefficients[2,1]
# se2 <- summary(lm2)$coefficients[2,2]
# 
# p_value = 2*pnorm(-abs(compare.coeff(b1,se1,b2,se2)))
# p_value


#Method 4: 
SolFitsAllPigmentfitPhycoChlalineardarkStrainGroupPE <- SolFitsAllPigmentPCPE |>
  filter(Ex_WL==590) %>%
  select(c(StrainGroup, Ex_WL, meanSigdark_nm2psii, PhycoChlaRatioExp))

summary(lm(meanSigdark_nm2psii ~ PhycoChlaRatioExp * StrainGroup, data = SolFitsAllPigmentfitPhycoChlalineardarkStrainGroupPE))
```
http://www.sthda.com/english/articles/40-regression-analysis/167-simple-linear-regression-in-r/
We can first check the correlation coefficient. The correlation coefficient value ranges between -1 (perfect negative correlation: when x increases, y decreases) and +1 (perfect positive correlation: when x increases, y increases).
Summary from lm tell us about a significant relationship between the predictors (x) and the outcome variable (y).






ANOVA testing whether the more complex model is significantly better at capturing the data than the simpler model. 





```{r}
library(agricolae)
data("PlantGrowth")
plant.lm <- lm(weight ~ group, data = PlantGrowth)
plant.av <- aov(plant.lm)
#plant.av <- aov(weight ~ group, data = PlantGrowth) #gives the same result
summary(plant.av)

tukey.test <- TukeyHSD(plant.av)
tukey.test


plant.lm <- lm(weight ~ group, data = PlantGrowth)
plant.av <- aov(weight ~ group, data = PlantGrowth)
summary(plant.av)


```


```{r}
library(agricolae)
data(sweetpotato)
model<-aov(yield~virus, data=sweetpotato)
out <- HSD.test(model,"virus", group=TRUE,console=TRUE)
plot(out)
```

different approaches
  #ANOVA test with no assumption of equal variances
  oneway.test(estimate_Pmax ~ Strain, data = SolFitsAllPigmentfitPhycoChlaParam445)
  
  #Pairwise t-tests with no assumption of equal variances
  pairwise.t.test(SolFitsAllPigmentfitPhycoChlaParam445$estimate_Pmax,SolFitsAllPigmentfitPhycoChlaParam445$Strain, p.adjust.method = "BH", pool.sd = FALSE)
  
  #Non-parametric alternative to one-way ANOVA test
  kruskal.test(estimate_Pmax ~ Strain, data = SolFitsAllPigmentfitPhycoChlaParam445)
  
  #The unpaired two-samples t-test (is used to compare the mean of two independent groups) = independent t-test
  res <- t.test(estimate_Pmax ~ Ex_WL, data = SolFitsAllPigmentfitPhycoChlaParam445, var.equal = TRUE)
  res
  

Stats - compare parameters - a, b, Pmax from sig vs phyco/chla ratio (SolFitsAllPigmentfitPhycoChla)
```{r}

# SolFitsAllPigmentfitPhycoChlaParam445<-SolFitsAllPigmentfitPhycoChla %>% 
#   filter(Ex_WL==445) %>% 
#   unnest(GRCplatt_Param) %>% 
#   select(c(Strain, Ex_WL, term, estimate)) %>% 
#   pivot_wider(., names_from = c(term), values_from = c(term, estimate)) 
# 
#   #create dummy replica
#   SolFitsAllPigmentfitPhycoChlaParam445<-rbind(SolFitsAllPigmentfitPhycoChlaParam445, SolFitsAllPigmentfitPhycoChlaParam445)
# 
#   #One-way Anova
#   SolFits445_a <- aov(estimate_a ~ Strain, SolFitsAllPigmentfitPhycoChlaParam445)
#   SummaryAnovaSolFits445_a<-summary(SolFits445_a) 
#   SolFits445_Pmax <- aov(estimate_Pmax ~ Strain, SolFitsAllPigmentfitPhycoChlaParam445)
#   SummaryAnovaSolFits445_Pmax<-summary(SolFits445_Pmax) 
#   #Tukey multiple pairwise-comparisons (As the ANOVA test is significant, we can compute Tukey HSD for performing multiple pairwise-comparison between the means of groups)
#   SummaryTukeySolFits445_a<-TukeyHSD(SolFits445_a)
#   SummaryTukeySolFits445_Pmax<-TukeyHSD(SolFits445_Pmax)
#    
#   
#   
#   
#   SolFitsAllPigmentfitPhycoChlaParam590<-SolFitsAllPigmentfitPhycoChla %>% 
#   filter(Ex_WL==590) %>% 
#   unnest(GRCplatt_Param) %>% 
#   select(c(Strain, Ex_WL, term, estimate)) %>% 
#   pivot_wider(., names_from = c(term), values_from = c(term, estimate)) 
# 
#   #create dummy replica
#   SolFitsAllPigmentfitPhycoChlaParam590<-rbind(SolFitsAllPigmentfitPhycoChlaParam590, SolFitsAllPigmentfitPhycoChlaParam590)
# 
#   #One-way Anova
#   SolFits590_a <- aov(estimate_a ~ Strain, SolFitsAllPigmentfitPhycoChlaParam590)
#   SummaryAnovaSolFits590_a<-summary(SolFits590_a) 
#   SolFits590_Pmax <- aov(estimate_Pmax ~ Strain, SolFitsAllPigmentfitPhycoChlaParam590)
#   SummaryAnovaSolFits590_Pmax<-summary(SolFits590_Pmax) 
#   #Tukey multiple pairwise-comparisons (As the ANOVA test is significant, we can compute Tukey HSD for performing multiple pairwise-comparison between the means of groups)
#   SummaryTukeySolFits590_a<-TukeyHSD(SolFits590_a)
#   SummaryTukeySolFits590_Pmax<-TukeyHSD(SolFits590_Pmax)
# 
# rm(SolFits445_a, SolFits445_Pmax, SolFits590_a, SolFits590_Pmax)
# 
# # library(data.table)
# # data1 <- data.table(SummaryAnovaSolFits590_a)
# # data2 <- data.table(SummaryAnovaSolFits590_Pmax)
# # l = list(data1, data2)
# # rbindlist(l)

```

Stats - compare fits from sig vs phyco/chla ratio (SolFitsAllPigmentfitPhycoChla)
```{r}


# SolFitsAllPigmentfitPhycoChlaPredict445<-SolFitsAllPigmentfitPhycoChla %>% 
#   filter(Ex_WL==445) %>% 
#   unnest(GRCplatt_Predict) %>% 
#   select(c(Strain, Ex_WL, ".fitted")) 
#   #One-way Anova
#   SolFits445_fitted <- aov(.fitted ~ Strain, SolFitsAllPigmentfitPhycoChlaPredict445)
#   SummaryAnovaSolFits445_fitted<-summary(SolFits445_fitted) 
#   #Tukey multiple pairwise-comparisons 
#   SummaryTukeySolFits445_fitted<-TukeyHSD(SolFits445_fitted)
# 
#   
# SolFitsAllPigmentfitPhycoChlaPredict590<-SolFitsAllPigmentfitPhycoChla %>% 
#   filter(Ex_WL==590) %>% 
#   unnest(GRCplatt_Predict) %>% 
#   select(c(Strain, Ex_WL, ".fitted")) 
#   #One-way Anova
#   SolFits590_fitted <- aov(.fitted ~ Strain, SolFitsAllPigmentfitPhycoChlaPredict590)
#   SummaryAnovaSolFits590_fitted<-summary(SolFits590_fitted) 
#   #Tukey multiple pairwise-comparisons 
#   SummaryTukeySolFits590_fitted<-TukeyHSD(SolFits590_fitted)
# 
# rm(SolFits445_fitted, SolFits590_fitted)


```




JVPSII

JVPSII vs Chl Turner (ug/L) and JVPSII vs photonDose
I also have data for ChlaugLExp based on Olis corr, but Chla Turner is better
```{r fig.height = 8, fig.width = 8, warning = FALSE}
#colnames(SolFitsAllPigment)

SolFitsAllPigment %>% 
  #filter(E_days< 13) %>% 
  ggplot() +
  geom_point(aes(x = AllmeanTurnerChl_ugL, y = JVPSII_ETRqpOxbo_aLHII_Sig, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  # geom_errorbar(aes(x = ChlapgcellExp, ymin = AllmeanSig_nm2psii - AllsdSig_nm2psii, ymax = AllmeanSig_nm2psii + AllsdSig_nm2psii, colour=as.factor(Par_ue))) +
  #geom_point(aes(x = ActPAR, y = Sig, colour = as.factor(Strain)), show.legend = F) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #labs(y = "Sigma", x = "Chl" ~italic(a)~ "content ( pg  " ~ cell^-1~")") +
  #labs(y=expression(paste(sigma,""["PSII"]*"'(nm"^"2"*")")), x = "Chl" ~italic(a)~ "content ( pg  " ~ cell^-1~")") +
  ggh4x::facet_nested(cols = vars(facetsExcitation, Ex_WL), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  theme_bw()


SolFitsAllPigment %>% 
  ggplot() +
  geom_point(aes(x = cellLExp, y = JVPSII_ETRqpOxbo_aLHII_Sig, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #labs(y = "Sigma", x = "Chl" ~italic(a)~ "content ( pg  " ~ cell^-1~")") +
  #labs(y=expression(paste(sigma,""["PSII"]*"'(nm"^"2"*")")), x = "Chl" ~italic(a)~ "content ( pg  " ~ cell^-1~")") +
  ggh4x::facet_nested(cols = vars(facetsExcitation, Ex_WL), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  theme_bw() 



SolFitsAllPigment %>% 
  ggplot() +
  geom_point(aes(x = AllmeanMDcellsL, y = JVPSII_ETRqpOxbo_aLHII_Sig, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #labs(y = "Sigma", x = "Chl" ~italic(a)~ "content ( pg  " ~ cell^-1~")") +
  #labs(y=expression(paste(sigma,""["PSII"]*"'(nm"^"2"*")")), x = "Chl" ~italic(a)~ "content ( pg  " ~ cell^-1~")") +
  ggh4x::facet_nested(cols = vars(facetsExcitation, Ex_WL), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  theme_bw()


SolFitsAllPigment %>% 
  #filter(E_days< 13) %>% 
  ggplot() +
  geom_point(aes(x = E_days, y = JVPSII_ETRqpOxbo_aLHII_Sig, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, show.legend = T) +
  scale_shape_manual(values = c(15, 16, 17,18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #labs(y = "Sigma", x = "Chl" ~italic(a)~ "content ( pg  " ~ cell^-1~")") +
  #labs(y=expression(paste(sigma,""["PSII"]*"'(nm"^"2"*")")), x = "Chl" ~italic(a)~ "content ( pg  " ~ cell^-1~")") +
  ggh4x::facet_nested(cols = vars(facetsExcitation, Ex_WL), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  theme_bw()

```




Growth rate vs JVPSII
#meandeltaOD_Lmu_corr ->mean for real replica from MultiCulti
```{r fig.height = 8, fig.width = 8, warning = FALSE}


# JVPSII_aLHIIOxbomax
# JVPSII_ETRtauav_FoSig
# JVPSII_ETRqpOxbo_FoSig
# JVPSII_ETRtauav_aLHII_Sig
# JVPSII_ETRqpOxbo_aLHII_Sig


lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("1 µE"), expression("2 µE"), expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))
scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }

Plot<-SolFitsAllPigment %>% 
  filter(Ex_WL==445) %>% 
ggplot() +
  geom_point(aes(AllmeanJVPSII_ETRqpOxbo_aLHII_Sig, meandeltaOD_Lmu_corr, colour=as.factor(Strain)), alpha = 0.9, size = 3.5, show.legend = T) +
#   geom_errorbar(aes(x = PhotonDose_value, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se, colour = as.factor(Par_ue)), width=4000000, data = . %>% filter(deltaOD_Lmu_se<8.057558e-03), show.legend = F) +
  # scale_y_continuous(breaks=seq(0, 0.25, by = 0.1)) +
  # coord_cartesian(ylim = c(0, 0.25)) +
  scale_x_continuous(label=scientific_10) +
  # scale_linetype_manual(values=c("equal900" = "dotted", "less900" = "solid"), breaks=c('8', '12', '16', "24", "", "")) +
  # scale_colour_manual(values = c("", "", "darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2, breaks=c('', '', '30', "90", "180", "300", "900")) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  #labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = ""~italic(JV)~""["PSII"]*" ( µmol"~e^-~""~L^-1~""~s^-1~")") +

    ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 
Plot


```



JVPSII per Turner Chl ug/L and per cell/L
```{r}
#colnames(SolFitsAllPigment)

# JVPSII_aLHIIOxbomax
# JVPSII_ETRtauav_FoSig
# JVPSII_ETRqpOxbo_FoSig
# JVPSII_ETRtauav_aLHII_Sig
# JVPSII_ETRqpOxbo_aLHII_Sig

SolFitsAllPigmentTurner<-SolFitsAllPigment %>% 
  #Turner
  mutate(meanJVPSII_aLHIIOxbomax_Chl = meanJVPSII_aLHIIOxbomax/AllmeanTurnerChl_ugL) %>% 
  mutate(meanJVPSII_ETRtauav_FoSig_Chl = meanJVPSII_ETRtauav_FoSig/AllmeanTurnerChl_ugL) %>% 
  mutate(meanJVPSII_ETRqpOxbo_FoSig_Chl = meanJVPSII_ETRqpOxbo_FoSig/AllmeanTurnerChl_ugL) %>% 
  mutate(meanJVPSII_ETRtauav_aLHII_Sig_Chl = meanJVPSII_ETRtauav_aLHII_Sig/AllmeanTurnerChl_ugL) %>% 
  mutate(meanJVPSII_ETRqpOxbo_aLHII_Sig_Chl = meanJVPSII_ETRqpOxbo_aLHII_Sig/AllmeanTurnerChl_ugL) %>% 
  
  #cell per L based on MD Pico
  mutate(meanJVPSII_aLHIIOxbomax_MDcell = meanJVPSII_aLHIIOxbomax/AllmeanMDcellsL) %>% 
  mutate(meanJVPSII_ETRtauav_FoSig_MDcell = meanJVPSII_ETRtauav_FoSig/AllmeanMDcellsL) %>% 
  mutate(meanJVPSII_ETRqpOxbo_FoSig_MDcell = meanJVPSII_ETRqpOxbo_FoSig/AllmeanMDcellsL) %>% 
  mutate(meanJVPSII_ETRtauav_aLHII_Sig_MDcell = meanJVPSII_ETRtauav_aLHII_Sig/AllmeanMDcellsL) %>% 
  mutate(meanJVPSII_ETRqpOxbo_aLHII_Sig_MDcell = meanJVPSII_ETRqpOxbo_aLHII_Sig/AllmeanMDcellsL) %>% 
  
  #cell per L based on pamas corr
  mutate(meanJVPSII_aLHIIOxbomax_Corrcell = meanJVPSII_aLHIIOxbomax/cellLExp) %>% 
  mutate(meanJVPSII_ETRtauav_FoSig_Corrcell = meanJVPSII_ETRtauav_FoSig/cellLExp) %>% 
  mutate(meanJVPSII_ETRqpOxbo_FoSig_Corrcell = meanJVPSII_ETRqpOxbo_FoSig/cellLExp) %>% 
  mutate(meanJVPSII_ETRtauav_aLHII_Sig_Corrcell = meanJVPSII_ETRtauav_aLHII_Sig/cellLExp) %>% 
  mutate(meanJVPSII_ETRqpOxbo_aLHII_Sig_Corrcell = meanJVPSII_ETRqpOxbo_aLHII_Sig/cellLExp) %>% 
  
 
  #Turner - one value
  mutate(AllmeanJVPSII_aLHIIOxbomax_Chl = AllmeanJVPSII_aLHIIOxbomax/AllmeanTurnerChl_ugL) %>% 
  mutate(AllmeanJVPSII_ETRtauav_FoSig_Chl = AllmeanJVPSII_ETRtauav_FoSig/AllmeanTurnerChl_ugL) %>% 
  mutate(AllmeanJVPSII_ETRqpOxbo_FoSig_Chl = AllmeanJVPSII_ETRqpOxbo_FoSig/AllmeanTurnerChl_ugL) %>% 
  mutate(AllmeanJVPSII_ETRtauav_aLHII_Sig_Chl = AllmeanJVPSII_ETRtauav_aLHII_Sig/AllmeanTurnerChl_ugL) %>% 
  mutate(AllmeanJVPSII_ETRqpOxbo_aLHII_Sig_Chl = AllmeanJVPSII_ETRqpOxbo_aLHII_Sig/AllmeanTurnerChl_ugL) %>% 
  
  #cell per L based on MD Pico - one value
  mutate(AllmeanJVPSII_aLHIIOxbomax_MDcell = AllmeanJVPSII_aLHIIOxbomax/AllmeanMDcellsL) %>% 
  mutate(AllmeanJVPSII_ETRtauav_FoSig_MDcell = AllmeanJVPSII_ETRtauav_FoSig/AllmeanMDcellsL) %>% 
  mutate(AllmeanJVPSII_ETRqpOxbo_FoSig_MDcell = AllmeanJVPSII_ETRqpOxbo_FoSig/AllmeanMDcellsL) %>% 
  mutate(AllmeanJVPSII_ETRtauav_aLHII_Sig_MDcell = AllmeanJVPSII_ETRtauav_aLHII_Sig/AllmeanMDcellsL) %>% 
  mutate(AllmeanJVPSII_ETRqpOxbo_aLHII_Sig_MDcell = AllmeanJVPSII_ETRqpOxbo_aLHII_Sig/AllmeanMDcellsL) %>% 
  
  #cell per L based on pamas corr - one value
  mutate(AllmeanJVPSII_aLHIIOxbomax_Corrcell = AllmeanJVPSII_aLHIIOxbomax/cellLExp) %>% 
  mutate(AllmeanJVPSII_ETRtauav_FoSig_Corrcell = AllmeanJVPSII_ETRtauav_FoSig/cellLExp) %>% 
  mutate(AllmeanJVPSII_ETRqpOxbo_FoSig_Corrcell = AllmeanJVPSII_ETRqpOxbo_FoSig/cellLExp) %>% 
  mutate(AllmeanJVPSII_ETRtauav_aLHII_Sig_Corrcell = AllmeanJVPSII_ETRtauav_aLHII_Sig/cellLExp) %>% 
  mutate(AllmeanJVPSII_ETRqpOxbo_aLHII_Sig_Corrcell = AllmeanJVPSII_ETRqpOxbo_aLHII_Sig/cellLExp) 
  
  #Olis
  # mutate(AllmeanJVPSII_aLHIIminmax_ChlExp = AllmeanJVPSII_aLHIIminmax/ChlaugLExp) %>% 
  # mutate(AllmeanJVPSII_aLHIIdark_ChlExp = AllmeanJVPSII_aLHIIdark/ChlaugLExp) %>% 
  # mutate(AllmeanJVPSII_ETRC_WtTau_ChlExp = AllmeanJVPSII_ETRC_WtTau/ChlaugLExp) %>% 
  # mutate(AllmeanJVPSII_ETRqp_ChlExp = AllmeanJVPSII_ETRqp/ChlaugLExp) %>% 
  # mutate(AllmeanJVPSII_ETRqpOxbo_ChlExp = AllmeanJVPSII_ETRqpOxbo/ChlaugLExp) %>% 
  
```





Growth rate vs JVPSII per Chl Turner 


Plot - Chl Olis (ChlaugLExp) vs  Chl Turner (AllmeanChl)
```{r fig.height = 8, fig.width = 8, warning = FALSE}

# lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
# lab2=c(expression("1 µE"), expression("2 µE"), expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))
# scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
# 
# 
# Plot<-SolFitsAllPigment %>% 
# ggplot() +
#   geom_point(aes(ChlaugLExp, AllmeanChl, colour=as.factor(Par_ue), shape = as.factor(Photoperiod)), alpha = 0.9, size = 3.5, show.legend = T) +
# #   geom_errorbar(aes(x = PhotonDose_value, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se, colour = as.factor(Par_ue)), width=4000000, data = . %>% filter(deltaOD_Lmu_se<8.057558e-03), show.legend = F) +
#   # scale_y_continuous(breaks=seq(0, 0.25, by = 0.1)) +
#   # coord_cartesian(ylim = c(0, 0.25)) +
#   # scale_x_continuous(label=scientific_10) +
#   scale_linetype_manual(values=c("equal900" = "dotted", "less900" = "solid"), breaks=c('8', '12', '16', "24", "", "")) +
#   scale_colour_manual(values = c("", "", "darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2, breaks=c('', '', '30', "90", "180", "300", "900")) +
#   #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
#   scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
#   geom_hline(yintercept = 0, linetype = "dashed") +
#   geom_vline(xintercept = 0, linetype = "dashed") +
#   geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
#   #labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "Photon dose ( µmol photons "~m^-2~""~d^-1~")") +
#     ggh4x::facet_nested(rows = vars(facetsStrain, Strain), labeller = label_parsed) +
#   theme_bw() 
# Plot


```

Growth rate vs JVPSII per Chl Turner
```{r fig.height = 8, fig.width = 8, warning = FALSE}

# JVPSII_aLHIIOxbomax
# JVPSII_ETRtauav_FoSig
# JVPSII_ETRqpOxbo_FoSig
# JVPSII_ETRtauav_aLHII_Sig
# JVPSII_ETRqpOxbo_aLHII_Sig



lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("1 µE"), expression("2 µE"), expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))
scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }


Plot<-SolFitsAllPigmentTurner %>% 
  filter(Ex_WL==445) %>% 
ggplot() +
  geom_point(aes(AllmeanJVPSII_ETRqpOxbo_aLHII_Sig_Chl, meandeltaOD_Lmu_corr, colour=as.factor(Strain)), alpha = 0.9, size = 3.5, show.legend = T) +
  scale_x_continuous(label=scientific_10) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
    ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 
Plot


Plot<-SolFitsAllPigmentTurner %>% 
  filter(Ex_WL==445) %>% 
ggplot() +
  geom_point(aes(AllmeanJVPSII_ETRqpOxbo_aLHII_Sig_Chl, meandeltaOD_Lmu_corr, colour=as.factor(Par_ue), shape = as.factor(Photoperiod)), alpha = 0.9, size = 3.5, show.legend = T) +
  scale_x_continuous(label=scientific_10) +
  scale_linetype_manual(values=c("equal900" = "dotted", "less900" = "solid"), breaks=c('8', '12', '16', "24", "", "")) +
  scale_colour_manual(values = c("", "", "darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2, breaks=c('', '', '30', "90", "180", "300", "900")) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
    ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Strain), labeller = label_parsed) +
  theme_bw() 
Plot

```


Growth rate vs JVPSII per cell/L based on Pamas correlation

Growth rate vs JVPSII per cell
```{r fig.height = 8, fig.width = 8, warning = FALSE}

# JVPSII_aLHIIOxbomax
# JVPSII_ETRtauav_FoSig
# JVPSII_ETRqpOxbo_FoSig
# JVPSII_ETRtauav_aLHII_Sig
# JVPSII_ETRqpOxbo_aLHII_Sig


lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("1 µE"), expression("2 µE"), expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))
scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }


Plot<-SolFitsAllPigmentTurner %>% 
  filter(Ex_WL==445) %>% 
ggplot() +
  geom_point(aes(AllmeanJVPSII_ETRqpOxbo_aLHII_Sig_Corrcell, meandeltaOD_Lmu_corr, colour=as.factor(Strain)), alpha = 0.9, size = 3.5, show.legend = T) +
  scale_x_continuous(label=scientific_10) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
    ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 
Plot


Plot<-SolFitsAllPigmentTurner %>% 
  filter(Ex_WL==445) %>% 
ggplot() +
  geom_point(aes(AllmeanJVPSII_ETRqpOxbo_aLHII_Sig_Corrcell, meandeltaOD_Lmu_corr, colour=as.factor(Par_ue), shape = as.factor(Photoperiod)), alpha = 0.9, size = 3.5, show.legend = T) +
  scale_x_continuous(label=scientific_10) +
  scale_linetype_manual(values=c("equal900" = "dotted", "less900" = "solid"), breaks=c('8', '12', '16', "24", "", "")) +
  scale_colour_manual(values = c("", "", "darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2, breaks=c('', '', '30', "90", "180", "300", "900")) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
    ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Strain), labeller = label_parsed) +
  theme_bw() 
Plot

```


Growth rate vs JVPSII per cell/L based on MD Pico

Growth rate vs JVPSII per cell
```{r fig.height = 8, fig.width = 8, warning = FALSE}

# JVPSII_aLHIIOxbomax
# JVPSII_ETRtauav_FoSig
# JVPSII_ETRqpOxbo_FoSig
# JVPSII_ETRtauav_aLHII_Sig
# JVPSII_ETRqpOxbo_aLHII_Sig


lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("1 µE"), expression("2 µE"), expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))
scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }


Plot<-SolFitsAllPigmentTurner %>% 
  filter(Ex_WL==445) %>% 
ggplot() +
  geom_point(aes(AllmeanJVPSII_ETRqpOxbo_aLHII_Sig_MDcell, meandeltaOD_Lmu_corr, colour=as.factor(Strain)), alpha = 0.9, size = 3.5, show.legend = T) +
  scale_x_continuous(label=scientific_10) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
    ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 
Plot


Plot<-SolFitsAllPigmentTurner %>% 
  filter(Ex_WL==445) %>% 
ggplot() +
  geom_point(aes(AllmeanJVPSII_ETRqpOxbo_aLHII_Sig_MDcell, meandeltaOD_Lmu_corr, colour=as.factor(Par_ue), shape = as.factor(Photoperiod)), alpha = 0.9, size = 3.5, show.legend = T) +
  scale_x_continuous(label=scientific_10) +
  scale_linetype_manual(values=c("equal900" = "dotted", "less900" = "solid"), breaks=c('8', '12', '16', "24", "", "")) +
  scale_colour_manual(values = c("", "", "darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2, breaks=c('', '', '30', "90", "180", "300", "900")) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
    ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Strain), labeller = label_parsed) +
  theme_bw() 
Plot

```

Growt rate per day
```{r}
#colnames(SolFitsAllPigmentTurnerDay2)
SolFitsAllPigmentTurnerDay2<-SolFitsAllPigmentTurner %>% 
  # select(-c(Alp1QA, Tau1QA, Alp2QA, Tau2QA, Alp3QA, Tau3QA, WtTau, InvWtTau, C_WtTau, Fmdark, Fodark, Fomin, Fmmax, Sigdark, Sigmax, qp, aLHIIdark, aLHIIminmax, meanSig, sdSig, sdSig_m2psii, deltaOD_LseGrowthFlag, GrowthAmpdeltaODFlag_14days)) %>% 
  mutate(deltaOD_Lmu_corr_day=deltaOD_Lmu_corr*24) %>% 
  mutate(deltaOD_Lmu_se_day=deltaOD_Lmu_se*24) %>% 
  mutate(meandeltaOD_Lmu_corr_day=meandeltaOD_Lmu_corr*24) %>% 
  mutate(sddeltaOD_Lmu_corr_day=sddeltaOD_Lmu_corr*24)

```

```{r}

# SolFitsAllPigmentTurnerDayTest<-SolFitsAllPigmentTurnerDay2 %>% 
#   mutate(AllmeanJVPSII_aLHIIOxbomax_Corrcell_day = case_when(Photoperiod != 24 ~ AllmeanJVPSII_aLHIIOxbomax_Corrcell*3600*Photoperiod/2, Photoperiod == 24 ~ AllmeanJVPSII_aLHIIOxbomax_Corrcell*3600*Photoperiod)) %>% 
```

calculate JVPSII per day
```{r}

# JVPSII_aLHIIOxbomax
# JVPSII_ETRtauav_FoSig
# JVPSII_ETRqpOxbo_FoSig
# JVPSII_ETRtauav_aLHII_Sig
# JVPSII_ETRqpOxbo_aLHII_Sig


SolFitsAllPigmentTurnerDay81216<-SolFitsAllPigmentTurnerDay2 %>% 
  filter(Photoperiod !=24) %>% 
  mutate(AllmeanJVPSII_aLHIIOxbomax_Corrcell_day = AllmeanJVPSII_aLHIIOxbomax_Corrcell*3600*Photoperiod/2) %>% 
  mutate(AllmeanJVPSII_ETRtauav_FoSig_Corrcell_day = AllmeanJVPSII_ETRtauav_FoSig_Corrcell*3600*Photoperiod/2) %>% 
  mutate(AllmeanJVPSII_ETRqpOxbo_FoSig_Corrcell_day = AllmeanJVPSII_ETRqpOxbo_FoSig_Corrcell*3600*Photoperiod/2) %>% 
  mutate(AllmeanJVPSII_ETRtauav_aLHII_Sig_Corrcell_day = AllmeanJVPSII_ETRtauav_aLHII_Sig_Corrcell*3600*Photoperiod/2) %>% 
  mutate(AllmeanJVPSII_ETRqpOxbo_aLHII_Sig_Corrcell_day = AllmeanJVPSII_ETRqpOxbo_aLHII_Sig_Corrcell*3600*8/2) %>%
  mutate(meanJVPSII_aLHIIOxbomax_Corrcell_day = meanJVPSII_aLHIIOxbomax_Corrcell*3600*Photoperiod/2) %>% 
  mutate(meanJVPSII_ETRtauav_FoSig_Corrcell_day = meanJVPSII_ETRtauav_FoSig_Corrcell*3600*Photoperiod/2) %>% 
  mutate(meanJVPSII_ETRqpOxbo_FoSig_Corrcell_day = meanJVPSII_ETRqpOxbo_FoSig_Corrcell*3600*Photoperiod/2) %>% 
  mutate(meanJVPSII_ETRtauav_aLHII_Sig_Corrcell_day = meanJVPSII_ETRtauav_aLHII_Sig_Corrcell*3600*Photoperiod/2) %>% 
  mutate(meanJVPSII_ETRqpOxbo_aLHII_Sig_Corrcell_day = meanJVPSII_ETRqpOxbo_aLHII_Sig_Corrcell*3600*Photoperiod/2) 
  
SolFitsAllPigmentTurnerDay900<-SolFitsAllPigmentTurnerDay2 %>% 
  filter(Photoperiod ==24) %>% 
  mutate(AllmeanJVPSII_aLHIIOxbomax_Corrcell_day = AllmeanJVPSII_aLHIIOxbomax_Corrcell*3600*Photoperiod) %>% 
  mutate(AllmeanJVPSII_ETRtauav_FoSig_Corrcell_day = AllmeanJVPSII_ETRtauav_FoSig_Corrcell*3600*Photoperiod) %>% 
  mutate(AllmeanJVPSII_ETRqpOxbo_FoSig_Corrcell_day = AllmeanJVPSII_ETRqpOxbo_FoSig_Corrcell*3600*Photoperiod) %>% 
  mutate(AllmeanJVPSII_ETRtauav_aLHII_Sig_Corrcell_day = AllmeanJVPSII_ETRtauav_aLHII_Sig_Corrcell*3600*Photoperiod) %>% 
  mutate(AllmeanJVPSII_ETRqpOxbo_aLHII_Sig_Corrcell_day = AllmeanJVPSII_ETRqpOxbo_aLHII_Sig_Corrcell*3600*Photoperiod) %>%
  mutate(meanJVPSII_aLHIIOxbomax_Corrcell_day = meanJVPSII_aLHIIOxbomax_Corrcell*3600*Photoperiod) %>% 
  mutate(meanJVPSII_ETRtauav_FoSig_Corrcell_day = meanJVPSII_ETRtauav_FoSig_Corrcell*3600*Photoperiod) %>% 
  mutate(meanJVPSII_ETRqpOxbo_FoSig_Corrcell_day = meanJVPSII_ETRqpOxbo_FoSig_Corrcell*3600*Photoperiod) %>% 
  mutate(meanJVPSII_ETRtauav_aLHII_Sig_Corrcell_day = meanJVPSII_ETRtauav_aLHII_Sig_Corrcell*3600*Photoperiod) %>% 
  mutate(meanJVPSII_ETRqpOxbo_aLHII_Sig_Corrcell_day = meanJVPSII_ETRqpOxbo_aLHII_Sig_Corrcell*3600*Photoperiod) 
  

SolFitsAllPigmentTurnerDay<-rbind(SolFitsAllPigmentTurnerDay81216, SolFitsAllPigmentTurnerDay900)
  rm(SolFitsAllPigmentTurnerDay81216, SolFitsAllPigmentTurnerDay900)
```


Growth rate vs JVPSII per cell (pamas corr) per day
```{r fig.height = 8, fig.width = 8, warning = FALSE}

# JVPSII_aLHIIOxbomax
# JVPSII_ETRtauav_FoSig
# JVPSII_ETRqpOxbo_FoSig
# JVPSII_ETRtauav_aLHII_Sig
# JVPSII_ETRqpOxbo_aLHII_Sig


lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("1 µE"), expression("2 µE"), expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))
scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }

Plot<-SolFitsAllPigmentTurnerDay %>% 
  filter(Ex_WL==445) %>% 
ggplot() +
  geom_point(aes(AllmeanJVPSII_aLHIIOxbomax_Corrcell_day, deltaOD_Lmu_corr_day, colour=as.factor(Strain)), alpha = 0.9, size = 3.5, show.legend = T) +
  scale_x_continuous(label=scientific_10) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
    ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw()
Plot

Plot<-SolFitsAllPigmentTurnerDay %>% 
  filter(Ex_WL==445) %>% 
ggplot() +
  geom_point(aes(AllmeanJVPSII_ETRtauav_FoSig_Corrcell_day, deltaOD_Lmu_corr_day, colour=as.factor(Strain)), alpha = 0.9, size = 3.5, show.legend = T) +
  scale_x_continuous(label=scientific_10) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
    ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 
Plot

Plot<-SolFitsAllPigmentTurnerDay %>% 
  filter(Ex_WL==445) %>% 
ggplot() +
  geom_point(aes(AllmeanJVPSII_ETRqpOxbo_FoSig_Corrcell_day, deltaOD_Lmu_corr_day, colour=as.factor(Strain)), alpha = 0.9, size = 3.5, show.legend = T) +
  scale_x_continuous(label=scientific_10) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
    ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 
Plot



Plot<-SolFitsAllPigmentTurnerDay %>% 
  filter(Ex_WL==445) %>% 
ggplot() +
  geom_point(aes(AllmeanJVPSII_ETRtauav_aLHII_Sig_Corrcell_day, deltaOD_Lmu_corr_day, colour=as.factor(Strain)), alpha = 0.9, size = 3.5, show.legend = T) +
  scale_x_continuous(label=scientific_10) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
    ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 
Plot


Plot<-SolFitsAllPigmentTurnerDay %>% 
  filter(Ex_WL==445) %>% 
ggplot() +
  geom_point(aes(AllmeanJVPSII_ETRqpOxbo_aLHII_Sig_Corrcell_day, deltaOD_Lmu_corr_day, colour=as.factor(Strain)), alpha = 0.9, size = 3.5, show.legend = T) +
  scale_x_continuous(label=scientific_10) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
    ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 
Plot


Plot<-SolFitsAllPigmentTurnerDay %>% 
  filter(Ex_WL==445) %>% 
ggplot() +
  geom_point(aes(AllmeanJVPSII_ETRqpOxbo_aLHII_Sig_Corrcell_day, deltaOD_Lmu_corr_day, colour=as.factor(Par_ue)), alpha = 0.9, size = 3.5, show.legend = T) +
  scale_x_continuous(label=scientific_10) +
  scale_linetype_manual(values=c("equal900" = "dotted", "less900" = "solid"), breaks=c('8', '12', '16', "24", "", "")) +
  scale_colour_manual(values = c("", "", "darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2, breaks=c('', '', '30', "90", "180", "300", "900")) +
  #scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
    ggh4x::facet_nested(labeller = label_parsed) +
  theme_bw() 
Plot

```

Nice labs
```{r}
  #labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = ""~italic(JV)~""["PSII"]*" ( µmol"~e^-~""~"µg Chl"~italic(a)~""^-1~""~s^-1~")") +

  #labs(y = "Total Phyco/Chl " ~italic(a)~ "ratio", x = "Elapsed time (h)") +

  #labs(y = "Sigma", x = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
```



6.02 x 10^23 electrons per mole

6.02*10e23 = 6.02e+24
6.02e+24/1000000 = 6.02e+18 ->umol e



# Save assembled spectra data set
```{r save Olis}

# saveRDS(SolFitsAllPigmentTurnerDay, file.path(DataOut, paste(Project, "SolFitsAllPigmentTurnerNew.Rds", sep = "_"), fsep = .Platform$file.sep))


```



Load previous choosen Olis file - for nice plot
```{r read ProcessFile}
# #File choosen for spectra plot - 4 spectra only
# OLISSpectraMetaAllPURShortFile <- "../ImportedData/SySlmanuscriptWWPhotoperiod/PicoBaltic_OLISSpectraMetaAllPURShort.Rds"
# OLISSpectraMetaAllPURShortFileName <- str_split(string = OLISSpectraMetaAllPURShortFile, "/")[[1]][3] %>%
#   str_remove(pattern = ".Rds")
# OLISSpectraMetaAllPURShort <- readRDS(OLISSpectraMetaAllPURShortFile)  %>%
#   ungroup()

# #All PUR data combined with MultiCulti Catalog
# OLISSpectraMetaAllPURPARRatioCleanFile <- "../ImportedData/SySlmanuscriptWWPhotoperiod/PicoBaltic_OLISSpectraMetaAllPURPARRatioClean.Rds"
# OLISSpectraMetaAllPURPARRatioCleanFileName <- str_split(string = OLISSpectraMetaAllPURPARRatioCleanFile, "/")[[1]][3] %>%
#   str_remove(pattern = ".Rds")
# OLISSpectraMetaAllPURPARRatioClean <- readRDS(OLISSpectraMetaAllPURPARRatioCleanFile)  %>%
#   ungroup()
# 
# #Choosen PUR exponential - 80 values
# OLISSpectraMetaAllPURPARRatioCleanExpPURFile <- "../ImportedData/SySlmanuscriptWWPhotoperiod/PicoBaltic_OLISSpectraMetaAllPURPARRatioCleanExpPUR.Rds"
# OLISSpectraMetaAllPURPARRatioCleanExpPURFileName <- str_split(string = OLISSpectraMetaAllPURPARRatioCleanExpPURFile, "/")[[1]][3] %>%
#   str_remove(pattern = ".Rds")
# OLISSpectraMetaAllPURPARRatioCleanExpPUR <- readRDS(OLISSpectraMetaAllPURPARRatioCleanExpPURFile)  %>%
#   ungroup()
# 
# #Choosen PUR pre-stationary - 80 values
# OLISSpectraMetaAllPURPARRatioCleanStatPURFile <- "../ImportedData/SySlmanuscriptWWPhotoperiod/PicoBaltic_OLISSpectraMetaAllPURPARRatioCleanStatPUR.Rds"
# OLISSpectraMetaAllPURPARRatioCleanStatPURFileName <- str_split(string = OLISSpectraMetaAllPURPARRatioCleanStatPURFile, "/")[[1]][3] %>%
#   str_remove(pattern = ".Rds")
# OLISSpectraMetaAllPURPARRatioCleanStatPUR <- readRDS(OLISSpectraMetaAllPURPARRatioCleanStatPURFile)  %>%
#   ungroup()
# 
# #Pigments from Clariostar combined with Olis Abs- for correlation 
# ClarioPigmentFileDataAll2File <- "../ImportedData/SySlmanuscriptWWPhotoperiod/PicoBaltic_ClarioPigmentFileDataAll2.Rds"
# ClarioPigmentFileDataAll2FileName <- str_split(string = ClarioPigmentFileDataAll2File, "/")[[1]][3] %>%
#   str_remove(pattern = ".Rds")
# ClarioPigmentFileDataAll2 <- readRDS(ClarioPigmentFileDataAll2File)  %>%
#   ungroup()

#Turner, MD Pico and pugments per mL
# ClarioOlisPigmentTurnerDataFile <- "../ImportedData/SySlmanuscriptWWPhotoperiod/PICO_ClarioOlisPigmentTurnerData.Rds"
# ClarioOlisPigmentTurnerDataFileName <- str_split(string = ClarioOlisPigmentTurnerDataFile, "/")[[1]][3] %>%
#   str_remove(pattern = ".Rds")
# ClarioOlisPigmentTurnerData <- readRDS(ClarioOlisPigmentTurnerDataFile)  %>%
#   ungroup()

```


Growth file
```{r read ProcessFile}

# #Growth rate combined with all PUR data
# MultiCultiDataCleanGrowth2File <- "../ImportedData/SySlmanuscriptWWPhotoperiod/PicoBaltic_MultiCultiDataCleanGrowth2.Rds"
# MultiCultiDataCleanGrowth2FileName <- str_split(string = MultiCultiDataCleanGrowth2File, "/")[[1]][3] %>%
#   str_remove(pattern = ".Rds")
# MultiCultiDataCleanGrowth2 <- readRDS(MultiCultiDataCleanGrowth2File)  %>%
#   ungroup()
# 
# #Growth rate with flags and SE combined with only exp PUR data - 80 values
# MultiCultiDataCleanGrowth3File <- "../ImportedData/SySlmanuscriptWWPhotoperiod/PicoBaltic_MultiCultiDataCleanGrowth3.Rds"
# MultiCultiDataCleanGrowth3FileName <- str_split(string = MultiCultiDataCleanGrowth3File, "/")[[1]][3] %>%
#   str_remove(pattern = ".Rds")
# MultiCultiDataCleanGrowth3 <- readRDS(MultiCultiDataCleanGrowth3File)  %>%
#   ungroup()
# 
# #data necessary for plot growth curve (round time) for all runs - contained od750, od680 and Actinic Par data
# MultiCultiDataAllStrainsokFile <- "../ImportedData/SySlmanuscriptWWPhotoperiod/PicoBaltic_MultiCultiDataAllStrainsokAll.Rds"
# MultiCultiDataAllStrainsokFileName <- str_split(string = MultiCultiDataAllStrainsokFile, "/")[[1]][3] %>%
#   str_remove(pattern = ".Rds")
# MultiCultiDataAllStrainsok <- readRDS(MultiCultiDataAllStrainsokFile)  %>%
#   ungroup()

# #contained mean od per day from Multiculti and based on this od calculated pigments per mL and per cell (pg/cell)
# MultiCultiPigmentMaxFile <- "../ImportedData/SySlmanuscriptWWPhotoperiod/PicoBaltic_MultiCultiPigmentMax.Rds"
# MultiCultiPigmentMaxFileName <- str_split(string = MultiCultiPigmentMaxFile, "/")[[1]][3] %>%
#   str_remove(pattern = ".Rds")
# MultiCultiPigmentMax <- readRDS(MultiCultiPigmentMaxFile)  %>%
#   ungroup()

# #contained pigments only from exp growth - 80 values (now 72 - fix this Sylwia!!!!)
# MultiCultiPigmentExp2File <- "../ImportedData/SySlmanuscriptWWPhotoperiod/PicoBaltic_MultiCultiPigmentExp2.Rds"
# MultiCultiPigmentExp2FileName <- str_split(string = MultiCultiPigmentExp2File, "/")[[1]][3] %>%
#   str_remove(pattern = ".Rds")
# MultiCultiPigmentExp <- readRDS(MultiCultiPigmentExp2File)  %>%
#   ungroup()


```


FIT curve

```{r test inhibition plot}

# TestI = c(0:28)
# 
#Harrison & Platt, 1986
#grcplatt <- function(I, a, b, Pmax){Pmax * (1-exp(-a*I/Pmax)) * exp(-b*I/Pmax)}






# 
# plot(x = TestI, y = grcplatt(I = TestI, a = 0.1, b = 0.01, Pmax = 1))
# 
# #plot(x = TestI, y = grcplatt(I = TestI, a = 0.1, b = 0.1, Pmax = 1))

# grcplattlag <- function(I, lag, a, b, Pmax){Pmax * (1-exp(-a*(I-lag)/Pmax)) * exp(-b*(I-lag)/Pmax)}
# 
# 
# 
# grcplattlag2 <- function(I, lag, a, b, Pmax){Pmax * (1-exp(-a*(I-lag)/Pmax)) * exp(-b*(I-lag)/Pmax)}
# 
# logistic_eqn <- function(I, Pmax, mu, intercept){(Pmax*intercept*exp(mu*I))/(Pmax + (intercept*(exp(mu*I)-1)))}

```


dummy df
```{r}

# gs4_deauth()
# 
# dummy<- read_sheet("https://docs.google.com/spreadsheets/d/11OcbG_HGQyYySYfpDpEGfEdOsIkJO6-k3RN-VXcWFAA/edit#gid=0")
# 
# as.data.frame(dummy)
# dummy <- dummy
# 
# dummy<-dummy %>%
#   mutate(PhotonDose_value = as.numeric(PhotonDose_value)) %>%
#   mutate(deltaOD_Lmu_corr = as.numeric(deltaOD_Lmu_corr))

```



```{r}


# CleanGrowthPARPURfit900 <- CleanGrowthPARPUR %>%   
#   filter(Par_ue ==900) 
#   #select(-c(facetsStrain))
# 
# #CleanGrowthPARPURfit900$facetsStrain = factor(CleanGrowthPARPURfit900$O2, labels = c("Strain"))
# 
# 
# CleanGrowthPARPURfit900dummy<-rbind(CleanGrowthPARPURfit900, dummy)


```





Harrison & Platt, 1986 
```{r platt fit}

# PURPARStrainO2NestDummy <- PURPARFits_dummy |>   
#   nest(data = -c("Strain","O2_uM")) |> 
#   mutate(GRCplatt_Model = map(data, possibly(~nlsLM(deltaOD_Lmu_corr_day ~ grcplatt(I = PUR_day, a, b, Pmax),
#                                                     data = .x, start = list(a = 1e-7, b = 1e-8, Pmax = 1),  
#                                                     lower = c(0, 0, 0),    
#                                                     upper = c(1,1,100)),
#                                                     0))) |>   
#   mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
#          GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
#          GRCplatt_Glance = map(GRCplatt_Model, possibly(glance)))




# CleanGrowthPARPURfit <- CleanGrowthPARPUR |>   
#   filter(Par_ue !=900) |> 
#   #filter(PhotonDose == "PAR") |>
#   nest(data = -c("Strain", "PhotonDose")) |> 
#   mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PhotonDose_value, a, b, Pmax),
#                                                     data = .x,
#                                                     start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),
#                                                     lower = c(0, 0, 0)))
#                                                     #upper = c(1,1,100)), 
#                                                     #0))
#          ) |>   
#   mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
#          GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
#          GRCplatt_Glance = map(GRCplatt_Model, possibly(glance))
#          )
# 
# GRCplatt_PredictGrowth <- CleanGrowthPARPURfit |>
#   unnest(GRCplatt_Predict)


# CleanGrowthPARPURfit |>   
#   filter(!map_lgl(GRCplatt_Model, is.null)) |>   
#   unnest(GRCplatt_Predict, data) |>   
#   ggplot() +   
#   geom_point(aes(x = PhotonDose_value, y = deltaOD_Lmu_corr)) +   
#   geom_line(aes(x = PhotonDose_value, y = `.fitted`)) +   
#   facet_grid(rows = vars(Strain), cols = vars(PhotonDose)) +   
#   #labs(title = "PURPARStrainO2NestDummy Platt") +   
#   theme_bw()



# logistic_eqn <- function(I, Pmax, mu, intercept){(Pmax*intercept*exp(mu*I))/(Pmax + (intercept*(exp(mu*I)-1)))}
# 
# CleanGrowthPARPURfitlog <- CleanGrowthPARPURfit900dummy2 |>   
#   #filter(Par_ue !=900) |> 
#   #filter(PhotonDose == "PAR") |>
#   nest(data = -c("Strain", "PhotonDose")) |> 
#   mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ logistic_eqn(I = PhotonDose_value, Pmax, mu, intercept),
#                                                     data = .x,
#                                                     start = list(mu = 0.1/2e7, intercept = 0, Pmax = 0.2),
#                                                     lower = c(0, 0, 0)))
#                                                     #upper = c(1,1,100)), 
#                                                     #0))
#          ) |>   
#   mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
#          GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
#          GRCplatt_Glance = map(GRCplatt_Model, possibly(glance))
#          )
# 
# CleanGrowthPARPURfitlog |>
#   filter(!map_lgl(GRCplatt_Model, is.null)) |>
#   unnest(GRCplatt_Predict, data) |>
#   ggplot() +
#   geom_point(aes(x = PhotonDose_value, y = deltaOD_Lmu_corr)) +
#   geom_line(aes(x = PhotonDose_value, y = `.fitted`)) +
#   facet_grid(rows = vars(Strain), cols = vars(PhotonDose)) +
#   #labs(title = "PURPARStrainO2NestDummy Platt") +
#   theme_bw()
```


Harrison & Platt, 1986 
```{r platt fit}


# CleanGrowthPARPURfit900 <- CleanGrowthPARPURfit900dummy |>   
#   #filter(Par_ue ==900) |> 
#   #filter(PhotonDose == "PAR") |>
#   nest(data = -c("Strain", "PhotonDose")) |> 
#   mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PhotonDose_value, a, b, Pmax),
#                                                     data = .x,
#                                                     start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),
#                                                     lower = c(0, 0, 0)))
#                                                     #upper = c(1,1,100)), 
#                                                     #0))
#          ) |>   
#   mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
#          GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
#          GRCplatt_Glance = map(GRCplatt_Model, possibly(glance))
#          )
# 
# GRCplatt_PredictGrowth900 <- CleanGrowthPARPURfit900 |>
#   unnest(GRCplatt_Predict)


# CleanGrowthPARPURfit |>   
#   filter(!map_lgl(GRCplatt_Model, is.null)) |>   
#   unnest(GRCplatt_Predict, data) |>   
#   ggplot() +   
#   geom_point(aes(x = PhotonDose_value, y = deltaOD_Lmu_corr)) +   
#   geom_line(aes(x = PhotonDose_value, y = `.fitted`)) +   
#   facet_grid(rows = vars(Strain), cols = vars(PhotonDose)) +   
#   #labs(title = "PURPARStrainO2NestDummy Platt") +   
#   theme_bw()

```




to get nice facet
```{r}

# CleanGrowthPARPUR$facetsStrain = factor(CleanGrowthPARPUR$WL, labels = c("Strain"))
# 
# GRCplatt_PredictGrowth$facetsStrain = factor(GRCplatt_PredictGrowth$PhotonDose, labels = c("Strain", "Strain"))
# 
# GRCplatt_PredictGrowth900$facetsStrain = factor(GRCplatt_PredictGrowth900$PhotonDose, labels = c("Strain", "Strain"))

```


```{r}
# CleanGrowthPARPURfitbez900 <- CleanGrowthPARPUR %>%    
#   filter(Par_ue !=900) 
# 
# CleanGrowthPARPURfittylko900 <- CleanGrowthPARPUR %>%    
#   filter(Par_ue ==900) %>% 
#   filter(deltaOD_Lmu_se<8.057558e-03)
```



Plot arrange
```{r fig.height = 11, fig.width = 8, warning = FALSE}
# 
# library(ggpubr)
# ggarrange(GrowthratePAR,GrowthratePUR,
#           ncol = 1, nrow = 2)
```


Load MaxGrowth catalog
```{r load local multiculticatalog, message = FALSE, warning = FALSE, echo=FALSE}
# gs4_deauth()
# 
# MaxGrowthMetaData <- read_sheet("https://docs.google.com/spreadsheets/d/10KUt0r2I6eOPPkBGIDMhh3-KyVVRW8FFIPXtK-PZqi8/edit#gid=0") 
# 
# as.data.frame(MaxGrowthMetaData)
# MaxGrowthMetaData <- MaxGrowthMetaData 

```

#MaxGrowthMetaData contained max growth per day and per h and max deriv - 80 values

```{r}
#colnames(ClarioOlisPigmentSmall)

# MaxGrowthMetaData<-MaxGrowthMetaData %>% 
#   mutate(Par_ue = as.numeric(Par_ue)) %>% 
#   mutate(Photoperiod = as.double(Photoperiod)) %>% 
#   mutate(MaxGrowthH = as.numeric(MaxGrowthH)) %>% 
#     mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
#          Strain=="BA48R"~"PE-rich_048",
#         Strain=="BA56G"~"PC-rich_056",
#          Strain=="BA77G"~"PC-rich_077")) 
# 
# MaxGrowth2 <- MultiCultiDataCleanGrowth3 %>%
#   left_join(., MaxGrowthMetaData, by = c("Strain" = "Strain", "Par_ue" = "Par_ue", "Photoperiod" = "Photoperiod")) 
# 
# rm(MaxGrowthMetaData, MultiCultiDataCleanGrowth3)

```

#MaxGrowth2 contained exp PUR, growth rate with se and flags, and max growth per day, per h and max deriv - 80 values

```{r}

#colnames(MaxGrowth2)
# 
# MaxGrowth3<-MaxGrowth2 %>% 
#   select(-c("Filename.x", SpectraDate, E_days, PUR,PURPhotonDose,PURPARRatio,Time_h,MaxMin_derivRatio,Max,Filename))
# 
# MaxGrowthExpSt <- MaxGrowth3 %>%
#   left_join(., OLISSpectraMetaPURExpSt, by = c("Run"="Run","ID"="ID","Strain"="Strain","InnocDate"="InnocDate","ExpDate"="ExpDate","Par_ue"="Par_ue","Photoperiod"="Photoperiod","O2"="O2","WL"="WL","LightShape"="LightShape","PARPhotonDose"="PARPhotonDose")) 
# 
# rm(OLISSpectraMetaPURExpSt,MaxGrowth3,MaxGrowth2)

```

#MaxGrowthExpSt contained exp and st PUR, growth rate with se and flags, and max growth per day, per h and max deriv - 80 values





```{r}
#colnames(MultiCultiPigmentExpClean)
# 
# MultiCultiPigmentExpClean<-MultiCultiPigmentExp %>% 
#   select(c(ID,Day,Strain,Par_ue,Photoperiod,ExpDate,InnocDate,meanOD680Day,meanOD720Day,cellml,Date,Chlapgcell,Carpgcell,Phycopgcell,CarChlaRatio,PhycoChlaRatio,Time_h,))
#   
# MultiCultiPigmentExpClean<-MultiCultiPigmentExpClean %>% 
#   mutate(PigmentDayExp=Day) %>% 
#   mutate(meanOD680DayExp=meanOD680Day) %>%
#   mutate(meanOD720DayExp=meanOD720Day) %>% 
#   mutate(cellmlExp=cellml) %>% 
#   mutate(PigmentDateExp=Date) %>% 
#   mutate(ChlapgcellExp=Chlapgcell) %>% 
#   mutate(CarpgcellExp=Carpgcell) %>% 
#   mutate(PhycopgcellExp=Phycopgcell) %>% 
#   mutate(CarChlaRatioExp=CarChlaRatio) %>% 
#   mutate(PhycoChlaRatioExp=PhycoChlaRatio) %>% 
#   mutate(PigmentTime_hExp=Time_h) %>% 
#   select(-c(Day,meanOD680Day,meanOD720Day,cellml,Date,Chlapgcell,Carpgcell,Phycopgcell,CarChlaRatio,PhycoChlaRatio,Time_h))
  
```

```{r}
# MaxGrowthExpSt <- MaxGrowthExpSt %>%
#   left_join(., MultiCultiPigmentExpClean, by = c("ID"="ID", "Strain" = "Strain", "Photoperiod" = "Photoperiod", "Par_ue" = "Par_ue", "ExpDate"="ExpDate", "InnocDate"="InnocDate")) 

```


```{r}
#colnames(GScatalog)
# colnames(MaxGrowthExpSt)

# GScatalogPURPAR <- GScatalog %>%
#   left_join(., MaxGrowthExpSt, by = c("Strain" = "Strain", "Photoperiod" = "Photoperiod", "Par_ue" = "Par_ue", "O2" = "O2", "WL" = "WL", "facets" = "facets", "facets2" = "facets2"))

```

Half photoperiod
```{r}

# GScatalog8<-GScatalogPURPAR %>% 
#   filter(Photoperiod == 8) %>% 
#   mutate(halfmeanAccLen = meanAccLen/4) %>% 
#   mutate(halfsdAccLen = sdAccLen/4) 
# 
# GScatalog12<-GScatalogPURPAR %>% 
#   filter(Photoperiod == 12) %>% 
#   mutate(halfmeanAccLen = meanAccLen/6) %>% 
#   mutate(halfsdAccLen = sdAccLen/6) 
# 
# GScatalog16<-GScatalogPURPAR %>% 
#   filter(Photoperiod == 16) %>% 
#   mutate(halfmeanAccLen = meanAccLen/8) %>% 
#   mutate(halfsdAccLen = sdAccLen/8) 
#   
# GScatalogPURPAR<-rbind(GScatalog8,GScatalog12,GScatalog16)
# 
# rm(GScatalog8,GScatalog12,GScatalog16)
# 
# GScatalogPURPAR<-GScatalogPURPAR %>% 
#     mutate(meanAccLenRound = round(meanAccLen, digits = 0)) 

```



STATISTICS


Two factor ANOVA without replication
```{r}
# result <- aov(response ~ factor.A + factor.B + factor.A:factor.B, data = fever)
# summary(result)

# GrowthBA127R <- MaxGrowthExpSt %>% 
# filter(Strain == "PE-rich_127")
# GrowthBA127R <- aov(OD720_Lmu_corr ~ Par_ue*Photoperiod, GrowthBA127R)
# anova(GrowthBA127R)
# 
# GrowthBA127R <- MaxGrowthExpSt %>% 
# filter(Strain == "PE-rich_127")
# GrowthBA127R <- aov(deltaOD_Lmu_corr ~ Par_ue*Photoperiod, GrowthBA127R)
# anova(GrowthBA127R)
# 
# 
# GrowthBA48R <- MaxGrowthExpSt %>% 
# filter(Strain == "PE-rich_048")
# GrowthBA48R <- aov(OD720_Lmu_corr ~ Par_ue*Photoperiod, GrowthBA48R)
# anova(GrowthBA48R)
# 
# GrowthBA48R <- MaxGrowthExpSt %>% 
# filter(Strain == "PE-rich_048")
# GrowthBA48R <- aov(deltaOD_Lmu_corr ~ Par_ue*Photoperiod, GrowthBA48R)
# anova(GrowthBA48R)
# 
# 
# GrowthBA56G <- MaxGrowthExpSt %>% 
# filter(Strain == "PC-rich_056")
# GrowthBA56G <- aov(OD720_Lmu_corr ~ Par_ue*Photoperiod, GrowthBA56G)
# anova(GrowthBA56G)
# 
# GrowthBA56G <- MaxGrowthExpSt %>% 
# filter(Strain == "PC-rich_056")
# GrowthBA56G <- aov(deltaOD_Lmu_corr ~ Par_ue*Photoperiod, GrowthBA56G)
# anova(GrowthBA56G)
# 
# 
# GrowthBA77G <- MaxGrowthExpSt %>% 
# filter(Strain == "PC-rich_077")
# GrowthBA77G <- aov(OD720_Lmu_corr ~ Par_ue*Photoperiod, GrowthBA77G)
# anova(GrowthBA77G)
# 
# GrowthBA77G <- MaxGrowthExpSt %>% 
# filter(Strain == "PC-rich_077")
# GrowthBA77G <- aov(deltaOD_Lmu_corr ~ Par_ue*Photoperiod, GrowthBA77G)
# anova(GrowthBA77G)

```

Tukey test
```{r}

# GrowthBA77G <- MaxGrowthExpSt %>% 
# filter(Strain == "PC-rich_077")
# data.aov.factor = aov(deltaOD_Lmu_corr ~ factor(Par_ue) + factor(Photoperiod), data = GrowthBA77G)
# TukeyHSD(data.aov.factor)


# letters
#https://stackoverflow.com/questions/69309101/automatically-adding-letters-of-significance-to-a-ggplot-barplot-using-output-fr


```



Correlation coefficient is comprised between -1 and 1:
    -1 indicates a strong negative correlation : this means that every time x increases, y decreases (left panel figure)
    0 means that there is no association between the two variables (x and y) (middle panel figure)
    1 indicates a strong positive correlation : this means that y increases with x (right panel figure)


```{r}
# library("ggpubr")
# my_data <- mtcars
# 
# 
# ggscatter(my_data, x = "mpg", y = "wt", 
#           add = "reg.line", conf.int = TRUE, 
#           cor.coef = TRUE, cor.method = "pearson",
#           xlab = "Miles/(US) gallon", ylab = "Weight (1000 lbs)")
# 
# 
# res2 <-cor.test(my_data$wt, my_data$mpg,  method = "spearman")
# res2
# #The correlation coefficient between x and y are -0.8864 and the p-value is 1.48810^{-11}. 
# 
# 
# 
# 
# gs4_deauth()
# 
# ZosiaData <- read_sheet("https://docs.google.com/spreadsheets/d/1oymzwhdikAoW1nPWE74VW7l-mHJ19CjJHOckBbggyPw/edit#gid=0") 
# 
# as.data.frame(ZosiaData)
# 
# ZosiaData<-ZosiaData %>% 
#   mutate(NO3=as.numeric(NO3)) %>% 
#   mutate(PO4=as.numeric(PO4)) %>% 
#   mutate(NP=as.numeric(NP)) %>% 
#   mutate(Red=as.numeric(Red)) %>% 
#   mutate(Green=as.numeric(Green)) %>% 
#   mutate(Brown=as.numeric(Brown)) 
# 			
# ggscatter(ZosiaData, x = "NP", y = "Red", 
#           add = "reg.line", conf.int = TRUE, 
#           cor.coef = TRUE, cor.method = "pearson")
# 
# ZosiaData1<-ZosiaData %>% 
#   filter(Month=="September")
# 
# res2 <-cor.test(ZosiaData1$Brown, ZosiaData1$PO4,  method = "spearman")
# res2
```




