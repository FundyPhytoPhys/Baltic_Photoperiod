---
title: "Process_GrowthRateData"
author:
- Sylwia Sliwinska-Wilczewska
- Douglas A. Campbell
date: "`r format(Sys.Date())`"
output:
bookdown::html_document2:
    code_folding: show
    keep_md: yes
    toc: TRUE
    toc_float: TRUE
    toc_depth: 6
    fig_caption: yes
bibliography: BalticPhotoperiod.bib
csl: plos-one.csl
editor_options: 
  markdown: 
    wrap: 72
---

# Set Chunk Options

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
knitr::opts_chunk$set(fig.path='Figs/')
```

# Introduction

Process_GrowthRateData.Rmd processes and combines PICO_NestedFitsData.Rds from Data/CleanData/CleanedMCData folder and Baltic_Photoperiod_Processed_OlisSpectraTidy.Rds from Data/ProcessedData/ProcessedOlisJazData. This .Rmd generates Baltic_Photoperiod_Processed_GrowthRate.Rds (stored in Data/ProcessedData/ProcessesGrowthRateData folder) and GrowthRate_Plot.png (stored in Output/Plots folder).

# Load Libraries and set Project Variables

```{r load libraries} 
library(tidyverse)
library(lubridate)
library(stringr)
library(broom)
library(knitr)
library(OneR)
library(zoo)
library(strucchange)
library(ggpubr)
library(caret)
library(reshape2)
library(gcookbook)
library(scales)
library(minpack.lm) #Standard 'nls' framework that uses 'nls.lm' for fitting
library(data.table)
library(googledrive)
library(googlesheets4)
```

```{r set project variables}
Project <- "Baltic_Photoperiod"
DataOut <- file.path("..", "Data", "ProcessedData", "ProcessedGrowthRateData")
DataIn <- file.path("..", "Data", "CleanData", "CleanedMCData", fsep = .Platform$file.sep)

PlotsPath <- file.path("..", "Output", "Plots")
RDSPlotPath <- file.path("..", "Output", "PlotsRDS")

FileEncode <- "UTF-8" 
Delimiter <- ""
HeaderRows <- 0
```

# List and read files

```{r Exported Rmd only first time in session}
list.files(path = DataIn, full.names = TRUE)
```

```{r read file}
MultiCultiGrowthFile <- "../Data/CleanData/CleanedMCData/PICO_NestedFitsData.Rds"

MultiCultiGrowthFileName <- str_split(string = MultiCultiGrowthFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds") 

MultiCultiGrowth <- readRDS(MultiCultiGrowthFile)  %>%
  ungroup()
```

# Select revelant variables and preparing for further analysis

```{r}
MultiCultiGrowth<-MultiCultiGrowth %>% 
  select(c(Tube, ExpDate, MC, Run, SampleID, Strain, Par_ue, Photoperiod, WL, O2, LightShape, PARPhotonDose_day, OD720_Lmu_se, OD720_Lmu_corr, deltaOD_Lmu_se, deltaOD_Lmu_corr))
  
MultiCultiGrowth<-MultiCultiGrowth %>% 
  mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077"))

MultiCultiGrowth1<-MultiCultiGrowth %>% 
  filter(Run==77) %>% 
  filter(Strain =="PC-rich_077")
MultiCultiGrowth2<-MultiCultiGrowth %>% 
  filter(Run==121) %>% 
  filter(Strain !="PC-rich_077")
MultiCultiGrowth3<-MultiCultiGrowth %>% 
  filter(Run!=121 & Run!= 77) 
MultiCultiGrowth<-rbind(MultiCultiGrowth1, MultiCultiGrowth2, MultiCultiGrowth3)
  rm(MultiCultiGrowth1, MultiCultiGrowth2, MultiCultiGrowth3)
```

# Load processed Olis&Jaz RDS

```{r set project variables}
Project <- "Baltic_Photoperiod"
DataIn <- file.path("..", "Data", "ProcessedData", "ProcessedOlisJazData", fsep = .Platform$file.sep)
```

# List and read processed Olis and Jaz files

```{r exported Rmd only first time in session}
list.files(path = DataIn, pattern = Project, full.names = TRUE)
```

```{r read imported Olis file}
OLISSpectraFile <- "../Data/ProcessedData/ProcessedOlisJazData/Baltic_Photoperiod_Processed_OlisSpectraTidy.Rds"
OLISSpectraFileName <- str_split(string = OLISSpectraFile, "/")[[1]][3] %>%
  str_remove(pattern = ".Rds")
OLISSpectra <- readRDS(OLISSpectraFile)  %>%
  ungroup()
```

# Combine growth rate and Tidy Olis to get PUR

```{r}
MCGrowthRate <- OLISSpectra %>% 
  left_join(., MultiCultiGrowth, by = c("Run" = "Run", "SampleID" = "SampleID","Strain" = "Strain", "Par_ue" = "Par_ue", "Photoperiod" = "Photoperiod",  "O2" = "O2", "WL" = "WL",  "MC" = "MC", "Tube" = "Tube", "ExpDate" = "ExpDate", "LightShape" = "LightShape", "PARPhotonDose_day" = "PARPhotonDose_day")) 
  rm(MultiCultiGrowth, OLISSpectra)
```

# Create preliminary plot

```{r preliminary plot, warning = FALSE}
scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))

MCGrowthRate %>%
  ggplot() +
  geom_point(aes(x = Par_ue, y = deltaOD_Lmu_corr,colour=as.factor(Strain)), size = 3.5, alpha = 0.9, show.legend = T) +
  geom_errorbar(aes(x = Par_ue, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se), alpha = 0.5) +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4")) +
  #labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "Photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  ggh4x::facet_nested(rows = vars(Strain), cols = vars(Photoperiod)) +
  theme_bw()
```

# Exstracted Exp PUR

```{r exstracted Exp PUR}

O1 <- MCGrowthRate %>%
  filter(Par_ue == 30 | Par_ue == 300 | Par_ue == 90 | Par_ue == 180) %>% 
  filter(Photoperiod == 24) %>% 
  filter(E_days < 4)

O2 <- MCGrowthRate %>%
  filter(Par_ue == 180 | Par_ue == 300) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days == 4)

O3 <- MCGrowthRate %>%
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days == 6)

O4 <- MCGrowthRate %>%
  filter(Par_ue == 30) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days == 12)

O5 <- MCGrowthRate %>%
  filter(Par_ue == 900 | Par_ue == 600) %>% 
  filter(Photoperiod == 16) %>% 
  filter(E_days == 4)

O6 <- MCGrowthRate %>%
  filter(Par_ue == 30) %>% 
  filter(Photoperiod == 8 | Photoperiod == 12) %>% 
  filter(E_days == 12| E_days == 13)
  
O7 <- MCGrowthRate %>%
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 8) %>% 
  filter(E_days == 12 | E_days ==13)

O8 <- MCGrowthRate %>%
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 12) %>% 
  filter(Strain == "PE-rich_127" | Strain == "PE-rich_048" | Strain == "PC-rich_077") %>% 
  filter(E_days == 8 | E_days ==9)

O9 <- MCGrowthRate %>%
  filter(Par_ue == 90) %>% 
  filter(Photoperiod == 12) %>% 
  filter(Strain == "PC-rich_056") %>% 
  filter(E_days == 11)

O10 <- MCGrowthRate %>%
  filter(Par_ue == 180) %>% 
  filter(Photoperiod == 8) %>% 
  filter(E_days == 8 | E_days == 9)

O11 <- MCGrowthRate %>%
  filter(Par_ue == 180) %>% 
  filter(Photoperiod == 12) %>% 
  filter(E_days == 6 | E_days == 7)

O12 <- MCGrowthRate %>%
  filter(Par_ue == 300) %>% 
  filter(Photoperiod == 8) %>% 
  filter(Strain == "PE-rich_127" | Strain == "PE-rich_048" | Strain == "PC-rich_077") %>% 
  filter(E_days == 6 | E_days ==7)

O13 <- MCGrowthRate %>%
  filter(Par_ue == 300) %>% 
  filter(Photoperiod == 8) %>% 
  filter(Strain == "PC-rich_056") %>% 
  filter(E_days == 9)

O14 <- MCGrowthRate %>%
  filter(Par_ue == 300) %>% 
  filter(Photoperiod == 12) %>% 
  filter(Strain == "PE-rich_127" | Strain == "PE-rich_048" | Strain == "PC-rich_077") %>% 
  filter(E_days == 4 | E_days ==5)

O15 <- MCGrowthRate %>%
  filter(Par_ue == 300) %>% 
  filter(Photoperiod == 12) %>% 
  filter(Strain == "PC-rich_056") %>%  
  filter(E_days == 7)

O16 <- MCGrowthRate %>%
  filter(Par_ue == 900) %>% 
  filter(Photoperiod == 8 | Photoperiod == 12)

O17 <- MCGrowthRate %>%
  filter(Par_ue == 900 | Par_ue == 600) %>% 
  filter(Photoperiod == 24) %>% 
  filter(E_hours < 100 & E_hours > 48)

MCCleanGrowthAPUR <-rbind(O1, O2, O3, O4, O5, O6, O7, O8, O9, O10, O11, O12, O13, O14, O15, O16, O17)
  rm(O1, O2, O3, O4, O5, O6, O7, O8, O9, O10, O11, O12, O13, O14, O15, O16, O17)
```

```{r exstracted Exp PUR, changed variable names}
MCCleanGrowthAPUR<-MCCleanGrowthAPUR %>% 
  mutate(PURExp = PUR) %>% 
  mutate(PURPhotonDoseExp = PURPhotonDose_day) %>% 
  mutate(PURPARRatioExp = PURPARRatio) %>% 
  mutate(E_hoursExp = E_hours) %>% 
  mutate(E_daysExp = E_days) %>% 
  select(c(Strain, Par_ue, Photoperiod, PURExp, PURPhotonDoseExp, PURPARRatioExp, E_hoursExp, E_daysExp))
  
MCGrowthRateExp <- MCGrowthRate %>%
  full_join(., MCCleanGrowthAPUR, by = c("Strain"="Strain", "Par_ue"="Par_ue","Photoperiod"="Photoperiod"))

rm(MCCleanGrowthAPUR, MCGrowthRate)
```

# Load tmaxAG catalog 

```{r}
gs4_deauth()
tmaxAG<- read_sheet("https://docs.google.com/spreadsheets/d/1ksY7xlg9wOsICOBRmZkHPKdd9KOislNwPDzyuJ3UIUI/edit#gid=0")
as.data.frame(tmaxAG)
tmaxAG <- tmaxAG

tmaxAG<-tmaxAG %>% 
  mutate(Par_ue = as.numeric(Par_ue)) %>%
  mutate(Photoperiod = as.numeric(Photoperiod)) %>%
  mutate(tMaxAG = as.numeric(tMaxAG)) %>%
  mutate(dayRound_tmaxAG=tMaxAG/24) %>% 
  mutate(dayRound_tmaxAG = round(dayRound_tmaxAG, digits = 0)) %>% 
  mutate(Strain=case_when(Strain=="BA127R"~"PE-rich_127",
         Strain=="BA48R"~"PE-rich_048",
        Strain=="BA56G"~"PC-rich_056",
         Strain=="BA77G"~"PC-rich_077"))

tmaxAG$facetsPar_ue = factor(tmaxAG$O2, labels = c("PAR~(µmol~photons~m^{-2}~s^{-1})"))
tmaxAG$facetsPhotoperiod = factor(tmaxAG$WL, labels = c("Photoperiod~(h)"))
tmaxAG$facetsStrain = factor(tmaxAG$O2, labels = c("Strain"))
tmaxAG$facetsPARPhotonDose_day = factor(tmaxAG$WL, labels = c("PAR~photon~dose~(10^{5}~µmol~photons~m^{-2}~d^{-1})"))
```

```{r select revelant columns}
tMaxAGLines_056<-tmaxAG %>% 
  filter(Strain == "PC-rich_056") %>% 
  select(c(Par_ue, Photoperiod, tMaxAG)) %>% 
  unique()
tMaxAGLines_077<-tmaxAG %>% 
  filter(Strain == "PC-rich_077") %>% 
  select(c(Par_ue, Photoperiod, tMaxAG)) %>% 
  unique()
tMaxAGLines_048<-tmaxAG %>% 
  filter(Strain == "PE-rich_048") %>% 
  select(c(Par_ue, Photoperiod, tMaxAG)) %>% 
  unique()
tMaxAGLines_127<-tmaxAG %>% 
  filter(Strain == "PE-rich_127") %>% 
  select(c(Par_ue, Photoperiod, tMaxAG)) %>% 
  unique()
```

# Create preliminary plots

```{r preliminary plot}
lab1=c(expression("PC-rich_056"), expression("PC-rich_077"), expression("PE-rich_048"), expression("PE-rich_127"))

MCGrowthRateExp %>%
  ggplot() +
  geom_point(aes(x = E_hours, y = PURPARRatio, colour = as.factor(Strain)), alpha = 0.9, size = 3, show.legend = T) +
  geom_vline(data = tMaxAGLines_056, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown4") +
  geom_vline(data = tMaxAGLines_077, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown1") +
  geom_vline(data = tMaxAGLines_048, aes(xintercept = tMaxAG), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = tMaxAGLines_127, aes(xintercept = tMaxAG), linetype="dotdash", colour = "palegreen3") +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  coord_cartesian(ylim = c(0, 1.7)) +
  ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 


MCGrowthRateExp %>%
  ggplot() +
  geom_point(aes(x = E_hoursExp, y = PURPARRatioExp, colour = as.factor(Strain)), alpha = 0.9, size = 3, show.legend = T) +
  geom_vline(data = tMaxAGLines_056, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown4") +
  geom_vline(data = tMaxAGLines_077, aes(xintercept = tMaxAG), linetype="dotdash", colour = "brown1") +
  geom_vline(data = tMaxAGLines_048, aes(xintercept = tMaxAG), linetype="dotdash", colour = "seagreen4") +
  geom_vline(data = tMaxAGLines_127, aes(xintercept = tMaxAG), linetype="dotdash", colour = "palegreen3") +
  scale_colour_discrete(type=c("seagreen4", "palegreen3", "brown1", "brown4"), name="", labels = lab1) +
  scale_y_continuous(breaks=seq(0, 1.2, by = 0.4)) +
  coord_cartesian(ylim = c(0, 1.7)) +
  ggh4x::facet_nested(cols = vars(Photoperiod), rows = vars(Par_ue), labeller = label_parsed) +
  theme_bw() 
```

# Cleaning the environment

```{r}
rm(tMaxAGLines_056, tMaxAGLines_077, tMaxAGLines_048, tMaxAGLines_127, tmaxAG)
```


# Create preliminary plot 

```{r preliminary plot, warning = FALSE}
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))

O2.labs <- c("Strain")
names(O2.labs) <- c(21)
scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }

MCGrowthRateExp %>%
  ggplot() +
  geom_point(aes(x = PARPhotonDose_day, y = deltaOD_Lmu_corr, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.9, show.legend = T) +
  geom_errorbar(aes(x = PARPhotonDose_day, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se), alpha = 0.5, width=2000000) +
  scale_x_continuous(breaks=seq(0, 80000000, by = 20000000)) +
  coord_cartesian(xlim = c(-100, 83000000)) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "PAR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  ggh4x::facet_nested(rows = vars(O2, Strain), labeller = labeller(O2 = O2.labs)) +
  scale_x_continuous(label=scientific_10) +
  guides(color = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_bw() 


MCGrowthRateExp %>%
  ggplot() +
  geom_point(aes(x = PURPhotonDoseExp, y = deltaOD_Lmu_corr, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.9, show.legend = T) +
  geom_errorbar(aes(x = PURPhotonDoseExp, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se), alpha = 0.5, width=2000000) +
  scale_x_continuous(breaks=seq(0, 80000000, by = 20000000)) +
  coord_cartesian(xlim = c(-100, 83000000)) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "PUR photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  ggh4x::facet_nested(rows = vars(O2, Strain), labeller = labeller(O2 = O2.labs)) +
  scale_x_continuous(label=scientific_10) +
  guides(color = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_bw()

MCGrowthRateExp %>%
  ggplot() +
  geom_point(aes(x = PURPhotonDoseExp, y = OD720_Lmu_corr, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.9, show.legend = T) +
  geom_errorbar(aes(x = PURPhotonDoseExp, ymin = OD720_Lmu_corr - OD720_Lmu_se, ymax = OD720_Lmu_corr + OD720_Lmu_se), alpha = 0.5, width=2000000) +
  scale_x_continuous(breaks=seq(0, 80000000, by = 20000000)) +
  coord_cartesian(xlim = c(-100, 83000000)) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  ggh4x::facet_nested(rows = vars(O2, Strain), labeller = labeller(O2 = O2.labs)) +
  scale_x_continuous(label=scientific_10) +
  guides(color = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_bw()
```

# Added column PhotonDose_value and combine data to to PAR and PUR - long format (MCGrowthRateExpFit)

```{r}
MCGrowthRateExpPAR<-MCGrowthRateExp %>% 
  select(-c(PURPhotonDose_day)) %>% 
  mutate(PhotonDose_value = PARPhotonDose_day) %>% 
  mutate(PhotonDose = O2) %>% 
  mutate(PhotonDose = case_when(PhotonDose==21~"PAR")) %>% 
  select(-c(PARPhotonDose_day, PURPhotonDoseExp))
  
MCGrowthRateExpPUR<-MCGrowthRateExp %>% 
  select(-c(PARPhotonDose_day)) %>% 
  mutate(PhotonDose_value = PURPhotonDoseExp) %>% 
  mutate(PhotonDose = O2) %>% 
  mutate(PhotonDose = case_when(PhotonDose==21~"PUR")) %>% 
  select(-c(PURPhotonDose_day, PURPhotonDoseExp))

MCGrowthRateExpFit<-rbind(MCGrowthRateExpPAR, MCGrowthRateExpPUR)
  rm(MCGrowthRateExpPAR, MCGrowthRateExpPUR)
```

# Create preliminary plot

```{r preliminary plot, warning = FALSE}
scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))

O2.labs <- c("Strain")
names(O2.labs) <- c(21)

MCGrowthRateExpFit %>%
  ggplot() +
  geom_point(aes(x = PhotonDose_value, y = deltaOD_Lmu_corr, colour = as.factor(Par_ue), shape = as.factor(Photoperiod)), size = 3.5, alpha = 0.9, show.legend = T) +
  geom_errorbar(aes(x = PhotonDose_value, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se), alpha = 0.5, width=2000000) +
  scale_x_continuous(breaks=seq(0, 80000000, by = 20000000)) +
  coord_cartesian(xlim = c(-100, 83000000)) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  scale_colour_manual(values = c("darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2) +
  labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "Photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  ggh4x::facet_nested(rows = vars(O2, Strain), cols = vars(PhotonDose), labeller = labeller(O2 = O2.labs)) +
  scale_x_continuous(label=scientific_10) +
  guides(color = guide_legend(order = 1), shape = guide_legend(order = 2)) +
  theme_bw()
```

# Added a starting point at 0

```{r}
gs4_deauth()
# this is the URL or ID of a Sheet readable by anyone (with a link)
Dummy <- read_sheet("https://docs.google.com/spreadsheets/d/1Ns_u26HagT-kDCy5WgjGA_U8R6qv4LqRPubtlWB8Cxc/edit#gid=0") 

MCGrowthRateExpFitDummy<-MCGrowthRateExpFit %>% 
  select(c(Strain, Par_ue, Photoperiod, O2, WL, deltaOD_Lmu_se, deltaOD_Lmu_corr, PhotonDose_value, PhotonDose, facetsStrain))

MCGrowthDummy<-rbind(MCGrowthRateExpFitDummy, Dummy)
  rm(MCGrowthRateExpFitDummy, Dummy)
  
MCGrowthDummy<-MCGrowthDummy %>% 
  unique() %>% 
  drop_na(deltaOD_Lmu_corr) 
  
```

# Estimated Harrison & Platt, 1986 fit - for 900uE and the rest uE

```{r Estimated Harrison & Platt, 1986 fit}

# grcplatt <- function(I, a, b, Pmax){Pmax * (1-exp(-a*I/Pmax)) * exp(-b*I/Pmax)}
# 
# MCGrowthDummyno900 <- MCGrowthDummy %>%    
#   filter(Par_ue !=900) %>%  
#   nest(data = -c("Strain", "PhotonDose")) %>%  
#   mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PhotonDose_value, a, b, Pmax),
#                                                     data = .x,
#                                                     start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),
#                                                     lower = c(0, 0, 0)))) %>%    
#   mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
#          GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
#          GRCplatt_Glance = map(GRCplatt_Model, possibly(glance)))
# 
# GRCplatt_PredictGrowthno900 <- MCGrowthDummyno900 %>% 
#   unnest(GRCplatt_Predict)
# 
# 
# 
# 
# MCGrowthDummy900 <- MCGrowthDummy %>%   
#   filter(Par_ue !=30 & Par_ue !=90 & Par_ue !=180 & Par_ue !=300) %>%  
#   nest(data = -c("Strain", "PhotonDose")) %>%  
#   mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PhotonDose_value, a, b, Pmax),
#                                                     data = .x,
#                                                     start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),
#                                                     lower = c(0, 0, 0)))) %>%   
#   mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
#          GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
#          GRCplatt_Glance = map(GRCplatt_Model, possibly(glance)))
# 
# GRCplatt_PredictGrowth900 <- MCGrowthDummy900 %>% 
#   unnest(GRCplatt_Predict)

```

# Create preliminary plot

```{r preliminary plot, warning = FALSE}
# lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
# lab2=c(expression("1 µE"), expression("2 µE"), expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))
# scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }
# 
# ggplot(MCGrowthRateExpFit, aes(PhotonDose_value, deltaOD_Lmu_corr)) +
#   geom_point(aes(PhotonDose_value, deltaOD_Lmu_corr, colour=as.factor(Par_ue), shape = as.factor(Photoperiod)), alpha = 0.9, size = 3.5, show.legend = T) +
#   geom_errorbar(aes(x = PhotonDose_value, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se, colour = as.factor(Par_ue)), width=4000000, data = . %>% filter(deltaOD_Lmu_se<8.057558e-03), show.legend = F) +
#   geom_line(aes(PhotonDose_value, .fitted), show.legend = F, GRCplatt_PredictGrowthno900) +
#   geom_line(aes(PhotonDose_value, .fitted), show.legend = F, GRCplatt_PredictGrowth900) +
#   scale_x_continuous(label=scientific_10) +
#   scale_linetype_manual(values=c("equal900" = "dotted", "less900" = "solid"), breaks=c('8', '12', '16', "24", "", "")) +
#   scale_colour_manual(values = c("", "", "darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2, breaks=c('', '', '30', "90", "180", "300", "900")) +
#   scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
#   labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "Photon dose ( µmol photons "~m^-2~""~d^-1~")") +
#   ggh4x::facet_nested(cols = vars(PhotonDose), rows = vars(Strain), labeller = label_parsed) +
#   theme_bw() 
```


# Estimated Harrison & Platt, 1986 fit - for all uE and each uE separately

```{r platt fit}

#Harrison & Platt, 1986
grcplatt <- function(I, a, b, Pmax){Pmax * (1-exp(-a*I/Pmax)) * exp(-b*I/Pmax)}

MCGrowthDummyAll <- MCGrowthDummy %>%   
  nest(data = -c("Strain", "PhotonDose")) %>%  
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PhotonDose_value, a, b, Pmax),
                                                    data = .x,
                                                    start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),
                                                    lower = c(0, 0, 0)))) %>%    
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance)))

GRCplatt_PredictGrowthAll <- MCGrowthDummyAll %>% 
  unnest(GRCplatt_Predict)%>% 
  unnest(GRCplatt_Param)




MCGrowthDummy30 <- MCGrowthDummy %>%   
  filter(Par_ue ==30) %>% 
  nest(data = -c("Strain", "PhotonDose")) %>%  
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PhotonDose_value, a, b, Pmax),
                                                    data = .x,
                                                    start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),
                                                    lower = c(0, 0, 0)))) %>%    
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance)))

GRCplatt_PredictGrowth30 <- MCGrowthDummy30 %>% 
  unnest(GRCplatt_Predict)%>% 
  unnest(GRCplatt_Param)



MCGrowthDummy90 <- MCGrowthDummy %>%    
  filter(Par_ue ==90) %>%  
  nest(data = -c("Strain", "PhotonDose")) %>% 
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PhotonDose_value, a, b, Pmax),
                                                    data = .x,
                                                    start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),
                                                    lower = c(0, 0, 0)))) %>%    
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance)))

GRCplatt_PredictGrowth90 <- MCGrowthDummy90 %>% 
  unnest(GRCplatt_Predict)%>% 
  unnest(GRCplatt_Param)


MCGrowthDummy180 <- MCGrowthDummy %>%    
  filter(Par_ue ==180) %>%  
  nest(data = -c("Strain", "PhotonDose")) %>%  
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PhotonDose_value, a, b, Pmax),
                                                    data = .x,
                                                    start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),
                                                    lower = c(0, 0, 0)))) %>%   
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance)))

GRCplatt_PredictGrowth180 <- MCGrowthDummy180 %>% 
  unnest(GRCplatt_Predict)%>% 
  unnest(GRCplatt_Param)



MCGrowthDummy300 <- MCGrowthDummy %>%   
  filter(Par_ue ==300) %>% 
  nest(data = -c("Strain", "PhotonDose")) %>%  
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PhotonDose_value, a, b, Pmax),
                                                    data = .x,
                                                    start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),
                                                    lower = c(0, 0, 0)))) %>%    
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance)))

GRCplatt_PredictGrowth300 <- MCGrowthDummy300 %>% 
  unnest(GRCplatt_Predict)%>% 
  unnest(GRCplatt_Param)


MCGrowthDummy900 <- MCGrowthDummy %>%    
  filter(Par_ue ==900) %>% 
  nest(data = -c("Strain", "PhotonDose")) %>%  
  mutate(GRCplatt_Model = map(data, ~nlsLM(deltaOD_Lmu_corr ~ grcplatt(I = PhotonDose_value, a, b, Pmax),
                                                    data = .x,
                                                    start = list(a = 0.1/2e7, b = 0.01/2e7, Pmax = 0.2),
                                                    lower = c(0, 0, 0)))) %>%    
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),          
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),          
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance)))
        #ANOVA = map(GRCplatt_Model, anova))

GRCplatt_PredictGrowth900 <- MCGrowthDummy900 %>% 
  unnest(GRCplatt_Predict) %>% 
  unnest(GRCplatt_Param)
# 
# anova(MCGrowthDummy900$GRCplatt_Model[[1]], MCGrowthDummy900$GRCplatt_Model[[2]], MCGrowthDummy900$GRCplatt_Model[[3]], MCGrowthDummy900$GRCplatt_Model[[4]])

```

# Create Growth Rate plot

```{r create growth rate plot, warning = FALSE}
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("1 µE"), expression("2 µE"), expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))
scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }

ggplot(MCGrowthDummy, aes(PhotonDose_value, deltaOD_Lmu_corr)) +
  geom_point(aes(PhotonDose_value, deltaOD_Lmu_corr, colour=as.factor(Par_ue), shape = as.factor(Photoperiod)), alpha = 0.8, size = 3.5, show.legend = T) +
  geom_errorbar(aes(x = PhotonDose_value, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se, colour = as.factor(Par_ue)), width=0, size=0.3, data = . %>% filter(deltaOD_Lmu_se<8.057558e-03), show.legend = F) +
  geom_line(aes(PhotonDose_value, .fitted), colour = "black", show.legend = F, GRCplatt_PredictGrowthAll) +
  geom_line(aes(PhotonDose_value, .fitted), colour = "darkslategray", show.legend = F, GRCplatt_PredictGrowth30) +
  geom_line(aes(PhotonDose_value, .fitted), colour = "lightblue4", show.legend = F, GRCplatt_PredictGrowth90) +
  geom_line(aes(PhotonDose_value, .fitted), colour = "hotpink4", show.legend = F, GRCplatt_PredictGrowth180) +
  geom_line(aes(PhotonDose_value, .fitted), colour = "indianred3", show.legend = F, GRCplatt_PredictGrowth300) +
  geom_line(aes(PhotonDose_value, .fitted), colour = "orange1", show.legend = F, GRCplatt_PredictGrowth900) +
  scale_x_continuous(breaks=seq(0, 60000000, by = 30000000), label=scientific_10) +
  coord_cartesian(xlim = c(0, 90000000)) +
  scale_linetype_manual(values=c("equal900" = "dotted", "less900" = "solid"), breaks=c('8', '12', '16', "24", "", "")) +
  scale_colour_manual(values = c("", "", "darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2, breaks=c('', '', '30', "90", "180", "300", "900")) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "Photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  ggh4x::facet_nested(cols = vars(PhotonDose), rows = vars(Strain), labeller = label_parsed) +
  theme_bw() 
```


# Exstracting parameters from each fit (for each light and all light together)

```{r}
GrowthRateAllParam<-GRCplatt_PredictGrowthAll %>% 
  select(c(Strain, PhotonDose, term, estimate, std.error, statistic, p.value)) %>% 
  unique()
  GrowthRateAllParam$Fit <- 'All'

GrowthRate30Param<-GRCplatt_PredictGrowth30 %>% 
  select(c(Strain, PhotonDose, term, estimate, std.error, statistic, p.value)) %>% 
  unique()
  GrowthRate30Param$Fit <- '30'

GrowthRate90Param<-GRCplatt_PredictGrowth90 %>% 
  select(c(Strain, PhotonDose, term, estimate, std.error, statistic, p.value)) %>% 
  unique()
  GrowthRate90Param$Fit <- '90'
  
GrowthRate180Param<-GRCplatt_PredictGrowth180 %>% 
  select(c(Strain, PhotonDose, term, estimate, std.error, statistic, p.value)) %>% 
  unique()
  GrowthRate180Param$Fit <- '180'
  
GrowthRate300Param<-GRCplatt_PredictGrowth300 %>% 
  select(c(Strain, PhotonDose, term, estimate, std.error, statistic, p.value)) %>% 
  unique()
  GrowthRate300Param$Fit <- '300'
  
GrowthRate900Param<-GRCplatt_PredictGrowth900 %>% 
  select(c(Strain, PhotonDose, term, estimate, std.error, statistic, p.value)) %>% 
  unique()
  GrowthRate900Param$Fit <- '900'
  
MCParamAll<-rbind(GrowthRateAllParam, GrowthRate30Param, GrowthRate90Param, GrowthRate180Param, GrowthRate300Param, GrowthRate900Param)

rm(GrowthRateAllParam, GrowthRate30Param, GrowthRate90Param, GrowthRate180Param, GrowthRate300Param, GrowthRate900Param)
```

# Exstracting models for each fit (for each light and all light together)

```{r}

MCGrowthDummyAllModel<-MCGrowthDummyAll %>% 
  select(c(Strain, PhotonDose, GRCplatt_Model))
  MCGrowthDummyAllModel$Fit <- 'All'

MCGrowthDummy30Model<-MCGrowthDummy30 %>% 
  select(c(Strain, PhotonDose, GRCplatt_Model))
  MCGrowthDummy30Model$Fit <- '30'

MCGrowthDummy90Model<-MCGrowthDummy90 %>% 
  select(c(Strain, PhotonDose, GRCplatt_Model))
  MCGrowthDummy90Model$Fit <- '90'
  
MCGrowthDummy180Model<-MCGrowthDummy180 %>% 
  select(c(Strain, PhotonDose, GRCplatt_Model))
  MCGrowthDummy180Model$Fit <- '180'
  
MCGrowthDummy300Model<-MCGrowthDummy300 %>% 
  select(c(Strain, PhotonDose, GRCplatt_Model))
  MCGrowthDummy300Model$Fit <- '300'
  
MCGrowthDummy900Model<-MCGrowthDummy900 %>% 
  select(c(Strain, PhotonDose, GRCplatt_Model))
  MCGrowthDummy900Model$Fit <- '900'
  
MCModelAll<-rbind(MCGrowthDummyAllModel, MCGrowthDummy30Model, MCGrowthDummy90Model, MCGrowthDummy180Model, MCGrowthDummy300Model, MCGrowthDummy900Model)

rm(MCGrowthDummyAllModel, MCGrowthDummy30Model, MCGrowthDummy90Model, MCGrowthDummy180Model, MCGrowthDummy300Model, MCGrowthDummy900Model)
```

https://bookdown.org/ndphillips/YaRrr/comparing-regression-models-with-anova.html

https://www.r-bloggers.com/2021/05/how-to-compare-nested-models-in-r/

https://stackoverflow.com/questions/52450956/fitted-values-from-a-different-model-in-r

https://stats.stackexchange.com/questions/53312/comparing-two-models-using-anova-function-in-r

https://stackoverflow.com/questions/71253671/comparing-models-using-anova

#Anova from the model - compare all light to selected light

```{r}
MCModelAll_BA56<-MCModelAll %>% 
  filter(Strain == "PC-rich_056") %>% 
  filter(PhotonDose == "PAR")
anova056<-anova(MCModelAll_BA56[[3]][[6]], MCModelAll_BA56[[3]][[1]], test="F")
#900 no sig different - PAR and PUR
# all significantly (except 900) -> This means that adding the 90, 180, 300 to the "simplest" model 30 did lead to a significantly improved fit over the model 30. - czyli dwa fity - wszystko i 900!!

MCModelAll_BA77<-MCModelAll %>% 
  filter(Strain == "PC-rich_077") %>% 
  filter(PhotonDose == "PAR")
anova077<-anova(MCModelAll_BA77[[3]][[1]], MCModelAll_BA77[[3]][[5]])
#900 no sig different - PAR and PUR

MCModelAll_BA48<-MCModelAll %>% 
  filter(Strain == "PE-rich_048") %>% 
  filter(PhotonDose == "PAR")
anova048<-anova(MCModelAll_BA48[[3]][[1]], MCModelAll_BA48[[3]][[5]])
#900 no sig different - PAR and PUR

MCModelAll_BA127<-MCModelAll %>% 
  filter(Strain == "PE-rich_127") %>% 
  filter(PhotonDose == "PAR")
anova127<-anova(MCModelAll_BA127[[3]][[6]], MCModelAll_BA127[[3]][[1]])
#all different - PAR and PUR

```







# Create preliminary plot

```{r preliminary plot}
MCParamAll %>% 
  filter(term == "a") %>% 
  filter(PhotonDose == "PAR") %>% 
  ggplot() +
  geom_point(aes(x = term, y = estimate, color = Strain)) +
  # ggh4x::facet_nested(cols = vars(Fit), rows = vars(Strain), labeller = label_parsed, scales = "free") +
  facet_grid(PhotonDose~factor(Fit, levels=c('30','90','180','300', "900", "All"))) +
  theme_bw()

MCParamAll %>% 
  filter(term == "Pmax") %>% 
  filter(PhotonDose == "PAR") %>% 
  ggplot() +
  geom_point(aes(x = term, y = estimate, color = Strain)) +
  # ggh4x::facet_nested(cols = vars(Fit), rows = vars(Strain), labeller = label_parsed, scales = "free") +
  facet_grid(PhotonDose~factor(Fit, levels=c('30','90','180','300', "900", "All"))) +
  theme_bw()
```

```{r}

DNaseSS<-GRCplatt_PredictGrowthCombine %>% 
  filter(Strain == "PC-rich_056") %>% 
  filter(PhotonDose == "PAR") %>% 
  select(Fit, PhotonDose_value, deltaOD_Lmu_corr) 

DNase1SS <- subset(DNaseSS, Fit == 30)
DNase2SS <- subset(DNaseSS, Fit == 900)


```

Compare non-linear model parameter estimates between conditions

https://stats.stackexchange.com/questions/458195/compare-non-linear-model-parameter-estimates-between-conditions

```{r}
DNase1 <- subset(DNase, Run == 1)
DNase2 <- subset(DNase, Run == 2)
## fit models and extract coefficients
m1 <- nls(density ~ SSlogis(log(conc), Asym, xmid, scal), DNase1)
m1_coef <- tidy(m1) %>% 
  mutate(Run = 1)

m2 <- nls(density ~ SSlogis(log(conc), Asym, xmid, scal), DNase2)
m2_coef <- tidy(m2) %>% 
  mutate(Run = 2)

pars <- rbind(m1_coef, m2_coef) %>% 
  dplyr::filter(term == "Asym")

print(pars)
# term Estimate Std. Error  t value     Pr(>|t|) Run
# 1    Asym 2.345182  0.0781541 30.00715 2.165539e-13   1
# 2    Asym 2.595948  0.0646589 40.14835 5.109901e-15   2

# Is there a way test if the estimate for 'Asym' from Run 2 (2.345) is significantly different than the estimate from Run 1 (2.596)?

# Answers 
# Create a model m12 consisting of separate parameters for each run and a model m0 where the parameters are the same for each run and then compare those two models using an F test. 

# m1 and m2 will be used to set starting values for m12 and a0
fo <- density ~ SSlogis(log(conc), Asym, xmid, scal)
m1 <- nls(fo, DNase, subset = Run == 1)
m2 <- nls(fo, DNase, subset = Run == 2)

Logis <- function(x, Asym, xmid, scal) Asym / (1 + exp((xmid - x)/ scal))

# Run 1 and Run 2 each have a separate set of parameters.
# (Run is a factor whose labels don't correspond to its levels so make it numeric.)
m12 <- nls(density ~ Logis(log(conc), Asym[Run], xmid[Run], scal[Run]),
  transform(DNase, Run = as.numeric(as.character(Run))), 
  subset = Run %in% 1:2, 
  start = as.data.frame(rbind(coef(m1), coef(m2))))

# Run 1 and Run 2 have the same set of parameters
m0 <- nls(fo, DNase, subset = Run %in% 1:2)

anova(m0, m12)

# Analysis of Variance Table
# 
# Model 1: density ~ SSlogis(log(conc), Asym, xmid, scal)
# Model 2: density ~ Logis(log(conc), Asym[Run], xmid[Run], scal[Run])
#   Res.Df Res.Sum Sq Df   Sum Sq F value    Pr(>F)    
# 1     29   0.096915                                  
# 2     26   0.008478  3 0.088437  90.408 7.044e-14 ***
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1



# If we want to test only whether Asym differs but not whether xmid and scal are the same then create a model a0 where Asym is the same but the other parameters can differ and compare it to m12.

# same Asym for Run 1 and Run 2 but other parameters separate
a0 <- nls(density ~ Logis(log(conc), Asym, xmid[Run], scal[Run]),
  transform(DNase, Run = as.numeric(as.character(Run))), 
  subset = Run %in% 1:2, 
  start = c(Asym = (coef(m1)[[1]] + coef(m2)[[1]])/2, 
    as.data.frame(rbind(coef(m1)[-1], coef(m2)[-1]))))

anova(a0, m12)

# Analysis of Variance Table
# 
# Model 1: density ~ Logis(log(conc), Asym, xmid[Run], scal[Run])
# Model 2: density ~ Logis(log(conc), Asym[Run], xmid[Run], scal[Run])
#   Res.Df Res.Sum Sq Df    Sum Sq F value  Pr(>F)  
# 1     27  0.0103246                               
# 2     26  0.0084778  1 0.0018468  5.6639 0.02494 *
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
```






# Added facets labels

```{r}
GRCplatt_PredictGrowth30$facetsStrain = factor(GRCplatt_PredictGrowth30$PhotonDose, labels = c("Strain", "Strain"))
GRCplatt_PredictGrowth90$facetsStrain = factor(GRCplatt_PredictGrowth90$PhotonDose, labels = c("Strain", "Strain"))
GRCplatt_PredictGrowth180$facetsStrain = factor(GRCplatt_PredictGrowth180$PhotonDose, labels = c("Strain", "Strain"))
GRCplatt_PredictGrowth300$facetsStrain = factor(GRCplatt_PredictGrowth300$PhotonDose, labels = c("Strain", "Strain"))
GRCplatt_PredictGrowth900$facetsStrain = factor(GRCplatt_PredictGrowth900$PhotonDose, labels = c("Strain", "Strain"))
```

# Create Growth Rate plot

```{r create growth rate plot, fig.height = 8, fig.width = 8, warning = FALSE}
lab1=c(expression("8 h"), expression("12 h"), expression("16 h"), expression("24 h"))
lab2=c(expression("1 µE"), expression("2 µE"), expression("30 µE"), expression("90 µE"), expression("180 µE"), expression("300 µE"), expression("900 µE"))
scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }

ggplot(MultiCultiGrowthRatePURExpFit, aes(PhotonDose_value, deltaOD_Lmu_corr)) +
  geom_point(aes(PhotonDose_value, deltaOD_Lmu_corr, colour=as.factor(Par_ue), shape = as.factor(Photoperiod)), alpha = 0.8, size = 3.5, show.legend = T) +
  geom_errorbar(aes(x = PhotonDose_value, ymin = deltaOD_Lmu_corr - deltaOD_Lmu_se, ymax = deltaOD_Lmu_corr + deltaOD_Lmu_se, colour = as.factor(Par_ue)), width=0, size=0.3, data = . %>% filter(deltaOD_Lmu_se<8.057558e-03), show.legend = F) +
  geom_line(aes(PhotonDose_value, .fitted), colour = "darkslategray", show.legend = F, GRCplatt_PredictGrowth30) +
  geom_line(aes(PhotonDose_value, .fitted), colour = "lightblue4", show.legend = F, GRCplatt_PredictGrowth90) +
  geom_line(aes(PhotonDose_value, .fitted), colour = "hotpink4", show.legend = F, GRCplatt_PredictGrowth180) +
  geom_line(aes(PhotonDose_value, .fitted), colour = "indianred3", show.legend = F, GRCplatt_PredictGrowth300) +
  geom_line(aes(PhotonDose_value, .fitted), colour = "orange1", show.legend = F, GRCplatt_PredictGrowth900) +
  scale_x_continuous(breaks=seq(0, 60000000, by = 30000000), label=scientific_10) +
  coord_cartesian(xlim = c(0, 90000000)) +
  scale_linetype_manual(values=c("equal900" = "dotted", "less900" = "solid"), breaks=c('8', '12', '16', "24", "", "")) +
  scale_colour_manual(values = c("", "", "darkslategray", "lightblue4", "hotpink4", "indianred3", "orange1"), name="", labels = lab2, breaks=c('', '', '30', "90", "180", "300", "900")) +
  scale_shape_manual(values = c(15, 16, 17, 18), name="", labels = lab1) +
  labs(y = "Logistic growth rate " ~ "("~h^-1~")", x = "Photon dose ( µmol photons "~m^-2~""~d^-1~")") +
  ggh4x::facet_nested(cols = vars(PhotonDose), rows = vars(facetsStrain, Strain), labeller = label_parsed) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.text.x = element_text(size=11),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        axis.title.y = element_text(margin=margin(r=10)),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.92,0.88),
        legend.key.height= unit(0.003, 'cm'),
        legend.spacing.y = unit(-0.1, "cm"),
        legend.spacing.x = unit(-0.1, 'cm'),
        legend.title = element_blank(),
        legend.text = element_text(size=9))
```







# Removed unneccessary df from the environment

```{r}
rm(MCGrowthDummy30, MCGrowthDummy90, MCGrowthDummy180, MCGrowthDummy300, MCGrowthDummy900, GRCplatt_PredictGrowth30, GRCplatt_PredictGrowth90, GRCplatt_PredictGrowth180, GRCplatt_PredictGrowth300, GRCplatt_PredictGrowth900, OLISSpectra, MultiCultiGrowth, GRCplatt_PredictGrowth, MultiCultiGrowthRatePURExpFit, tmaxAG, tMaxAGLines_056, tMaxAGLines_077, tMaxAGLines_048, tMaxAGLines_127)
```

# Save RDS that create plot

```{r}
saveRDS(MultiCultiGrowthRatePURExpFit, file.path(RDSPlotPath, paste(Project, "Plot_Growthrate_1.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)

saveRDS(GRCplatt_PredictGrowth30, file.path(RDSPlotPath, paste(Project, "Plot_Growthrate_2.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)

saveRDS(GRCplatt_PredictGrowth90, file.path(RDSPlotPath, paste(Project, "Plot_Growthrate_3.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)

saveRDS(GRCplatt_PredictGrowth180, file.path(RDSPlotPath, paste(Project, "Plot_Growthrate_4.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)

saveRDS(GRCplatt_PredictGrowth300, file.path(RDSPlotPath, paste(Project, "Plot_Growthrate_5", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)

saveRDS(GRCplatt_PredictGrowth900, file.path(RDSPlotPath, paste(Project, "Plot_Growthrate_6", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)
```

# Save plot 

```{r save plot}
ggsave(file = file.path(PlotsPath, paste("GrowthRate_Plot",".png",sep = "")), height=10, width= 8,  dpi = 300, limitsize = TRUE)
```

# Save rds for further analysis

```{r save rds}
saveRDS(MCGrowthRateExp, file.path(DataOut, paste(Project, "Processed_GrowthRate.Rds", sep = "_"), fsep = .Platform$file.sep), ascii = FALSE, version = NULL, compress = "xz", refhook = NULL)
```

# Variable names used in Data Dictionary

```{r}
colnames(MCGrowthRateExp)
```













# Statistics

The likelihood-ratio test in statistics compares the goodness of fit of two nested regression models based on the ratio of their likelihoods, specifically one obtained by maximization over the entire parameter space and another obtained after imposing some constraint.
To see if these two models differ significantly, we can use a likelihood ratio test with the following null and alternative hypotheses.

H0: Both the full and nested models fit the data equally well. As a result, you should employ the nested model. #jezeli nie ma roznic, to nie trzeba dodawac ekstra czynnika
H1: The full model significantly outperforms the nested model in terms of data fit. As a result, you should use the entire model.


```{r}
fullmodel <- lm(mpg ~ cyl + disp + hp + wt, data = mtcars)
reducedmodel <- lm(mpg ~ cyl + disp, data = mtcars)

library(lmtest) #Likelihood Ratio Test
lrtest(fullmodel, reducedmodel)
```

ANOVA testing whether the more complex model is significantly better at capturing the data than the simpler model. 

```{r}
library(agricolae)
data("PlantGrowth")
plant.lm <- lm(weight ~ group, data = PlantGrowth)
plant.av <- aov(plant.lm)
#plant.av <- aov(weight ~ group, data = PlantGrowth) #gives the same result
summary(plant.av)

tukey.test <- TukeyHSD(plant.av)
tukey.test

summary(lm(weight ~ group, data = PlantGrowth))
```

# Stats with letters

```{r}
# library(agricolae)
# data(sweetpotato)
# model<-aov(yield~virus, data=sweetpotato)
# out <- HSD.test(model,"virus", group=TRUE,console=TRUE)
# plot(out)
```















